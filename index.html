<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SZMC Pro: Mobile v15.5</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2c3e50">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx@9.5.1/build/index.js"></script>
    
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --bg: #f4f6f7; --sidebar: #ffffff; }
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* SIDEBAR (Desktop) */
        .sidebar { width: 300px; background: var(--sidebar); border-right: 1px solid #dce1e6; display: flex; flex-direction: column; padding: 20px; z-index: 2; overflow-y: auto; }
        .logo { font-size: 1.4rem; font-weight: 800; color: var(--primary); margin-bottom: 20px; display:flex; justify-content:space-between; align-items:center; }
        .badge { background: var(--accent); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; }
        
        /* DROPZONE */
        .drop-zone { border: 2px dashed #bdc3c7; border-radius: 12px; padding: 20px 10px; text-align: center; background: #fafafa; cursor: pointer; transition: 0.2s; min-height: 120px; display:flex; flex-direction:column; justify-content:center; align-items:center; }
        .drop-zone:active { background: #eafaf1; border-color: var(--accent); }
        
        /* MAIN LAYOUT (Desktop) */
        .main { flex: 1; padding: 20px; overflow-y: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding-bottom: 80px; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; flex-direction: column; height: fit-content; }
        
        /* INPUTS */
        h2 { margin-top:0; font-size:1rem; color:var(--primary); border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px; font-weight:700; }
        label { display: block; font-size: 0.75rem; font-weight: 700; color: #7f8c8d; margin-bottom: 5px; text-transform: uppercase; letter-spacing:0.5px; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #e1e4e8; border-radius: 8px; font-size: 16px; /* Prevents iOS zoom */ background: #fdfdfd; margin-bottom: 15px; -webkit-appearance: none; }
        input:focus, textarea:focus { border-color: var(--accent); outline: none; background: white; }

        /* BUTTONS */
        .btn { padding: 14px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; color: white; width: 100%; font-size: 0.95rem; margin-top: 5px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:active { transform: scale(0.96); opacity: 0.9; }
        .btn-magic { background: linear-gradient(135deg, #27ae60, #2ecc71); }
        .btn-ppt { background: #e67e22; margin-bottom: 10px; }
        .btn-doc { background: #2980b9; }
        
        .ai-box { border: 2px solid #27ae60; background: #f0fcf4; color: #2c3e50; font-family: monospace; font-size: 0.85rem; }
        #status { font-size: 0.8rem; color: #e67e22; text-align: center; margin-top: 10px; min-height: 1.2em; font-weight: bold; }

        /* --- MOBILE RESPONSIVE ENGINE --- */
        @media (max-width: 768px) {
            body { flex-direction: column; height: auto; overflow: auto; }
            .sidebar { width: 100%; height: auto; border-right: none; border-bottom: 1px solid #ddd; padding: 15px; flex-shrink: 0; }
            .main { display: flex; flex-direction: column; height: auto; overflow: visible; padding: 15px; }
            .drop-zone { padding: 15px; min-height: 100px; }
            textarea { min-height: 100px; }
            .ai-box { min-height: 200px; }
            /* Hide raw text on mobile to save space */
            #raw-text-container { display: none; } 
        }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="logo"><span>SZMC Pro</span> <span class="badge">v15.5 Mobile</span></div>
    
    <div class="drop-zone" onclick="document.getElementById('file-in')?.click()" id="drop-area">
        <div style="font-size:1.8rem;">üìÇ</div>
        <div style="font-weight:700; color:#2c3e50; margin-top:5px;">Import File</div>
        <div style="font-size:0.7rem; color:#7f8c8d;">PDF ‚Ä¢ DOCX ‚Ä¢ DOC ‚Ä¢ PPTX ‚Ä¢ HTML ‚Ä¢ JPG</div>
        <input type="file" id="file-in" style="display:none" onchange="handleFile(this)">
    </div>
    <div id="status"></div>
    
    <div id="raw-text-container" style="margin-top:20px;">
        <label>Raw Data</label>
        <textarea id="raw-text" style="height:150px; font-size:0.7rem; font-family:monospace;" placeholder="Text extractor..."></textarea>
    </div>
    
    <div style="margin-top:20px; padding:10px; background:#f9f9f9; border-radius:8px; font-size:0.75rem;">
        <strong>‚å®Ô∏è Keyboard Shortcuts:</strong>
        <div style="margin-top:8px; color:#666;">
            <div>Ctrl/‚åò + G - Generate Prompt</div>
            <div>Ctrl/‚åò + E - Export PPTX</div>
            <div>Ctrl/‚åò + Shift + E - Export DOC</div>
        </div>
    </div>
</div>

<div class="main">
    <div class="card">
        <h2>1. Patient Data</h2>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
            <div><label for="age_sex">Age/Sex</label><input type="text" id="age_sex" placeholder="e.g. 85F" aria-label="Patient age and sex"></div>
            <div><label for="initials">Initials</label><input type="text" id="initials" placeholder="e.g. A.B." aria-label="Patient initials"></div>
        </div>
        <label for="hpi">CC / HPI</label><textarea id="hpi" rows="4" placeholder="Admitted for..." aria-label="Chief complaint and history of present illness"></textarea>
        <label for="meds">Meds & Labs</label><textarea id="meds" rows="4" placeholder="List meds and labs..." aria-label="Medications and laboratory results"></textarea>
        
        <button class="btn btn-magic" onclick="generateMagicPrompt()" aria-label="Generate and copy AI prompt to clipboard">
            <span>‚ú®</span> Copy AI Prompt
        </button>
        <button class="btn" style="background:#95a5a6; margin-top:10px;" onclick="clearForm()" aria-label="Clear all form fields">
            <span>üóëÔ∏è</span> Clear Form
        </button>
    </div>

    <div class="card">
        <h2>2. AI Result & Export</h2>
        <label>Paste Claude/GPT Answer Here:</label>
        <textarea id="ai-response" class="ai-box" rows="12" placeholder="Paste the full AI analysis here. This text will be included in your export." aria-label="AI response input"></textarea>
        
        <div style="margin-top:20px;">
            <button class="btn btn-ppt" onclick="exportPPT()" aria-label="Export to PowerPoint presentation with AI analysis">üìä Download PPTX (With AI)</button>
            <button class="btn" style="background:#8e44ad; margin-top:10px;" onclick="exportProfessionalPPT()" aria-label="Export professional medical presentation without AI requirement">üéì Professional PPTX (No AI)</button>
            <button class="btn btn-doc" onclick="exportDOC()" aria-label="Export to Word document">üìù Download Word (Doc)</button>
            <button class="btn" style="background:#16a085; margin-top:10px;" onclick="exportJSON()" aria-label="Export data as JSON file">üíæ Export JSON</button>
        </div>
    </div>
</div>

<script>
    // --- 0. CONSTANTS ---
    const APP_VERSION = '15.5.0';
    const STORAGE_KEY = 'szmc-pro-form-data';
    const FORM_FIELDS = ['age_sex', 'initials', 'hpi', 'meds', 'ai-response', 'raw-text'];

    // Load saved data on page load
    function loadSavedData() {
        try {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                const data = JSON.parse(saved);
                FORM_FIELDS.forEach(id => {
                    const el = document.getElementById(id);
                    if (el && data[id]) el.value = data[id];
                });
                console.log('Form data restored from localStorage');
            }
        } catch (err) {
            console.error('Error loading saved data:', err);
        }
    }

    // Save data to localStorage (debounced)
    let saveTimeout;
    function saveFormData() {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
            try {
                const data = {};
                FORM_FIELDS.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) data[id] = el.value;
                });
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            } catch (err) {
                console.error('Error saving data:', err);
            }
        }, 500); // Debounce by 500ms
    }

    // Immediate save function (no debounce) for critical moments
    function saveFormDataNow() {
        try {
            const data = {};
            FORM_FIELDS.forEach(id => {
                const el = document.getElementById(id);
                if (el) data[id] = el.value;
            });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        } catch (err) {
            console.error('Error saving data:', err);
        }
    }

    // Save data before page unload to prevent data loss
    window.addEventListener('beforeunload', () => {
        clearTimeout(saveTimeout);
        saveFormDataNow();
    });

    // Attach auto-save listeners
    document.addEventListener('DOMContentLoaded', () => {
        loadSavedData();
        FORM_FIELDS.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('input', saveFormData);
        });
    });

    // --- 1. IMPORT ENGINE ---
    const dropArea = document.getElementById('drop-area');
    const statusDiv = document.getElementById('status');

    // Prevent default drag behaviors
    function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        if (dropArea) dropArea.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });

    // Highlight drop area and handle drops (only if dropArea exists)
    if (dropArea) {
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.style.background = '#eafaf1', false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.style.background = '#fafafa', false);
        });

        // Handle Drop
        dropArea.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFile({files: files});
        }, false);
    }

    async function handleFile(input) {
        // Validate input
        if (!input || !input.files || !input.files[0]) return;
        const file = input.files[0];

        // File size validation (max 50MB)
        const MAX_FILE_SIZE = 50 * 1024 * 1024;
        if (file.size > MAX_FILE_SIZE) {
            alert('File too large. Maximum size is 50MB.');
            return;
        }

        const ext = file.name.split('.').pop().toLowerCase();
        const SUPPORTED_EXTENSIONS = ['pptx', 'pdf', 'docx', 'doc', 'html', 'htm', 'txt', 'jpg', 'png', 'jpeg'];
        if (!SUPPORTED_EXTENSIONS.includes(ext)) {
            alert(`Unsupported file type: .${ext}. Supported: ${SUPPORTED_EXTENSIONS.join(', ')}`);
            return;
        }

        let text = "";
        if (statusDiv) statusDiv.innerText = "Reading...";

        try {
            if (ext === 'pptx') {
                if (typeof JSZip === 'undefined') throw new Error('JSZip library not loaded');
                const zip = await JSZip.loadAsync(file);
                // Filter and numerical sort for slides (with safe number extraction)
                const slides = Object.keys(zip.files).filter(n => n.match(/ppt\/slides\/slide\d+\.xml/)).sort((a,b)=>{
                    const numA = a.match(/\d+/)?.[0] || '0';
                    const numB = b.match(/\d+/)?.[0] || '0';
                    return parseInt(numA, 10) - parseInt(numB, 10);
                });
                for(let s of slides) { 
                    const t = await zip.file(s).async("string"); 
                    const d = new DOMParser().parseFromString(t,"text/xml"); 
                    // Safe access to textContent
                    if(d.documentElement) text += (d.documentElement.textContent || "") + "\n\n"; 
                }
            } 
            else if (ext === 'pdf') {
                if (typeof pdfjsLib === 'undefined') throw new Error('PDF.js library not loaded');
                const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
                for(let i=1; i<=pdf.numPages; i++) text += (await (await pdf.getPage(i)).getTextContent()).items.map(s=>s.str).join(' ') + " ";
            } 
            else if (ext === 'docx') {
                if (typeof mammoth === 'undefined') throw new Error('Mammoth library not loaded');
                const res = await mammoth.extractRawText({arrayBuffer: await file.arrayBuffer()});
                text = res.value;
            } 
            else if (['html', 'htm', 'txt'].includes(ext)) {
                text = await file.text();
                // Strip tags if HTML
                if(ext.includes('htm')) {
                    const doc = new DOMParser().parseFromString(text, 'text/html');
                    text = doc.body?.innerText || doc.body?.textContent || '';
                }
            }
            else if (['jpg','png','jpeg'].includes(ext)) {
                if (typeof Tesseract === 'undefined') throw new Error('Tesseract.js library not loaded');
                if (statusDiv) statusDiv.innerText = "OCR (Wait)...";
                const w = await Tesseract.createWorker('eng');
                const r = await w.recognize(file); 
                text = r.data.text; 
                await w.terminate();
            } 
            
            const rawTextEl = document.getElementById('raw-text');
            if (rawTextEl) rawTextEl.value = text;
            smartPopulate(text);
            if (statusDiv) statusDiv.innerText = "Success!";
            setTimeout(() => { if (statusDiv) statusDiv.innerText = ""; }, 2000);
        } catch (err) {
            console.error(err);
            if (statusDiv) statusDiv.innerText = "Error";
            alert("Could not read file. " + err.message);
        }
    }

    // --- 2. POPULATOR ---
    function smartPopulate(text) {
        const set = (id, r) => {
            const m = text.match(r);
            const el = document.getElementById(id);
            if(m && m[1] && el) el.value = m[1].trim();
        };
        // Enhanced patterns to match more variations (e.g., "85F", "72 M", "65 male", "78 female")
        set('age_sex', /(\d{2,3}\s?(?:male|female|Male|Female|[MmFf]))/);
        set('hpi', /(?:HPI|History of Present Illness|History)[:\s]+([\s\S]*?)(?=\n\s*(?:PMH|Past Medical History|Meds|Medications|Assessment|Physical Exam)|$)/i);
        set('meds', /(?:Meds|Medications|Current Medications|Home Medications)[:\s]+([\s\S]*?)(?=\n\s*(?:Labs|Laboratory|Plan|Assessment|Allergies)|$)/i);
    }

    // --- 3. PROMPT ---
    // Constants for prompt generation
    const PROMPT_MESSAGES = {
        BYPASS_CONFIRM: 'Structured fields are empty, but raw text is available.\n\nDo you want to generate the AI prompt using the raw extracted text instead?',
        SUCCESS_STANDARD: 'Prompt Copied! Paste into AI.',
        SUCCESS_RAW_TEXT: 'Prompt generated from raw text and copied! Paste into AI.',
        COPY_FAILED: 'Auto-copy failed. The prompt is displayed - please copy manually (Ctrl+C), then close this dialog.'
    };

    // Prompt template - matches src/prompt.js PROMPT_TEMPLATE
    const PROMPT_TEMPLATE = `Act as a Senior Geriatrician.
I will provide clinical data. Please output a response with TWO SECTIONS:

SECTION 1: SAFETY AUDIT (Strict)
- Flag Drug Interactions.
- Flag Beers Criteria.

SECTION 2: CLINICAL SUMMARY (Professional)
- Case Presentation style.
- Assessment & Plan.

DATA:
ID: {ageSex}
HPI: {hpi}
MEDS/LABS: {meds}`;

    async function generateMagicPrompt() {
        const v = (id) => document.getElementById(id)?.value || '';
        
        // Get all data including raw text
        const ageSex = v('age_sex').trim();
        const hpi = v('hpi').trim();
        const meds = v('meds').trim();
        const rawText = v('raw-text').trim();
        
        // Check if ALL required structured fields are filled
        const allStructuredFieldsFilled = ageSex && hpi && meds;
        
        // If any structured field is missing, check if we have raw text as fallback
        if (!allStructuredFieldsFilled) {
            if (rawText) {
                // Raw text is available - offer to use it
                const useRawText = confirm(PROMPT_MESSAGES.BYPASS_CONFIRM);
                if (!useRawText) {
                    return;
                }
            } else {
                // No raw text fallback available - show error
                const missing = [];
                if (!ageSex) missing.push('Age/Sex');
                if (!hpi) missing.push('HPI');
                if (!meds) missing.push('Meds/Labs');
                alert(`Please fill in the following required fields: ${missing.join(', ')}`);
                return;
            }
        }
        
        // Generate prompt using template
        let p;
        if (!allStructuredFieldsFilled && rawText) {
            // Use raw text in prompt when structured fields are incomplete
            p = PROMPT_TEMPLATE
                .replace('{ageSex}', 'See below')
                .replace('{hpi}', 'See clinical data below')
                .replace('{meds}', rawText);
        } else {
            // Use structured fields
            p = PROMPT_TEMPLATE
                .replace('{ageSex}', ageSex)
                .replace('{hpi}', hpi)
                .replace('{meds}', meds);
        }

        try {
            await navigator.clipboard.writeText(p);
            const message = !allStructuredFieldsFilled && rawText 
                ? PROMPT_MESSAGES.SUCCESS_RAW_TEXT
                : PROMPT_MESSAGES.SUCCESS_STANDARD;
            alert(message);
        } catch (err) {
            console.error('Clipboard error:', err);
            // Fallback: show prompt in a textarea for manual copy
            const textarea = document.createElement('textarea');
            textarea.value = p;
            textarea.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:80%;height:60%;z-index:9999;';
            document.body.appendChild(textarea);
            textarea.select();
            alert(PROMPT_MESSAGES.COPY_FAILED);
            document.body.removeChild(textarea);
        }
    }

    // --- 4. SAFE EXPORTS ---
    const getVal = (id) => document.getElementById(id)?.value || "";

    // Sanitize text by removing control characters and HTML/XML tags (except newlines and tabs)
    const sanitizeText = (text) => {
        if (!text || typeof text !== 'string') return '';
        // Remove HTML/XML tags iteratively to handle nested/malformed tags
        let sanitized = text;
        let previous;
        do {
            previous = sanitized;
            sanitized = sanitized.replace(/<[^>]*>/g, '');
        } while (sanitized !== previous);
        // Remove control characters except newlines and tabs
        return sanitized.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '');
    };

    // HTML escape function to prevent XSS in Word export
    const escapeHtml = (text) => {
        if (!text || typeof text !== 'string') return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    };

    function exportPPT() {
        console.log('Starting comprehensive PPT export (15+ slides)...');
        try {
            // Validate minimum required data
            if (!getVal('age_sex').trim() && !getVal('hpi').trim()) {
                alert('Please add some patient data before exporting.');
                return;
            }

            if (typeof PptxGenJS === 'undefined') throw new Error('PptxGenJS library not loaded');
            let pres = new PptxGenJS();

            // Professional color scheme
            const colors = {
                primary: '2c3e50',
                secondary: '7f8c8d',
                accent: '27ae60',
                highlight: 'c0392b',
                text: '333333',
                warning: 'e74c3c',
                info: '3498db',
                success: '27ae60',
                lightBg: 'f8f9fa',
                white: 'ffffff'
            };

            // Sanitize all text fields to remove control characters
            const ageSex = sanitizeText(getVal('age_sex')) || 'Not specified';
            const initials = sanitizeText(getVal('initials')) || 'N/A';
            const hpi = sanitizeText(getVal('hpi')) || 'Not documented';
            const meds = sanitizeText(getVal('meds')) || 'Not documented';
            const aiText = sanitizeText(getVal('ai-response')) || 'Pending clinical analysis';
            const currentDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            // Helper function to add styled header to slides
            const addSlideHeader = (slide, title, color) => {
                slide.addShape('rect', { x: 0, y: 0, w: '100%', h: 0.8, fill: { color: color } });
                slide.addText(title, { x: 0.5, y: 0.2, w: '90%', fontSize: 24, color: 'ffffff', bold: true });
            };

            // Helper function to truncate text
            const truncate = (text, max) => text && text.length > max ? text.substring(0, max) + '...' : text;

            // ========== SLIDE 1: Title Page ==========
            let s1 = pres.addSlide();
            s1.addShape('rect', { x: 0, y: 0, w: '100%', h: '100%', fill: { color: colors.primary } });
            s1.addText('GERIATRIC CASE PRESENTATION', { x: 0.5, y: 1.5, w: '90%', fontSize: 36, color: 'ffffff', bold: true, align: 'center' });
            s1.addText(`Patient: ${ageSex} (${initials})`, { x: 0.5, y: 2.5, w: '90%', fontSize: 24, color: 'ecf0f1', align: 'center' });
            s1.addShape('line', { x: 2, y: 3.2, w: 6, h: 0, line: { color: colors.accent, width: 3 } });
            s1.addText('Comprehensive Geriatric Assessment', { x: 0.5, y: 3.5, w: '90%', fontSize: 18, color: 'bdc3c7', align: 'center' });
            s1.addText(`SZMC Geriatrics Pro | ${currentDate}`, { x: 0.5, y: 4.8, w: '90%', fontSize: 12, color: '95a5a6', align: 'center' });

            // ========== SLIDE 2: Case Overview ==========
            let s2 = pres.addSlide();
            addSlideHeader(s2, 'üìã Case Overview', colors.primary);
            s2.addText('Patient Demographics', { x: 0.5, y: 1.1, fontSize: 18, color: colors.accent, bold: true });
            s2.addText([
                { text: '‚Ä¢ Age/Sex: ', options: { bold: true } }, { text: ageSex, options: { bold: false } }
            ], { x: 0.7, y: 1.5, fontSize: 14, color: colors.text });
            s2.addText([
                { text: '‚Ä¢ Patient ID: ', options: { bold: true } }, { text: initials, options: { bold: false } }
            ], { x: 0.7, y: 1.9, fontSize: 14, color: colors.text });
            s2.addText('Presentation Context', { x: 0.5, y: 2.5, fontSize: 18, color: colors.accent, bold: true });
            s2.addText('‚Ä¢ Comprehensive Geriatric Assessment (CGA)', { x: 0.7, y: 2.9, fontSize: 14, color: colors.text });
            s2.addText('‚Ä¢ Multidisciplinary evaluation approach', { x: 0.7, y: 3.3, fontSize: 14, color: colors.text });
            s2.addText('‚Ä¢ Evidence-based clinical decision support', { x: 0.7, y: 3.7, fontSize: 14, color: colors.text });
            s2.addShape('rect', { x: 0.5, y: 4.3, w: 9, h: 0.6, fill: { color: colors.lightBg } });
            s2.addText('‚öïÔ∏è Aligned with AGS Beers Criteria¬Æ and STOPP/START Guidelines', { x: 0.6, y: 4.4, fontSize: 11, color: colors.secondary, italic: true });

            // ========== SLIDE 3: Chief Complaint & HPI ==========
            let s3 = pres.addSlide();
            addSlideHeader(s3, 'üè• Chief Complaint & History of Present Illness', colors.info);
            s3.addText(truncate(hpi, 800), { x: 0.5, y: 1.1, w: 9, h: 3.8, fontSize: 13, color: colors.text, valign: 'top' });

            // ========== SLIDE 4: HPI Continued (if needed) ==========
            if (hpi.length > 800) {
                let s4 = pres.addSlide();
                addSlideHeader(s4, 'üè• History of Present Illness (Continued)', colors.info);
                s4.addText(truncate(hpi.substring(800), 1000), { x: 0.5, y: 1.1, w: 9, h: 3.8, fontSize: 13, color: colors.text, valign: 'top' });
            }

            // ========== SLIDE 5: Medication Review ==========
            let s5 = pres.addSlide();
            addSlideHeader(s5, 'üíä Current Medications & Labs', colors.accent);
            s5.addText(truncate(meds, 900), { x: 0.5, y: 1.1, w: 9, h: 3.8, fontSize: 12, color: colors.text, valign: 'top' });

            // ========== SLIDE 6: Medication Safety Review ==========
            let s6 = pres.addSlide();
            addSlideHeader(s6, '‚ö†Ô∏è Medication Safety Assessment', colors.warning);
            s6.addText('Critical Safety Screening Points:', { x: 0.5, y: 1.1, fontSize: 16, color: colors.highlight, bold: true });
            const safetyItems = [
                '‚Ä¢ Beers Criteria¬Æ Assessment - PIMs in older adults',
                '‚Ä¢ STOPP/START Criteria Review',
                '‚Ä¢ Drug-Drug Interactions (DDIs)',
                '‚Ä¢ Drug-Disease Interactions',
                '‚Ä¢ Renal Dosing Adjustments (CrCl-based)',
                '‚Ä¢ Hepatic Impairment Considerations',
                '‚Ä¢ Anticholinergic Burden Score (ABS)',
                '‚Ä¢ QTc Prolongation Risk',
                '‚Ä¢ Fall-Risk Increasing Drugs (FRIDs)'
            ];
            safetyItems.forEach((item, idx) => {
                s6.addText(item, { x: 0.7, y: 1.5 + (idx * 0.35), fontSize: 13, color: colors.text });
            });

            // ========== SLIDE 7: Functional Assessment ==========
            let s7 = pres.addSlide();
            addSlideHeader(s7, 'üö∂ Functional Assessment', colors.accent);
            s7.addText('Activities of Daily Living (ADLs)', { x: 0.5, y: 1.1, fontSize: 16, color: colors.primary, bold: true });
            s7.addText('Bathing ‚Ä¢ Dressing ‚Ä¢ Toileting ‚Ä¢ Transferring ‚Ä¢ Continence ‚Ä¢ Feeding', { x: 0.7, y: 1.5, fontSize: 12, color: colors.secondary });
            s7.addText('Instrumental ADLs (IADLs)', { x: 0.5, y: 2.1, fontSize: 16, color: colors.primary, bold: true });
            s7.addText('Shopping ‚Ä¢ Cooking ‚Ä¢ Managing Medications ‚Ä¢ Finances ‚Ä¢ Transportation ‚Ä¢ Phone Use', { x: 0.7, y: 2.5, fontSize: 12, color: colors.secondary });
            s7.addText('Mobility & Gait Assessment', { x: 0.5, y: 3.1, fontSize: 16, color: colors.primary, bold: true });
            s7.addText('‚Ä¢ Timed Up and Go (TUG) Test\n‚Ä¢ Gait Speed Assessment\n‚Ä¢ Fall History & Risk Stratification', { x: 0.7, y: 3.5, fontSize: 12, color: colors.text });

            // ========== SLIDE 8: Cognitive Assessment ==========
            let s8 = pres.addSlide();
            addSlideHeader(s8, 'üß† Cognitive & Mental Status Assessment', colors.info);
            s8.addText('Cognitive Screening', { x: 0.5, y: 1.1, fontSize: 16, color: colors.primary, bold: true });
            s8.addText('‚Ä¢ Mini-Mental State Examination (MMSE)\n‚Ä¢ Montreal Cognitive Assessment (MoCA)\n‚Ä¢ Clock Drawing Test', { x: 0.7, y: 1.5, fontSize: 13, color: colors.text });
            s8.addText('Delirium Assessment', { x: 0.5, y: 2.5, fontSize: 16, color: colors.primary, bold: true });
            s8.addText('‚Ä¢ Confusion Assessment Method (CAM)\n‚Ä¢ 4AT Rapid Delirium Screening\n‚Ä¢ Delirium Observation Screening Scale', { x: 0.7, y: 2.9, fontSize: 13, color: colors.text });
            s8.addText('Mood & Depression Screening', { x: 0.5, y: 3.9, fontSize: 16, color: colors.primary, bold: true });
            s8.addText('‚Ä¢ Geriatric Depression Scale (GDS-15)', { x: 0.7, y: 4.3, fontSize: 13, color: colors.text });

            // ========== SLIDE 9: Clinical Analysis Part 1 ==========
            let s9 = pres.addSlide();
            addSlideHeader(s9, 'üìä Clinical Assessment & Analysis', colors.primary);
            s9.addText(truncate(aiText, 900), { x: 0.5, y: 1.1, w: 9, h: 3.8, fontSize: 12, color: colors.text, valign: 'top' });

            // ========== SLIDE 10: Clinical Analysis Part 2 (if needed) ==========
            if (aiText.length > 900) {
                let s10 = pres.addSlide();
                addSlideHeader(s10, 'üìä Clinical Assessment (Continued)', colors.primary);
                s10.addText(truncate(aiText.substring(900), 1000), { x: 0.5, y: 1.1, w: 9, h: 3.8, fontSize: 12, color: colors.text, valign: 'top' });
            }

            // ========== SLIDE 11: Differential Diagnosis ==========
            let s11 = pres.addSlide();
            addSlideHeader(s11, 'üîç Differential Diagnosis', colors.info);
            s11.addText('Key Diagnostic Considerations:', { x: 0.5, y: 1.1, fontSize: 16, color: colors.primary, bold: true });
            s11.addText('‚Ä¢ Primary Working Diagnosis\n‚Ä¢ Alternative Diagnoses to Consider\n‚Ä¢ Comorbidity Assessment\n‚Ä¢ Atypical Presentations in Elderly', { x: 0.7, y: 1.5, fontSize: 13, color: colors.text });
            s11.addText('Geriatric Syndromes to Evaluate:', { x: 0.5, y: 3.0, fontSize: 16, color: colors.warning, bold: true });
            s11.addText('‚Ä¢ Frailty Syndrome\n‚Ä¢ Sarcopenia\n‚Ä¢ Polypharmacy\n‚Ä¢ Falls & Mobility Issues\n‚Ä¢ Delirium/Dementia\n‚Ä¢ Incontinence\n‚Ä¢ Malnutrition', { x: 0.7, y: 3.4, fontSize: 12, color: colors.text });

            // ========== SLIDE 12: Pharmacological Management ==========
            let s12 = pres.addSlide();
            addSlideHeader(s12, 'üíâ Management: Pharmacological', colors.success);
            s12.addText('Medication Optimization Strategy:', { x: 0.5, y: 1.1, fontSize: 16, color: colors.primary, bold: true });
            s12.addText('‚Ä¢ Review indication for each medication\n‚Ä¢ Deprescribing candidates identified\n‚Ä¢ Dose adjustments per renal/hepatic function\n‚Ä¢ Time therapy optimization\n‚Ä¢ Simplify regimen where possible', { x: 0.7, y: 1.5, fontSize: 13, color: colors.text });
            s12.addText('Deprescribing Priorities:', { x: 0.5, y: 3.3, fontSize: 16, color: colors.warning, bold: true });
            s12.addText('‚Ä¢ High anticholinergic burden medications\n‚Ä¢ Sedative-hypnotics (benzodiazepines, Z-drugs)\n‚Ä¢ Proton pump inhibitors (if prolonged use)\n‚Ä¢ Medications without clear indication', { x: 0.7, y: 3.7, fontSize: 12, color: colors.text });

            // ========== SLIDE 13: Non-Pharmacological Management ==========
            let s13 = pres.addSlide();
            addSlideHeader(s13, 'üèÉ Management: Non-Pharmacological', colors.success);
            s13.addText('Multidisciplinary Interventions:', { x: 0.5, y: 1.1, fontSize: 16, color: colors.primary, bold: true });
            s13.addText('‚Ä¢ Physical Therapy - mobility, strength, balance training\n‚Ä¢ Occupational Therapy - ADL/IADL optimization\n‚Ä¢ Speech & Language Therapy - swallowing assessment\n‚Ä¢ Nutrition/Dietitian - MNA screening, protein optimization\n‚Ä¢ Social Work - care coordination, caregiver support\n‚Ä¢ Pharmacy Consult - medication therapy management', { x: 0.7, y: 1.5, fontSize: 12, color: colors.text });
            s13.addText('Lifestyle Modifications:', { x: 0.5, y: 3.5, fontSize: 16, color: colors.accent, bold: true });
            s13.addText('‚Ä¢ Regular physical activity program\n‚Ä¢ Cognitive stimulation activities\n‚Ä¢ Social engagement optimization\n‚Ä¢ Sleep hygiene education', { x: 0.7, y: 3.9, fontSize: 12, color: colors.text });

            // ========== SLIDE 14: Safety & Risk Management ==========
            let s14 = pres.addSlide();
            addSlideHeader(s14, 'üõ°Ô∏è Safety & Risk Management', colors.warning);
            s14.addText('Fall Prevention Protocol:', { x: 0.5, y: 1.1, fontSize: 16, color: colors.highlight, bold: true });
            s14.addText('‚Ä¢ Environmental modifications\n‚Ä¢ FRID review and optimization\n‚Ä¢ Assistive device assessment\n‚Ä¢ Vision/hearing correction\n‚Ä¢ Footwear evaluation', { x: 0.7, y: 1.5, fontSize: 12, color: colors.text });
            s14.addText('Delirium Prevention (HELP Protocol):', { x: 0.5, y: 3.0, fontSize: 16, color: colors.highlight, bold: true });
            s14.addText('‚Ä¢ Orientation protocols\n‚Ä¢ Early mobilization\n‚Ä¢ Sleep enhancement\n‚Ä¢ Minimize psychoactive medications\n‚Ä¢ Adequate hydration/nutrition', { x: 0.7, y: 3.4, fontSize: 12, color: colors.text });

            // ========== SLIDE 15: Discharge Planning ==========
            let s15 = pres.addSlide();
            addSlideHeader(s15, 'üè† Discharge & Transition Planning', colors.info);
            s15.addText('Disposition Considerations:', { x: 0.5, y: 1.1, fontSize: 16, color: colors.primary, bold: true });
            s15.addText('‚Ä¢ Home (with/without home health services)\n‚Ä¢ Skilled Nursing Facility (SNF)\n‚Ä¢ Acute Rehabilitation\n‚Ä¢ Long-term Care', { x: 0.7, y: 1.5, fontSize: 13, color: colors.text });
            s15.addText('Transition of Care Essentials:', { x: 0.5, y: 2.8, fontSize: 16, color: colors.primary, bold: true });
            s15.addText('‚Ä¢ Medication reconciliation at discharge\n‚Ä¢ Clear follow-up appointments\n‚Ä¢ Patient/caregiver education completed\n‚Ä¢ Warning signs reviewed\n‚Ä¢ DME orders placed\n‚Ä¢ Home safety evaluation if needed', { x: 0.7, y: 3.2, fontSize: 12, color: colors.text });

            // ========== SLIDE 16: Follow-up & Monitoring ==========
            let s16 = pres.addSlide();
            addSlideHeader(s16, 'üìÖ Follow-up & Monitoring Plan', colors.accent);
            s16.addText('Short-term Follow-up (1-2 weeks):', { x: 0.5, y: 1.1, fontSize: 16, color: colors.primary, bold: true });
            s16.addText('‚Ä¢ Medication tolerance/efficacy check\n‚Ä¢ Vital signs and symptom monitoring\n‚Ä¢ Lab follow-up as indicated', { x: 0.7, y: 1.5, fontSize: 13, color: colors.text });
            s16.addText('Long-term Monitoring:', { x: 0.5, y: 2.5, fontSize: 16, color: colors.primary, bold: true });
            s16.addText('‚Ä¢ Functional status reassessment\n‚Ä¢ Cognitive screening at intervals\n‚Ä¢ Annual comprehensive medication review\n‚Ä¢ Preventive care and immunizations\n‚Ä¢ Goals of care discussions', { x: 0.7, y: 2.9, fontSize: 13, color: colors.text });
            s16.addText('Quality Metrics:', { x: 0.5, y: 4.1, fontSize: 14, color: colors.accent, bold: true });
            s16.addText('30-day readmission prevention ‚Ä¢ ADL maintenance ‚Ä¢ QoL improvement', { x: 0.7, y: 4.4, fontSize: 11, color: colors.secondary });

            // ========== SLIDE 17: Evidence-Based Guidelines ==========
            let s17 = pres.addSlide();
            addSlideHeader(s17, 'üìö Evidence-Based Clinical Standards', colors.primary);
            s17.addText('Guidelines Applied in This Assessment:', { x: 0.5, y: 1.1, fontSize: 16, color: colors.accent, bold: true });
            s17.addText('‚Ä¢ AGS Beers Criteria¬Æ (2023 Update)', { x: 0.7, y: 1.5, fontSize: 13, color: colors.text });
            s17.addText('   Potentially Inappropriate Medications in Older Adults', { x: 0.9, y: 1.8, fontSize: 11, color: colors.secondary, italic: true });
            s17.addText('‚Ä¢ STOPP/START Criteria v2', { x: 0.7, y: 2.2, fontSize: 13, color: colors.text });
            s17.addText('   Screening Tool for Prescribing in Older Persons', { x: 0.9, y: 2.5, fontSize: 11, color: colors.secondary, italic: true });
            s17.addText('‚Ä¢ Comprehensive Geriatric Assessment (CGA)', { x: 0.7, y: 2.9, fontSize: 13, color: colors.text });
            s17.addText('   Multidimensional interdisciplinary diagnostic process', { x: 0.9, y: 3.2, fontSize: 11, color: colors.secondary, italic: true });
            s17.addText('‚Ä¢ Clinical Frailty Scale (Rockwood CFS)', { x: 0.7, y: 3.6, fontSize: 13, color: colors.text });
            s17.addText('   Validated frailty assessment tool', { x: 0.9, y: 3.9, fontSize: 11, color: colors.secondary, italic: true });
            s17.addText('‚Ä¢ Hospital Elder Life Program (HELP)', { x: 0.7, y: 4.3, fontSize: 13, color: colors.text });
            s17.addText('   Evidence-based delirium prevention', { x: 0.9, y: 4.6, fontSize: 11, color: colors.secondary, italic: true });

            // ========== SLIDE 18: References ==========
            let s18 = pres.addSlide();
            addSlideHeader(s18, 'üìñ References & Citations', colors.secondary);
            s18.addText('Key Clinical References:', { x: 0.5, y: 1.0, fontSize: 14, color: colors.primary, bold: true });
            const references = [
                '1. 2023 AGS Beers Criteria¬Æ Update Expert Panel. J Am Geriatr Soc. 2023;71(7):2052-2081.',
                '2. O\'Mahony D, et al. STOPP/START criteria v2. Age Ageing. 2015;44(2):213-218.',
                '3. Ellis G, et al. Comprehensive geriatric assessment. BMJ. 2011;343:d6553.',
                '4. Rockwood K, et al. Clinical Frailty Scale. CMAJ. 2005;173(5):489-495.',
                '5. Inouye SK, et al. CAM: Confusion Assessment Method. Ann Intern Med. 1990;113(12):941-948.',
                '6. Inouye SK, et al. HELP: Hospital Elder Life Program. J Am Geriatr Soc. 2000;48(12):1697-1706.',
                '7. Fick DM, et al. Anticholinergic Drug Burden. J Clin Pharm Ther. 2008;33(5):493-503.',
                '8. Panel on Prevention of Falls in Older Persons. J Am Geriatr Soc. 2011;59(1):148-157.'
            ];
            references.forEach((ref, idx) => {
                s18.addText(ref, { x: 0.5, y: 1.35 + (idx * 0.42), w: 9, fontSize: 10, color: colors.text });
            });

            // ========== SLIDE 19: Thank You / Questions ==========
            let s19 = pres.addSlide();
            s19.addShape('rect', { x: 0, y: 0, w: '100%', h: '100%', fill: { color: colors.primary } });
            s19.addText('Thank You', { x: 0.5, y: 1.8, w: '90%', fontSize: 44, color: 'ffffff', bold: true, align: 'center' });
            s19.addShape('line', { x: 3, y: 2.7, w: 4, h: 0, line: { color: colors.accent, width: 3 } });
            s19.addText('Questions & Discussion', { x: 0.5, y: 3.0, w: '90%', fontSize: 24, color: 'ecf0f1', align: 'center' });
            s19.addText(`Patient: ${ageSex} (${initials})`, { x: 0.5, y: 4.0, w: '90%', fontSize: 16, color: 'bdc3c7', align: 'center' });
            s19.addText('Generated with SZMC Geriatrics Pro', { x: 0.5, y: 4.8, w: '90%', fontSize: 11, color: '7f8c8d', align: 'center' });

            const trimmedPptInitials = initials ? initials.trim() : '';
            const outputInitials = (trimmedPptInitials && trimmedPptInitials !== 'N/A') ? trimmedPptInitials : 'export';
            pres.writeFile({ fileName: `Case_${outputInitials}.pptx` });
            console.log('Comprehensive PPT export completed successfully (19 slides)');
        } catch(e) {
            console.error('PPT export failed:', e);
            alert("PPT Export Error: " + e.message);
        }
    }

    // Professional Medical Presentation Generator (No AI Required)
    function exportProfessionalPPT() {
        console.log('Starting professional medical presentation export (16 slides)...');
        try {
            // Only require basic patient data - AI response is optional
            if (!getVal('age_sex').trim() && !getVal('initials').trim()) {
                alert('Please add at least patient age/sex or initials before exporting.');
                return;
            }

            if (typeof PptxGenJS === 'undefined') throw new Error('PptxGenJS library not loaded');
            
            const pres = new PptxGenJS();
            pres.layout = 'LAYOUT_WIDE';
            pres.author = 'SZMC Geriatrics Pro';
            pres.company = 'SZMC';
            pres.subject = 'Comprehensive Geriatric Assessment';
            
            // Sanitize all input data
            const ageSex = sanitizeText(getVal('age_sex')) || 'Not specified';
            const initials = sanitizeText(getVal('initials')) || 'N/A';
            const hpi = sanitizeText(getVal('hpi')) || 'History of present illness to be documented';
            const meds = sanitizeText(getVal('meds')) || 'Medication list to be documented';
            const currentDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            // Color scheme
            const colors = {
                primary: '2c3e50',
                secondary: '7f8c8d',
                accent: '27ae60',
                highlight: 'c0392b',
                info: '3498db',
                success: '27ae60',
                warning: 'e74c3c'
            };

            // Helper to add header bar
            const addHeader = (slide, text, color) => {
                slide.addShape(pres.ShapeType.rect, { x: 0, y: 0, w: '100%', h: 0.7, fill: { color: color } });
                slide.addText(text, { x: 0.5, y: 0.15, w: '90%', fontSize: 22, color: 'FFFFFF', bold: true });
            };

            // Helper to add citation
            const cite = (text) => `[${text}]`;

            // === SLIDE 1: Title ===
            let s1 = pres.addSlide();
            s1.background = { color: colors.primary };
            s1.addText('COMPREHENSIVE GERIATRIC ASSESSMENT', { x: 0.5, y: 1.8, w: '90%', fontSize: 36, color: 'FFFFFF', bold: true, align: 'center' });
            s1.addText(`Patient: ${ageSex} | ID: ${initials}`, { x: 0.5, y: 2.8, w: '90%', fontSize: 24, color: 'ECF0F1', align: 'center' });
            s1.addText(`Date: ${currentDate}`, { x: 0.5, y: 3.5, w: '90%', fontSize: 18, color: 'BDC3C7', align: 'center' });
            s1.addText('Evidence-Based Clinical Decision Support', { x: 0.5, y: 4.2, w: '90%', fontSize: 16, color: '95A5A6', align: 'center', italic: true });

            // === SLIDE 2: Case Overview ===
            let s2 = pres.addSlide();
            addHeader(s2, 'üìã CASE OVERVIEW', colors.primary);
            s2.addText('Patient Demographics', { x: 0.5, y: 1.2, fontSize: 20, color: colors.accent, bold: true });
            s2.addText(`‚Ä¢ Age/Sex: ${ageSex}`, { x: 0.8, y: 1.7, fontSize: 16 });
            s2.addText(`‚Ä¢ Patient Identifier: ${initials}`, { x: 0.8, y: 2.1, fontSize: 16 });
            s2.addText('Assessment Framework', { x: 0.5, y: 2.7, fontSize: 20, color: colors.accent, bold: true });
            s2.addText('‚Ä¢ Comprehensive Geriatric Assessment (CGA)', { x: 0.8, y: 3.2, fontSize: 16 });
            s2.addText('‚Ä¢ Multidisciplinary evaluation approach', { x: 0.8, y: 3.6, fontSize: 16 });
            s2.addText('‚Ä¢ Evidence-based guideline adherence', { x: 0.8, y: 4.0, fontSize: 16 });
            s2.addText(`Reference: ${cite('Ellis G, et al. BMJ. 2011')}`, { x: 0.5, y: 4.6, fontSize: 11, color: colors.secondary, italic: true });

            // === SLIDE 3: Chief Complaint & HPI ===
            let s3 = pres.addSlide();
            addHeader(s3, 'üè• CHIEF COMPLAINT & HISTORY', colors.info);
            s3.addText(hpi.substring(0, 900), { x: 0.5, y: 1.2, w: 9, h: 4.0, fontSize: 14, valign: 'top' });
            s3.addText('Clinical Documentation Standards Applied', { x: 0.5, y: 5.3, fontSize: 10, color: colors.secondary, italic: true });

            // === SLIDE 4: Current Medications ===
            let s4 = pres.addSlide();
            addHeader(s4, 'üíä MEDICATION REVIEW', colors.accent);
            s4.addText('Current Medication Regimen', { x: 0.5, y: 1.2, fontSize: 18, bold: true });
            s4.addText(meds.substring(0, 850), { x: 0.5, y: 1.7, w: 9, h: 3.5, fontSize: 12, valign: 'top' });
            s4.addText(`Reference: ${cite('AGS Beers Criteria, 2023')}`, { x: 0.5, y: 5.3, fontSize: 11, color: colors.secondary, italic: true });

            // === SLIDE 5: Medication Safety ===
            let s5 = pres.addSlide();
            addHeader(s5, '‚ö†Ô∏è MEDICATION SAFETY ASSESSMENT', colors.warning);
            s5.addText('Critical Safety Screening', { x: 0.5, y: 1.2, fontSize: 18, color: colors.highlight, bold: true });
            s5.addText('‚úì AGS Beers Criteria - Potentially Inappropriate Medications', { x: 0.8, y: 1.8, fontSize: 14 });
            s5.addText('‚úì STOPP/START Criteria for Prescribing', { x: 0.8, y: 2.2, fontSize: 14 });
            s5.addText('‚úì Drug-Drug Interaction Analysis', { x: 0.8, y: 2.6, fontSize: 14 });
            s5.addText('‚úì Renal/Hepatic Dosing Assessment (CrCl-based)', { x: 0.8, y: 3.0, fontSize: 14 });
            s5.addText('‚úì Anticholinergic Burden Score', { x: 0.8, y: 3.4, fontSize: 14 });
            s5.addText('‚úì Fall-Risk Increasing Drugs (FRIDs)', { x: 0.8, y: 3.8, fontSize: 14 });
            s5.addText('‚úì QTc Prolongation Risk', { x: 0.8, y: 4.2, fontSize: 14 });
            s5.addText(`References: ${cite('AGS 2023')} | ${cite('O\'Mahony D, et al. 2015')}`, { x: 0.5, y: 4.8, fontSize: 11, color: colors.secondary, italic: true });

            // === SLIDE 6: Functional Assessment ===
            let s6 = pres.addSlide();
            addHeader(s6, 'üö∂ FUNCTIONAL STATUS EVALUATION', colors.accent);
            s6.addText('Activities of Daily Living (ADLs)', { x: 0.5, y: 1.2, fontSize: 18, bold: true, color: colors.primary });
            s6.addText('Bathing ‚Ä¢ Dressing ‚Ä¢ Toileting ‚Ä¢ Transferring ‚Ä¢ Continence ‚Ä¢ Feeding', { x: 0.8, y: 1.7, fontSize: 13, color: colors.secondary });
            s6.addText('Instrumental ADLs (IADLs)', { x: 0.5, y: 2.3, fontSize: 18, bold: true, color: colors.primary });
            s6.addText('Shopping ‚Ä¢ Cooking ‚Ä¢ Medications ‚Ä¢ Finances ‚Ä¢ Transportation ‚Ä¢ Phone', { x: 0.8, y: 2.8, fontSize: 13, color: colors.secondary });
            s6.addText('Mobility Assessment', { x: 0.5, y: 3.4, fontSize: 18, bold: true, color: colors.primary });
            s6.addText('‚Ä¢ Timed Up and Go (TUG) Test', { x: 0.8, y: 3.9, fontSize: 14 });
            s6.addText('‚Ä¢ Gait Speed Assessment', { x: 0.8, y: 4.3, fontSize: 14 });
            s6.addText('‚Ä¢ Fall History & Risk Stratification', { x: 0.8, y: 4.7, fontSize: 14 });
            s6.addText(`Reference: ${cite('Ellis G, et al. BMJ. 2011')}`, { x: 0.5, y: 5.2, fontSize: 11, color: colors.secondary, italic: true });

            // === SLIDE 7: Cognitive Assessment ===
            let s7 = pres.addSlide();
            addHeader(s7, 'üß† COGNITIVE & MENTAL STATUS', colors.info);
            s7.addText('Cognitive Screening Tools', { x: 0.5, y: 1.2, fontSize: 18, bold: true });
            s7.addText('‚Ä¢ Mini-Mental State Examination (MMSE)', { x: 0.8, y: 1.7, fontSize: 14 });
            s7.addText('‚Ä¢ Montreal Cognitive Assessment (MoCA)', { x: 0.8, y: 2.1, fontSize: 14 });
            s7.addText('‚Ä¢ Clock Drawing Test', { x: 0.8, y: 2.5, fontSize: 14 });
            s7.addText('Delirium Screening', { x: 0.5, y: 3.0, fontSize: 18, bold: true });
            s7.addText('‚Ä¢ Confusion Assessment Method (CAM)', { x: 0.8, y: 3.5, fontSize: 14 });
            s7.addText('‚Ä¢ 4AT Rapid Delirium Assessment', { x: 0.8, y: 3.9, fontSize: 14 });
            s7.addText('Depression Screening', { x: 0.5, y: 4.4, fontSize: 18, bold: true });
            s7.addText('‚Ä¢ Geriatric Depression Scale (GDS-15)', { x: 0.8, y: 4.9, fontSize: 14 });
            s7.addText(`References: ${cite('Inouye SK, 1990')} | ${cite('Ellis G, 2011')}`, { x: 0.5, y: 5.4, fontSize: 11, color: colors.secondary, italic: true });

            // === SLIDE 8: Frailty Assessment ===
            let s8 = pres.addSlide();
            addHeader(s8, 'üìä FRAILTY EVALUATION', colors.primary);
            s8.addText('Clinical Frailty Scale (Rockwood)', { x: 0.5, y: 1.2, fontSize: 18, bold: true });
            s8.addText('1. Very Fit - Robust, active, energetic', { x: 0.8, y: 1.8, fontSize: 13 });
            s8.addText('2. Well - No active disease symptoms', { x: 0.8, y: 2.2, fontSize: 13 });
            s8.addText('3. Managing Well - Medical problems controlled', { x: 0.8, y: 2.6, fontSize: 13 });
            s8.addText('4. Vulnerable - Symptoms limit activities', { x: 0.8, y: 3.0, fontSize: 13 });
            s8.addText('5. Mildly Frail - Limited dependence on others', { x: 0.8, y: 3.4, fontSize: 13 });
            s8.addText('6. Moderately Frail - Help with ADLs and IADLs', { x: 0.8, y: 3.8, fontSize: 13 });
            s8.addText('7. Severely Frail - Completely dependent', { x: 0.8, y: 4.2, fontSize: 13 });
            s8.addText(`Reference: ${cite('Rockwood K, et al. CMAJ. 2005')}`, { x: 0.5, y: 4.8, fontSize: 11, color: colors.secondary, italic: true });

            // === SLIDE 9: Geriatric Syndromes ===
            let s9 = pres.addSlide();
            addHeader(s9, 'üîç GERIATRIC SYNDROMES SCREENING', colors.info);
            s9.addText('Key Geriatric Syndromes to Evaluate', { x: 0.5, y: 1.2, fontSize: 18, bold: true });
            s9.addText('‚Ä¢ Frailty - Physical decline and vulnerability', { x: 0.8, y: 1.8, fontSize: 14 });
            s9.addText('‚Ä¢ Falls - History, risk factors, prevention', { x: 0.8, y: 2.2, fontSize: 14 });
            s9.addText('‚Ä¢ Delirium - Acute confusion, CAM screening', { x: 0.8, y: 2.6, fontSize: 14 });
            s9.addText('‚Ä¢ Dementia - Cognitive impairment progression', { x: 0.8, y: 3.0, fontSize: 14 });
            s9.addText('‚Ä¢ Incontinence - Urinary and fecal', { x: 0.8, y: 3.4, fontSize: 14 });
            s9.addText('‚Ä¢ Malnutrition - MNA screening, protein status', { x: 0.8, y: 3.8, fontSize: 14 });
            s9.addText('‚Ä¢ Polypharmacy - ‚â•5 medications, interactions', { x: 0.8, y: 4.2, fontSize: 14 });
            s9.addText('‚Ä¢ Sarcopenia - Muscle mass and strength loss', { x: 0.8, y: 4.6, fontSize: 14 });
            s9.addText(`Reference: ${cite('Ellis G, et al. BMJ. 2011')}`, { x: 0.5, y: 5.1, fontSize: 11, color: colors.secondary, italic: true });

            // === SLIDE 10: Pharmacological Management ===
            let s10 = pres.addSlide();
            addHeader(s10, 'üíâ MEDICATION OPTIMIZATION', colors.success);
            s10.addText('Medication Review Strategy', { x: 0.5, y: 1.2, fontSize: 18, bold: true });
            s10.addText('‚úì Review indication for each medication', { x: 0.8, y: 1.8, fontSize: 14 });
            s10.addText('‚úì Assess risk-benefit ratio in elderly', { x: 0.8, y: 2.2, fontSize: 14 });
            s10.addText('‚úì Consider deprescribing opportunities', { x: 0.8, y: 2.6, fontSize: 14 });
            s10.addText('‚úì Adjust doses for organ function', { x: 0.8, y: 3.0, fontSize: 14 });
            s10.addText('‚úì Simplify regimen where possible', { x: 0.8, y: 3.4, fontSize: 14 });
            s10.addText('Deprescribing Priorities', { x: 0.5, y: 3.9, fontSize: 16, bold: true, color: colors.warning });
            s10.addText('‚Ä¢ High anticholinergic burden agents', { x: 0.8, y: 4.4, fontSize: 13 });
            s10.addText('‚Ä¢ Benzodiazepines and Z-drugs', { x: 0.8, y: 4.8, fontSize: 13 });
            s10.addText(`References: ${cite('AGS 2023')} | ${cite('STOPP/START 2015')}`, { x: 0.5, y: 5.3, fontSize: 11, color: colors.secondary, italic: true });

            // === SLIDE 11: Non-Pharmacological ===
            let s11 = pres.addSlide();
            addHeader(s11, 'üèÉ NON-PHARMACOLOGICAL CARE', colors.success);
            s11.addText('Multidisciplinary Team Approach', { x: 0.5, y: 1.2, fontSize: 18, bold: true });
            s11.addText('‚Ä¢ Physical Therapy', { x: 0.8, y: 1.8, fontSize: 14, bold: true });
            s11.addText('  Mobility, strength training, balance exercises', { x: 1.0, y: 2.1, fontSize: 12, color: colors.secondary });
            s11.addText('‚Ä¢ Occupational Therapy', { x: 0.8, y: 2.5, fontSize: 14, bold: true });
            s11.addText('  ADL/IADL optimization, adaptive equipment', { x: 1.0, y: 2.8, fontSize: 12, color: colors.secondary });
            s11.addText('‚Ä¢ Speech & Language Therapy', { x: 0.8, y: 3.2, fontSize: 14, bold: true });
            s11.addText('  Swallowing assessment, communication', { x: 1.0, y: 3.5, fontSize: 12, color: colors.secondary });
            s11.addText('‚Ä¢ Nutrition/Dietitian', { x: 0.8, y: 3.9, fontSize: 14, bold: true });
            s11.addText('  MNA screening, protein optimization', { x: 1.0, y: 4.2, fontSize: 12, color: colors.secondary });
            s11.addText('‚Ä¢ Social Work', { x: 0.8, y: 4.6, fontSize: 14, bold: true });
            s11.addText('  Care coordination, caregiver support', { x: 1.0, y: 4.9, fontSize: 12, color: colors.secondary });
            s11.addText(`Reference: ${cite('Ellis G, et al. BMJ. 2011')}`, { x: 0.5, y: 5.4, fontSize: 11, color: colors.secondary, italic: true });

            // === SLIDE 12: Fall Prevention ===
            let s12 = pres.addSlide();
            addHeader(s12, 'üõ°Ô∏è FALL PREVENTION PROTOCOL', colors.warning);
            s12.addText('Multifactorial Fall Risk Assessment', { x: 0.5, y: 1.2, fontSize: 18, bold: true });
            s12.addText('Intrinsic Risk Factors', { x: 0.5, y: 1.8, fontSize: 16, bold: true, color: colors.highlight });
            s12.addText('‚Ä¢ Advanced age, prior falls, gait/balance impairment', { x: 0.8, y: 2.2, fontSize: 13 });
            s12.addText('‚Ä¢ Muscle weakness, vision impairment, cognitive deficit', { x: 0.8, y: 2.6, fontSize: 13 });
            s12.addText('Extrinsic Risk Factors', { x: 0.5, y: 3.1, fontSize: 16, bold: true, color: colors.highlight });
            s12.addText('‚Ä¢ Environmental hazards, inappropriate footwear', { x: 0.8, y: 3.5, fontSize: 13 });
            s12.addText('‚Ä¢ Polypharmacy, fall-risk increasing drugs', { x: 0.8, y: 3.9, fontSize: 13 });
            s12.addText('Prevention Strategies', { x: 0.5, y: 4.4, fontSize: 16, bold: true, color: colors.success });
            s12.addText('‚úì Exercise programs ‚Ä¢ Medication review ‚Ä¢ Vision correction', { x: 0.8, y: 4.9, fontSize: 13 });
            s12.addText(`Reference: ${cite('AGS/BGS Fall Prevention Guidelines, 2011')}`, { x: 0.5, y: 5.4, fontSize: 11, color: colors.secondary, italic: true });

            // === SLIDE 13: Delirium Prevention ===
            let s13 = pres.addSlide();
            addHeader(s13, '‚öïÔ∏è DELIRIUM PREVENTION (HELP)', colors.warning);
            s13.addText('Hospital Elder Life Program (HELP)', { x: 0.5, y: 1.2, fontSize: 18, bold: true });
            s13.addText('Core Intervention Protocols', { x: 0.5, y: 1.8, fontSize: 16, bold: true });
            s13.addText('‚Ä¢ Orientation Protocol', { x: 0.8, y: 2.3, fontSize: 14, bold: true });
            s13.addText('  Orientation board, calendar, family photos', { x: 1.0, y: 2.6, fontSize: 12, color: colors.secondary });
            s13.addText('‚Ä¢ Early Mobilization', { x: 0.8, y: 3.0, fontSize: 14, bold: true });
            s13.addText('  Ambulation 3x daily, minimize restraints', { x: 1.0, y: 3.3, fontSize: 12, color: colors.secondary });
            s13.addText('‚Ä¢ Sleep Enhancement', { x: 0.8, y: 3.7, fontSize: 14, bold: true });
            s13.addText('  Reduce nighttime noise/lights, sleep protocol', { x: 1.0, y: 4.0, fontSize: 12, color: colors.secondary });
            s13.addText('‚Ä¢ Medication Review', { x: 0.8, y: 4.4, fontSize: 14, bold: true });
            s13.addText('  Avoid deliriogenic medications', { x: 1.0, y: 4.7, fontSize: 12, color: colors.secondary });
            s13.addText(`References: ${cite('Inouye SK, 1990')} | ${cite('HELP, 2000')}`, { x: 0.5, y: 5.2, fontSize: 11, color: colors.secondary, italic: true });

            // === SLIDE 14: Discharge Planning ===
            let s14 = pres.addSlide();
            addHeader(s14, 'üè† TRANSITION OF CARE', colors.info);
            s14.addText('Comprehensive Discharge Strategy', { x: 0.5, y: 1.2, fontSize: 18, bold: true });
            s14.addText('Disposition Planning', { x: 0.5, y: 1.8, fontSize: 16, bold: true });
            s14.addText('‚ñ° Home with/without home health', { x: 0.8, y: 2.2, fontSize: 14 });
            s14.addText('‚ñ° Skilled Nursing Facility (SNF)', { x: 0.8, y: 2.6, fontSize: 14 });
            s14.addText('‚ñ° Acute Rehabilitation', { x: 0.8, y: 3.0, fontSize: 14 });
            s14.addText('Essential Components', { x: 0.5, y: 3.5, fontSize: 16, bold: true });
            s14.addText('‚úì Medication reconciliation completed', { x: 0.8, y: 3.9, fontSize: 13 });
            s14.addText('‚úì Follow-up appointments scheduled', { x: 0.8, y: 4.2, fontSize: 13 });
            s14.addText('‚úì Patient/caregiver education provided', { x: 0.8, y: 4.5, fontSize: 13 });
            s14.addText('‚úì DME orders and prescriptions', { x: 0.8, y: 4.8, fontSize: 13 });
            s14.addText('‚úì Home safety evaluation if needed', { x: 0.8, y: 5.1, fontSize: 13 });

            // === SLIDE 15: Guidelines Applied ===
            let s15 = pres.addSlide();
            addHeader(s15, 'üìö CLINICAL PRACTICE GUIDELINES', colors.primary);
            s15.addText('Evidence-Based Standards', { x: 0.5, y: 1.2, fontSize: 18, bold: true });
            s15.addText('‚Ä¢ AGS Beers Criteria¬Æ (2023)', { x: 0.7, y: 1.8, fontSize: 15, bold: true });
            s15.addText('  Potentially Inappropriate Medications in Older Adults', { x: 0.9, y: 2.1, fontSize: 12, color: colors.secondary, italic: true });
            s15.addText('‚Ä¢ STOPP/START Criteria v2', { x: 0.7, y: 2.5, fontSize: 15, bold: true });
            s15.addText('  Screening Tool for Prescribing Appropriateness', { x: 0.9, y: 2.8, fontSize: 12, color: colors.secondary, italic: true });
            s15.addText('‚Ä¢ Comprehensive Geriatric Assessment', { x: 0.7, y: 3.2, fontSize: 15, bold: true });
            s15.addText('  Multidimensional interdisciplinary evaluation', { x: 0.9, y: 3.5, fontSize: 12, color: colors.secondary, italic: true });
            s15.addText('‚Ä¢ Clinical Frailty Scale (Rockwood)', { x: 0.7, y: 3.9, fontSize: 15, bold: true });
            s15.addText('  Validated assessment of fitness and frailty', { x: 0.9, y: 4.2, fontSize: 12, color: colors.secondary, italic: true });
            s15.addText('‚Ä¢ CAM & HELP Protocol', { x: 0.7, y: 4.6, fontSize: 15, bold: true });
            s15.addText('  Delirium assessment and prevention', { x: 0.9, y: 4.9, fontSize: 12, color: colors.secondary, italic: true });

            // === SLIDE 16: References ===
            let s16 = pres.addSlide();
            addHeader(s16, 'üìñ REFERENCES & CITATIONS', colors.secondary);
            s16.addText('Clinical References', { x: 0.5, y: 1.0, fontSize: 16, bold: true });
            s16.addText('1. 2023 AGS Beers Criteria¬Æ Update Expert Panel. J Am Geriatr Soc. 2023;71(7):2052-2081.', { x: 0.5, y: 1.5, w: 9, fontSize: 11 });
            s16.addText('2. O\'Mahony D, et al. STOPP/START criteria v2. Age Ageing. 2015;44(2):213-218.', { x: 0.5, y: 2.0, w: 9, fontSize: 11 });
            s16.addText('3. Ellis G, et al. Comprehensive geriatric assessment. BMJ. 2011;343:d6553.', { x: 0.5, y: 2.5, w: 9, fontSize: 11 });
            s16.addText('4. Rockwood K, et al. Clinical Frailty Scale. CMAJ. 2005;173(5):489-495.', { x: 0.5, y: 3.0, w: 9, fontSize: 11 });
            s16.addText('5. Inouye SK, et al. Confusion Assessment Method. Ann Intern Med. 1990;113(12):941-948.', { x: 0.5, y: 3.5, w: 9, fontSize: 11 });
            s16.addText('6. Inouye SK, et al. Hospital Elder Life Program. J Am Geriatr Soc. 2000;48(12):1697-1706.', { x: 0.5, y: 4.0, w: 9, fontSize: 11 });
            s16.addText('7. Panel on Prevention of Falls in Older Persons. AGS/BGS Guidelines. J Am Geriatr Soc. 2011;59(1):148-157.', { x: 0.5, y: 4.5, w: 9, fontSize: 11 });
            s16.addText(`Generated: ${currentDate} | SZMC Geriatrics Pro v15.5`, { x: 0.5, y: 5.2, w: 9, fontSize: 10, align: 'center', color: '95A5A6', italic: true });

            // Save the presentation
            const cleanInitials = initials.replace(/[^a-zA-Z0-9]/g, '') || 'Patient';
            await pres.writeFile({ fileName: `Professional_CGA_${cleanInitials}.pptx` });
            console.log('Professional medical presentation export completed successfully (16 slides)');
        } catch(e) {
            console.error('Professional PPT export failed:', e);
            alert("Professional PPT Export Error: " + e.message);
        }
    }

    async function exportDOC() {
        console.log('Starting comprehensive DOCX export...');
        try {
            // Validate minimum required data
            if (!getVal('age_sex').trim() && !getVal('hpi').trim()) {
                alert('Please add some patient data before exporting.');
                return;
            }

            // Check if docx library is loaded
            if (typeof docx === 'undefined') {
                console.warn('DOCX library not loaded, falling back to HTML-based DOC export');
                exportDOCLegacy();
                return;
            }

            const { Document, Paragraph, TextRun, HeadingLevel, AlignmentType, Packer, BorderStyle, PageBreak, Tab, TabStopType, TabStopPosition } = docx;

            // Enhanced text sanitization - remove control chars, HTML/XML tags, AND problematic Unicode
            const deepSanitize = (text) => {
                if (!text || typeof text !== 'string') return '';
                // Remove HTML/XML tags iteratively
                let sanitized = text;
                let previous;
                do {
                    previous = sanitized;
                    sanitized = sanitized.replace(/<[^>]*>/g, '');
                } while (sanitized !== previous);
                
                return sanitized
                    .replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '') // Control characters
                    .replace(/[\uFFFE\uFFFF]/g, '') // Invalid Unicode
                    .replace(/\r\n/g, '\n') // Normalize line endings
                    .replace(/\r/g, '\n');
            };

            // Get sanitized data
            const ageSex = deepSanitize(getVal('age_sex')) || 'Not specified';
            const initials = deepSanitize(getVal('initials')) || 'N/A';
            const hpi = deepSanitize(getVal('hpi')) || 'Not documented';
            const meds = deepSanitize(getVal('meds')) || 'Not documented';
            const aiText = deepSanitize(getVal('ai-response')) || 'Pending clinical analysis';
            const currentDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            // Helper to create bullet paragraphs
            const createBullet = (text, level = 0, spacing = {}) => new Paragraph({
                text: deepSanitize(text),
                bullet: { level },
                spacing: { after: 120, ...spacing }
            });

            // Helper to create section header
            const createSectionHeader = (text) => new Paragraph({
                text: text,
                heading: HeadingLevel.HEADING_2,
                spacing: { before: 300, after: 200 },
                border: {
                    bottom: { color: '27ae60', space: 1, size: 6, style: BorderStyle.SINGLE }
                }
            });

            // Helper to create subsection header
            const createSubHeader = (text) => new Paragraph({
                text: text,
                heading: HeadingLevel.HEADING_3,
                spacing: { before: 200, after: 100 }
            });

            // Helper to split long text into paragraphs
            const createTextParagraphs = (text, spacing = { after: 200 }) => {
                if (!text) return [new Paragraph({ text: 'Not documented', spacing })];
                const lines = text.split('\n').filter(line => line.trim());
                if (lines.length === 0) return [new Paragraph({ text: 'Not documented', spacing })];
                return lines.map((line, idx) => new Paragraph({
                    text: line,
                    spacing: idx === lines.length - 1 ? spacing : { after: 120 }
                }));
            };

            // Build document sections
            const children = [
                // ========== TITLE PAGE ==========
                new Paragraph({
                    children: [
                        new TextRun({ text: 'GERIATRIC CASE REPORT', bold: true, size: 56, color: '2c3e50' })
                    ],
                    alignment: AlignmentType.CENTER,
                    spacing: { after: 400 }
                }),
                new Paragraph({
                    children: [
                        new TextRun({ text: 'Comprehensive Geriatric Assessment', size: 28, color: '7f8c8d', italics: true })
                    ],
                    alignment: AlignmentType.CENTER,
                    spacing: { after: 600 }
                }),
                new Paragraph({
                    children: [
                        new TextRun({ text: 'Patient: ', bold: true, size: 24 }),
                        new TextRun({ text: `${ageSex} (${initials})`, size: 24 })
                    ],
                    alignment: AlignmentType.CENTER,
                    spacing: { after: 200 }
                }),
                new Paragraph({
                    children: [
                        new TextRun({ text: `Date: ${currentDate}`, size: 20, color: '7f8c8d' })
                    ],
                    alignment: AlignmentType.CENTER,
                    spacing: { after: 400 }
                }),
                new Paragraph({
                    children: [
                        new TextRun({ text: 'Generated by SZMC Geriatrics Pro', size: 18, color: '95a5a6', italics: true })
                    ],
                    alignment: AlignmentType.CENTER,
                    spacing: { after: 800 }
                }),

                // ========== PATIENT DEMOGRAPHICS ==========
                createSectionHeader('1. Patient Demographics'),
                new Paragraph({
                    children: [
                        new TextRun({ text: 'Age/Sex: ', bold: true }),
                        new TextRun(ageSex)
                    ],
                    spacing: { after: 120 }
                }),
                new Paragraph({
                    children: [
                        new TextRun({ text: 'Patient Identifier: ', bold: true }),
                        new TextRun(initials)
                    ],
                    spacing: { after: 120 }
                }),
                new Paragraph({
                    children: [
                        new TextRun({ text: 'Assessment Type: ', bold: true }),
                        new TextRun('Comprehensive Geriatric Assessment (CGA)')
                    ],
                    spacing: { after: 300 }
                }),

                // ========== CHIEF COMPLAINT & HPI ==========
                createSectionHeader('2. Chief Complaint & History of Present Illness'),
                ...createTextParagraphs(hpi, { after: 300 }),

                // ========== MEDICATIONS & LABS ==========
                createSectionHeader('3. Current Medications & Laboratory Results'),
                ...createTextParagraphs(meds, { after: 300 }),

                // ========== MEDICATION SAFETY REVIEW ==========
                createSectionHeader('4. Medication Safety Review'),
                new Paragraph({
                    children: [
                        new TextRun({ text: 'Safety Screening Checklist:', bold: true, color: 'c0392b' })
                    ],
                    spacing: { after: 150 }
                }),
                createBullet('AGS Beers Criteria Assessment - Potentially Inappropriate Medications (PIMs)'),
                createBullet('STOPP/START Criteria Review'),
                createBullet('Drug-Drug Interactions (DDIs) Analysis'),
                createBullet('Drug-Disease Interactions'),
                createBullet('Renal Dosing Adjustments (CrCl-based calculations)'),
                createBullet('Hepatic Impairment Considerations'),
                createBullet('Anticholinergic Burden Score (ABS)'),
                createBullet('QTc Prolongation Risk Assessment'),
                createBullet('Fall-Risk Increasing Drugs (FRIDs) Review', 0, { after: 300 }),

                // ========== FUNCTIONAL ASSESSMENT ==========
                createSectionHeader('5. Functional & Cognitive Assessment'),
                createSubHeader('Activities of Daily Living (ADLs)'),
                new Paragraph({
                    text: 'Bathing, Dressing, Toileting, Transferring, Continence, Feeding',
                    spacing: { after: 150 }
                }),
                createSubHeader('Instrumental ADLs (IADLs)'),
                new Paragraph({
                    text: 'Shopping, Cooking, Managing Medications, Finances, Transportation, Phone Use',
                    spacing: { after: 150 }
                }),
                createSubHeader('Mobility Assessment'),
                createBullet('Timed Up and Go (TUG) Test'),
                createBullet('Gait Speed Assessment'),
                createBullet('Fall History & Risk Stratification'),
                createSubHeader('Cognitive Screening'),
                createBullet('Mini-Mental State Examination (MMSE)'),
                createBullet('Montreal Cognitive Assessment (MoCA)'),
                createBullet('Clock Drawing Test'),
                createSubHeader('Delirium Assessment'),
                createBullet('Confusion Assessment Method (CAM)'),
                createBullet('4AT Rapid Delirium Screening', 0, { after: 150 }),
                createSubHeader('Mood Screening'),
                createBullet('Geriatric Depression Scale (GDS-15)', 0, { after: 300 }),

                // ========== CLINICAL ASSESSMENT ==========
                createSectionHeader('6. Clinical Assessment & Analysis'),
                ...createTextParagraphs(aiText, { after: 300 }),

                // ========== DIFFERENTIAL DIAGNOSIS ==========
                createSectionHeader('7. Differential Diagnosis'),
                createSubHeader('Diagnostic Considerations'),
                createBullet('Primary Working Diagnosis'),
                createBullet('Alternative Diagnoses'),
                createBullet('Comorbidity Assessment'),
                createBullet('Atypical Presentations in Elderly'),
                createSubHeader('Geriatric Syndromes Evaluation'),
                createBullet('Frailty Syndrome'),
                createBullet('Sarcopenia'),
                createBullet('Polypharmacy'),
                createBullet('Falls & Mobility Impairment'),
                createBullet('Delirium / Dementia'),
                createBullet('Urinary Incontinence'),
                createBullet('Malnutrition', 0, { after: 300 }),

                // ========== MANAGEMENT PLAN ==========
                createSectionHeader('8. Comprehensive Management Plan'),
                createSubHeader('Pharmacological Interventions'),
                createBullet('Medication indication review for each agent'),
                createBullet('Deprescribing candidates identified'),
                createBullet('Dose adjustments per renal/hepatic function'),
                createBullet('Therapy timing optimization'),
                createBullet('Regimen simplification where possible'),
                createSubHeader('Deprescribing Priorities'),
                createBullet('High anticholinergic burden medications'),
                createBullet('Sedative-hypnotics (benzodiazepines, Z-drugs)'),
                createBullet('Proton pump inhibitors (if prolonged use without indication)'),
                createBullet('Medications without clear current indication'),
                createSubHeader('Non-Pharmacological Interventions'),
                createBullet('Physical Therapy - mobility, strength, balance training'),
                createBullet('Occupational Therapy - ADL/IADL optimization'),
                createBullet('Speech & Language Therapy - swallowing assessment'),
                createBullet('Nutrition/Dietitian - MNA screening, protein optimization'),
                createBullet('Social Work - care coordination, caregiver support'),
                createBullet('Pharmacy Consult - medication therapy management', 0, { after: 300 }),

                // ========== SAFETY & RISK MANAGEMENT ==========
                createSectionHeader('9. Safety & Risk Management'),
                createSubHeader('Fall Prevention Protocol'),
                createBullet('Environmental modifications'),
                createBullet('FRID review and optimization'),
                createBullet('Assistive device assessment'),
                createBullet('Vision/hearing correction'),
                createBullet('Footwear evaluation'),
                createSubHeader('Delirium Prevention (HELP Protocol)'),
                createBullet('Orientation protocols'),
                createBullet('Early mobilization'),
                createBullet('Sleep enhancement'),
                createBullet('Minimize psychoactive medications'),
                createBullet('Adequate hydration/nutrition', 0, { after: 300 }),

                // ========== DISCHARGE PLANNING ==========
                createSectionHeader('10. Discharge & Transition Planning'),
                createSubHeader('Disposition Options'),
                createBullet('Home (with/without home health services)'),
                createBullet('Skilled Nursing Facility (SNF)'),
                createBullet('Acute Rehabilitation'),
                createBullet('Long-term Care'),
                createSubHeader('Transition of Care Essentials'),
                createBullet('Medication reconciliation at discharge'),
                createBullet('Clear follow-up appointments scheduled'),
                createBullet('Patient/caregiver education completed'),
                createBullet('Warning signs reviewed'),
                createBullet('DME orders placed'),
                createBullet('Home safety evaluation if indicated', 0, { after: 300 }),

                // ========== FOLLOW-UP ==========
                createSectionHeader('11. Follow-up & Monitoring Plan'),
                createSubHeader('Short-term Follow-up (1-2 weeks)'),
                createBullet('Medication tolerance/efficacy assessment'),
                createBullet('Vital signs and symptom monitoring'),
                createBullet('Laboratory follow-up as indicated'),
                createSubHeader('Long-term Monitoring'),
                createBullet('Functional status reassessment'),
                createBullet('Cognitive screening at intervals'),
                createBullet('Annual comprehensive medication review'),
                createBullet('Preventive care and immunizations'),
                createBullet('Goals of care discussions', 0, { after: 300 }),

                // ========== REFERENCES ==========
                createSectionHeader('12. Clinical Guidelines & References'),
                new Paragraph({
                    children: [
                        new TextRun({ text: '1. ', bold: true }),
                        new TextRun('2023 AGS Beers Criteria Update Expert Panel. '),
                        new TextRun({ text: 'American Geriatrics Society 2023 updated AGS Beers Criteria for potentially inappropriate medication use in older adults. ', italics: true }),
                        new TextRun('J Am Geriatr Soc. 2023;71(7):2052-2081.')
                    ],
                    spacing: { after: 120 }
                }),
                new Paragraph({
                    children: [
                        new TextRun({ text: '2. ', bold: true }),
                        new TextRun('O\'Mahony D, O\'Sullivan D, Byrne S, et al. '),
                        new TextRun({ text: 'STOPP/START criteria for potentially inappropriate prescribing in older people: version 2. ', italics: true }),
                        new TextRun('Age Ageing. 2015;44(2):213-218.')
                    ],
                    spacing: { after: 120 }
                }),
                new Paragraph({
                    children: [
                        new TextRun({ text: '3. ', bold: true }),
                        new TextRun('Ellis G, Whitehead MA, Robinson D, et al. '),
                        new TextRun({ text: 'Comprehensive geriatric assessment for older adults admitted to hospital: meta-analysis of randomised controlled trials. ', italics: true }),
                        new TextRun('BMJ. 2011;343:d6553.')
                    ],
                    spacing: { after: 120 }
                }),
                new Paragraph({
                    children: [
                        new TextRun({ text: '4. ', bold: true }),
                        new TextRun('Rockwood K, Song X, MacKnight C, et al. '),
                        new TextRun({ text: 'A global clinical measure of fitness and frailty in elderly people. ', italics: true }),
                        new TextRun('CMAJ. 2005;173(5):489-495.')
                    ],
                    spacing: { after: 120 }
                }),
                new Paragraph({
                    children: [
                        new TextRun({ text: '5. ', bold: true }),
                        new TextRun('Inouye SK, van Dyck CH, Alessi CA, et al. '),
                        new TextRun({ text: 'Clarifying confusion: the confusion assessment method. A new method for detection of delirium. ', italics: true }),
                        new TextRun('Ann Intern Med. 1990;113(12):941-948.')
                    ],
                    spacing: { after: 120 }
                }),
                new Paragraph({
                    children: [
                        new TextRun({ text: '6. ', bold: true }),
                        new TextRun('Inouye SK, Bogardus ST Jr, Baker DI, et al. '),
                        new TextRun({ text: 'The Hospital Elder Life Program: a model of care to prevent cognitive and functional decline in older hospitalized patients. ', italics: true }),
                        new TextRun('J Am Geriatr Soc. 2000;48(12):1697-1706.')
                    ],
                    spacing: { after: 120 }
                }),
                new Paragraph({
                    children: [
                        new TextRun({ text: '7. ', bold: true }),
                        new TextRun('Panel on Prevention of Falls in Older Persons, American Geriatrics Society and British Geriatrics Society. '),
                        new TextRun({ text: 'Summary of the Updated American Geriatrics Society/British Geriatrics Society clinical practice guideline for prevention of falls in older persons. ', italics: true }),
                        new TextRun('J Am Geriatr Soc. 2011;59(1):148-157.')
                    ],
                    spacing: { after: 120 }
                }),
                new Paragraph({
                    children: [
                        new TextRun({ text: '8. ', bold: true }),
                        new TextRun('Fick DM, Semla TP, Steinman M, et al. '),
                        new TextRun({ text: 'American Geriatrics Society 2019 Updated AGS Beers Criteria for Potentially Inappropriate Medication Use in Older Adults. ', italics: true }),
                        new TextRun('J Am Geriatr Soc. 2019;67(4):674-694.')
                    ],
                    spacing: { after: 400 }
                }),

                // ========== FOOTER ==========
                new Paragraph({
                    children: [
                        new TextRun({ text: '---', color: 'cccccc' })
                    ],
                    alignment: AlignmentType.CENTER,
                    spacing: { before: 400, after: 200 }
                }),
                new Paragraph({
                    children: [
                        new TextRun({ text: 'Document generated by SZMC Geriatrics Pro | ', size: 18, color: '95a5a6' }),
                        new TextRun({ text: currentDate, size: 18, color: '95a5a6' })
                    ],
                    alignment: AlignmentType.CENTER
                })
            ];

            // Create document with proper settings
            const doc = new Document({
                creator: 'SZMC Geriatrics Pro',
                title: `Geriatric Case Report - ${initials}`,
                description: 'Comprehensive Geriatric Assessment Report',
                sections: [{
                    properties: {
                        page: {
                            margin: {
                                top: 1440, // 1 inch
                                right: 1440,
                                bottom: 1440,
                                left: 1440
                            }
                        }
                    },
                    children: children
                }]
            });

            // Generate and download with proper MIME type
            const blob = await Packer.toBlob(doc);

            // Create proper download link
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            const trimmedDocInitials = initials ? initials.trim() : '';
            const docInitials = (trimmedDocInitials && trimmedDocInitials !== 'N/A') ? trimmedDocInitials : 'export';
            link.download = `Case_${docInitials}.docx`;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();

            // Cleanup
            setTimeout(() => {
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }, 100);

            console.log('Comprehensive DOCX export completed successfully');
        } catch(e) {
            console.error('DOCX export failed:', e);
            console.error('Error details:', e.stack);
            alert("DOCX Export Error: " + e.message + "\n\nFalling back to RTF export...");
            exportDOCLegacy();
        }
    }

    // Legacy DOC export (RTF-based, more compatible fallback)
    function exportDOCLegacy() {
        console.log('Starting RTF-based DOC export...');
        try {
            // Validate minimum required data
            if (!getVal('age_sex').trim() && !getVal('hpi').trim()) {
                alert('Please add some patient data before exporting.');
                return;
            }

            // Enhanced sanitization for RTF - remove HTML/XML tags
            const rtfSanitize = (text) => {
                if (!text || typeof text !== 'string') return '';
                // Remove HTML/XML tags iteratively
                let sanitized = text;
                let previous;
                do {
                    previous = sanitized;
                    sanitized = sanitized.replace(/<[^>]*>/g, '');
                } while (sanitized !== previous);
                
                return sanitized
                    .replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '') // Control chars
                    .replace(/\\/g, '\\\\') // Escape backslashes
                    .replace(/\{/g, '\\{') // Escape braces
                    .replace(/\}/g, '\\}')
                    .replace(/\n/g, '\\par\n') // Line breaks to RTF paragraphs
                    .replace(/[^\x00-\x7F]/g, (char) => { // Unicode to RTF
                        const code = char.charCodeAt(0);
                        return `\\u${code}?`;
                    });
            };

            // Get sanitized data
            const ageSex = rtfSanitize(getVal('age_sex')) || 'Not specified';
            const initials = rtfSanitize(getVal('initials')) || 'N/A';
            const hpi = rtfSanitize(getVal('hpi')) || 'Not documented';
            const meds = rtfSanitize(getVal('meds')) || 'Not documented';
            const aiText = rtfSanitize(getVal('ai-response')) || 'Pending clinical analysis';
            const currentDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            // RTF document with proper header
            const rtf = `{\\rtf1\\ansi\\ansicpg1252\\deff0\\deflang1033
{\\fonttbl{\\f0\\fswiss\\fcharset0 Arial;}{\\f1\\fmodern\\fcharset0 Courier New;}}
{\\colortbl;\\red44\\green62\\blue80;\\red39\\green174\\blue96;\\red192\\green57\\blue43;\\red127\\green140\\blue141;}
\\viewkind4\\uc1\\pard\\qc\\b\\f0\\fs44\\cf1 GERIATRIC CASE REPORT\\par
\\fs24\\b0\\cf4\\i Comprehensive Geriatric Assessment\\i0\\par
\\par
\\b Patient: \\b0 ${ageSex} (${initials})\\par
\\b Date: \\b0 ${currentDate}\\par
\\par
\\pard\\ql
\\par
\\b\\fs28\\cf2 1. Patient Demographics\\b0\\fs22\\cf0\\par
\\b Age/Sex: \\b0 ${ageSex}\\par
\\b Patient ID: \\b0 ${initials}\\par
\\b Assessment: \\b0 Comprehensive Geriatric Assessment (CGA)\\par
\\par
\\b\\fs28\\cf2 2. Chief Complaint & History of Present Illness\\b0\\fs22\\cf0\\par
${hpi}\\par
\\par
\\b\\fs28\\cf2 3. Current Medications & Labs\\b0\\fs22\\cf0\\par
${meds}\\par
\\par
\\b\\fs28\\cf3 4. Medication Safety Review\\b0\\fs22\\cf0\\par
\\bullet  AGS Beers Criteria Assessment\\par
\\bullet  STOPP/START Criteria Review\\par
\\bullet  Drug-Drug Interactions\\par
\\bullet  Renal Dosing Adjustments\\par
\\bullet  Anticholinergic Burden Score\\par
\\bullet  Fall-Risk Medications\\par
\\par
\\b\\fs28\\cf2 5. Functional & Cognitive Assessment\\b0\\fs22\\cf0\\par
\\b ADLs: \\b0 Bathing, Dressing, Toileting, Transferring, Continence, Feeding\\par
\\b IADLs: \\b0 Shopping, Cooking, Medications, Finances, Transportation\\par
\\b Cognitive: \\b0 MMSE/MoCA, CAM for delirium\\par
\\b Mood: \\b0 GDS-15 screening\\par
\\par
\\b\\fs28\\cf1 6. Clinical Assessment & Analysis\\b0\\fs22\\cf0\\par
${aiText}\\par
\\par
\\b\\fs28\\cf2 7. Management Plan\\b0\\fs22\\cf0\\par
\\b Pharmacological:\\b0\\par
\\bullet  Medication optimization\\par
\\bullet  Deprescribing strategy\\par
\\bullet  Dose adjustments for organ function\\par
\\b Non-Pharmacological:\\b0\\par
\\bullet  Physical Therapy\\par
\\bullet  Occupational Therapy\\par
\\bullet  Nutrition support\\par
\\bullet  Social work coordination\\par
\\par
\\b\\fs28\\cf3 8. Safety & Risk Management\\b0\\fs22\\cf0\\par
\\bullet  Fall prevention protocol\\par
\\bullet  Delirium prevention (HELP)\\par
\\bullet  Pressure injury prevention\\par
\\bullet  Caregiver support\\par
\\par
\\b\\fs28\\cf2 9. Discharge Planning\\b0\\fs22\\cf0\\par
\\bullet  Disposition planning\\par
\\bullet  Medication reconciliation\\par
\\bullet  Follow-up appointments\\par
\\bullet  Patient/family education\\par
\\bullet  Home safety evaluation\\par
\\par
\\b\\fs28\\cf1 10. Clinical References\\b0\\fs22\\cf0\\par
1. AGS Beers Criteria (2023) - J Am Geriatr Soc\\par
2. STOPP/START Criteria v2 - Age Ageing 2015\\par
3. CGA Guidelines - BMJ 2011\\par
4. Clinical Frailty Scale - CMAJ 2005\\par
5. CAM Method - Ann Intern Med 1990\\par
\\par
\\pard\\qc\\cf4\\fs18 ---\\par
Generated by SZMC Geriatrics Pro | ${currentDate}\\par
}`;

            // Create blob with RTF MIME type
            const blob = new Blob([rtf], {
                type: 'application/rtf'
            });

            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            const cleanInitials = getVal('initials').replace(/[^a-zA-Z0-9]/g, '') || 'export';
            link.download = `Case_${cleanInitials}.rtf`;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();

            // Cleanup
            setTimeout(() => {
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }, 100);

            console.log('RTF DOC export completed successfully');
        } catch(e) {
            console.error('RTF export failed:', e);
            alert("DOC Export Error: " + e.message);
        }
    }

    // --- 5. CLEAR FORM ---
    function clearForm() {
        if (confirm('Are you sure you want to clear all form data? This cannot be undone.')) {
            FORM_FIELDS.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            // Clear localStorage
            localStorage.removeItem(STORAGE_KEY);
            alert('Form cleared successfully!');
        }
    }

    // --- 6. EXPORT TO JSON ---
    function exportJSON() {
        try {
            const data = {
                ageSex: getVal('age_sex'),
                initials: getVal('initials'),
                hpi: getVal('hpi'),
                meds: getVal('meds'),
                aiResponse: getVal('ai-response'),
                rawText: getVal('raw-text'),
                exportDate: new Date().toISOString(),
                version: APP_VERSION
            };

            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            const jsonInitials = getVal('initials').trim() || 'export';
            link.download = `Case_${jsonInitials}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            console.log('JSON export completed successfully');
        } catch(e) {
            console.error('JSON export failed:', e);
            alert("JSON Export Error: " + e.message);
        }
    }

    // --- 7. KEYBOARD SHORTCUTS ---
    document.addEventListener('keydown', (e) => {
        // Ctrl/Cmd + G to generate prompt
        if ((e.ctrlKey || e.metaKey) && e.key === 'g') {
            e.preventDefault();
            generateMagicPrompt();
        }
        // Ctrl/Cmd + E to export PPTX
        if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
            e.preventDefault();
            exportPPT();
        }
        // Ctrl/Cmd + Shift + E to export DOC
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'E') {
            e.preventDefault();
            exportDOC();
        }
    });
</script>
</body>
</html>
