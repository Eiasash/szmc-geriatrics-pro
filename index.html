<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SZMC Pro: Mobile v15.5</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2c3e50">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx@9.5.1/build/index.js"></script>
    
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --bg: #f4f6f7; --sidebar: #ffffff; }
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* SIDEBAR (Desktop) */
        .sidebar { width: 300px; background: var(--sidebar); border-right: 1px solid #dce1e6; display: flex; flex-direction: column; padding: 20px; z-index: 2; overflow-y: auto; }
        .logo { font-size: 1.4rem; font-weight: 800; color: var(--primary); margin-bottom: 20px; display:flex; justify-content:space-between; align-items:center; }
        .badge { background: var(--accent); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; }
        
        /* DROPZONE */
        .drop-zone { border: 2px dashed #bdc3c7; border-radius: 12px; padding: 20px 10px; text-align: center; background: #fafafa; cursor: pointer; transition: 0.2s; min-height: 120px; display:flex; flex-direction:column; justify-content:center; align-items:center; }
        .drop-zone:active { background: #eafaf1; border-color: var(--accent); }
        
        /* MAIN LAYOUT (Desktop) */
        .main { flex: 1; padding: 20px; overflow-y: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding-bottom: 80px; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; flex-direction: column; height: fit-content; }
        
        /* INPUTS */
        h2 { margin-top:0; font-size:1rem; color:var(--primary); border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px; font-weight:700; }
        label { display: block; font-size: 0.75rem; font-weight: 700; color: #7f8c8d; margin-bottom: 5px; text-transform: uppercase; letter-spacing:0.5px; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #e1e4e8; border-radius: 8px; font-size: 16px; /* Prevents iOS zoom */ background: #fdfdfd; margin-bottom: 15px; -webkit-appearance: none; }
        input:focus, textarea:focus { border-color: var(--accent); outline: none; background: white; }

        /* BUTTONS */
        .btn { padding: 14px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; color: white; width: 100%; font-size: 0.95rem; margin-top: 5px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:active { transform: scale(0.96); opacity: 0.9; }
        .btn-magic { background: linear-gradient(135deg, #27ae60, #2ecc71); }
        .btn-ppt { background: #e67e22; margin-bottom: 10px; }
        .btn-doc { background: #2980b9; }
        
        .ai-box { border: 2px solid #27ae60; background: #f0fcf4; color: #2c3e50; font-family: monospace; font-size: 0.85rem; }
        #status { font-size: 0.8rem; color: #e67e22; text-align: center; margin-top: 10px; min-height: 1.2em; font-weight: bold; }

        /* --- MOBILE RESPONSIVE ENGINE --- */
        @media (max-width: 768px) {
            body { flex-direction: column; height: auto; overflow: auto; }
            .sidebar { width: 100%; height: auto; border-right: none; border-bottom: 1px solid #ddd; padding: 15px; flex-shrink: 0; }
            .main { display: flex; flex-direction: column; height: auto; overflow: visible; padding: 15px; }
            .drop-zone { padding: 15px; min-height: 100px; }
            textarea { min-height: 100px; }
            .ai-box { min-height: 200px; }
            /* Hide raw text on mobile to save space */
            #raw-text-container { display: none; } 
        }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="logo"><span>SZMC Pro</span> <span class="badge">v15.5 Mobile</span></div>
    
    <div class="drop-zone" onclick="document.getElementById('file-in')?.click()" id="drop-area">
        <div style="font-size:1.8rem;">üìÇ</div>
        <div style="font-weight:700; color:#2c3e50; margin-top:5px;">Import File</div>
        <div style="font-size:0.7rem; color:#7f8c8d;">PDF ‚Ä¢ DOCX ‚Ä¢ JSON ‚Ä¢ HTML ‚Ä¢ JPG</div>
        <input type="file" id="file-in" style="display:none" onchange="handleFile(this)">
    </div>
    <div id="status"></div>
    
    <div id="raw-text-container" style="margin-top:20px;">
        <label>Raw Data</label>
        <textarea id="raw-text" style="height:150px; font-size:0.7rem; font-family:monospace;" placeholder="Text extractor..."></textarea>
    </div>
    
    <div style="margin-top:20px; padding:10px; background:#f9f9f9; border-radius:8px; font-size:0.75rem;">
        <strong>‚å®Ô∏è Keyboard Shortcuts:</strong>
        <div style="margin-top:8px; color:#666;">
            <div>Ctrl/‚åò + G - Generate Prompt</div>
            <div>Ctrl/‚åò + E - Export PPTX</div>
            <div>Ctrl/‚åò + Shift + E - Export DOC</div>
        </div>
    </div>
</div>

<div class="main">
    <div class="card">
        <h2>1. Patient Data</h2>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
            <div><label for="age_sex">Age/Sex</label><input type="text" id="age_sex" placeholder="e.g. 85F" aria-label="Patient age and sex"></div>
            <div><label for="initials">Initials</label><input type="text" id="initials" placeholder="e.g. A.B." aria-label="Patient initials"></div>
        </div>
        <label for="hpi">CC / HPI</label><textarea id="hpi" rows="4" placeholder="Admitted for..." aria-label="Chief complaint and history of present illness"></textarea>
        <label for="meds">Meds & Labs</label><textarea id="meds" rows="4" placeholder="List meds and labs..." aria-label="Medications and laboratory results"></textarea>
        
        <button class="btn btn-magic" onclick="generateMagicPrompt()" aria-label="Generate and copy AI prompt to clipboard">
            <span>‚ú®</span> Copy AI Prompt
        </button>
        <button class="btn" style="background:#95a5a6; margin-top:10px;" onclick="clearForm()" aria-label="Clear all form fields">
            <span>üóëÔ∏è</span> Clear Form
        </button>
    </div>

    <div class="card">
        <h2>2. AI Result & Export</h2>
        <label>Paste Claude/GPT Answer Here:</label>
        <textarea id="ai-response" class="ai-box" rows="12" placeholder="Paste the full AI analysis here. This text will be included in your export." aria-label="AI response input"></textarea>
        
        <div style="margin-top:20px;">
            <button class="btn btn-ppt" onclick="exportPPT()" aria-label="Export to PowerPoint presentation">üìä Download PPTX (Slides)</button>
            <button class="btn btn-doc" onclick="exportDOC()" aria-label="Export to Word document">üìù Download Word (Doc)</button>
            <button class="btn" style="background:#16a085; margin-top:10px;" onclick="exportJSON()" aria-label="Export data as JSON file">üíæ Export JSON</button>
        </div>
    </div>
</div>

<script>
    // --- 0. CONSTANTS ---
    const APP_VERSION = '15.5.0';
    const STORAGE_KEY = 'szmc-pro-form-data';
    const FORM_FIELDS = ['age_sex', 'initials', 'hpi', 'meds', 'ai-response', 'raw-text'];

    // Load saved data on page load
    function loadSavedData() {
        try {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                const data = JSON.parse(saved);
                FORM_FIELDS.forEach(id => {
                    const el = document.getElementById(id);
                    if (el && data[id]) el.value = data[id];
                });
                console.log('Form data restored from localStorage');
            }
        } catch (err) {
            console.error('Error loading saved data:', err);
        }
    }

    // Save data to localStorage (debounced)
    let saveTimeout;
    function saveFormData() {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
            try {
                const data = {};
                FORM_FIELDS.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) data[id] = el.value;
                });
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            } catch (err) {
                console.error('Error saving data:', err);
            }
        }, 500); // Debounce by 500ms
    }

    // Immediate save function (no debounce) for critical moments
    function saveFormDataNow() {
        try {
            const data = {};
            FORM_FIELDS.forEach(id => {
                const el = document.getElementById(id);
                if (el) data[id] = el.value;
            });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        } catch (err) {
            console.error('Error saving data:', err);
        }
    }

    // Save data before page unload to prevent data loss
    window.addEventListener('beforeunload', () => {
        clearTimeout(saveTimeout);
        saveFormDataNow();
    });

    // Attach auto-save listeners
    document.addEventListener('DOMContentLoaded', () => {
        loadSavedData();
        FORM_FIELDS.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('input', saveFormData);
        });
    });

    // --- 1. IMPORT ENGINE ---
    const dropArea = document.getElementById('drop-area');
    const statusDiv = document.getElementById('status');

    // Prevent default drag behaviors
    function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        if (dropArea) dropArea.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });

    // Highlight drop area and handle drops (only if dropArea exists)
    if (dropArea) {
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.style.background = '#eafaf1', false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.style.background = '#fafafa', false);
        });

        // Handle Drop
        dropArea.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFile({files: files});
        }, false);
    }

    async function handleFile(input) {
        // Validate input
        if (!input || !input.files || !input.files[0]) return;
        const file = input.files[0];

        // File size validation (max 50MB)
        const MAX_FILE_SIZE = 50 * 1024 * 1024;
        if (file.size > MAX_FILE_SIZE) {
            alert('File too large. Maximum size is 50MB.');
            return;
        }

        const ext = file.name.split('.').pop().toLowerCase();
        const SUPPORTED_EXTENSIONS = ['pptx', 'pdf', 'docx', 'doc', 'html', 'htm', 'txt', 'json', 'rtf', 'jpg', 'png', 'jpeg'];
        if (!SUPPORTED_EXTENSIONS.includes(ext)) {
            alert(`Unsupported file type: .${ext}.\nSupported: ${SUPPORTED_EXTENSIONS.join(', ')}`);
            return;
        }

        let text = "";
        if (statusDiv) statusDiv.innerText = "Reading...";

        try {
            // JSON import - directly populates form fields
            if (ext === 'json') {
                const jsonText = await file.text();
                const data = JSON.parse(jsonText);
                // Map JSON fields to form fields
                const fieldMap = {
                    'age_sex': data.ageSex || data.age_sex || '',
                    'initials': data.initials || '',
                    'hpi': data.hpi || data.HPI || '',
                    'meds': data.meds || data.medications || '',
                    'ai-response': data.aiResponse || data.ai_response || data.analysis || '',
                    'raw-text': data.rawText || data.raw_text || ''
                };
                Object.entries(fieldMap).forEach(([id, value]) => {
                    const el = document.getElementById(id);
                    if (el && value) el.value = value;
                });
                saveFormData();
                if (statusDiv) statusDiv.innerText = "JSON Loaded!";
                setTimeout(() => { if (statusDiv) statusDiv.innerText = ""; }, 2000);
                return;
            }
            // PPTX
            else if (ext === 'pptx') {
                if (typeof JSZip === 'undefined') throw new Error('JSZip library not loaded');
                const zip = await JSZip.loadAsync(file);
                const slides = Object.keys(zip.files).filter(n => n.match(/ppt\/slides\/slide\d+\.xml/)).sort((a,b) => {
                    return parseInt(a.match(/\d+/)?.[0] || '0', 10) - parseInt(b.match(/\d+/)?.[0] || '0', 10);
                });
                for (const s of slides) {
                    const t = await zip.file(s).async("string");
                    const d = new DOMParser().parseFromString(t, "text/xml");
                    if (d.documentElement) text += (d.documentElement.textContent || "") + "\n\n";
                }
            }
            // PDF
            else if (ext === 'pdf') {
                if (typeof pdfjsLib === 'undefined') throw new Error('PDF.js library not loaded');
                const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    text += content.items.map(s => s.str).join(' ') + " ";
                }
            }
            // DOCX
            else if (ext === 'docx') {
                if (typeof mammoth === 'undefined') throw new Error('Mammoth library not loaded');
                const res = await mammoth.extractRawText({ arrayBuffer: await file.arrayBuffer() });
                text = res.value;
            }
            // HTML, HTM, TXT, DOC (legacy), RTF
            else if (['html', 'htm', 'txt', 'doc', 'rtf'].includes(ext)) {
                text = await file.text();
                if (ext === 'html' || ext === 'htm') {
                    const doc = new DOMParser().parseFromString(text, 'text/html');
                    text = doc.body?.innerText || doc.body?.textContent || '';
                }
            }
            // Images (OCR)
            else if (['jpg', 'png', 'jpeg'].includes(ext)) {
                if (typeof Tesseract === 'undefined') throw new Error('Tesseract.js library not loaded');
                if (statusDiv) statusDiv.innerText = "OCR...";
                const w = await Tesseract.createWorker('eng');
                const r = await w.recognize(file);
                text = r.data.text;
                await w.terminate();
            }

            const rawTextEl = document.getElementById('raw-text');
            if (rawTextEl) rawTextEl.value = text;
            smartPopulate(text);
            if (statusDiv) statusDiv.innerText = "Success!";
            setTimeout(() => { if (statusDiv) statusDiv.innerText = ""; }, 2000);
        } catch (err) {
            console.error(err);
            if (statusDiv) statusDiv.innerText = "Error";
            alert("Could not read file: " + err.message);
        }
    }

    // --- 2. POPULATOR ---
    function smartPopulate(text) {
        const set = (id, r) => {
            const m = text.match(r);
            const el = document.getElementById(id);
            if(m && m[1] && el) el.value = m[1].trim();
        };
        // Enhanced patterns to match more variations (e.g., "85F", "72 M", "65 male", "78 female")
        set('age_sex', /(\d{2,3}\s?(?:male|female|Male|Female|[MmFf]))/);
        set('hpi', /(?:HPI|History of Present Illness|History)[:\s]+([\s\S]*?)(?=\n\s*(?:PMH|Past Medical History|Meds|Medications|Assessment|Physical Exam)|$)/i);
        set('meds', /(?:Meds|Medications|Current Medications|Home Medications)[:\s]+([\s\S]*?)(?=\n\s*(?:Labs|Laboratory|Plan|Assessment|Allergies)|$)/i);
    }

    // --- 3. PROMPT ---
    // Constants for prompt generation
    const PROMPT_MESSAGES = {
        BYPASS_CONFIRM: 'Structured fields are empty, but raw text is available.\n\nDo you want to generate the AI prompt using the raw extracted text instead?',
        SUCCESS_STANDARD: 'Prompt Copied! Paste into AI.',
        SUCCESS_RAW_TEXT: 'Prompt generated from raw text and copied! Paste into AI.',
        COPY_FAILED: 'Auto-copy failed. The prompt is displayed - please copy manually (Ctrl+C), then close this dialog.'
    };

    // Prompt template - matches src/prompt.js PROMPT_TEMPLATE
    const PROMPT_TEMPLATE = `Act as a Senior Geriatrician.
I will provide clinical data. Please output a response with TWO SECTIONS:

SECTION 1: SAFETY AUDIT (Strict)
- Flag Drug Interactions.
- Flag Beers Criteria.

SECTION 2: CLINICAL SUMMARY (Professional)
- Case Presentation style.
- Assessment & Plan.

DATA:
ID: {ageSex}
HPI: {hpi}
MEDS/LABS: {meds}`;

    async function generateMagicPrompt() {
        const v = (id) => document.getElementById(id)?.value || '';
        
        // Get all data including raw text
        const ageSex = v('age_sex').trim();
        const hpi = v('hpi').trim();
        const meds = v('meds').trim();
        const rawText = v('raw-text').trim();
        
        // Check if ALL required structured fields are filled
        const allStructuredFieldsFilled = ageSex && hpi && meds;
        
        // If any structured field is missing, check if we have raw text as fallback
        if (!allStructuredFieldsFilled) {
            if (rawText) {
                // Raw text is available - offer to use it
                const useRawText = confirm(PROMPT_MESSAGES.BYPASS_CONFIRM);
                if (!useRawText) {
                    return;
                }
            } else {
                // No raw text fallback available - show error
                const missing = [];
                if (!ageSex) missing.push('Age/Sex');
                if (!hpi) missing.push('HPI');
                if (!meds) missing.push('Meds/Labs');
                alert(`Please fill in the following required fields: ${missing.join(', ')}`);
                return;
            }
        }
        
        // Generate prompt using template
        let p;
        if (!allStructuredFieldsFilled && rawText) {
            // Use raw text in prompt when structured fields are incomplete
            p = PROMPT_TEMPLATE
                .replace('{ageSex}', 'See below')
                .replace('{hpi}', 'See clinical data below')
                .replace('{meds}', rawText);
        } else {
            // Use structured fields
            p = PROMPT_TEMPLATE
                .replace('{ageSex}', ageSex)
                .replace('{hpi}', hpi)
                .replace('{meds}', meds);
        }

        try {
            await navigator.clipboard.writeText(p);
            const message = !allStructuredFieldsFilled && rawText 
                ? PROMPT_MESSAGES.SUCCESS_RAW_TEXT
                : PROMPT_MESSAGES.SUCCESS_STANDARD;
            alert(message);
        } catch (err) {
            console.error('Clipboard error:', err);
            // Fallback: show prompt in a textarea for manual copy
            const textarea = document.createElement('textarea');
            textarea.value = p;
            textarea.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:80%;height:60%;z-index:9999;';
            document.body.appendChild(textarea);
            textarea.select();
            alert(PROMPT_MESSAGES.COPY_FAILED);
            document.body.removeChild(textarea);
        }
    }

    // --- 4. SAFE EXPORTS ---
    const getVal = (id) => document.getElementById(id)?.value || "";

    // Sanitize text by removing control characters (except newlines and tabs)
    const sanitizeText = (text) => {
        if (!text || typeof text !== 'string') return '';
        // Remove control characters except newlines and tabs
        return text.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '');
    };

    // HTML escape function to prevent XSS in Word export
    const escapeHtml = (text) => {
        if (!text || typeof text !== 'string') return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    };

    function exportPPT() {
        try {
            if (!getVal('age_sex').trim() && !getVal('hpi').trim()) {
                alert('Please add some patient data before exporting.');
                return;
            }
            if (typeof PptxGenJS === 'undefined') throw new Error('PptxGenJS library not loaded');

            const pres = new PptxGenJS();
            const C = { pri: '2c3e50', sec: '7f8c8d', acc: '27ae60', warn: 'e74c3c', info: '3498db', txt: '333333' };
            const data = {
                age: sanitizeText(getVal('age_sex')) || 'Not specified',
                init: sanitizeText(getVal('initials')) || 'N/A',
                hpi: sanitizeText(getVal('hpi')) || 'Not documented',
                meds: sanitizeText(getVal('meds')) || 'Not documented',
                ai: sanitizeText(getVal('ai-response')) || 'Pending analysis',
                date: new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })
            };
            const trunc = (t, n) => t?.length > n ? t.substring(0, n) + '...' : t;
            const header = (s, title, color) => {
                s.addShape('rect', { x: 0, y: 0, w: '100%', h: 0.8, fill: { color } });
                s.addText(title, { x: 0.5, y: 0.2, w: '90%', fontSize: 24, color: 'ffffff', bold: true });
            };
            const bullets = (s, items, startY) => items.forEach((t, i) => s.addText(t, { x: 0.7, y: startY + i * 0.35, fontSize: 13, color: C.txt }));

            // Slide 1: Title
            let s = pres.addSlide();
            s.addShape('rect', { x: 0, y: 0, w: '100%', h: '100%', fill: { color: C.pri } });
            s.addText('GERIATRIC CASE PRESENTATION', { x: 0.5, y: 1.5, w: '90%', fontSize: 36, color: 'ffffff', bold: true, align: 'center' });
            s.addText(`Patient: ${data.age} (${data.init})`, { x: 0.5, y: 2.5, w: '90%', fontSize: 24, color: 'ecf0f1', align: 'center' });
            s.addShape('line', { x: 2, y: 3.2, w: 6, h: 0, line: { color: C.acc, width: 3 } });
            s.addText('Comprehensive Geriatric Assessment', { x: 0.5, y: 3.5, w: '90%', fontSize: 18, color: 'bdc3c7', align: 'center' });
            s.addText(`SZMC Geriatrics Pro | ${data.date}`, { x: 0.5, y: 4.8, w: '90%', fontSize: 12, color: '95a5a6', align: 'center' });

            // Slide 2: Case Overview
            s = pres.addSlide(); header(s, 'Case Overview', C.pri);
            s.addText('Patient Demographics', { x: 0.5, y: 1.1, fontSize: 18, color: C.acc, bold: true });
            s.addText([{ text: '‚Ä¢ Age/Sex: ', options: { bold: true } }, { text: data.age }], { x: 0.7, y: 1.5, fontSize: 14, color: C.txt });
            s.addText([{ text: '‚Ä¢ Patient ID: ', options: { bold: true } }, { text: data.init }], { x: 0.7, y: 1.9, fontSize: 14, color: C.txt });
            s.addText('Assessment: Comprehensive Geriatric Assessment (CGA)', { x: 0.7, y: 2.4, fontSize: 14, color: C.txt });

            // Slide 3: HPI
            s = pres.addSlide(); header(s, 'Chief Complaint & HPI', C.info);
            s.addText(trunc(data.hpi, 900), { x: 0.5, y: 1.1, w: 9, h: 3.8, fontSize: 13, color: C.txt, valign: 'top' });

            // Slide 4: HPI Overflow
            if (data.hpi.length > 900) {
                s = pres.addSlide(); header(s, 'HPI (Continued)', C.info);
                s.addText(trunc(data.hpi.substring(900), 1000), { x: 0.5, y: 1.1, w: 9, h: 3.8, fontSize: 13, color: C.txt, valign: 'top' });
            }

            // Slide 5: Medications
            s = pres.addSlide(); header(s, 'Current Medications & Labs', C.acc);
            s.addText(trunc(data.meds, 900), { x: 0.5, y: 1.1, w: 9, h: 3.8, fontSize: 12, color: C.txt, valign: 'top' });

            // Slide 6: Medication Safety
            s = pres.addSlide(); header(s, 'Medication Safety Assessment', C.warn);
            s.addText('Safety Screening:', { x: 0.5, y: 1.1, fontSize: 16, color: C.warn, bold: true });
            bullets(s, ['‚Ä¢ Beers Criteria - PIMs in older adults', '‚Ä¢ STOPP/START Criteria Review', '‚Ä¢ Drug-Drug Interactions', '‚Ä¢ Renal/Hepatic Dosing', '‚Ä¢ Anticholinergic Burden Score', '‚Ä¢ QTc Prolongation Risk', '‚Ä¢ Fall-Risk Increasing Drugs'], 1.5);

            // Slide 7: Functional Assessment
            s = pres.addSlide(); header(s, 'Functional Assessment', C.acc);
            s.addText('ADLs: Bathing ‚Ä¢ Dressing ‚Ä¢ Toileting ‚Ä¢ Transferring ‚Ä¢ Continence ‚Ä¢ Feeding', { x: 0.5, y: 1.2, fontSize: 13, color: C.txt });
            s.addText('IADLs: Shopping ‚Ä¢ Cooking ‚Ä¢ Medications ‚Ä¢ Finances ‚Ä¢ Transportation', { x: 0.5, y: 1.7, fontSize: 13, color: C.txt });
            s.addText('Mobility:', { x: 0.5, y: 2.3, fontSize: 16, color: C.pri, bold: true });
            s.addText('‚Ä¢ Timed Up and Go (TUG)\n‚Ä¢ Gait Speed Assessment\n‚Ä¢ Fall Risk Stratification', { x: 0.7, y: 2.7, fontSize: 13, color: C.txt });

            // Slide 8: Cognitive Assessment
            s = pres.addSlide(); header(s, 'Cognitive & Mental Status', C.info);
            s.addText('Cognitive: MMSE ‚Ä¢ MoCA ‚Ä¢ Clock Drawing Test', { x: 0.5, y: 1.2, fontSize: 13, color: C.txt });
            s.addText('Delirium: CAM ‚Ä¢ 4AT Rapid Screening', { x: 0.5, y: 1.7, fontSize: 13, color: C.txt });
            s.addText('Mood: Geriatric Depression Scale (GDS-15)', { x: 0.5, y: 2.2, fontSize: 13, color: C.txt });

            // Slide 9: Clinical Analysis
            s = pres.addSlide(); header(s, 'Clinical Assessment & Analysis', C.pri);
            s.addText(trunc(data.ai, 900), { x: 0.5, y: 1.1, w: 9, h: 3.8, fontSize: 12, color: C.txt, valign: 'top' });

            // Slide 10: Analysis Overflow
            if (data.ai.length > 900) {
                s = pres.addSlide(); header(s, 'Clinical Assessment (Continued)', C.pri);
                s.addText(trunc(data.ai.substring(900), 1000), { x: 0.5, y: 1.1, w: 9, h: 3.8, fontSize: 12, color: C.txt, valign: 'top' });
            }

            // Slide 11: Differential Diagnosis
            s = pres.addSlide(); header(s, 'Differential Diagnosis', C.info);
            s.addText('Diagnostic Considerations:', { x: 0.5, y: 1.1, fontSize: 16, color: C.pri, bold: true });
            bullets(s, ['‚Ä¢ Primary Working Diagnosis', '‚Ä¢ Alternative Diagnoses', '‚Ä¢ Comorbidity Assessment'], 1.5);
            s.addText('Geriatric Syndromes:', { x: 0.5, y: 2.7, fontSize: 16, color: C.warn, bold: true });
            bullets(s, ['‚Ä¢ Frailty ‚Ä¢ Sarcopenia ‚Ä¢ Polypharmacy', '‚Ä¢ Falls ‚Ä¢ Delirium/Dementia ‚Ä¢ Incontinence'], 3.1);

            // Slide 12: Pharmacological Management
            s = pres.addSlide(); header(s, 'Management: Pharmacological', C.acc);
            s.addText('Medication Optimization:', { x: 0.5, y: 1.1, fontSize: 16, color: C.pri, bold: true });
            bullets(s, ['‚Ä¢ Review indication for each medication', '‚Ä¢ Identify deprescribing candidates', '‚Ä¢ Dose adjustments per organ function', '‚Ä¢ Simplify regimen where possible'], 1.5);

            // Slide 13: Non-Pharmacological
            s = pres.addSlide(); header(s, 'Management: Non-Pharmacological', C.acc);
            bullets(s, ['‚Ä¢ Physical Therapy - mobility, balance', '‚Ä¢ Occupational Therapy - ADL optimization', '‚Ä¢ Nutrition - MNA screening', '‚Ä¢ Social Work - care coordination', '‚Ä¢ Pharmacy Consult - MTM'], 1.1);

            // Slide 14: Safety
            s = pres.addSlide(); header(s, 'Safety & Risk Management', C.warn);
            s.addText('Fall Prevention:', { x: 0.5, y: 1.1, fontSize: 16, color: C.warn, bold: true });
            bullets(s, ['‚Ä¢ Environmental modifications', '‚Ä¢ FRID review', '‚Ä¢ Assistive devices', '‚Ä¢ Vision/hearing correction'], 1.5);
            s.addText('Delirium Prevention (HELP):', { x: 0.5, y: 3.0, fontSize: 16, color: C.warn, bold: true });
            s.addText('Orientation ‚Ä¢ Mobilization ‚Ä¢ Sleep ‚Ä¢ Hydration', { x: 0.7, y: 3.4, fontSize: 13, color: C.txt });

            // Slide 15: Discharge
            s = pres.addSlide(); header(s, 'Discharge Planning', C.info);
            bullets(s, ['‚Ä¢ Disposition: Home / SNF / Rehab / LTC', '‚Ä¢ Medication reconciliation', '‚Ä¢ Follow-up appointments', '‚Ä¢ Patient/caregiver education', '‚Ä¢ DME orders', '‚Ä¢ Home safety evaluation'], 1.1);

            // Slide 16: Follow-up
            s = pres.addSlide(); header(s, 'Follow-up & Monitoring', C.acc);
            s.addText('Short-term (1-2 weeks):', { x: 0.5, y: 1.1, fontSize: 16, color: C.pri, bold: true });
            s.addText('Medication efficacy ‚Ä¢ Symptom monitoring ‚Ä¢ Labs', { x: 0.7, y: 1.5, fontSize: 13, color: C.txt });
            s.addText('Long-term:', { x: 0.5, y: 2.1, fontSize: 16, color: C.pri, bold: true });
            s.addText('Functional reassessment ‚Ä¢ Cognitive screening ‚Ä¢ Annual med review', { x: 0.7, y: 2.5, fontSize: 13, color: C.txt });

            // Slide 17: Guidelines
            s = pres.addSlide(); header(s, 'Evidence-Based Guidelines', C.pri);
            const guidelines = ['AGS Beers Criteria (2023)', 'STOPP/START Criteria v2', 'Comprehensive Geriatric Assessment', 'Clinical Frailty Scale (Rockwood)', 'CAM - Confusion Assessment Method', 'Hospital Elder Life Program (HELP)'];
            guidelines.forEach((g, i) => s.addText('‚Ä¢ ' + g, { x: 0.7, y: 1.2 + i * 0.5, fontSize: 14, color: C.txt }));

            // Slide 18: References
            s = pres.addSlide(); header(s, 'References', C.sec);
            const refs = [
                '1. AGS Beers Criteria. J Am Geriatr Soc. 2023;71(7):2052-2081',
                '2. O\'Mahony D. STOPP/START v2. Age Ageing. 2015;44(2):213-218',
                '3. Ellis G. CGA meta-analysis. BMJ. 2011;343:d6553',
                '4. Rockwood K. Clinical Frailty Scale. CMAJ. 2005;173(5):489-495',
                '5. Inouye SK. CAM. Ann Intern Med. 1990;113(12):941-948',
                '6. Inouye SK. HELP. J Am Geriatr Soc. 2000;48(12):1697-1706'
            ];
            refs.forEach((r, i) => s.addText(r, { x: 0.5, y: 1.1 + i * 0.5, w: 9, fontSize: 11, color: C.txt }));

            // Slide 19: Thank You
            s = pres.addSlide();
            s.addShape('rect', { x: 0, y: 0, w: '100%', h: '100%', fill: { color: C.pri } });
            s.addText('Thank You', { x: 0.5, y: 1.8, w: '90%', fontSize: 44, color: 'ffffff', bold: true, align: 'center' });
            s.addShape('line', { x: 3, y: 2.7, w: 4, h: 0, line: { color: C.acc, width: 3 } });
            s.addText('Questions & Discussion', { x: 0.5, y: 3.0, w: '90%', fontSize: 24, color: 'ecf0f1', align: 'center' });
            s.addText(`Patient: ${data.age} (${data.init})`, { x: 0.5, y: 4.0, w: '90%', fontSize: 16, color: 'bdc3c7', align: 'center' });
            s.addText('SZMC Geriatrics Pro', { x: 0.5, y: 4.8, w: '90%', fontSize: 11, color: '7f8c8d', align: 'center' });

            pres.writeFile({ fileName: `Case_${data.init !== 'N/A' ? data.init : 'export'}.pptx` });
        } catch (e) {
            console.error('PPT export failed:', e);
            alert("PPT Export Error: " + e.message);
        }
    }

    async function exportDOC() {
        console.log('Starting comprehensive DOCX export...');
        try {
            // Validate minimum required data
            if (!getVal('age_sex').trim() && !getVal('hpi').trim()) {
                alert('Please add some patient data before exporting.');
                return;
            }

            // Check if docx library is loaded
            if (typeof docx === 'undefined') {
                console.warn('DOCX library not loaded, falling back to HTML-based DOC export');
                exportDOCLegacy();
                return;
            }

            const { Document, Paragraph, TextRun, HeadingLevel, AlignmentType, Packer, BorderStyle, PageBreak, Tab, TabStopType, TabStopPosition } = docx;

            // Enhanced text sanitization - remove control chars AND problematic Unicode
            const deepSanitize = (text) => {
                if (!text || typeof text !== 'string') return '';
                return text
                    .replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '') // Control characters
                    .replace(/[\uFFFE\uFFFF]/g, '') // Invalid Unicode
                    .replace(/\r\n/g, '\n') // Normalize line endings
                    .replace(/\r/g, '\n');
            };

            // Get sanitized data
            const ageSex = deepSanitize(getVal('age_sex')) || 'Not specified';
            const initials = deepSanitize(getVal('initials')) || 'N/A';
            const hpi = deepSanitize(getVal('hpi')) || 'Not documented';
            const meds = deepSanitize(getVal('meds')) || 'Not documented';
            const aiText = deepSanitize(getVal('ai-response')) || 'Pending clinical analysis';
            const currentDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            // Helper to create bullet paragraphs
            const createBullet = (text, level = 0, spacing = {}) => new Paragraph({
                text: deepSanitize(text),
                bullet: { level },
                spacing: { after: 120, ...spacing }
            });

            // Helper to create section header
            const createSectionHeader = (text) => new Paragraph({
                text: text,
                heading: HeadingLevel.HEADING_2,
                spacing: { before: 300, after: 200 },
                border: {
                    bottom: { color: '27ae60', space: 1, size: 6, style: BorderStyle.SINGLE }
                }
            });

            // Helper to create subsection header
            const createSubHeader = (text) => new Paragraph({
                text: text,
                heading: HeadingLevel.HEADING_3,
                spacing: { before: 200, after: 100 }
            });

            // Helper to split long text into paragraphs
            const createTextParagraphs = (text, spacing = { after: 200 }) => {
                if (!text) return [new Paragraph({ text: 'Not documented', spacing })];
                const lines = text.split('\n').filter(line => line.trim());
                if (lines.length === 0) return [new Paragraph({ text: 'Not documented', spacing })];
                return lines.map((line, idx) => new Paragraph({
                    text: line,
                    spacing: idx === lines.length - 1 ? spacing : { after: 120 }
                }));
            };

            // Build document sections
            const children = [
                // ========== TITLE PAGE ==========
                new Paragraph({
                    children: [
                        new TextRun({ text: 'GERIATRIC CASE REPORT', bold: true, size: 56, color: '2c3e50' })
                    ],
                    alignment: AlignmentType.CENTER,
                    spacing: { after: 400 }
                }),
                new Paragraph({
                    children: [
                        new TextRun({ text: 'Comprehensive Geriatric Assessment', size: 28, color: '7f8c8d', italics: true })
                    ],
                    alignment: AlignmentType.CENTER,
                    spacing: { after: 600 }
                }),
                new Paragraph({
                    children: [
                        new TextRun({ text: 'Patient: ', bold: true, size: 24 }),
                        new TextRun({ text: `${ageSex} (${initials})`, size: 24 })
                    ],
                    alignment: AlignmentType.CENTER,
                    spacing: { after: 200 }
                }),
                new Paragraph({
                    children: [
                        new TextRun({ text: `Date: ${currentDate}`, size: 20, color: '7f8c8d' })
                    ],
                    alignment: AlignmentType.CENTER,
                    spacing: { after: 400 }
                }),
                new Paragraph({
                    children: [
                        new TextRun({ text: 'Generated by SZMC Geriatrics Pro', size: 18, color: '95a5a6', italics: true })
                    ],
                    alignment: AlignmentType.CENTER,
                    spacing: { after: 800 }
                }),

                // ========== PATIENT DEMOGRAPHICS ==========
                createSectionHeader('1. Patient Demographics'),
                new Paragraph({
                    children: [
                        new TextRun({ text: 'Age/Sex: ', bold: true }),
                        new TextRun(ageSex)
                    ],
                    spacing: { after: 120 }
                }),
                new Paragraph({
                    children: [
                        new TextRun({ text: 'Patient Identifier: ', bold: true }),
                        new TextRun(initials)
                    ],
                    spacing: { after: 120 }
                }),
                new Paragraph({
                    children: [
                        new TextRun({ text: 'Assessment Type: ', bold: true }),
                        new TextRun('Comprehensive Geriatric Assessment (CGA)')
                    ],
                    spacing: { after: 300 }
                }),

                // ========== CHIEF COMPLAINT & HPI ==========
                createSectionHeader('2. Chief Complaint & History of Present Illness'),
                ...createTextParagraphs(hpi, { after: 300 }),

                // ========== MEDICATIONS & LABS ==========
                createSectionHeader('3. Current Medications & Laboratory Results'),
                ...createTextParagraphs(meds, { after: 300 }),

                // ========== MEDICATION SAFETY REVIEW ==========
                createSectionHeader('4. Medication Safety Review'),
                new Paragraph({
                    children: [
                        new TextRun({ text: 'Safety Screening Checklist:', bold: true, color: 'c0392b' })
                    ],
                    spacing: { after: 150 }
                }),
                createBullet('AGS Beers Criteria Assessment - Potentially Inappropriate Medications (PIMs)'),
                createBullet('STOPP/START Criteria Review'),
                createBullet('Drug-Drug Interactions (DDIs) Analysis'),
                createBullet('Drug-Disease Interactions'),
                createBullet('Renal Dosing Adjustments (CrCl-based calculations)'),
                createBullet('Hepatic Impairment Considerations'),
                createBullet('Anticholinergic Burden Score (ABS)'),
                createBullet('QTc Prolongation Risk Assessment'),
                createBullet('Fall-Risk Increasing Drugs (FRIDs) Review', 0, { after: 300 }),

                // ========== FUNCTIONAL ASSESSMENT ==========
                createSectionHeader('5. Functional & Cognitive Assessment'),
                createSubHeader('Activities of Daily Living (ADLs)'),
                new Paragraph({
                    text: 'Bathing, Dressing, Toileting, Transferring, Continence, Feeding',
                    spacing: { after: 150 }
                }),
                createSubHeader('Instrumental ADLs (IADLs)'),
                new Paragraph({
                    text: 'Shopping, Cooking, Managing Medications, Finances, Transportation, Phone Use',
                    spacing: { after: 150 }
                }),
                createSubHeader('Mobility Assessment'),
                createBullet('Timed Up and Go (TUG) Test'),
                createBullet('Gait Speed Assessment'),
                createBullet('Fall History & Risk Stratification'),
                createSubHeader('Cognitive Screening'),
                createBullet('Mini-Mental State Examination (MMSE)'),
                createBullet('Montreal Cognitive Assessment (MoCA)'),
                createBullet('Clock Drawing Test'),
                createSubHeader('Delirium Assessment'),
                createBullet('Confusion Assessment Method (CAM)'),
                createBullet('4AT Rapid Delirium Screening', 0, { after: 150 }),
                createSubHeader('Mood Screening'),
                createBullet('Geriatric Depression Scale (GDS-15)', 0, { after: 300 }),

                // ========== CLINICAL ASSESSMENT ==========
                createSectionHeader('6. Clinical Assessment & Analysis'),
                ...createTextParagraphs(aiText, { after: 300 }),

                // ========== DIFFERENTIAL DIAGNOSIS ==========
                createSectionHeader('7. Differential Diagnosis'),
                createSubHeader('Diagnostic Considerations'),
                createBullet('Primary Working Diagnosis'),
                createBullet('Alternative Diagnoses'),
                createBullet('Comorbidity Assessment'),
                createBullet('Atypical Presentations in Elderly'),
                createSubHeader('Geriatric Syndromes Evaluation'),
                createBullet('Frailty Syndrome'),
                createBullet('Sarcopenia'),
                createBullet('Polypharmacy'),
                createBullet('Falls & Mobility Impairment'),
                createBullet('Delirium / Dementia'),
                createBullet('Urinary Incontinence'),
                createBullet('Malnutrition', 0, { after: 300 }),

                // ========== MANAGEMENT PLAN ==========
                createSectionHeader('8. Comprehensive Management Plan'),
                createSubHeader('Pharmacological Interventions'),
                createBullet('Medication indication review for each agent'),
                createBullet('Deprescribing candidates identified'),
                createBullet('Dose adjustments per renal/hepatic function'),
                createBullet('Therapy timing optimization'),
                createBullet('Regimen simplification where possible'),
                createSubHeader('Deprescribing Priorities'),
                createBullet('High anticholinergic burden medications'),
                createBullet('Sedative-hypnotics (benzodiazepines, Z-drugs)'),
                createBullet('Proton pump inhibitors (if prolonged use without indication)'),
                createBullet('Medications without clear current indication'),
                createSubHeader('Non-Pharmacological Interventions'),
                createBullet('Physical Therapy - mobility, strength, balance training'),
                createBullet('Occupational Therapy - ADL/IADL optimization'),
                createBullet('Speech & Language Therapy - swallowing assessment'),
                createBullet('Nutrition/Dietitian - MNA screening, protein optimization'),
                createBullet('Social Work - care coordination, caregiver support'),
                createBullet('Pharmacy Consult - medication therapy management', 0, { after: 300 }),

                // ========== SAFETY & RISK MANAGEMENT ==========
                createSectionHeader('9. Safety & Risk Management'),
                createSubHeader('Fall Prevention Protocol'),
                createBullet('Environmental modifications'),
                createBullet('FRID review and optimization'),
                createBullet('Assistive device assessment'),
                createBullet('Vision/hearing correction'),
                createBullet('Footwear evaluation'),
                createSubHeader('Delirium Prevention (HELP Protocol)'),
                createBullet('Orientation protocols'),
                createBullet('Early mobilization'),
                createBullet('Sleep enhancement'),
                createBullet('Minimize psychoactive medications'),
                createBullet('Adequate hydration/nutrition', 0, { after: 300 }),

                // ========== DISCHARGE PLANNING ==========
                createSectionHeader('10. Discharge & Transition Planning'),
                createSubHeader('Disposition Options'),
                createBullet('Home (with/without home health services)'),
                createBullet('Skilled Nursing Facility (SNF)'),
                createBullet('Acute Rehabilitation'),
                createBullet('Long-term Care'),
                createSubHeader('Transition of Care Essentials'),
                createBullet('Medication reconciliation at discharge'),
                createBullet('Clear follow-up appointments scheduled'),
                createBullet('Patient/caregiver education completed'),
                createBullet('Warning signs reviewed'),
                createBullet('DME orders placed'),
                createBullet('Home safety evaluation if indicated', 0, { after: 300 }),

                // ========== FOLLOW-UP ==========
                createSectionHeader('11. Follow-up & Monitoring Plan'),
                createSubHeader('Short-term Follow-up (1-2 weeks)'),
                createBullet('Medication tolerance/efficacy assessment'),
                createBullet('Vital signs and symptom monitoring'),
                createBullet('Laboratory follow-up as indicated'),
                createSubHeader('Long-term Monitoring'),
                createBullet('Functional status reassessment'),
                createBullet('Cognitive screening at intervals'),
                createBullet('Annual comprehensive medication review'),
                createBullet('Preventive care and immunizations'),
                createBullet('Goals of care discussions', 0, { after: 300 }),

                // ========== REFERENCES ==========
                createSectionHeader('12. Clinical Guidelines & References'),
                new Paragraph({
                    children: [
                        new TextRun({ text: '1. ', bold: true }),
                        new TextRun('2023 AGS Beers Criteria Update Expert Panel. '),
                        new TextRun({ text: 'American Geriatrics Society 2023 updated AGS Beers Criteria for potentially inappropriate medication use in older adults. ', italics: true }),
                        new TextRun('J Am Geriatr Soc. 2023;71(7):2052-2081.')
                    ],
                    spacing: { after: 120 }
                }),
                new Paragraph({
                    children: [
                        new TextRun({ text: '2. ', bold: true }),
                        new TextRun('O\'Mahony D, O\'Sullivan D, Byrne S, et al. '),
                        new TextRun({ text: 'STOPP/START criteria for potentially inappropriate prescribing in older people: version 2. ', italics: true }),
                        new TextRun('Age Ageing. 2015;44(2):213-218.')
                    ],
                    spacing: { after: 120 }
                }),
                new Paragraph({
                    children: [
                        new TextRun({ text: '3. ', bold: true }),
                        new TextRun('Ellis G, Whitehead MA, Robinson D, et al. '),
                        new TextRun({ text: 'Comprehensive geriatric assessment for older adults admitted to hospital: meta-analysis of randomised controlled trials. ', italics: true }),
                        new TextRun('BMJ. 2011;343:d6553.')
                    ],
                    spacing: { after: 120 }
                }),
                new Paragraph({
                    children: [
                        new TextRun({ text: '4. ', bold: true }),
                        new TextRun('Rockwood K, Song X, MacKnight C, et al. '),
                        new TextRun({ text: 'A global clinical measure of fitness and frailty in elderly people. ', italics: true }),
                        new TextRun('CMAJ. 2005;173(5):489-495.')
                    ],
                    spacing: { after: 120 }
                }),
                new Paragraph({
                    children: [
                        new TextRun({ text: '5. ', bold: true }),
                        new TextRun('Inouye SK, van Dyck CH, Alessi CA, et al. '),
                        new TextRun({ text: 'Clarifying confusion: the confusion assessment method. A new method for detection of delirium. ', italics: true }),
                        new TextRun('Ann Intern Med. 1990;113(12):941-948.')
                    ],
                    spacing: { after: 120 }
                }),
                new Paragraph({
                    children: [
                        new TextRun({ text: '6. ', bold: true }),
                        new TextRun('Inouye SK, Bogardus ST Jr, Baker DI, et al. '),
                        new TextRun({ text: 'The Hospital Elder Life Program: a model of care to prevent cognitive and functional decline in older hospitalized patients. ', italics: true }),
                        new TextRun('J Am Geriatr Soc. 2000;48(12):1697-1706.')
                    ],
                    spacing: { after: 120 }
                }),
                new Paragraph({
                    children: [
                        new TextRun({ text: '7. ', bold: true }),
                        new TextRun('Panel on Prevention of Falls in Older Persons, American Geriatrics Society and British Geriatrics Society. '),
                        new TextRun({ text: 'Summary of the Updated American Geriatrics Society/British Geriatrics Society clinical practice guideline for prevention of falls in older persons. ', italics: true }),
                        new TextRun('J Am Geriatr Soc. 2011;59(1):148-157.')
                    ],
                    spacing: { after: 120 }
                }),
                new Paragraph({
                    children: [
                        new TextRun({ text: '8. ', bold: true }),
                        new TextRun('Fick DM, Semla TP, Steinman M, et al. '),
                        new TextRun({ text: 'American Geriatrics Society 2019 Updated AGS Beers Criteria for Potentially Inappropriate Medication Use in Older Adults. ', italics: true }),
                        new TextRun('J Am Geriatr Soc. 2019;67(4):674-694.')
                    ],
                    spacing: { after: 400 }
                }),

                // ========== FOOTER ==========
                new Paragraph({
                    children: [
                        new TextRun({ text: '---', color: 'cccccc' })
                    ],
                    alignment: AlignmentType.CENTER,
                    spacing: { before: 400, after: 200 }
                }),
                new Paragraph({
                    children: [
                        new TextRun({ text: 'Document generated by SZMC Geriatrics Pro | ', size: 18, color: '95a5a6' }),
                        new TextRun({ text: currentDate, size: 18, color: '95a5a6' })
                    ],
                    alignment: AlignmentType.CENTER
                })
            ];

            // Create document with proper settings
            const doc = new Document({
                creator: 'SZMC Geriatrics Pro',
                title: `Geriatric Case Report - ${initials}`,
                description: 'Comprehensive Geriatric Assessment Report',
                sections: [{
                    properties: {
                        page: {
                            margin: {
                                top: 1440, // 1 inch
                                right: 1440,
                                bottom: 1440,
                                left: 1440
                            }
                        }
                    },
                    children: children
                }]
            });

            // Generate and download with proper MIME type
            const blob = await Packer.toBlob(doc);

            // Create proper download link
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            const docInitials = initials !== 'N/A' ? initials.trim() : 'export';
            link.download = `Case_${docInitials}.docx`;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();

            // Cleanup
            setTimeout(() => {
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }, 100);

            console.log('Comprehensive DOCX export completed successfully');
        } catch(e) {
            console.error('DOCX export failed:', e);
            console.error('Error details:', e.stack);
            alert("DOCX Export Error: " + e.message + "\n\nFalling back to RTF export...");
            exportDOCLegacy();
        }
    }

    // Legacy DOC export (RTF-based, more compatible fallback)
    function exportDOCLegacy() {
        console.log('Starting RTF-based DOC export...');
        try {
            // Validate minimum required data
            if (!getVal('age_sex').trim() && !getVal('hpi').trim()) {
                alert('Please add some patient data before exporting.');
                return;
            }

            // Enhanced sanitization for RTF
            const rtfSanitize = (text) => {
                if (!text || typeof text !== 'string') return '';
                return text
                    .replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '') // Control chars
                    .replace(/\\/g, '\\\\') // Escape backslashes
                    .replace(/\{/g, '\\{') // Escape braces
                    .replace(/\}/g, '\\}')
                    .replace(/\n/g, '\\par\n') // Line breaks to RTF paragraphs
                    .replace(/[^\x00-\x7F]/g, (char) => { // Unicode to RTF
                        const code = char.charCodeAt(0);
                        return `\\u${code}?`;
                    });
            };

            // Get sanitized data
            const ageSex = rtfSanitize(getVal('age_sex')) || 'Not specified';
            const initials = rtfSanitize(getVal('initials')) || 'N/A';
            const hpi = rtfSanitize(getVal('hpi')) || 'Not documented';
            const meds = rtfSanitize(getVal('meds')) || 'Not documented';
            const aiText = rtfSanitize(getVal('ai-response')) || 'Pending clinical analysis';
            const currentDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            // RTF document with proper header
            const rtf = `{\\rtf1\\ansi\\ansicpg1252\\deff0\\deflang1033
{\\fonttbl{\\f0\\fswiss\\fcharset0 Arial;}{\\f1\\fmodern\\fcharset0 Courier New;}}
{\\colortbl;\\red44\\green62\\blue80;\\red39\\green174\\blue96;\\red192\\green57\\blue43;\\red127\\green140\\blue141;}
\\viewkind4\\uc1\\pard\\qc\\b\\f0\\fs44\\cf1 GERIATRIC CASE REPORT\\par
\\fs24\\b0\\cf4\\i Comprehensive Geriatric Assessment\\i0\\par
\\par
\\b Patient: \\b0 ${ageSex} (${initials})\\par
\\b Date: \\b0 ${currentDate}\\par
\\par
\\pard\\ql
\\par
\\b\\fs28\\cf2 1. Patient Demographics\\b0\\fs22\\cf0\\par
\\b Age/Sex: \\b0 ${ageSex}\\par
\\b Patient ID: \\b0 ${initials}\\par
\\b Assessment: \\b0 Comprehensive Geriatric Assessment (CGA)\\par
\\par
\\b\\fs28\\cf2 2. Chief Complaint & History of Present Illness\\b0\\fs22\\cf0\\par
${hpi}\\par
\\par
\\b\\fs28\\cf2 3. Current Medications & Labs\\b0\\fs22\\cf0\\par
${meds}\\par
\\par
\\b\\fs28\\cf3 4. Medication Safety Review\\b0\\fs22\\cf0\\par
\\bullet  AGS Beers Criteria Assessment\\par
\\bullet  STOPP/START Criteria Review\\par
\\bullet  Drug-Drug Interactions\\par
\\bullet  Renal Dosing Adjustments\\par
\\bullet  Anticholinergic Burden Score\\par
\\bullet  Fall-Risk Medications\\par
\\par
\\b\\fs28\\cf2 5. Functional & Cognitive Assessment\\b0\\fs22\\cf0\\par
\\b ADLs: \\b0 Bathing, Dressing, Toileting, Transferring, Continence, Feeding\\par
\\b IADLs: \\b0 Shopping, Cooking, Medications, Finances, Transportation\\par
\\b Cognitive: \\b0 MMSE/MoCA, CAM for delirium\\par
\\b Mood: \\b0 GDS-15 screening\\par
\\par
\\b\\fs28\\cf1 6. Clinical Assessment & Analysis\\b0\\fs22\\cf0\\par
${aiText}\\par
\\par
\\b\\fs28\\cf2 7. Management Plan\\b0\\fs22\\cf0\\par
\\b Pharmacological:\\b0\\par
\\bullet  Medication optimization\\par
\\bullet  Deprescribing strategy\\par
\\bullet  Dose adjustments for organ function\\par
\\b Non-Pharmacological:\\b0\\par
\\bullet  Physical Therapy\\par
\\bullet  Occupational Therapy\\par
\\bullet  Nutrition support\\par
\\bullet  Social work coordination\\par
\\par
\\b\\fs28\\cf3 8. Safety & Risk Management\\b0\\fs22\\cf0\\par
\\bullet  Fall prevention protocol\\par
\\bullet  Delirium prevention (HELP)\\par
\\bullet  Pressure injury prevention\\par
\\bullet  Caregiver support\\par
\\par
\\b\\fs28\\cf2 9. Discharge Planning\\b0\\fs22\\cf0\\par
\\bullet  Disposition planning\\par
\\bullet  Medication reconciliation\\par
\\bullet  Follow-up appointments\\par
\\bullet  Patient/family education\\par
\\bullet  Home safety evaluation\\par
\\par
\\b\\fs28\\cf1 10. Clinical References\\b0\\fs22\\cf0\\par
1. AGS Beers Criteria (2023) - J Am Geriatr Soc\\par
2. STOPP/START Criteria v2 - Age Ageing 2015\\par
3. CGA Guidelines - BMJ 2011\\par
4. Clinical Frailty Scale - CMAJ 2005\\par
5. CAM Method - Ann Intern Med 1990\\par
\\par
\\pard\\qc\\cf4\\fs18 ---\\par
Generated by SZMC Geriatrics Pro | ${currentDate}\\par
}`;

            // Create blob with RTF MIME type
            const blob = new Blob([rtf], {
                type: 'application/rtf'
            });

            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            const cleanInitials = getVal('initials').replace(/[^a-zA-Z0-9]/g, '') || 'export';
            link.download = `Case_${cleanInitials}.rtf`;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();

            // Cleanup
            setTimeout(() => {
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }, 100);

            console.log('RTF DOC export completed successfully');
        } catch(e) {
            console.error('RTF export failed:', e);
            alert("DOC Export Error: " + e.message);
        }
    }

    // --- 5. CLEAR FORM ---
    function clearForm() {
        if (confirm('Are you sure you want to clear all form data? This cannot be undone.')) {
            FORM_FIELDS.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            // Clear localStorage
            localStorage.removeItem(STORAGE_KEY);
            alert('Form cleared successfully!');
        }
    }

    // --- 6. EXPORT TO JSON ---
    function exportJSON() {
        try {
            const data = {
                ageSex: getVal('age_sex'),
                initials: getVal('initials'),
                hpi: getVal('hpi'),
                meds: getVal('meds'),
                aiResponse: getVal('ai-response'),
                rawText: getVal('raw-text'),
                exportDate: new Date().toISOString(),
                version: APP_VERSION
            };

            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            const jsonInitials = getVal('initials').trim() || 'export';
            link.download = `Case_${jsonInitials}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            console.log('JSON export completed successfully');
        } catch(e) {
            console.error('JSON export failed:', e);
            alert("JSON Export Error: " + e.message);
        }
    }

    // --- 7. KEYBOARD SHORTCUTS ---
    document.addEventListener('keydown', (e) => {
        // Ctrl/Cmd + G to generate prompt
        if ((e.ctrlKey || e.metaKey) && e.key === 'g') {
            e.preventDefault();
            generateMagicPrompt();
        }
        // Ctrl/Cmd + E to export PPTX
        if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
            e.preventDefault();
            exportPPT();
        }
        // Ctrl/Cmd + Shift + E to export DOC
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'E') {
            e.preventDefault();
            exportDOC();
        }
    });
</script>
</body>
</html>
