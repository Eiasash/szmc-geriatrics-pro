<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SZMC Geriatrics Pro</title>
  <meta name="description" content="Geriatric Case Presentation Tool for Shaare Zedek Medical Center">
  <meta name="theme-color" content="#2563eb">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü©∫</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- File parsing libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
  <script>
    // Set PDF.js worker
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
  </script>
  <style>
    * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, sans-serif; overscroll-behavior: none; }
    .rtl { direction: rtl; text-align: right; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .animate-pulse { animation: pulse 2s infinite; }
    .animate-slideUp { animation: slideUp 0.3s ease-out; }
    .animate-fadeIn { animation: fadeIn 0.2s ease-out; }
    .modal-content { animation: slideUp 0.3s ease-out; }
    input, textarea, select { font-size: 16px !important; }
    .typing span { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #94a3b8; margin: 0 2px; animation: pulse 1s infinite; }
    .typing span:nth-child(2) { animation-delay: 0.2s; }
    .typing span:nth-child(3) { animation-delay: 0.4s; }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom, 20px); }
    .gradient-szmc { background: linear-gradient(135deg, #1e40af 0%, #7c3aed 100%); }
    .glass { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); }
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
  </style>
</head>
<body class="bg-slate-100 min-h-screen">
  <div id="app"></div>

  <script>
    // ============ SZMC GERIATRICS PRO v4.0 ============
    const VERSION = '5.3';
    
    // State
    let state = {
      view: 'home', // home, editor, present, calc, ref, ai
      pres: null,
      slide: 0,
      saved: [],
      editing: null,
      showAI: false,
      aiChat: [],
      aiInput: '',
      aiLoading: false,
      apiKey: '',
      showSettings: false,
      showImport: false,
      importText: '',
      showExport: false,
      showCalc: false,
      calcType: 'crcl',
      calcIn: {},
      calcRes: null,
      showDrugs: false,
      showLabs: false,
      showEmergency: false,
      showTemplates: false,
      presentMode: false,
      timer: 0,
      timerOn: false,
      darkMode: false,
      recentAction: null,
      // Enhanced AI features
      aiHistory: [],
      aiTemplates: [],
      aiCategory: 'clinical',
      showAIHistory: false,
      showAITemplates: false,
      isListening: false,
      patientContext: null,
      // AI assistant state
      lastAIContent: null,
      showApplyPanel: false,
      aiTargetSlide: 0,
      aiTargetField: 'items',
      editableAIContent: '',
      lastEvidenceId: null,
      // QA + API helpers
      showQA: false,
      qaResults: null,
      apiStatus: null
    };

    // Load saved data
    try {
      const saved = localStorage.getItem('szmc-pro-v4');
      if (saved) {
        const data = JSON.parse(saved);
        state.saved = data.presentations || [];
        state.apiKey = data.apiKey || '';
        state.darkMode = data.darkMode || false;
        state.aiHistory = data.aiHistory || [];
        state.aiTemplates = data.aiTemplates || [];
        state.lastEvidenceId = data.lastEvidenceId || null;
      }
    } catch(e) { console.error('Load error:', e); }

    // Save to storage
    function save() {
      try {
        localStorage.setItem('szmc-pro-v4', JSON.stringify({
          presentations: state.saved,
          apiKey: state.apiKey,
          darkMode: state.darkMode,
          aiHistory: state.aiHistory.slice(-50), // Keep last 50 conversations
          aiTemplates: state.aiTemplates,
          lastEvidenceId: state.lastEvidenceId
        }));
      } catch(e) { console.error('Save error:', e); }
    }

    const EVIDENCE_LIBRARY = [
      {
        id: 'delirium2024',
        title: 'Delirium (AGS 2024 & PADIS updated)',
        year: '2024',
        summary: 'Emphasize multicomponent prevention, early mobilization, sleep hygiene, and judicious use of antipsychotics only for severe distress or safety. Incorporate CAM-ICU/CAM for monitoring and medication stewardship (avoid benzos/anticholinergics).',
        keyPoints: [
          'Use DIMS-VOID screen for precipitants and treat pain, infection, and withdrawal aggressively',
          'Prioritize non-pharmacologic bundle: orientation cues, glasses/hearing aids, mobilization 3x/day, quiet nights',
          'Reserve low-dose antipsychotics for immediate risk; reassess daily and de-escalate',
          'Document baseline cognition and functional trajectory to guide disposition and goals-of-care'
        ],
        sources: 'AGS Guidelines 2023/2024; PADIS ICU updates'
      },
      {
        id: 'falls2024',
        title: 'Falls & Mobility (AGS/BGS 2024)',
        year: '2024',
        summary: 'Risk stratification should integrate orthostatics, medication burden, vision/hearing, and home hazards. Exercise + strength/balance training (OTAGO/Tai Chi) with vitamin D for deficiency and deprescribing sedatives.' ,
        keyPoints: [
          'Orthostatic vitals on admission and after medication changes',
          'Deprescribe high-risk meds: benzos, Z-drugs, anticholinergics, alpha-blockers, rapid antihypertensives',
          'PT/OT assessment within 48h; add hip protectors and assistive device training when recurrent falls',
          'Address sarcopenia with protein 1.2‚Äì1.5g/kg/day and resistance work 2‚Äì3x/week'
        ],
        sources: 'AGS Clinical Practice 2024; British Geriatrics Society Falls Update'
      },
      {
        id: 'osteoporosis2025',
        title: 'Fragility Fractures & Osteoporosis',
        year: '2025',
        summary: 'Post-fracture secondary prevention should be initiated in-hospital when possible. Choose parenteral bisphosphonate or anabolic therapy for very high risk; reassess after 3-5 years; ensure calcium/vit D repletion and fall mitigation.',
        keyPoints: [
          'T-score ‚â§ -2.5 or FRAX major ‚â•20%/hip ‚â•3% warrants therapy; consider anabolic agent if multiple fragility fractures',
          'Renal dosing: avoid IV zoledronic acid if eGFR <35; consider denosumab with hypocalcemia monitoring',
          'Start calcium 1200mg elemental + vitamin D3 800-1000 IU/day unless contraindicated',
          'Plan drug holiday after 3-5y of bisphosphonates if low-moderate risk; continue if very high risk'
        ],
        sources: 'Endocrine Society 2024 addendum; IOF 2025 position statement'
      },
      {
        id: 'afib2024',
        title: 'Atrial Fibrillation in Older Adults',
        year: '2024',
        summary: 'Stroke prevention prioritized unless absolute contraindication. Prefer DOACs with creatinine clearance-based dosing; integrate CHA‚ÇÇDS‚ÇÇ-VASc, HAS-BLED, and frailty to personalize therapy.',
        keyPoints: [
          'Use DOAC dose adjustments: apixaban 2.5mg BID if ‚â•2 of age ‚â•80, weight ‚â§60kg, Cr ‚â•1.5; avoid underdosing',
          'Falls risk alone rarely outweighs anticoag benefit; pair with fall prevention bundle',
          'Rate control first-line; cautious beta-blocker/CCB titration with orthostatic monitoring',
          'Consider left atrial appendage occlusion when anticoagulation contraindicated'
        ],
        sources: 'ACC/AHA/ACCP/HRS 2023/2024 updates'
      },
      {
        id: 'uti2025',
        title: 'UTI & Antimicrobial Stewardship',
        year: '2025',
        summary: 'Avoid treating asymptomatic bacteriuria except pregnancy/urologic procedures. Narrow antibiotics to 5‚Äì7 days for uncomplicated lower UTI; avoid fluoroquinolones when safer options exist; dose-adjust for renal function.',
        keyPoints: [
          'Confirm symptoms (dysuria, frequency, urgency) + UA before treating; avoid culture for asymptomatic patients',
          'Use nitrofurantoin if eGFR ‚â•30; avoid for pyelonephritis or poor renal function',
          'Document stewardship plan: start-narrow-stop with reassessment at 48-72h',
          'Hydration, catheter review/removal, and delirium monitoring in inpatients'
        ],
        sources: 'IDSA 2024 stewardship pathways; NICE 2025 UTI update'
      },
      {
        id: 'hfpef2025',
        title: 'Heart Failure (HFpEF/HFrEF updates)',
        year: '2025',
        summary: 'Use SGLT2 inhibitors for nearly all symptomatic HF unless contraindicated, prioritize GDMT uptitration with geriatric monitoring (renal function, BP, orthostasis), and pair diuresis with daily weights and electrolytes.',
        keyPoints: [
          'Start SGLT2i even with preserved EF unless eGFR <20‚Äì25; watch volume status and genital infections',
          'Titrate ARNI/ACEi/ARB and beta-blockers slowly; pause if SBP <95 or symptomatic hypotension',
          'Mineralocorticoid receptor antagonists: monitor K and Cr at 2-3 days, 1 week, monthly x3, then q3mo',
          'Encourage low-sodium patterns, compression for edema, and daily weights with action thresholds'
        ],
        sources: 'AHA/ACC/HFSA 2024-2025 guidance; ESC HF update'
      },
      {
        id: 'palliative2024',
        title: 'Serious Illness & Palliation',
        year: '2024',
        summary: 'Integrate serious-illness communication early, pair symptom control (pain, dyspnea, delirium) with deprescribing, and document goals that drive disposition and code status.',
        keyPoints: [
          'Use Ask-Tell-Ask and NURSE statements; confirm decision-makers and advance directives',
          'Prioritize non-opioid + low-dose opioid titration for pain; bowel regimens with any opioid',
          'For dyspnea: fan/positioning, low-dose opioids, and treat reversible drivers (PE, HF, anemia)',
          'Deprescribe non-beneficial statins, vitamins, and duplicative preventive meds when life expectancy limited'
        ],
        sources: 'CAPC/ASCO serious illness frameworks 2024; WHO pain ladder updates'
      }
    ];

    // ============ TEMPLATES ============
    const templates = {
      case: {
        name: 'ü©∫ Case Presentation',
        desc: '13 slides for clinical cases',
        slides: [
          { type: 'title', title: 'Case Presentation', subtitle: '', presenter: '', date: new Date().toLocaleDateString('en-IL') },
          { type: 'patient', title: 'Patient', demographics: '', cc: '', codeStatus: '' },
          { type: 'content', title: 'HPI', content: '' },
          { type: 'list', title: 'PMH / PSH', items: [] },
          { type: 'list', title: 'Medications', items: [] },
          { type: 'exam', title: 'Physical Exam', vitals: {}, findings: '' },
          { type: 'list', title: 'Labs', items: [] },
          { type: 'content', title: 'Imaging', content: '' },
          { type: 'scores', title: 'Geriatric Assessment', scores: {} },
          { type: 'list', title: 'Differential Diagnosis', items: [] },
          { type: 'content', title: 'Final Diagnosis', content: '' },
          { type: 'treatment', title: 'Management', pharm: '', nonpharm: '' },
          { type: 'list', title: 'Teaching Points', items: [] }
        ]
      },
      consult: {
        name: 'üìã Consult Note',
        desc: '8 slides for consultations',
        slides: [
          { type: 'title', title: 'Geriatrics Consultation', subtitle: '', presenter: '', date: new Date().toLocaleDateString('en-IL') },
          { type: 'patient', title: 'Patient', demographics: '', cc: '' },
          { type: 'content', title: 'Reason for Consult', content: '' },
          { type: 'content', title: 'Brief History', content: '' },
          { type: 'scores', title: 'Geriatric Assessment', scores: {} },
          { type: 'list', title: 'Problems Identified', items: [] },
          { type: 'list', title: 'Recommendations', items: [] },
          { type: 'content', title: 'Follow-up Plan', content: '' }
        ]
      },
      morning: {
        name: '‚òÄÔ∏è Morning Report',
        desc: '6 slides for teaching',
        slides: [
          { type: 'title', title: 'Morning Report', subtitle: '', presenter: '', date: new Date().toLocaleDateString('en-IL') },
          { type: 'patient', title: 'Case Summary', demographics: '', cc: '' },
          { type: 'content', title: 'Clinical Question', content: '' },
          { type: 'list', title: 'Key Points', items: [] },
          { type: 'content', title: 'Evidence', content: '' },
          { type: 'list', title: 'Take-home Messages', items: [] }
        ]
      }
    };

    // ============ CLINICAL KNOWLEDGE DATABASE ============
    const KNOWLEDGE = {
      // DRUG INTERACTIONS - HIGH YIELD
      interactions: [
        { drugs: 'Warfarin + NSAIDs', risk: 'Major GI bleed (3-6x risk)', action: 'Avoid. Use acetaminophen.' },
        { drugs: 'ACEi/ARB + K-sparing diuretics', risk: 'Severe hyperkalemia', action: 'Monitor K closely, avoid if CKD' },
        { drugs: 'Metformin + IV contrast', risk: 'Lactic acidosis (rare but fatal)', action: 'Hold 48h, check Cr before restart' },
        { drugs: 'Fluoroquinolones + QT drugs', risk: 'Torsades de pointes', action: 'Avoid combo, monitor QTc' },
        { drugs: 'SSRIs + Triptans', risk: 'Serotonin syndrome', action: 'Use with caution, educate patient' },
        { drugs: 'Clarithromycin + Statins', risk: 'Rhabdomyolysis', action: 'Hold statin or use azithromycin' },
        { drugs: 'Methotrexate + TMP-SMX', risk: 'Bone marrow suppression', action: 'Avoid - use alternative abx' },
        { drugs: 'Lithium + NSAIDs/ACEi/diuretics', risk: 'Lithium toxicity', action: 'Monitor levels, avoid if possible' },
        { drugs: 'Digoxin + Amiodarone', risk: 'Digoxin toxicity', action: 'Reduce digoxin dose 50%' },
        { drugs: 'Clopidogrel + PPIs', risk: 'Reduced antiplatelet effect', action: 'Use pantoprazole if needed' },
        { drugs: 'Warfarin + Abx (any)', risk: 'INR changes', action: 'Check INR in 3-5 days' },
        { drugs: 'Potassium + ACEi + Spironolactone', risk: 'Life-threatening hyperK', action: 'Triple whammy - avoid' }
      ],

      // RENAL DOSING - COMMON DRUGS
      renalDosing: [
        { drug: 'Metformin', normal: '500-1000mg BID', gfr60: 'Max 1000mg/day', gfr30: 'AVOID', gfr15: 'CONTRAINDICATED' },
        { drug: 'Gabapentin', normal: '300-600mg TID', gfr60: '200-300mg TID', gfr30: '100-300mg BID', gfr15: '100-300mg daily' },
        { drug: 'Enoxaparin (tx)', normal: '1mg/kg BID', gfr60: 'No change', gfr30: '1mg/kg DAILY', gfr15: 'Use UFH' },
        { drug: 'Ciprofloxacin', normal: '500mg BID', gfr60: 'No change', gfr30: '250-500mg q12-24h', gfr15: '250mg q18-24h' },
        { drug: 'Levofloxacin', normal: '750mg daily', gfr60: 'No change', gfr30: '750mg q48h', gfr15: '500mg q48h' },
        { drug: 'Vancomycin', normal: '15-20mg/kg q8-12h', gfr60: 'q12h', gfr30: 'q24h', gfr15: 'q48-72h + levels' },
        { drug: 'Gentamicin', normal: '5-7mg/kg daily', gfr60: 'Extend interval', gfr30: 'q24-48h + levels', gfr15: 'Avoid if possible' },
        { drug: 'Morphine', normal: 'Standard dosing', gfr60: 'Reduce 25%', gfr30: 'Reduce 50%', gfr15: 'Avoid - active metabolites' },
        { drug: 'Colchicine (acute)', normal: '1.2mg then 0.6mg', gfr60: 'No change', gfr30: '0.6mg x1, no repeat x14d', gfr15: '0.3mg x1' },
        { drug: 'Allopurinol', normal: '300mg daily', gfr60: '200mg daily', gfr30: '100mg daily', gfr15: '100mg q48h' },
        { drug: 'Dabigatran', normal: '150mg BID', gfr60: 'No change', gfr30: '75mg BID', gfr15: 'AVOID' },
        { drug: 'Apixaban', normal: '5mg BID', gfr60: 'No change', gfr30: 'No change*', gfr15: '2.5mg BID if HD' },
        { drug: 'Rivaroxaban', normal: '20mg daily', gfr60: 'No change', gfr30: '15mg daily', gfr15: 'AVOID' }
      ],

      // CRITICAL VALUES
      criticalLabs: [
        { test: 'Potassium', critical: '<2.5 or >6.5', action: 'STAT ECG, treat immediately' },
        { test: 'Sodium', critical: '<120 or >160', action: 'Slow correction (0.5 mEq/L/hr), avoid ODS' },
        { test: 'Glucose', critical: '<50 or >500', action: 'D50 or insulin, check gap' },
        { test: 'Calcium (total)', critical: '<6.5 or >13', action: 'ECG, IV calcium gluconate or fluids+bisphosphonate' },
        { test: 'Magnesium', critical: '<1.0 or >4.0', action: 'IV Mg or hold Mg/dialysis' },
        { test: 'pH', critical: '<7.2 or >7.6', action: 'ABG, treat underlying cause' },
        { test: 'Lactate', critical: '>4', action: 'Sepsis workup, fluid resuscitation' },
        { test: 'Troponin', critical: 'Any elevation', action: 'ACS protocol, cardiology consult' },
        { test: 'Hemoglobin', critical: '<7 (or <8 if ACS)', action: 'Type & screen, transfuse' },
        { test: 'Platelets', critical: '<20 or >1000', action: 'Hold procedures, heme consult' },
        { test: 'INR', critical: '>5 (or any if bleeding)', action: 'Hold warfarin, Vit K, consider PCC' },
        { test: 'WBC', critical: '<1.0 or >30', action: 'Neutropenic precautions or leukocytosis workup' }
      ],

      // COMPREHENSIVE LAB REFERENCE
      labs: {
        cbc: [
          { test: 'WBC', normal: '4.5-11.0', unit: '√ó10‚Åπ/L', high: 'Infection, inflammation, leukemia, stress', low: 'Bone marrow suppression, sepsis, viral' },
          { test: 'Hemoglobin', normal: 'M:13.5-17.5, F:12-16', unit: 'g/dL', high: 'Polycythemia, dehydration', low: 'Anemia - check MCV' },
          { test: 'Platelets', normal: '150-400', unit: '√ó10‚Åπ/L', high: 'Reactive, myeloproliferative', low: 'ITP, TTP, HIT, marrow failure' },
          { test: 'MCV', normal: '80-100', unit: 'fL', high: 'B12/folate def, alcohol, hypothyroid', low: 'Iron def, thalassemia, chronic disease' },
          { test: 'RDW', normal: '11.5-14.5', unit: '%', high: 'Mixed deficiency, early iron def', low: 'Usually normal' }
        ],
        bmp: [
          { test: 'Sodium', normal: '136-145', unit: 'mEq/L', high: 'Dehydration, DI, salt excess', low: 'SIADH, CHF, cirrhosis, diuretics' },
          { test: 'Potassium', normal: '3.5-5.0', unit: 'mEq/L', high: 'AKI, ACEi, K-sparing, hemolysis', low: 'Diuretics, GI loss, alkalosis' },
          { test: 'Chloride', normal: '98-106', unit: 'mEq/L', high: 'Non-AG acidosis, dehydration', low: 'Vomiting, diuretics' },
          { test: 'Bicarb (CO2)', normal: '22-29', unit: 'mEq/L', high: 'Metabolic alkalosis, compensation', low: 'Metabolic acidosis' },
          { test: 'BUN', normal: '7-20', unit: 'mg/dL', high: 'Dehydration, GI bleed, AKI', low: 'Liver disease, malnutrition' },
          { test: 'Creatinine', normal: '0.7-1.3', unit: 'mg/dL', high: 'AKI, CKD', low: 'Low muscle mass' },
          { test: 'Glucose', normal: '70-100', unit: 'mg/dL', high: 'DM, stress, steroids', low: 'Insulin excess, sepsis, liver failure' }
        ],
        lft: [
          { test: 'AST', normal: '10-40', unit: 'U/L', high: 'Hepatocellular injury, MI, muscle', pattern: 'AST>ALT = alcohol, cirrhosis' },
          { test: 'ALT', normal: '7-56', unit: 'U/L', high: 'Hepatocellular injury (more specific)', pattern: 'ALT>AST = viral, NAFLD' },
          { test: 'Alk Phos', normal: '44-147', unit: 'U/L', high: 'Cholestasis, bone disease', pattern: 'With GGT = liver; alone = bone' },
          { test: 'Bilirubin (total)', normal: '0.1-1.2', unit: 'mg/dL', high: 'Hemolysis (indirect), obstruction (direct)', pattern: 'Check direct/indirect ratio' },
          { test: 'Albumin', normal: '3.5-5.0', unit: 'g/dL', low: 'Liver disease, malnutrition, inflammation', pattern: 'Chronic marker, t¬Ω = 20 days' },
          { test: 'GGT', normal: '9-48', unit: 'U/L', high: 'Cholestasis, alcohol, enzyme induction', pattern: 'Confirms hepatic source of ALP' }
        ],
        coags: [
          { test: 'PT/INR', normal: '11-13.5s / 0.9-1.1', use: 'Extrinsic path, warfarin monitoring', high: 'Warfarin, liver disease, Vit K def' },
          { test: 'PTT', normal: '25-35s', use: 'Intrinsic path, heparin monitoring', high: 'Heparin, factor deficiency, lupus anticoag' },
          { test: 'Fibrinogen', normal: '200-400', unit: 'mg/dL', low: 'DIC, liver failure', high: 'Acute phase reactant' },
          { test: 'D-dimer', normal: '<500', unit: 'ng/mL', high: 'VTE, DIC, inflammation, post-op', note: 'Age-adjusted: age √ó 10 if >50' }
        ],
        cardiac: [
          { test: 'Troponin', normal: '<0.04', unit: 'ng/mL', high: 'MI, PE, myocarditis, renal failure', timing: 'Rises 3-6h, peaks 12-24h' },
          { test: 'BNP', normal: '<100', unit: 'pg/mL', high: 'CHF, cor pulmonale, ACS', low: 'Obesity falsely lowers', gray: '100-400 = gray zone' },
          { test: 'NT-proBNP', normal: '<300', unit: 'pg/mL', high: 'CHF (more sensitive in elderly/CKD)', note: 'Age-adjusted cutoffs exist' }
        ],
        thyroid: [
          { test: 'TSH', normal: '0.4-4.0', unit: 'mIU/L', high: 'Primary hypothyroid', low: 'Hyperthyroid, pituitary disease' },
          { test: 'Free T4', normal: '0.8-1.8', unit: 'ng/dL', note: 'Interpret with TSH', pattern: 'Low TSH + High T4 = hyperthyroid' },
          { test: 'Free T3', normal: '2.3-4.2', unit: 'pg/mL', note: 'Most active form', pattern: 'Check in hyperthyroid workup' }
        ],
        other: [
          { test: 'Lactate', normal: '<2.0', unit: 'mmol/L', high: 'Sepsis, hypoperfusion, metformin', action: '>4 = severe, high mortality' },
          { test: 'Procalcitonin', normal: '<0.25', unit: 'ng/mL', high: 'Bacterial infection (not viral)', use: 'Abx stewardship, serial trending' },
          { test: 'CRP', normal: '<10', unit: 'mg/L', high: 'Inflammation, infection', use: 'Non-specific, trend over time' },
          { test: 'ESR', normal: 'M:<15, F:<20', unit: 'mm/hr', high: 'Inflammation, infection, malignancy', note: 'Age/2 (men) or (age+10)/2 (women)' },
          { test: 'Ferritin', normal: '12-300', unit: 'ng/mL', low: 'Iron deficiency', high: 'Inflammation, hemochromatosis, malignancy' },
          { test: 'B12', normal: '200-900', unit: 'pg/mL', low: 'Pernicious anemia, vegan diet, metformin', note: 'Check MMA if borderline' },
          { test: 'Folate', normal: '>3', unit: 'ng/mL', low: 'Malnutrition, alcohol, malabsorption', note: 'RBC folate more accurate' },
          { test: 'Ammonia', normal: '15-45', unit: '¬µg/dL', high: 'Hepatic encephalopathy, urea cycle defects', note: 'Keep on ice, process quickly' }
        ]
      },

      // CLINICAL CALCULATORS FORMULAS
      formulas: {
        anionGap: { formula: 'Na - (Cl + HCO3)', normal: '8-12', note: 'Adjust for albumin: add 2.5 for each 1 g/dL below 4' },
        correctedNa: { formula: 'Na + 0.024 √ó (Glucose - 100)', note: 'For hyperglycemia' },
        correctedCa: { formula: 'Ca + 0.8 √ó (4 - Albumin)', note: 'For hypoalbuminemia' },
        aaGradient: { formula: '(713 √ó FiO2) - (PaCO2/0.8) - PaO2', normal: '<10-15 (age/4 + 4)', note: 'Increased = V/Q mismatch, shunt' },
        fena: { formula: '(UNa √ó PCr) / (PNa √ó UCr) √ó 100', prerenal: '<1%', intrinsic: '>2%', note: 'Invalid if diuretics' },
        feUrea: { formula: '(Urea_urine √ó Cr_plasma) / (Urea_plasma √ó Cr_urine) √ó 100', prerenal: '<35%', note: 'Use if on diuretics' },
        maddrey: { formula: '4.6 √ó (PT - control) + Bilirubin', cutoff: '>32 = severe, consider steroids' },
        meldNa: { formula: 'Complex - use calculator', note: 'Liver transplant priority' },
        chadsvasc: { formula: 'C1 H1 A2 D1 S2 V1 A1 Sc1', max: 9, note: '0=low, 1=low-mod, ‚â•2=anticoagulate' },
        hasbled: { formula: 'H A S B L E D', max: 9, note: '‚â•3 = high bleed risk, caution with anticoag' },
        wellsDVT: { formula: 'Clinical criteria', low: '‚â§0', moderate: '1-2', high: '‚â•3' },
        wellsPE: { formula: 'Clinical criteria', unlikely: '‚â§4', likely: '>4' },
        perc: { formula: '8 criteria - all must be negative', note: 'If all negative, PE ruled out without D-dimer' },
        curb65: { formula: 'C U R B 65', scores: '0-1:outpt, 2:admit, ‚â•3:ICU consider' },
        heart: { formula: 'H E A R T', low: '0-3', mod: '4-6', high: '7-10' },
        timi: { formula: '7 criteria for ACS', risk: 'Higher = more events at 14d' }
      },

      // EMERGENCY PROTOCOLS
      emergencies: [
        { 
          condition: 'Hyperkalemia (K >6.0)',
          ecg: 'Peaked T, wide QRS, sine wave',
          immediate: '1. Calcium gluconate 1g IV (stabilize membrane)\n2. Insulin 10U + D50 (shift K)\n3. Albuterol nebs\n4. Kayexalate or Lokelma\n5. Dialysis if refractory',
          avoid: 'Succinylcholine, K-sparing diuretics'
        },
        {
          condition: 'Hypoglycemia (<70)',
          symptoms: 'Tremor, sweats, confusion, seizure, coma',
          immediate: '1. If conscious: 15-20g fast carbs\n2. If unconscious: D50 25-50mL IV\n3. Glucagon 1mg IM if no IV\n4. Recheck q15min\n5. Identify cause',
          note: 'Goal >100 before meals'
        },
        {
          condition: 'DKA',
          criteria: 'Glucose >250, pH <7.3, HCO3 <18, ketones+',
          immediate: '1. Fluids: NS 1-1.5L/hr √ó 2h\n2. Insulin: 0.1 U/kg/hr\n3. Potassium: add when K <5.3\n4. Monitor q1-2h\n5. Transition when gap closed',
          note: 'Close anion gap, not glucose'
        },
        {
          condition: 'Acute MI (STEMI)',
          immediate: 'MONA-B:\n1. Morphine (if pain)\n2. Oxygen (if SpO2 <90%)\n3. Nitro SL (unless RV infarct)\n4. Aspirin 325mg chewed\n5. P2Y12 inhibitor\n6. Heparin\n7. CATH LAB <90min',
          contraindications: 'Nitro if: SBP<90, RV infarct, PDE5 inhibitor'
        },
        {
          condition: 'Stroke (acute)',
          immediate: '1. Time of onset\n2. NIHSS score\n3. CT head (r/o bleed)\n4. Glucose check\n5. tPA if <4.5h + eligible\n6. Thrombectomy if LVO <24h\n7. BP management',
          tpa_contraindications: 'Recent surgery, bleed, INR>1.7, platelets<100k'
        },
        {
          condition: 'Anaphylaxis',
          immediate: '1. Epinephrine 0.3-0.5mg IM (thigh)\n2. Remove trigger\n3. Fluids\n4. Diphenhydramine 50mg IV\n5. Methylpred 125mg IV\n6. Observe 4-6h (biphasic)\n7. EpiPen rx at discharge',
          note: 'Repeat epi q5-15min if needed'
        },
        {
          condition: 'Sepsis / Septic Shock',
          criteria: 'qSOFA ‚â•2: RR‚â•22, SBP‚â§100, AMS',
          hour1: '1. Lactate\n2. Blood cultures √ó 2\n3. Broad abx\n4. Fluids 30mL/kg if hypotensive\n5. Vasopressors if MAP<65 after fluids',
          note: 'Every hour delay in abx = 7% mortality increase'
        },
        {
          condition: 'GI Bleed (upper)',
          immediate: '1. 2 large bore IVs\n2. Type & cross\n3. Transfuse if Hgb <7 (or <8 if ACS)\n4. PPI drip: 80mg bolus + 8mg/hr\n5. GI consult for EGD\n6. Hold anticoag/antiplatelet',
          risk: 'Glasgow-Blatchford score for disposition'
        },
        {
          condition: 'PE (massive)',
          signs: 'Hypotension, RV strain, elevated troponin',
          immediate: '1. Heparin bolus + drip\n2. Consider thrombolytics\n3. Consider ECMO/embolectomy\n4. Pressors if shock\n5. Avoid fluid overload',
          note: 'Submassive: anticoag + close monitoring'
        }
      ],

      // ANTIBIOTIC GUIDE
      antibiotics: [
        { indication: 'CAP (outpatient)', first: 'Amoxicillin 1g TID or Doxycycline', alt: 'Azithromycin (if no comorbid)', duration: '5 days' },
        { indication: 'CAP (inpatient, non-severe)', first: 'Ceftriaxone + Azithro', alt: 'Levofloxacin 750mg', duration: '5 days' },
        { indication: 'CAP (severe/ICU)', first: 'Ceftriaxone + Azithro + Vanc if MRSA risk', alt: 'Add coverage for Pseudomonas if risk', duration: '7 days' },
        { indication: 'UTI (uncomplicated)', first: 'Nitrofurantoin 100mg BID √ó 5d', alt: 'TMP-SMX √ó 3d, Fosfomycin √ó 1', duration: '3-5 days' },
        { indication: 'UTI (complicated/pyelo)', first: 'Ceftriaxone or Cipro', alt: 'TMP-SMX if susceptible', duration: '7-14 days' },
        { indication: 'Cellulitis (non-purulent)', first: 'Cephalexin 500mg QID', alt: 'Clindamycin if PCN allergy', duration: '5-7 days' },
        { indication: 'Cellulitis (purulent/abscess)', first: 'TMP-SMX or Doxycycline', alt: 'Clindamycin', note: 'I&D is primary treatment' },
        { indication: 'Diverticulitis (uncomplicated)', first: 'Cipro + Metronidazole', alt: 'Augmentin alone', duration: '4-7 days' },
        { indication: 'C. diff (non-severe)', first: 'Vancomycin 125mg PO QID', alt: 'Fidaxomicin', duration: '10 days' },
        { indication: 'C. diff (severe/fulminant)', first: 'Vanc PO + Metronidazole IV', alt: 'Vanc enemas if ileus', note: 'Surgery consult if toxic megacolon' },
        { indication: 'Meningitis (empiric)', first: 'Ceftriaxone + Vanc + Ampicillin (if >50yo)', alt: 'Add Acyclovir if HSV suspected', note: 'Dexamethasone before/with abx' },
        { indication: 'Sepsis (unknown source)', first: 'Vanc + Pip-Tazo or Cefepime', alt: 'Meropenem if ESBL risk', note: 'De-escalate based on cultures' }
      ],

      // COMMON SYNDROMES - DIAGNOSTIC CRITERIA
      syndromes: {
        sirs: { criteria: '‚â•2 of: Temp >38 or <36, HR >90, RR >20 or PaCO2 <32, WBC >12k or <4k or >10% bands' },
        sepsis: { criteria: 'Infection + qSOFA ‚â•2 (RR‚â•22, SBP‚â§100, AMS) or SOFA ‚â•2' },
        ards: { criteria: 'Acute onset, bilateral infiltrates, PaO2/FiO2 ‚â§300, not cardiac' },
        dic: { criteria: 'Low plt + high PT/PTT + high D-dimer + low fibrinogen + schistocytes' },
        hus: { criteria: 'Microangiopathic hemolytic anemia + thrombocytopenia + AKI' },
        ttp: { criteria: 'MAHA + thrombocytopenia + neuro changes + fever + renal (pentad rare)' },
        nms: { criteria: 'Fever + rigidity + AMS + autonomic instability + recent antipsychotic' },
        serotoninSyn: { criteria: 'Agitation + hyperthermia + hyperreflexia + clonus + recent serotonergic drug' },
        hepatorenal: { criteria: 'Cirrhosis + AKI + no improvement with albumin + no shock/nephrotoxins' }
      },

      // GERIATRIC SPECIFICS (keeping some relevant ones)
      geriatrics: {
        beers: [
          { drug: 'Diphenhydramine', risk: 'Confusion, falls, urinary retention', alt: 'Melatonin, trazodone' },
          { drug: 'Benzodiazepines', risk: 'Falls, cognitive impairment, dependence', alt: 'Trazodone, mirtazapine, CBT-I' },
          { drug: 'NSAIDs', risk: 'GI bleed, AKI, CHF exacerbation', alt: 'Acetaminophen, topical NSAIDs' },
          { drug: 'Muscle relaxants', risk: 'Anticholinergic, sedation', alt: 'Physical therapy' },
          { drug: 'PPIs >8 weeks', risk: 'C. diff, fractures, B12 deficiency, hypoMg', alt: 'H2 blocker, step-down' },
          { drug: 'Sliding scale insulin alone', risk: 'Poor control, hypoglycemia', alt: 'Basal-bolus regimen' },
          { drug: 'Sulfonylureas (long-acting)', risk: 'Prolonged hypoglycemia', alt: 'Shorter-acting agents' },
          { drug: 'Anticholinergics', risk: 'Confusion, constipation, urinary retention', alt: 'Minimize anticholinergic burden' }
        ],
        assessments: [
          { name: 'MMSE', cutoff: '‚â§23', interpretation: 'Cognitive impairment' },
          { name: 'MoCA', cutoff: '‚â§25', interpretation: 'Cognitive impairment (+1 if edu<12y)' },
          { name: 'GDS-15', cutoff: '‚â•5', interpretation: 'Depression screen positive' },
          { name: 'PHQ-9', cutoff: '‚â•10', interpretation: 'Moderate depression' },
          { name: 'CAM', cutoff: '1+2+(3or4)', interpretation: 'Delirium positive' },
          { name: '4AT', cutoff: '‚â•4', interpretation: 'Possible delirium' },
          { name: 'Morse', cutoff: '‚â•25', interpretation: 'Fall risk' },
          { name: 'Braden', cutoff: '‚â§18', interpretation: 'Pressure injury risk' },
          { name: 'MNA-SF', cutoff: '<8', interpretation: 'Malnourished' }
        ],
        dosing: [
          { drug: 'Opioids', start: 'Start 25-50% of adult dose', note: 'Titrate slowly, monitor for sedation' },
          { drug: 'Benzodiazepines', start: 'Start 50% of adult dose', note: 'Short-acting preferred (lorazepam)' },
          { drug: 'Antipsychotics', start: 'Start 25-50% of adult dose', note: 'Monitor QTc, EPS risk higher' },
          { drug: 'Antidepressants', start: 'Start 50% of adult dose', note: 'SSRIs preferred, watch for hyponatremia' },
          { drug: 'Anticoagulants', start: 'Standard dosing, adjust for renal/weight', note: 'DOACs may need dose reduction' },
          { drug: 'Antihypertensives', start: 'Start low, titrate slowly', note: 'Target SBP 130-150 in frail elderly' },
          { drug: 'Diabetic medications', start: 'Start conservative, avoid hypoglycemia', note: 'A1c target 7.5-8% in frail' },
          { drug: 'Antibiotics', start: 'Adjust for renal function', note: 'Check CrCl before dosing' },
          { drug: 'Gabapentinoids', start: 'Start 100mg daily, titrate slowly', note: 'Renal adjust, sedation risk' },
          { drug: 'Statins', start: 'Consider lower intensity in >75yo', note: 'Balance benefits vs polypharmacy' }
        ]
      }
    };

    // ============ UTILITY FUNCTIONS ============
    function e(str) {
      if (!str) return '';
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function setState(updates) {
      Object.assign(state, updates);
      render();
    }

    function showToast(msg) {
      state.recentAction = msg;
      render();
      setTimeout(() => { state.recentAction = null; render(); }, 2000);
    }

    // ============ IMPORT FUNCTIONS ============
    function parseJSON(text) {
      try {
        const data = JSON.parse(text);
        // Handle array of presentations
        if (Array.isArray(data)) {
          return data.filter(p => p.slides && Array.isArray(p.slides));
        }
        // Handle single presentation
        if (data.slides && Array.isArray(data.slides)) {
          return [data];
        }
        // Handle just slides array
        if (Array.isArray(data) && data[0]?.type) {
          return [{ id: Date.now(), created: new Date().toISOString(), slides: data }];
        }
        return null;
      } catch(e) { return null; }
    }

    function parseMarkdown(text) {
      const lines = text.split('\n');
      const slides = [];
      let currentSlide = null;
      let contentBuffer = [];

      const flushContent = () => {
        if (currentSlide && contentBuffer.length) {
          const content = contentBuffer.join('\n').trim();
          if (currentSlide.type === 'list') {
            currentSlide.items = content.split('\n').map(l => l.replace(/^[-*‚Ä¢]\s*/, '').trim()).filter(l => l);
          } else {
            currentSlide.content = content;
          }
          contentBuffer = [];
        }
      };

      lines.forEach(line => {
        // H1 = Title slide
        if (line.match(/^#\s+(.+)/)) {
          flushContent();
          if (currentSlide) slides.push(currentSlide);
          currentSlide = { type: 'title', title: line.replace(/^#\s+/, '').trim(), subtitle: '' };
        }
        // H2 = New slide
        else if (line.match(/^##\s+(.+)/)) {
          flushContent();
          if (currentSlide) slides.push(currentSlide);
          const title = line.replace(/^##\s+/, '').trim().toLowerCase();
          let type = 'content';
          if (title.includes('medication') || title.includes('pmh') || title.includes('differential') || title.includes('teaching') || title.includes('lab')) type = 'list';
          else if (title.includes('exam') || title.includes('physical')) type = 'exam';
          else if (title.includes('management') || title.includes('treatment')) type = 'treatment';
          else if (title.includes('assessment') || title.includes('score')) type = 'scores';
          else if (title.includes('patient')) type = 'patient';
          currentSlide = { type, title: line.replace(/^##\s+/, '').trim(), items: [], content: '', vitals: {}, scores: {} };
        }
        // List items
        else if (line.match(/^[-*‚Ä¢]\s+/)) {
          contentBuffer.push(line);
          if (currentSlide && currentSlide.type !== 'list') currentSlide.type = 'list';
        }
        // Regular content
        else if (line.trim()) {
          contentBuffer.push(line);
        }
      });

      flushContent();
      if (currentSlide) slides.push(currentSlide);

      if (slides.length === 0) return null;
      return [{ id: Date.now(), created: new Date().toISOString(), modified: new Date().toISOString(), slides }];
    }

    function parsePlainText(text) {
      // Split by double newlines or common separators
      const sections = text.split(/\n{2,}|={3,}|-{3,}/).filter(s => s.trim());
      if (sections.length === 0) return null;

      const slides = [];
      
      // First section is title
      slides.push({
        type: 'title',
        title: sections[0].split('\n')[0].trim() || 'Imported Case',
        subtitle: sections[0].split('\n').slice(1).join(' ').trim()
      });

      // Process remaining sections
      sections.slice(1).forEach(section => {
        const lines = section.split('\n').filter(l => l.trim());
        if (lines.length === 0) return;

        const firstLine = lines[0].toLowerCase();
        let type = 'content';
        let title = lines[0];

        // Detect slide type from first line
        if (firstLine.includes('hpi') || firstLine.includes('history')) {
          type = 'content'; title = 'HPI';
        } else if (firstLine.includes('medication') || firstLine.includes('med')) {
          type = 'list'; title = 'Medications';
        } else if (firstLine.includes('pmh') || firstLine.includes('past medical')) {
          type = 'list'; title = 'PMH / PSH';
        } else if (firstLine.includes('exam') || firstLine.includes('physical')) {
          type = 'exam'; title = 'Physical Exam';
        } else if (firstLine.includes('lab')) {
          type = 'list'; title = 'Labs';
        } else if (firstLine.includes('differential') || firstLine.includes('ddx')) {
          type = 'list'; title = 'Differential Diagnosis';
        } else if (firstLine.includes('assessment') || firstLine.includes('geriatric')) {
          type = 'scores'; title = 'Geriatric Assessment';
        } else if (firstLine.includes('management') || firstLine.includes('plan') || firstLine.includes('treatment')) {
          type = 'treatment'; title = 'Management';
        } else if (firstLine.includes('teaching') || firstLine.includes('point')) {
          type = 'list'; title = 'Teaching Points';
        } else if (firstLine.includes('patient') || firstLine.match(/^\d+\s*(yo|y\/o|year)/i)) {
          type = 'patient'; title = 'Patient';
        }

        const content = lines.slice(1).join('\n').trim() || lines.join('\n').trim();
        const slide = { type, title };

        if (type === 'list') {
          slide.items = content.split('\n').map(l => l.replace(/^[-*‚Ä¢\d.)\]]\s*/, '').trim()).filter(l => l);
        } else if (type === 'patient') {
          slide.demographics = content.split('\n')[0] || '';
          slide.cc = content.split('\n').slice(1).join(' ').trim() || '';
        } else if (type === 'treatment') {
          const pharm = content.match(/pharm[^:]*:([\s\S]*?)(?=non-?pharm|$)/i);
          const nonpharm = content.match(/non-?pharm[^:]*:([\s\S]*)/i);
          slide.pharm = pharm ? pharm[1].trim() : content;
          slide.nonpharm = nonpharm ? nonpharm[1].trim() : '';
        } else if (type === 'exam') {
          slide.vitals = {};
          slide.findings = content;
          // Try to extract vitals
          const bpMatch = content.match(/BP[:\s]*(\d+\/\d+)/i);
          const hrMatch = content.match(/HR[:\s]*(\d+)/i);
          const rrMatch = content.match(/RR[:\s]*(\d+)/i);
          const tempMatch = content.match(/Temp[:\s]*([\d.]+)/i);
          const spo2Match = content.match(/SpO2[:\s]*(\d+)/i);
          if (bpMatch) slide.vitals.BP = bpMatch[1];
          if (hrMatch) slide.vitals.HR = hrMatch[1];
          if (rrMatch) slide.vitals.RR = rrMatch[1];
          if (tempMatch) slide.vitals.Temp = tempMatch[1];
          if (spo2Match) slide.vitals.SpO2 = spo2Match[1];
        } else if (type === 'scores') {
          slide.scores = {};
          const scorePatterns = ['MMSE', 'MoCA', 'GDS', 'ADL', 'IADL', 'TUG', 'MNA', 'CFS', 'Morse', 'Braden', 'CAM'];
          scorePatterns.forEach(score => {
            const match = content.match(new RegExp(score + '[:\\s]*(\\d+[/\\d]*)', 'i'));
            if (match) slide.scores[score] = match[1];
          });
        } else {
          slide.content = content;
        }

        slides.push(slide);
      });

      return [{ id: Date.now(), created: new Date().toISOString(), modified: new Date().toISOString(), slides }];
    }

    function parseCSV(text) {
      const lines = text.split('\n').filter(l => l.trim());
      if (lines.length < 2) return null;

      const headers = lines[0].split(/[,\t]/).map(h => h.trim().toLowerCase());
      const rows = lines.slice(1).map(line => {
        const values = line.split(/[,\t]/).map(v => v.trim().replace(/^["']|["']$/g, ''));
        const row = {};
        headers.forEach((h, i) => row[h] = values[i] || '');
        return row;
      });

      // Detect CSV type and create appropriate slides
      const slides = [{ type: 'title', title: 'Imported Data', subtitle: `${rows.length} items` }];

      // Medication list
      if (headers.some(h => h.includes('medication') || h.includes('drug') || h.includes('med'))) {
        slides.push({
          type: 'list',
          title: 'Medications',
          items: rows.map(r => Object.values(r).filter(v => v).join(' - '))
        });
      }
      // Lab results
      else if (headers.some(h => h.includes('test') || h.includes('lab') || h.includes('result'))) {
        slides.push({
          type: 'list',
          title: 'Labs',
          items: rows.map(r => Object.values(r).filter(v => v).join(': '))
        });
      }
      // Generic list
      else {
        slides.push({
          type: 'list',
          title: 'Imported Items',
          items: rows.map(r => Object.values(r).filter(v => v).join(' | '))
        });
      }

      return [{ id: Date.now(), created: new Date().toISOString(), modified: new Date().toISOString(), slides }];
    }

    function detectAndParse(text) {
      text = text.trim();
      if (!text) return null;

      // Try JSON first
      if (text.startsWith('{') || text.startsWith('[')) {
        const result = parseJSON(text);
        if (result) return { format: 'JSON', presentations: result };
      }

      // Try Markdown
      if (text.includes('# ') || text.includes('## ')) {
        const result = parseMarkdown(text);
        if (result) return { format: 'Markdown', presentations: result };
      }

      // Try CSV
      if (text.includes(',') && text.split('\n')[0].split(',').length > 2) {
        const result = parseCSV(text);
        if (result) return { format: 'CSV', presentations: result };
      }

      // Fall back to plain text
      const result = parsePlainText(text);
      if (result) return { format: 'Plain Text', presentations: result };

      return null;
    }

    function importPresentation(text) {
      const result = detectAndParse(text);
      if (!result || !result.presentations.length) {
        showToast('‚ùå Could not parse import data');
        return;
      }

      result.presentations.forEach(p => {
        p.id = Date.now() + Math.random();
        p.created = p.created || new Date().toISOString();
        p.modified = new Date().toISOString();
        state.saved.push(p);
      });

      save();
      showToast(`‚úÖ Imported ${result.presentations.length} presentation(s) from ${result.format}`);
      setState({ showImport: false, importText: '' });
    }

    function handleFileImport(file) {
      if (!file) return;
      
      const ext = file.name.split('.').pop().toLowerCase();
      const statusEl = document.getElementById('importStatus');
      if (statusEl) statusEl.textContent = `Reading ${file.name}...`;

      // Handle different file types
      if (ext === 'pdf') {
        handlePDFImport(file);
      } else if (ext === 'pptx') {
        handlePPTXImport(file);
      } else if (ext === 'docx' || ext === 'doc') {
        handleDOCXImport(file);
      } else if (ext === 'html' || ext === 'htm') {
        handleHTMLImport(file);
      } else {
        // Text-based files (json, md, txt, csv, tsv)
        const reader = new FileReader();
        reader.onload = (e) => {
          state.importText = e.target.result;
          if (statusEl) statusEl.textContent = `‚úì Loaded ${file.name}`;
          render();
        };
        reader.onerror = () => {
          if (statusEl) statusEl.textContent = `‚ùå Error reading file`;
          showToast('‚ùå Error reading file');
        };
        reader.readAsText(file);
      }
    }

    async function handlePDFImport(file) {
      const statusEl = document.getElementById('importStatus');
      try {
        if (statusEl) statusEl.textContent = 'Parsing PDF...';
        
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let fullText = '';
        
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const textContent = await page.getTextContent();
          const pageText = textContent.items.map(item => item.str).join(' ');
          fullText += pageText + '\n\n---PAGE BREAK---\n\n';
        }

        state.importText = fullText.replace(/---PAGE BREAK---/g, '\n\n');
        if (statusEl) statusEl.textContent = `‚úì Extracted ${pdf.numPages} pages from PDF`;
        render();
      } catch (err) {
        console.error('PDF parse error:', err);
        if (statusEl) statusEl.textContent = '‚ùå Could not parse PDF';
        showToast('‚ùå PDF parsing failed - try a different file');
      }
    }

    async function handlePPTXImport(file) {
      const statusEl = document.getElementById('importStatus');
      try {
        if (statusEl) statusEl.textContent = 'Parsing PowerPoint...';
        
        const arrayBuffer = await file.arrayBuffer();
        const zip = await JSZip.loadAsync(arrayBuffer);
        
        // Get slide content
        const slides = [];
        const slideFiles = Object.keys(zip.files).filter(f => f.match(/ppt\/slides\/slide\d+\.xml/)).sort();
        
        for (const slideFile of slideFiles) {
          const content = await zip.file(slideFile).async('string');
          // Extract text from XML
          const textMatches = content.match(/<a:t>([^<]*)<\/a:t>/g) || [];
          const slideText = textMatches.map(m => m.replace(/<\/?a:t>/g, '')).filter(t => t.trim());
          
          if (slideText.length > 0) {
            slides.push({
              title: slideText[0] || '',
              content: slideText.slice(1).join('\n')
            });
          }
        }
        
        // Convert to markdown format
        let mdText = '';
        slides.forEach((slide, i) => {
          if (i === 0) {
            mdText += '# ' + slide.title + '\n\n' + slide.content + '\n\n';
          } else {
            mdText += '## ' + slide.title + '\n\n' + slide.content + '\n\n';
          }
        });
        
        state.importText = mdText || 'Could not extract text from PowerPoint';
        if (statusEl) statusEl.textContent = `‚úì Extracted ${slides.length} slides from PPTX`;
        render();
      } catch (err) {
        console.error('PPTX parse error:', err);
        if (statusEl) statusEl.textContent = '‚ùå Could not parse PPTX';
        showToast('‚ùå PPTX parsing failed');
      }
    }

    async function handleDOCXImport(file) {
      const statusEl = document.getElementById('importStatus');
      try {
        if (statusEl) statusEl.textContent = 'Parsing Word document...';
        
        const arrayBuffer = await file.arrayBuffer();
        const result = await mammoth.extractRawText({ arrayBuffer });
        
        state.importText = result.value || 'Could not extract text';
        if (statusEl) statusEl.textContent = `‚úì Extracted text from DOCX`;
        render();
      } catch (err) {
        console.error('DOCX parse error:', err);
        if (statusEl) statusEl.textContent = '‚ùå Could not parse DOCX';
        showToast('‚ùå DOCX parsing failed');
      }
    }

    async function handleHTMLImport(file) {
      const statusEl = document.getElementById('importStatus');
      try {
        if (statusEl) statusEl.textContent = 'Parsing HTML...';
        
        const text = await file.text();
        // Create a DOM parser to extract text
        const parser = new DOMParser();
        const doc = parser.parseFromString(text, 'text/html');
        
        // Remove scripts and styles
        doc.querySelectorAll('script, style, noscript').forEach(el => el.remove());
        
        // Try to extract structured content
        let mdText = '';
        
        // Get title
        const title = doc.querySelector('title')?.textContent || doc.querySelector('h1')?.textContent;
        if (title) mdText += '# ' + title.trim() + '\n\n';

        // Get headers and their content
        doc.querySelectorAll('h1, h2, h3, h4, h5, h6, p, li, td').forEach(el => {
          const tag = el.tagName.toLowerCase();
          const text = el.textContent.trim();
          if (!text) return;

          if (tag === 'h1') mdText += '# ' + text + '\n\n';
          else if (tag === 'h2') mdText += '## ' + text + '\n\n';
          else if (tag === 'h3') mdText += '### ' + text + '\n\n';
          else if (tag === 'li') mdText += '- ' + text + '\n';
          else if (tag === 'p' || tag === 'td') mdText += text + '\n\n';
        });
        
        state.importText = mdText || doc.body?.textContent || 'Could not extract text';
        if (statusEl) statusEl.textContent = `‚úì Extracted content from HTML`;
        render();
      } catch (err) {
        console.error('HTML parse error:', err);
        if (statusEl) statusEl.textContent = '‚ùå Could not parse HTML';
        showToast('‚ùå HTML parsing failed');
      }
    }

    // Example loaders
    function loadExampleDelirium() {
      state.importText = `# Delirium Case

## Patient
78yo male, nursing home resident

## Chief Complaint
Acute confusion x 2 days

## HPI
Found by staff to be more confused than baseline. Not eating well. Low-grade fever.

## PMH
- Dementia (baseline MMSE 18)
- HTN
- DM2
- BPH

## Medications
- Metformin 500mg BID
- Lisinopril 10mg daily
- Tamsulosin 0.4mg qhs
- Donepezil 10mg qhs

## Physical Exam
BP 138/78, HR 92, Temp 38.1, RR 18, SpO2 96%
Confused, inattentive. Suprapubic tenderness.

## Labs
- WBC 14.2
- UA: positive nitrites, bacteria
- Cr 1.4 (baseline 1.0)

## Assessment
MMSE: 12/30
CAM: Positive

## Differential
- Delirium secondary to UTI
- Urosepsis
- Medication effect

## Management
Pharmacological:
- Ceftriaxone 1g IV daily
- Hold tamsulosin
- Low-dose haloperidol 0.5mg PRN

Non-pharmacological:
- Reorientation
- Family at bedside
- Minimize tethers
- Sleep hygiene`;
      render();
    }

    function loadExampleFalls() {
      state.importText = `# Falls Evaluation

## Patient
82yo female, lives alone

## Chief Complaint
Found on floor by daughter this morning

## HPI
Patient unsure how she fell. Denies LOC, chest pain, palpitations. Last remembers watching TV. Some hip pain.

## PMH
- HTN
- Osteoporosis
- Mild cognitive impairment
- Cataracts

## Medications
- Amlodipine 10mg daily
- Trazodone 50mg qhs
- Meclizine 25mg PRN
- Calcium/Vit D

## Physical Exam
BP 142/78 sitting, 118/70 standing (orthostatic!)
HR 68 regular
Gait unsteady, uses furniture

## Labs
- CBC normal
- BMP: K 3.2 (low)
- TSH normal
- Vit D 18

## Assessment
Morse Fall Scale: 55 (high risk)
TUG: 18 seconds

## Differential
- Orthostatic hypotension (amlodipine)
- Medication effect (trazodone, meclizine)
- Vitamin D deficiency
- Hypokalemia

## Management
- Stop meclizine
- Reduce amlodipine to 5mg
- K supplementation
- Vitamin D 2000 IU daily
- PT evaluation
- Home safety assessment`;
      render();
    }

    function loadExampleMedList() {
      state.importText = `Medication,Dose,Frequency,Notes
Metoprolol,25mg,daily,Hold if HR<60
Lisinopril,10mg,daily,Monitor K and Cr
Metformin,500mg,BID,Hold if NPO
Aspirin,81mg,daily,GI protection
Atorvastatin,40mg,qhs,Monitor LFTs
Omeprazole,20mg,daily,Consider de-escalation
Furosemide,40mg,daily,Monitor electrolytes
Potassium,20mEq,daily,Keep K >4.0`;
      render();
    }

    function exportPresentation(idx) {
      const p = state.saved[idx];
      if (!p) return;
      
      const json = JSON.stringify(p, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = (p.slides[0]?.title || 'presentation').replace(/[^a-z0-9]/gi, '_') + '.json';
      a.click();
      URL.revokeObjectURL(url);
      showToast('üì§ Exported!');
    }

    // ============ PRESENTATION FUNCTIONS ============
    function createPresentation(templateKey) {
      const template = templates[templateKey];
      if (!template) return;
      
      const newPres = {
        id: Date.now(),
        created: new Date().toISOString(),
        modified: new Date().toISOString(),
        template: templateKey,
        slides: JSON.parse(JSON.stringify(template.slides)).map(slide => ({ ...slide, notes: slide.notes || '' }))
      };
      
      state.saved.push(newPres);
      state.pres = newPres;
      state.slide = 0;
      state.view = 'editor';
      state.showTemplates = false;
      save();
      render();
    }

    function openPresentation(p) {
      state.pres = p;
      state.slide = 0;
      state.view = 'editor';
      render();
    }

    function openPresentationByIndex(idx) {
      const p = state.saved[idx];
      if (p) openPresentation(p);
    }

    function deletePresentationByIndex(idx) {
      if (!confirm('Delete this presentation?')) return;
      const p = state.saved[idx];
      state.saved.splice(idx, 1);
      if (state.pres?.id === p?.id) {
        state.pres = null;
        state.view = 'home';
      }
      save();
      render();
      showToast('üóëÔ∏è Deleted');
    }

    function deletePresentation(id) {
      if (!confirm('Delete this presentation?')) return;
      state.saved = state.saved.filter(p => p.id !== id);
      if (state.pres?.id === id) {
        state.pres = null;
        state.view = 'home';
      }
      save();
      render();
    }

    function savePres() {
      if (!state.pres) return;
      state.pres.modified = new Date().toISOString();
      state.saved = state.saved.map(p => p.id === state.pres.id ? state.pres : p);
      save();
    }

    function updateSlide(field, value) {
      if (!state.pres) return;
      state.pres.slides[state.slide][field] = value;
      savePres();
      render();
    }

    function addSlide(type) {
      if (!state.pres) return;
      const newSlide = { type, title: 'New Slide', content: '', items: [], notes: '' };
      state.pres.slides.splice(state.slide + 1, 0, newSlide);
      state.slide++;
      savePres();
      render();
    }

    function deleteSlide() {
      if (!state.pres || state.pres.slides.length <= 1) return;
      if (!confirm('Delete this slide?')) return;
      state.pres.slides.splice(state.slide, 1);
      if (state.slide >= state.pres.slides.length) state.slide = state.pres.slides.length - 1;
      savePres();
      render();
    }

    // ============ AI FUNCTIONS ============
    function buildContext() {
      if (!state.pres) return 'No presentation.';
      let ctx = `PRESENTATION: ${state.pres.slides[0]?.title}\nSlides: ${state.pres.slides.length}\nCurrent slide: ${state.slide + 1}\n\n`;
      
      state.pres.slides.forEach((s, i) => {
        ctx += `[${i + 1}] ${s.type.toUpperCase()}: ${s.title}\n`;
        if (s.demographics) ctx += `  Demographics: ${s.demographics}\n`;
        if (s.cc) ctx += `  CC: ${s.cc}\n`;
        if (s.content) ctx += `  Content: ${s.content.substring(0, 200)}${s.content.length > 200 ? '...' : ''}\n`;
        if (s.items?.length) ctx += `  Items: ${s.items.slice(0, 6).join('; ')}${s.items.length > 6 ? '...' : ''}\n`;
        if (s.vitals && Object.values(s.vitals).some(v => v)) {
          ctx += `  Vitals: ${Object.entries(s.vitals).filter(([k,v]) => v).map(([k,v]) => `${k}:${v}`).join(', ')}\n`;
        }
        if (s.findings) ctx += `  Exam: ${s.findings.substring(0, 150)}...\n`;
        if (s.pharm) ctx += `  Pharm: ${s.pharm.substring(0, 150)}...\n`;
        if (s.scores && Object.keys(s.scores).some(k => s.scores[k])) {
          ctx += `  Scores: ${Object.entries(s.scores).filter(([k,v]) => v).map(([k,v]) => `${k}:${v}`).join(', ')}\n`;
        }
      });
      
      return ctx;
    }

    async function sendAI() {
      if (!state.aiInput.trim() || state.aiLoading) return;
      if (!state.apiKey) {
        state.aiChat.push({ role: 'assistant', content: '‚ö†Ô∏è Please add your Anthropic API key in Settings first.', time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) });
        render();
        return;
      }

      const userMsg = state.aiInput.trim();
      const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      state.aiInput = '';
      state.aiChat.push({ role: 'user', content: userMsg, time: timestamp });
      state.aiLoading = true;
      render();

      // Build context from current presentation
      let presContext = 'No presentation loaded.';
      if (state.pres) {
        presContext = `Current presentation: "${state.pres.name}" with ${state.pres.slides.length} slides.\n`;
        presContext += `Current slide (${state.slide + 1}): ${JSON.stringify(state.pres.slides[state.slide], null, 2)}`;
      }

      const evidenceDigest = EVIDENCE_LIBRARY.map(ev => `${ev.title} (${ev.year}): ${ev.summary}`).join('\n- ');

      const systemPrompt = `You are an AI assistant that helps create and modify presentation slides.

CURRENT CONTEXT:
${presContext}

EVIDENCE CHEAT SHEET (2024-2025):
- ${evidenceDigest}

INSTRUCTIONS:
Use up-to-date guideline-level evidence (2023-2025) and clearly separate recommendations from rationale. Prefer concise bullet lists, highlight geriatric dosing/contraindications, and flag safety issues.
- For list items, use bullet points (‚Ä¢ or -)
- For text content, provide crisp paragraphs or mini checklists
- Be concise, clinical, and slide-ready
- If suggesting medications, include dose ranges and renal/hepatic notes when relevant
- If recommending follow-up, include timelines

If asked to generate items for a list (like DDx, medications, teaching points), provide them as a bullet list.
If asked to generate content, provide clear text.

DO NOT include any code blocks or JSON. Just provide the content directly.`;

      try {
        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': state.apiKey,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
          },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 2000,
            messages: [{ role: 'user', content: systemPrompt + '\n\nUser request: ' + userMsg }]
          })
        });

        if (!response.ok) {
          const err = await response.json().catch(() => ({}));
          throw new Error(err.error?.message || `API error ${response.status}`);
        }

        const data = await response.json();
        let aiResponse = data.content[0]?.text || 'No response';

        // Store the generated content for potential use
        state.lastAIContent = aiResponse;

        state.aiChat.push({ role: 'assistant', content: aiResponse, time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) });
      } catch(e) {
        state.aiChat.push({ role: 'assistant', content: `‚ö†Ô∏è Error: ${e.message}`, time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) });
      }

      state.aiLoading = false;
      render();
      setTimeout(() => {
        const box = document.getElementById('aiChatBox');
        if (box) box.scrollTop = box.scrollHeight;
      }, 100);
    }

    // Apply AI content to a specific slide field
    function applyAIToSlide(slideIndex, field) {
      if (!state.pres || !state.lastAIContent) {
        showToast('No content to apply');
        return;
      }

      const slide = state.pres.slides[slideIndex];
      const content = state.lastAIContent;

      // Parse content based on field type
      if (field === 'items') {
        // Extract bullet points or lines as items
        const lines = content.split('\n')
          .map(line => line.replace(/^[\s‚Ä¢\-\*\d\.]+/, '').trim())
          .filter(line => line.length > 0);
        slide.items = lines;
      } else if (field === 'content' || field === 'findings' || field === 'pharm' || field === 'nonpharm') {
        slide[field] = content;
      } else if (field === 'title') {
        slide.title = content.split('\n')[0].substring(0, 100);
      }

      savePres();
      showToast(`Applied to slide ${slideIndex + 1}: ${slide.title}`);
      setState({ showAI: false, slide: slideIndex });
    }

    // Quick generate for specific slide types
    function quickGenerate(type) {
      const prompts = {
        ddx: 'Generate a differential diagnosis list with 5-7 items. Just list the conditions.',
        teaching: 'Generate 4-5 key teaching points. List them as bullet points.',
        plan: 'Generate a management plan with both pharmacological and non-pharmacological interventions.',
        summary: 'Summarize the key points from the current slide content.',
        improve: 'Suggest improvements for the current slide content.',
        expand: 'Expand on the current slide content with more detail.'
      };

      state.aiInput = prompts[type] || '';
      render();
      if (state.aiInput) {
        setTimeout(() => sendAI(), 50);
      }
    }

    function aiCommand(cmd) {
      const commands = {
        ddx: 'Generate a comprehensive differential diagnosis for this patient. List the most likely conditions.',
        teaching: 'Identify 4-5 key teaching points from this case.',
        meds: 'Review all medications for interactions, contraindications, and dosing considerations.',
        plan: 'Generate a comprehensive management plan with treatment recommendations.',
        workup: 'What additional workup should be ordered? Consider labs, imaging, and consultations.',
        gaps: 'What information is missing from this presentation?',
        improve: 'Review the presentation and suggest improvements.'
      };

      state.aiInput = commands[cmd] || '';
      render();
      setTimeout(() => sendAI(), 50);
    }

    async function testAPIKey() {
      if (!state.apiKey) {
        showToast('Add your Anthropic key first');
        return;
      }

      setState({ apiStatus: 'Checking key...' });
      try {
        const resp = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': state.apiKey,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
          },
          body: JSON.stringify({
            model: 'claude-3-5-sonnet-20240620',
            max_tokens: 20,
            messages: [{ role: 'user', content: 'Reply READY if you can hear me.' }]
          })
        });

        if (!resp.ok) {
          const err = await resp.json().catch(() => ({}));
          throw new Error(err.error?.message || `API error ${resp.status}`);
        }

        const data = await resp.json();
        const ok = data.content?.[0]?.text?.toLowerCase().includes('ready');
        setState({ apiStatus: ok ? '‚úÖ Key works' : '‚ö†Ô∏è Unexpected response (check model access)' });
        showToast(ok ? 'API connected' : 'Key responded, verify model access');
      } catch (e) {
        console.error(e);
        setState({ apiStatus: `‚ö†Ô∏è ${e.message}` });
        showToast('API check failed');
      }
    }

    function summarizePresentation(pres = state.pres) {
      if (!pres) return 'No presentation loaded';
      const bullets = pres.slides.map((s, i) => `${i + 1}. ${s.title || s.type}: ${
        s.content?.slice(0, 100) || s.items?.slice(0, 3)?.join('; ') || s.demographics || ''
      }`).join('\n');
      return `Name: ${pres.name || pres.slides[0]?.title || 'Untitled'}\nSlides: ${pres.slides.length}\n${bullets}`;
    }

    function auditPresentation() {
      if (!state.pres) return;
      const p = state.pres;
      const issues = [];
      const warnings = [];
      let score = 100;

      if (!p.slides?.length) {
        issues.push('No slides found. Start from a template.');
        score -= 40;
      }

      const requiredFields = [
        { type: 'patient', field: 'demographics', msg: 'Add demographics (age/sex) to the Patient slide.' },
        { type: 'patient', field: 'cc', msg: 'Add a chief complaint.' },
        { type: 'content', title: 'HPI', field: 'content', msg: 'HPI is empty. Add a succinct story.' },
        { type: 'list', title: 'Medications', field: 'items', msg: 'List current medications.' },
        { type: 'exam', field: 'findings', msg: 'Document key physical exam findings.' },
        { type: 'list', title: 'Differential Diagnosis', field: 'items', msg: 'Add a differential diagnosis list.' },
        { type: 'treatment', field: 'pharm', msg: 'Pharmacological plan missing.' },
        { type: 'treatment', field: 'nonpharm', msg: 'Non-pharmacologic plan missing.' },
      ];

      requiredFields.forEach(req => {
        const slide = p.slides.find(s => s.type === req.type && (!req.title || s.title === req.title));
        if (!slide || !(slide[req.field]?.length)) {
          issues.push(req.msg);
          score -= 5;
        }
      });

      p.slides.forEach((s, idx) => {
        if (['content', 'list', 'treatment'].includes(s.type)) {
          const lengthScore = (s.content || s.pharm || s.nonpharm || (s.items || []).join(' ')).length;
          if (!lengthScore) {
            issues.push(`Slide ${idx + 1} (${s.title || s.type}) is empty.`);
            score -= 3;
          }
        }

        if (s.type === 'exam' && (!s.vitals || Object.values(s.vitals).every(v => !v))) {
          warnings.push('Vitals missing in Physical Exam.');
          score -= 2;
        }
      });

      const evidenceMatch = EVIDENCE_LIBRARY.find(ev => p.slides.some(sl => (sl.content || '').toLowerCase().includes(ev.title.toLowerCase())));
      if (!evidenceMatch) {
        warnings.push('No guideline references detected. Use AI ‚ÄúEvidence‚Äù quick actions to cite 2024-2025 guidance.');
        score -= 3;
      }

      score = Math.max(0, Math.min(100, score));

      setState({
        qaResults: {
          score,
          issues,
          warnings,
          summary: summarizePresentation(p)
        },
        showQA: true
      });
    }

    function injectEvidence(evId) {
      const ev = EVIDENCE_LIBRARY.find(e => e.id === evId);
      if (!ev) return;
      const ctx = summarizePresentation();
      const prompt = `Use ${ev.title} (${ev.year}) guidance to update this case. Patient/context:\n${ctx}\nEvidence summary:${ev.summary}\nKey points:${ev.keyPoints.join('; ')}\nReturn slide-ready bullets with dosing, monitoring, and citations.`;
      state.aiInput = prompt;
      setState({ showAI: true });
      setTimeout(() => sendAI(), 80);
    }

    // ============ CALCULATORS ============
    function calculate() {
      const ci = state.calcIn;
      let r = null;

      switch(state.calcType) {
        case 'crcl':
          if (ci.age && ci.wt && ci.cr) {
            let v = ((140 - +ci.age) * +ci.wt) / (72 * +ci.cr);
            if (ci.female) v *= 0.85;
            const stage = v < 15 ? 'Stage 5 (ESRD)' : v < 30 ? 'Stage 4' : v < 60 ? 'Stage 3' : v < 90 ? 'Stage 2' : 'Normal';
            r = { v: v.toFixed(1), u: 'mL/min', i: stage };
          }
          break;

        case 'ckdepi':
          if (ci.age && ci.cr) {
            const age = +ci.age, cr = +ci.cr;
            let gfr;
            if (ci.female) {
              gfr = 142 * Math.pow(Math.min(cr/0.7, 1), -0.241) * Math.pow(Math.max(cr/0.7, 1), -1.2) * Math.pow(0.9938, age) * 1.012;
            } else {
              gfr = 142 * Math.pow(Math.min(cr/0.9, 1), -0.302) * Math.pow(Math.max(cr/0.9, 1), -1.2) * Math.pow(0.9938, age);
            }
            const stage = gfr < 15 ? 'Stage 5' : gfr < 30 ? 'Stage 4' : gfr < 45 ? 'Stage 3b' : gfr < 60 ? 'Stage 3a' : gfr < 90 ? 'Stage 2' : 'Normal';
            r = { v: gfr.toFixed(1), u: 'mL/min/1.73m¬≤', i: stage };
          }
          break;

        case 'anion':
          if (ci.na && ci.cl && ci.hco3) {
            let ag = +ci.na - (+ci.cl + +ci.hco3);
            let corrAG = ag;
            if (ci.alb) corrAG = ag + 2.5 * (4 - +ci.alb);
            const interp = corrAG > 12 ? 'Elevated - MUDPILES' : 'Normal';
            r = { v: ag.toFixed(0), u: ci.alb ? ` (corrected: ${corrAG.toFixed(0)})` : '', i: interp };
          }
          break;

        case 'corrNa':
          if (ci.na && ci.glu) {
            const corrected = +ci.na + 0.024 * (+ci.glu - 100);
            r = { v: corrected.toFixed(1), u: 'mEq/L', i: corrected < 135 ? 'Still hyponatremic' : corrected > 145 ? 'Hypernatremic' : 'Normal' };
          }
          break;

        case 'corrCa':
          if (ci.ca && ci.alb) {
            const corrected = +ci.ca + 0.8 * (4 - +ci.alb);
            const interp = corrected < 8.5 ? 'Hypocalcemia' : corrected > 10.5 ? 'Hypercalcemia' : 'Normal';
            r = { v: corrected.toFixed(1), u: 'mg/dL', i: interp };
          }
          break;

        case 'wellsDVT':
          const dvt = (ci.cancer?1:0) + (ci.paralysis?1:0) + (ci.bedridden?1:0) + (ci.tenderness?1:0) + 
                      (ci.swelling?1:0) + (ci.calf?1:0) + (ci.pitting?1:0) + (ci.collateral?1:0) + 
                      (ci.prevDVT?1:0) + (ci.altDx?-2:0);
          const dvtRisk = dvt <= 0 ? 'Low (5%)' : dvt <= 2 ? 'Moderate (17%)' : 'High (53%)';
          const dvtAction = dvt <= 0 ? '‚Üí D-dimer, if neg rule out' : dvt <= 2 ? '‚Üí D-dimer or US' : '‚Üí Ultrasound';
          r = { v: dvt, u: 'pts', i: dvtRisk + ' ' + dvtAction };
          break;

        case 'wellsPE':
          const pe = (ci.dvtSx?3:0) + (ci.peFirst?3:0) + (ci.hr100?1.5:0) + (ci.immob?1.5:0) + 
                     (ci.prevVTE?1.5:0) + (ci.hemoptysis?1:0) + (ci.malignancy?1:0);
          const peRisk = pe <= 4 ? 'Unlikely (<15%)' : 'Likely (>40%)';
          const peAction = pe <= 4 ? '‚Üí PERC or D-dimer' : '‚Üí CTA';
          r = { v: pe.toFixed(1), u: 'pts', i: peRisk + ' ' + peAction };
          break;

        case 'perc':
          const percNeg = !ci.age50 && !ci.hr100 && !ci.spo2 && !ci.legSwell && !ci.hemoptysis && 
                          !ci.surgery && !ci.prevVTE && !ci.estrogen;
          r = { v: percNeg ? 'NEGATIVE' : 'Failed', u: '', i: percNeg ? '‚úì PE ruled out (if low pretest)' : '‚Üí Need D-dimer or imaging' };
          break;

        case 'curb65':
          const curb = (ci.confusion?1:0) + (ci.urea?1:0) + (ci.rr?1:0) + (ci.bp?1:0) + (ci.age65?1:0);
          const curbDisp = curb <= 1 ? 'Outpatient' : curb === 2 ? 'Consider admission' : curb >= 3 ? 'Admit, consider ICU' : '';
          const curbMort = curb === 0 ? '0.6%' : curb === 1 ? '2.7%' : curb === 2 ? '6.8%' : curb === 3 ? '14%' : curb >= 4 ? '28%' : '';
          r = { v: curb, u: '/5', i: `${curbDisp} (mortality ~${curbMort})` };
          break;

        case 'heart':
          if (ci.history !== undefined && ci.ecg !== undefined && ci.ageScore !== undefined && ci.risk !== undefined && ci.trop !== undefined) {
            const heart = +ci.history + +ci.ecg + +ci.ageScore + +ci.risk + +ci.trop;
            const heartRisk = heart <= 3 ? 'Low (1.7% MACE)' : heart <= 6 ? 'Moderate (12-17% MACE)' : 'High (50%+ MACE)';
            const heartDisp = heart <= 3 ? '‚Üí Consider discharge' : heart <= 6 ? '‚Üí Admit, serial troponins' : '‚Üí Admit, early intervention';
            r = { v: heart, u: '/10', i: heartRisk + ' ' + heartDisp };
          }
          break;

        case 'chads':
          const chads = (ci.chf?1:0) + (ci.htn?1:0) + (ci.age75?2:ci.age65?1:0) + (ci.dm?1:0) + (ci.stroke?2:0) + (ci.vasc?1:0) + (ci.female?1:0);
          const chadsRisk = chads === 0 ? '0%' : chads === 1 ? '1.3%' : chads === 2 ? '2.2%' : chads === 3 ? '3.2%' : chads >= 4 ? '>4%' : '';
          const chadsRx = chads === 0 ? 'No anticoag needed' : chads === 1 ? 'Consider anticoag' : '‚Üí Anticoagulate';
          r = { v: chads, u: '/9', i: `Annual stroke risk: ${chadsRisk}. ${chadsRx}` };
          break;

        case 'hasbled':
          const hasbled = (ci.htn?1:0) + (ci.abnRenal?1:0) + (ci.abnLiver?1:0) + (ci.strokeHx?1:0) + 
                          (ci.bleedHx?1:0) + (ci.labile?1:0) + (ci.elderly?1:0) + (ci.drugs?1:0) + (ci.alcohol?1:0);
          const bleedRisk = hasbled >= 3 ? 'High bleeding risk' : 'Low-moderate';
          r = { v: hasbled, u: '/9', i: hasbled >= 3 ? '‚ö†Ô∏è ' + bleedRisk + ' - caution with anticoag' : bleedRisk };
          break;

        case 'meld':
          if (ci.bili && ci.cr && ci.inr && ci.na) {
            const bili = Math.max(+ci.bili, 1);
            const cr = ci.dialysis ? 4 : Math.min(Math.max(+ci.cr, 1), 4);
            const inr = Math.max(+ci.inr, 1);
            const na = Math.min(Math.max(+ci.na, 125), 137);
            
            const meld = 10 * (0.957 * Math.log(cr) + 0.378 * Math.log(bili) + 1.12 * Math.log(inr) + 0.643);
            const meldNa = meld + 1.32 * (137 - na) - 0.033 * meld * (137 - na);
            const finalMeld = Math.round(Math.min(Math.max(meldNa, 6), 40));
            
            const mort3m = finalMeld < 10 ? '2%' : finalMeld < 20 ? '6%' : finalMeld < 30 ? '20%' : finalMeld < 40 ? '50%' : '>70%';
            r = { v: finalMeld, u: '', i: `3-month mortality: ~${mort3m}` };
          }
          break;

        case 'cam':
          const cam = ci.acute && ci.inattention && (ci.disorganized || ci.altered);
          r = { v: cam ? 'POSITIVE' : 'Negative', u: '', i: cam ? '‚ö†Ô∏è Delirium likely' : '‚úì Low probability' };
          break;

        case 'morse':
          const morse = (ci.fallHx ? 25 : 0) + (ci.secDx ? 15 : 0) + 
            (ci.ambAid === 'furniture' ? 30 : ci.ambAid === 'device' ? 15 : 0) + 
            (ci.iv ? 20 : 0) + 
            (ci.gait === 'impaired' ? 20 : ci.gait === 'weak' ? 10 : 0);
          r = { v: morse, u: 'pts', i: morse < 25 ? 'Low risk' : morse < 45 ? 'Moderate risk' : 'High risk - fall precautions' };
          break;
      }

      setState({ calcRes: r });
    }

    // ============ RENDER FUNCTIONS ============
    function render() {
      const app = document.getElementById('app');

      switch(state.view) {
        case 'home': app.innerHTML = renderHome(); break;
        case 'editor': app.innerHTML = renderEditor(); break;
        case 'ai': app.innerHTML = renderAIAssistant(); break;
        default: app.innerHTML = renderHome();
      }
    }

    function renderHome() {
      const savedList = state.saved.length > 0 ? state.saved.map((p, idx) => {
        const title = p.slides[0]?.title || p.slides[0]?.demographics || 'Untitled Case';
        const subtitle = p.slides[0]?.subtitle || p.slides[0]?.cc || '';
        return `
        <div class="bg-white rounded-xl p-4 shadow-sm flex justify-between items-center mb-3">
          <div onclick="openPresentationByIndex(${idx})" class="flex-1 cursor-pointer min-w-0">
            <div class="font-bold text-slate-800 truncate">${e(title)}</div>
            ${subtitle ? `<div class="text-sm text-slate-600 truncate">${e(subtitle)}</div>` : ''}
            <div class="text-xs text-slate-400">${p.slides.length} slides ‚Ä¢ ${new Date(p.modified || p.created).toLocaleDateString()}</div>
          </div>
          <button onclick="event.stopPropagation();deletePresentationByIndex(${idx})" class="text-red-400 p-2 hover:text-red-600">üóëÔ∏è</button>
        </div>
      `}).join('') : '<p class="text-center text-blue-200 py-4">No presentations yet</p>';

      return `
        <div class="min-h-screen gradient-szmc text-white">
          <!-- Header -->
          <div class="p-6 text-center">
            <div class="text-5xl mb-2">ü©∫</div>
            <h1 class="text-2xl font-bold">SZMC Geriatrics Pro</h1>
            <p class="text-blue-200">v${VERSION} ‚Ä¢ Case Presentations</p>
          </div>

          <!-- Quick Tools -->
          <div class="px-4 mb-6">
            <div class="grid grid-cols-5 gap-2 mb-2">
              <button onclick="setState({view:'ai'})" class="bg-gradient-to-br from-purple-500 to-blue-500 rounded-xl p-3 text-center hover:from-purple-400 hover:to-blue-400 transition shadow-lg">
                <div class="text-2xl">üß†</div>
                <div class="text-xs mt-1 font-medium">AI</div>
              </button>
              <button onclick="setState({showCalc:true})" class="bg-white/20 rounded-xl p-3 text-center hover:bg-white/30 transition">
                <div class="text-2xl">üßÆ</div>
                <div class="text-xs mt-1">Calc</div>
              </button>
              <button onclick="setState({showDrugs:true})" class="bg-white/20 rounded-xl p-3 text-center hover:bg-white/30 transition">
                <div class="text-2xl">üíä</div>
                <div class="text-xs mt-1">Drugs</div>
              </button>
              <button onclick="setState({showLabs:true})" class="bg-white/20 rounded-xl p-3 text-center hover:bg-white/30 transition">
                <div class="text-2xl">üß™</div>
                <div class="text-xs mt-1">Labs</div>
              </button>
              <button onclick="setState({showEmergency:true})" class="bg-red-500/90 rounded-xl p-3 text-center hover:bg-red-500 transition">
                <div class="text-2xl">üö®</div>
                <div class="text-xs mt-1">Emerg</div>
              </button>
            </div>
            <button onclick="setState({showSettings:true})" class="w-full bg-white/10 rounded-xl p-2 text-center hover:bg-white/20 transition text-xs">
              ‚öôÔ∏è Settings & API Key
            </button>
          </div>

          <!-- New Presentation -->
          <div class="px-4 mb-4">
            <button onclick="setState({showTemplates:true})" class="w-full bg-white text-blue-600 rounded-xl p-4 font-bold shadow-lg hover:shadow-xl transition">
              + New Presentation
            </button>
          </div>

          <!-- Import Button -->
          <div class="px-4 mb-6">
            <button onclick="setState({showImport:true})" class="w-full bg-white/20 text-white rounded-xl p-3 font-medium hover:bg-white/30 transition flex items-center justify-center gap-2">
              üì• Import Presentation
            </button>
          </div>

          <!-- Saved Presentations -->
          <div class="px-4 pb-8">
            <h2 class="font-bold mb-3 flex items-center gap-2">
              <span>üìÅ</span> Saved Presentations
              <span class="bg-white/20 px-2 py-0.5 rounded-full text-sm">${state.saved.length}</span>
            </h2>
            ${savedList}
          </div>
          
          <!-- Footer -->
          <div class="text-center text-blue-200 text-xs pb-6">
            Shaare Zedek Medical Center ‚Ä¢ Geriatrics Fellowship
          </div>

          ${state.showTemplates ? renderTemplatesModal() : ''}
          ${state.showImport ? renderImportModal() : ''}
          ${state.showCalc ? renderCalcModal() : ''}
          ${state.showDrugs ? renderDrugsModal() : ''}
          ${state.showLabs ? renderLabsModal() : ''}
          ${state.showEmergency ? renderEmergencyModal() : ''}
          ${state.showSettings ? renderSettingsModal() : ''}
        </div>
        ${state.recentAction ? `<div class="fixed bottom-4 left-4 right-4 bg-green-500 text-white p-3 rounded-xl text-center animate-fadeIn">${e(state.recentAction)}</div>` : ''}
      `;
    }

    function renderTemplatesModal() {
      return `
        <div class="fixed inset-0 bg-black/50 flex items-end z-50 animate-fadeIn" onclick="if(event.target===this)setState({showTemplates:false})">
          <div class="bg-white w-full rounded-t-2xl p-4 modal-content">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-bold text-lg text-slate-800">Choose Template</h3>
              <button onclick="setState({showTemplates:false})" class="text-2xl text-slate-400">√ó</button>
            </div>
            <div class="space-y-3">
              ${Object.entries(templates).map(([key, t]) => `
                <button onclick="createPresentation('${key}')" class="w-full bg-slate-50 hover:bg-slate-100 rounded-xl p-4 text-left transition">
                  <div class="font-bold text-slate-800">${t.name}</div>
                  <div class="text-sm text-slate-500">${t.desc}</div>
                </button>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    }

    function renderImportModal() {
      return `
        <div class="fixed inset-0 bg-black/50 flex items-end z-50 animate-fadeIn" onclick="if(event.target===this)setState({showImport:false,importText:''})">
          <div class="bg-white w-full rounded-t-2xl p-4 modal-content max-h-[85vh] overflow-auto">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-bold text-lg text-slate-800">üì• Import Presentation</h3>
              <button onclick="setState({showImport:false,importText:''})" class="text-2xl text-slate-400">√ó</button>
            </div>
            
            <!-- Supported Formats -->
            <div class="bg-blue-50 rounded-lg p-3 mb-4 text-sm">
              <div class="font-medium text-blue-800 mb-2">Supported formats:</div>
              <div class="grid grid-cols-2 gap-1 text-blue-600 text-xs">
                <div>üìÑ <b>JSON</b> - Native format</div>
                <div>üìù <b>Markdown</b> - # Headers</div>
                <div>üìã <b>Plain text</b> - Auto-detect</div>
                <div>üìä <b>CSV/TSV</b> - Lists, labs</div>
                <div>üé® <b>PPTX</b> - PowerPoint</div>
                <div>üåê <b>HTML</b> - Web pages</div>
                <div>üìë <b>PDF</b> - Documents</div>
                <div>üìÅ <b>DOCX</b> - Word docs</div>
              </div>
            </div>

            <!-- File Upload -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-slate-700 mb-2">Upload File</label>
              <input type="file" id="importFileInput"
                accept=".json,.md,.txt,.csv,.tsv,.markdown,.pptx,.html,.htm,.pdf,.docx,.doc"
                onchange="handleFileImport(this.files[0])"
                class="w-full border rounded-lg p-2 text-sm file:mr-3 file:py-1 file:px-3 file:rounded-full file:border-0 file:text-sm file:bg-blue-100 file:text-blue-700">
              <div id="importStatus" class="text-xs text-slate-500 mt-1"></div>
            </div>

            <!-- Paste Area -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-slate-700 mb-2">Or paste content</label>
              <textarea 
                placeholder="Paste JSON, Markdown, plain text, or CSV here...

Example Markdown:
# Case: Delirium

## Patient
85yo female with confusion

## HPI
2 days of altered mental status...

## Medications
- Metoprolol 25mg daily
- Lisinopril 10mg daily"
                oninput="state.importText=this.value"
                class="w-full border rounded-lg p-3 min-h-32 text-sm font-mono">${e(state.importText || '')}</textarea>
            </div>

            <!-- Quick Examples -->
            <div class="mb-4">
              <div class="text-sm font-medium text-slate-700 mb-2">Quick examples:</div>
              <div class="flex gap-2 flex-wrap">
                <button onclick="loadExampleDelirium()" class="px-3 py-1 bg-slate-100 rounded-full text-xs hover:bg-slate-200">Delirium case</button>
                <button onclick="loadExampleFalls()" class="px-3 py-1 bg-slate-100 rounded-full text-xs hover:bg-slate-200">Falls case</button>
                <button onclick="loadExampleMedList()" class="px-3 py-1 bg-slate-100 rounded-full text-xs hover:bg-slate-200">Med list CSV</button>
              </div>
            </div>

            <!-- Import Button -->
            <button onclick="importPresentation(state.importText)" 
              ${!state.importText ? 'disabled' : ''}
              class="w-full bg-blue-500 text-white rounded-lg py-3 font-medium disabled:opacity-50 disabled:cursor-not-allowed">
              Import Presentation
            </button>

            <!-- Export Current -->
            ${state.saved.length > 0 ? `
              <div class="mt-4 pt-4 border-t">
                <div class="text-sm font-medium text-slate-700 mb-2">Export existing:</div>
                <div class="flex gap-2 flex-wrap">
                  ${state.saved.slice(0, 3).map((p, i) => `
                    <button onclick="exportPresentation(${i})" 
                      class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs hover:bg-green-200">
                      üì§ ${e((p.slides[0]?.title || 'Untitled').substring(0, 15))}
                    </button>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    function renderSettingsModal() {
      return `
        <div class="fixed inset-0 bg-black/50 flex items-end z-50 animate-fadeIn" onclick="if(event.target===this)setState({showSettings:false})">
          <div class="bg-white w-full rounded-t-2xl p-4 modal-content max-h-[80vh] overflow-auto">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-bold text-lg text-slate-800">‚öôÔ∏è Settings</h3>
              <button onclick="setState({showSettings:false})" class="text-2xl text-slate-400">√ó</button>
            </div>
            
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Anthropic API Key (for AI features)</label>
                <input type="password" value="${e(state.apiKey)}"
                  oninput="state.apiKey=this.value;save()"
                  placeholder="sk-ant-..."
                  class="w-full border rounded-lg p-3 text-slate-800">
                <div class="flex items-center justify-between text-xs text-slate-500 mt-1">
                  <span>Get your key from console.anthropic.com</span>
                  <button onclick="testAPIKey()" class="text-blue-600 font-medium">Test key ‚Üí</button>
                </div>
                ${state.apiStatus ? `<div class="mt-2 text-sm ${state.apiStatus.includes('‚úÖ') ? 'text-green-600' : 'text-orange-600'}">${e(state.apiStatus)}</div>` : ''}
              </div>

              <div class="border-t pt-4">
                <h4 class="font-medium text-slate-700 mb-2">Data Management</h4>
                <button onclick="if(confirm('Export all data?')){const d=JSON.stringify(state.saved);navigator.clipboard.writeText(d);showToast('Copied to clipboard!')}"
                  class="w-full bg-blue-50 text-blue-700 rounded-lg p-3 mb-2">
                  üì§ Export All Presentations
                </button>
                <button onclick="if(confirm('This will delete ALL data. Continue?')){state.saved=[];state.pres=null;save();setState({view:'home',showSettings:false})}" 
                  class="w-full bg-red-50 text-red-700 rounded-lg p-3">
                  üóëÔ∏è Clear All Data
                </button>
              </div>
              
              <div class="border-t pt-4 text-center text-slate-500 text-sm">
                <p>SZMC Geriatrics Pro v${VERSION}</p>
                <p>Built for Shaare Zedek Medical Center</p>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderQAModal() {
      const r = state.qaResults || { issues: [], warnings: [], score: 0, summary: '' };
      const badge = r.score >= 85 ? 'bg-green-100 text-green-700' : r.score >= 60 ? 'bg-amber-100 text-amber-700' : 'bg-red-100 text-red-700';
      const prompt = `Use this QA report to improve the slides. Score: ${r.score}. Issues: ${r.issues.join('; ')}. Warnings: ${r.warnings.join('; ')}. Presentation summary: ${r.summary}`;
      const promptSafe = JSON.stringify(prompt);

      return `
        <div class="fixed inset-0 bg-black/50 flex items-end z-50 animate-fadeIn" onclick="if(event.target===this)setState({showQA:false})">
          <div class="bg-white w-full rounded-t-2xl p-5 modal-content max-h-[80vh] overflow-auto">
            <div class="flex items-start justify-between mb-3">
              <div>
                <div class="text-sm text-slate-500">Presentation QA</div>
                <div class="flex items-center gap-3">
                  <div class="text-3xl font-bold">${r.score}</div>
                  <span class="text-xs ${badge} px-2 py-1 rounded-full">Readiness score</span>
                </div>
              </div>
              <button onclick="setState({showQA:false})" class="text-2xl text-slate-400">√ó</button>
            </div>

            <div class="bg-slate-50 rounded-lg p-3 text-xs text-slate-600 mb-3">
              <div class="font-medium text-slate-800 mb-1">Snapshot</div>
              <pre class="whitespace-pre-wrap text-[11px]">${e(r.summary)}</pre>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div class="bg-red-50 rounded-lg p-3">
                <div class="font-semibold text-red-700 mb-2">Critical fixes</div>
                ${r.issues.length ? `<ul class="list-disc list-inside text-sm text-red-800 space-y-1">${r.issues.map(i => `<li>${e(i)}</li>`).join('')}</ul>` : '<p class="text-sm text-red-700">No critical gaps detected.</p>'}
              </div>
              <div class="bg-amber-50 rounded-lg p-3">
                <div class="font-semibold text-amber-700 mb-2">Warnings</div>
                ${r.warnings.length ? `<ul class="list-disc list-inside text-sm text-amber-800 space-y-1">${r.warnings.map(i => `<li>${e(i)}</li>`).join('')}</ul>` : '<p class="text-sm text-amber-700">No warnings detected.</p>'}
              </div>
            </div>

            <div class="mt-4 flex flex-col gap-2">
              <button onclick="state.aiInput=${promptSafe}; setState({showAI:true, showQA:false}); setTimeout(()=>sendAI(),80)" class="w-full bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-lg py-3 font-medium shadow">‚ö° Ask AI to fix these</button>
              <button onclick="state.aiInput='Convert this entire case into 6 bullet slides with evidence citations and monitoring plans.'; setState({showAI:true, showQA:false}); setTimeout(()=>sendAI(),80)" class="w-full bg-slate-900 text-white rounded-lg py-3 font-medium">üé¨ Auto-build speaker deck</button>
              <button onclick="setState({showQA:false})" class="w-full bg-slate-100 text-slate-700 rounded-lg py-3 font-medium">Close</button>
            </div>
          </div>
        </div>
      `;
    }

    function renderCalcModal() {
      const calcTypes = [
        ['crcl', 'üíß CrCl'],
        ['ckdepi', 'üß™ eGFR'],
        ['anion', '‚ö° Anion Gap'],
        ['wellsDVT', 'ü¶µ Wells DVT'],
        ['wellsPE', 'ü´Å Wells PE'],
        ['perc', '‚úì PERC'],
        ['curb65', 'ü¶† CURB-65'],
        ['heart', '‚ù§Ô∏è HEART'],
        ['chads', 'üíî CHA‚ÇÇDS‚ÇÇ'],
        ['hasbled', 'ü©∏ HAS-BLED'],
        ['meld', 'ü´Ä MELD'],
        ['corrNa', 'üßÇ Na Correct'],
        ['corrCa', 'ü¶¥ Ca Correct'],
        ['cam', 'üß† CAM'],
        ['morse', 'üö∂ Morse']
      ];

      let fields = '';
      const ci = state.calcIn;

      switch(state.calcType) {
        case 'crcl':
          fields = `
            <h4 class="font-medium mb-2">Creatinine Clearance (Cockcroft-Gault)</h4>
            <input type="number" placeholder="Age" value="${ci.age||''}" oninput="state.calcIn.age=this.value" class="w-full border rounded-lg p-3 mb-2">
            <input type="number" placeholder="Weight (kg)" value="${ci.wt||''}" oninput="state.calcIn.wt=this.value" class="w-full border rounded-lg p-3 mb-2">
            <input type="number" step="0.1" placeholder="Creatinine (mg/dL)" value="${ci.cr||''}" oninput="state.calcIn.cr=this.value" class="w-full border rounded-lg p-3 mb-2">
            <label class="flex items-center gap-2"><input type="checkbox" ${ci.female?'checked':''} onchange="state.calcIn.female=this.checked"> Female</label>`;
          break;
        case 'ckdepi':
          fields = `
            <h4 class="font-medium mb-2">eGFR (CKD-EPI 2021)</h4>
            <input type="number" placeholder="Age" value="${ci.age||''}" oninput="state.calcIn.age=this.value" class="w-full border rounded-lg p-3 mb-2">
            <input type="number" step="0.1" placeholder="Creatinine (mg/dL)" value="${ci.cr||''}" oninput="state.calcIn.cr=this.value" class="w-full border rounded-lg p-3 mb-2">
            <label class="flex items-center gap-2"><input type="checkbox" ${ci.female?'checked':''} onchange="state.calcIn.female=this.checked"> Female</label>`;
          break;
        case 'anion':
          fields = `
            <h4 class="font-medium mb-2">Anion Gap</h4>
            <input type="number" placeholder="Sodium (mEq/L)" value="${ci.na||''}" oninput="state.calcIn.na=this.value" class="w-full border rounded-lg p-3 mb-2">
            <input type="number" placeholder="Chloride (mEq/L)" value="${ci.cl||''}" oninput="state.calcIn.cl=this.value" class="w-full border rounded-lg p-3 mb-2">
            <input type="number" placeholder="Bicarb (mEq/L)" value="${ci.hco3||''}" oninput="state.calcIn.hco3=this.value" class="w-full border rounded-lg p-3 mb-2">
            <input type="number" step="0.1" placeholder="Albumin (g/dL) - optional" value="${ci.alb||''}" oninput="state.calcIn.alb=this.value" class="w-full border rounded-lg p-3">
            <p class="text-xs text-slate-500 mt-1">Corrected AG = AG + 2.5 √ó (4 - Albumin)</p>`;
          break;
        case 'corrNa':
          fields = `
            <h4 class="font-medium mb-2">Corrected Sodium (for hyperglycemia)</h4>
            <input type="number" placeholder="Measured Sodium (mEq/L)" value="${ci.na||''}" oninput="state.calcIn.na=this.value" class="w-full border rounded-lg p-3 mb-2">
            <input type="number" placeholder="Glucose (mg/dL)" value="${ci.glu||''}" oninput="state.calcIn.glu=this.value" class="w-full border rounded-lg p-3">
            <p class="text-xs text-slate-500 mt-1">Na + 0.024 √ó (Glucose - 100)</p>`;
          break;
        case 'corrCa':
          fields = `
            <h4 class="font-medium mb-2">Corrected Calcium (for hypoalbuminemia)</h4>
            <input type="number" step="0.1" placeholder="Total Calcium (mg/dL)" value="${ci.ca||''}" oninput="state.calcIn.ca=this.value" class="w-full border rounded-lg p-3 mb-2">
            <input type="number" step="0.1" placeholder="Albumin (g/dL)" value="${ci.alb||''}" oninput="state.calcIn.alb=this.value" class="w-full border rounded-lg p-3">
            <p class="text-xs text-slate-500 mt-1">Ca + 0.8 √ó (4 - Albumin)</p>`;
          break;
        case 'wellsDVT':
          fields = `
            <h4 class="font-medium mb-2">Wells Score for DVT</h4>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.cancer?'checked':''} onchange="state.calcIn.cancer=this.checked"> Active cancer (+1)</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.paralysis?'checked':''} onchange="state.calcIn.paralysis=this.checked"> Paralysis/immobilization (+1)</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.bedridden?'checked':''} onchange="state.calcIn.bedridden=this.checked"> Bedridden >3d or surgery <12wk (+1)</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.tenderness?'checked':''} onchange="state.calcIn.tenderness=this.checked"> Tenderness along deep veins (+1)</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.swelling?'checked':''} onchange="state.calcIn.swelling=this.checked"> Entire leg swelling (+1)</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.calf?'checked':''} onchange="state.calcIn.calf=this.checked"> Calf >3cm larger (+1)</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.pitting?'checked':''} onchange="state.calcIn.pitting=this.checked"> Pitting edema (+1)</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.collateral?'checked':''} onchange="state.calcIn.collateral=this.checked"> Collateral superficial veins (+1)</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.prevDVT?'checked':''} onchange="state.calcIn.prevDVT=this.checked"> Previous documented DVT (+1)</label>
            <label class="flex items-center gap-2 p-2 bg-yellow-50 rounded"><input type="checkbox" ${ci.altDx?'checked':''} onchange="state.calcIn.altDx=this.checked"> Alternative diagnosis as likely (-2)</label>`;
          break;
        case 'wellsPE':
          fields = `
            <h4 class="font-medium mb-2">Wells Score for PE</h4>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.dvtSx?'checked':''} onchange="state.calcIn.dvtSx=this.checked"> DVT signs/symptoms (+3)</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.peFirst?'checked':''} onchange="state.calcIn.peFirst=this.checked"> PE is #1 diagnosis (+3)</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.hr100?'checked':''} onchange="state.calcIn.hr100=this.checked"> Heart rate >100 (+1.5)</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.immob?'checked':''} onchange="state.calcIn.immob=this.checked"> Immobilization/surgery <4wk (+1.5)</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.prevVTE?'checked':''} onchange="state.calcIn.prevVTE=this.checked"> Previous DVT/PE (+1.5)</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.hemoptysis?'checked':''} onchange="state.calcIn.hemoptysis=this.checked"> Hemoptysis (+1)</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded"><input type="checkbox" ${ci.malignancy?'checked':''} onchange="state.calcIn.malignancy=this.checked"> Malignancy (+1)</label>`;
          break;
        case 'perc':
          fields = `
            <h4 class="font-medium mb-2">PERC Rule (all must be NO to rule out PE)</h4>
            <p class="text-xs text-slate-500 mb-2">If ALL are negative + low pretest prob ‚Üí PE ruled out without D-dimer</p>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.age50?'checked':''} onchange="state.calcIn.age50=this.checked"> Age ‚â•50</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.hr100?'checked':''} onchange="state.calcIn.hr100=this.checked"> HR ‚â•100</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.spo2?'checked':''} onchange="state.calcIn.spo2=this.checked"> SpO2 <95% on RA</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.legSwell?'checked':''} onchange="state.calcIn.legSwell=this.checked"> Unilateral leg swelling</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.hemoptysis?'checked':''} onchange="state.calcIn.hemoptysis=this.checked"> Hemoptysis</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.surgery?'checked':''} onchange="state.calcIn.surgery=this.checked"> Surgery/trauma <4wk</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.prevVTE?'checked':''} onchange="state.calcIn.prevVTE=this.checked"> Prior DVT/PE</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded"><input type="checkbox" ${ci.estrogen?'checked':''} onchange="state.calcIn.estrogen=this.checked"> Hormone use (OCP/HRT)</label>`;
          break;
        case 'curb65':
          fields = `
            <h4 class="font-medium mb-2">CURB-65 (Pneumonia Severity)</h4>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.confusion?'checked':''} onchange="state.calcIn.confusion=this.checked"> <b>C</b>onfusion (new)</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.urea?'checked':''} onchange="state.calcIn.urea=this.checked"> <b>U</b>rea >7 mmol/L (BUN >19)</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.rr?'checked':''} onchange="state.calcIn.rr=this.checked"> <b>R</b>espiratory rate ‚â•30</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.bp?'checked':''} onchange="state.calcIn.bp=this.checked"> <b>B</b>lood pressure: SBP <90 or DBP ‚â§60</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded"><input type="checkbox" ${ci.age65?'checked':''} onchange="state.calcIn.age65=this.checked"> Age ‚â•<b>65</b></label>`;
          break;
        case 'heart':
          fields = `
            <h4 class="font-medium mb-2">HEART Score (Chest Pain Risk)</h4>
            <div class="mb-2">
              <label class="text-sm font-medium">History</label>
              <select onchange="state.calcIn.history=+this.value" class="w-full border rounded-lg p-2 text-sm">
                <option value="">Select...</option>
                <option value="0" ${ci.history===0?'selected':''}>Slightly suspicious (0)</option>
                <option value="1" ${ci.history===1?'selected':''}>Moderately suspicious (1)</option>
                <option value="2" ${ci.history===2?'selected':''}>Highly suspicious (2)</option>
              </select>
            </div>
            <div class="mb-2">
              <label class="text-sm font-medium">ECG</label>
              <select onchange="state.calcIn.ecg=+this.value" class="w-full border rounded-lg p-2 text-sm">
                <option value="">Select...</option>
                <option value="0" ${ci.ecg===0?'selected':''}>Normal (0)</option>
                <option value="1" ${ci.ecg===1?'selected':''}>Non-specific changes (1)</option>
                <option value="2" ${ci.ecg===2?'selected':''}>Significant ST deviation (2)</option>
              </select>
            </div>
            <div class="mb-2">
              <label class="text-sm font-medium">Age</label>
              <select onchange="state.calcIn.ageScore=+this.value" class="w-full border rounded-lg p-2 text-sm">
                <option value="">Select...</option>
                <option value="0" ${ci.ageScore===0?'selected':''}><45 (0)</option>
                <option value="1" ${ci.ageScore===1?'selected':''}>45-64 (1)</option>
                <option value="2" ${ci.ageScore===2?'selected':''}>‚â•65 (2)</option>
              </select>
            </div>
            <div class="mb-2">
              <label class="text-sm font-medium">Risk Factors (HTN, DM, smoking, obesity, FHx)</label>
              <select onchange="state.calcIn.risk=+this.value" class="w-full border rounded-lg p-2 text-sm">
                <option value="">Select...</option>
                <option value="0" ${ci.risk===0?'selected':''}>None (0)</option>
                <option value="1" ${ci.risk===1?'selected':''}>1-2 factors (1)</option>
                <option value="2" ${ci.risk===2?'selected':''}>‚â•3 or known CAD/PVD/CVA (2)</option>
              </select>
            </div>
            <div class="mb-2">
              <label class="text-sm font-medium">Troponin</label>
              <select onchange="state.calcIn.trop=+this.value" class="w-full border rounded-lg p-2 text-sm">
                <option value="">Select...</option>
                <option value="0" ${ci.trop===0?'selected':''}>Normal (0)</option>
                <option value="1" ${ci.trop===1?'selected':''}>1-3x normal (1)</option>
                <option value="2" ${ci.trop===2?'selected':''}>>3x normal (2)</option>
              </select>
            </div>`;
          break;
        case 'cam':
          fields = `
            <h4 class="font-medium mb-2">CAM (Confusion Assessment Method)</h4>
            <p class="text-xs text-slate-500 mb-2">Positive = 1 + 2 + (3 or 4)</p>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.acute?'checked':''} onchange="state.calcIn.acute=this.checked"> 1. Acute onset + fluctuating</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.inattention?'checked':''} onchange="state.calcIn.inattention=this.checked"> 2. Inattention</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.disorganized?'checked':''} onchange="state.calcIn.disorganized=this.checked"> 3. Disorganized thinking</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded"><input type="checkbox" ${ci.altered?'checked':''} onchange="state.calcIn.altered=this.checked"> 4. Altered consciousness</label>`;
          break;
        case 'morse':
          fields = `
            <h4 class="font-medium mb-2">Morse Fall Scale</h4>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.fallHx?'checked':''} onchange="state.calcIn.fallHx=this.checked"> Fall history (25pts)</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.secDx?'checked':''} onchange="state.calcIn.secDx=this.checked"> Secondary diagnosis (15pts)</label>
            <select onchange="state.calcIn.ambAid=this.value" class="w-full border rounded-lg p-3 mb-2">
              <option value="">Ambulatory aid (0pts)</option>
              <option value="device" ${ci.ambAid==='device'?'selected':''}>Cane/Walker (15pts)</option>
              <option value="furniture" ${ci.ambAid==='furniture'?'selected':''}>Furniture (30pts)</option>
            </select>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.iv?'checked':''} onchange="state.calcIn.iv=this.checked"> IV/Heparin lock (20pts)</label>
            <select onchange="state.calcIn.gait=this.value" class="w-full border rounded-lg p-3 mb-2">
              <option value="">Normal gait (0pts)</option>
              <option value="weak" ${ci.gait==='weak'?'selected':''}>Weak (10pts)</option>
              <option value="impaired" ${ci.gait==='impaired'?'selected':''}>Impaired (20pts)</option>
            </select>`;
          break;
        case 'chads':
          fields = `
            <h4 class="font-medium mb-2">CHA‚ÇÇDS‚ÇÇ-VASc (Stroke Risk in AFib)</h4>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.chf?'checked':''} onchange="state.calcIn.chf=this.checked"> CHF (1pt)</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.htn?'checked':''} onchange="state.calcIn.htn=this.checked"> Hypertension (1pt)</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.age75?'checked':''} onchange="state.calcIn.age75=this.checked;if(this.checked)state.calcIn.age65=false"> Age ‚â•75 (2pts)</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.age65?'checked':''} onchange="state.calcIn.age65=this.checked;if(this.checked)state.calcIn.age75=false"> Age 65-74 (1pt)</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.dm?'checked':''} onchange="state.calcIn.dm=this.checked"> Diabetes (1pt)</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.stroke?'checked':''} onchange="state.calcIn.stroke=this.checked"> Stroke/TIA (2pts)</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.vasc?'checked':''} onchange="state.calcIn.vasc=this.checked"> Vascular disease (1pt)</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded"><input type="checkbox" ${ci.female?'checked':''} onchange="state.calcIn.female=this.checked"> Female (1pt)</label>`;
          break;
        case 'hasbled':
          fields = `
            <h4 class="font-medium mb-2">HAS-BLED (Bleeding Risk)</h4>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.htn?'checked':''} onchange="state.calcIn.htn=this.checked"> <b>H</b>ypertension (SBP >160)</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.abnRenal?'checked':''} onchange="state.calcIn.abnRenal=this.checked"> <b>A</b>bnormal renal function</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.abnLiver?'checked':''} onchange="state.calcIn.abnLiver=this.checked"> <b>A</b>bnormal liver function</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.strokeHx?'checked':''} onchange="state.calcIn.strokeHx=this.checked"> <b>S</b>troke history</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.bleedHx?'checked':''} onchange="state.calcIn.bleedHx=this.checked"> <b>B</b>leeding history/predisposition</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.labile?'checked':''} onchange="state.calcIn.labile=this.checked"> <b>L</b>abile INRs</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.elderly?'checked':''} onchange="state.calcIn.elderly=this.checked"> <b>E</b>lderly (>65)</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.drugs?'checked':''} onchange="state.calcIn.drugs=this.checked"> <b>D</b>rugs (antiplatelets, NSAIDs)</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded"><input type="checkbox" ${ci.alcohol?'checked':''} onchange="state.calcIn.alcohol=this.checked"> Alcohol (‚â•8 drinks/wk)</label>`;
          break;
        case 'meld':
          fields = `
            <h4 class="font-medium mb-2">MELD-Na (Liver Disease Severity)</h4>
            <input type="number" step="0.1" placeholder="Bilirubin (mg/dL)" value="${ci.bili||''}" oninput="state.calcIn.bili=this.value" class="w-full border rounded-lg p-3 mb-2">
            <input type="number" step="0.1" placeholder="Creatinine (mg/dL)" value="${ci.cr||''}" oninput="state.calcIn.cr=this.value" class="w-full border rounded-lg p-3 mb-2">
            <input type="number" step="0.1" placeholder="INR" value="${ci.inr||''}" oninput="state.calcIn.inr=this.value" class="w-full border rounded-lg p-3 mb-2">
            <input type="number" placeholder="Sodium (mEq/L)" value="${ci.na||''}" oninput="state.calcIn.na=this.value" class="w-full border rounded-lg p-3 mb-2">
            <label class="flex items-center gap-2"><input type="checkbox" ${ci.dialysis?'checked':''} onchange="state.calcIn.dialysis=this.checked"> On dialysis (Cr set to 4)</label>`;
          break;
      }

      let resultColor = 'bg-slate-100';
      if (state.calcRes) {
        const i = (state.calcRes.i || '').toLowerCase();
        if (i.includes('normal') || i.includes('robust') || i.includes('low') || state.calcRes.v === 'Negative') {
          resultColor = 'bg-green-100 text-green-800';
        } else if (i.includes('stage 4') || i.includes('stage 5') || i.includes('frail') || i.includes('high') || i.includes('severe') || state.calcRes.v === 'POSITIVE' || i.includes('malnourished')) {
          resultColor = 'bg-red-100 text-red-800';
        } else {
          resultColor = 'bg-yellow-100 text-yellow-800';
        }
      }

      return `
        <div class="fixed inset-0 bg-black/50 flex items-end z-50 animate-fadeIn" onclick="if(event.target===this)setState({showCalc:false})">
          <div class="bg-white w-full rounded-t-2xl p-4 modal-content max-h-[85vh] overflow-auto">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-bold text-lg text-slate-800">üßÆ Calculators</h3>
              <button onclick="setState({showCalc:false})" class="text-2xl text-slate-400">√ó</button>
            </div>
            
            <div class="flex gap-2 overflow-x-auto pb-3 mb-3">
              ${calcTypes.map(([k, n]) => `
                <button onclick="setState({calcType:'${k}',calcIn:{},calcRes:null})" 
                  class="flex-shrink-0 px-3 py-2 rounded-lg text-sm ${state.calcType === k ? 'bg-orange-500 text-white' : 'bg-slate-100'}">
                  ${n}
                </button>
              `).join('')}
            </div>
            
            <div class="space-y-2 text-slate-700">
              ${fields}
            </div>
            
            <button onclick="calculate()" class="w-full bg-orange-500 text-white rounded-lg py-3 font-medium mt-4">Calculate</button>
            
            ${state.calcRes ? `
              <div class="${resultColor} rounded-lg p-4 mt-4 text-center">
                <div class="text-3xl font-bold">${state.calcRes.v} ${state.calcRes.u}</div>
                <div class="mt-1">${state.calcRes.i}</div>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    function renderDrugsModal() {
      return `
        <div class="fixed inset-0 bg-black/50 flex items-end z-50 animate-fadeIn" onclick="if(event.target===this)setState({showDrugs:false})">
          <div class="bg-white w-full rounded-t-2xl p-4 modal-content max-h-[85vh] overflow-auto">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-bold text-lg text-slate-800">üíä Clinical Drug Reference</h3>
              <button onclick="setState({showDrugs:false})" class="text-2xl text-slate-400">√ó</button>
            </div>
            
            <!-- Tabs -->
            <div class="flex gap-1 mb-4 overflow-x-auto pb-2">
              <button onclick="document.getElementById('drug-interactions').scrollIntoView({behavior:'smooth'})" class="px-3 py-1 bg-red-100 text-red-700 rounded-full text-xs whitespace-nowrap">‚ö†Ô∏è Interactions</button>
              <button onclick="document.getElementById('drug-renal').scrollIntoView({behavior:'smooth'})" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs whitespace-nowrap">üíß Renal Dosing</button>
              <button onclick="document.getElementById('drug-geri-dosing').scrollIntoView({behavior:'smooth'})" class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-xs whitespace-nowrap">üßì Geriatric Dosing</button>
              <button onclick="document.getElementById('drug-abx').scrollIntoView({behavior:'smooth'})" class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs whitespace-nowrap">ü¶† Antibiotics</button>
              <button onclick="document.getElementById('drug-beers').scrollIntoView({behavior:'smooth'})" class="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-xs whitespace-nowrap">‚ö†Ô∏è Beers</button>
            </div>
            
            <!-- Drug Interactions -->
            <div id="drug-interactions" class="mb-6">
              <h4 class="font-bold text-red-600 mb-2 sticky top-0 bg-white py-1">‚ö†Ô∏è High-Risk Drug Interactions</h4>
              <div class="space-y-2">
                ${KNOWLEDGE.interactions.map(i => `
                  <div class="bg-red-50 rounded-lg p-2 text-sm">
                    <div class="font-medium text-red-800">${i.drugs}</div>
                    <div class="text-red-600 text-xs">${i.risk}</div>
                    <div class="text-green-600 text-xs font-medium">‚Üí ${i.action}</div>
                  </div>
                `).join('')}
              </div>
            </div>
            
            <!-- Renal Dosing -->
            <div id="drug-renal" class="mb-6">
              <h4 class="font-bold text-blue-600 mb-2 sticky top-0 bg-white py-1">üíß Renal Dosing Adjustments</h4>
              <div class="overflow-x-auto">
                <table class="w-full text-xs">
                  <thead>
                    <tr class="bg-blue-50">
                      <th class="p-2 text-left">Drug</th>
                      <th class="p-2">GFR >60</th>
                      <th class="p-2">GFR 30-60</th>
                      <th class="p-2">GFR 15-30</th>
                      <th class="p-2">GFR <15</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${KNOWLEDGE.renalDosing.map(d => `
                      <tr class="border-b">
                        <td class="p-2 font-medium">${d.drug}</td>
                        <td class="p-2 text-center">${d.normal}</td>
                        <td class="p-2 text-center">${d.gfr60}</td>
                        <td class="p-2 text-center ${d.gfr30.includes('AVOID') ? 'text-red-600 font-bold' : ''}">${d.gfr30}</td>
                        <td class="p-2 text-center ${d.gfr15.includes('AVOID') || d.gfr15.includes('CONTRA') ? 'text-red-600 font-bold' : ''}">${d.gfr15}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
            
            <!-- Geriatric Dosing -->
            <div id="drug-geri-dosing" class="mb-6">
              <h4 class="font-bold text-purple-600 mb-2 sticky top-0 bg-white py-1">üë¥ Geriatric Dosing (Start Low, Go Slow)</h4>
              <div class="space-y-2">
                ${KNOWLEDGE.geriatrics.dosing.map(d => `
                  <div class="bg-purple-50 rounded-lg p-2 text-sm">
                    <div class="font-medium text-purple-800">${d.drug}</div>
                    <div class="text-purple-700 text-xs"><b>Start:</b> ${d.start}</div>
                    <div class="text-slate-500 text-xs">${d.note}</div>
                  </div>
                `).join('')}
              </div>
            </div>
            
            <!-- Antibiotics -->
            <div id="drug-abx" class="mb-6">
              <h4 class="font-bold text-green-600 mb-2 sticky top-0 bg-white py-1">ü¶† Empiric Antibiotic Guide</h4>
              <div class="space-y-2">
                ${KNOWLEDGE.antibiotics.map(a => `
                  <div class="bg-green-50 rounded-lg p-2 text-sm">
                    <div class="font-medium text-green-800">${a.indication}</div>
                    <div class="text-green-700 text-xs"><b>1st:</b> ${a.first}</div>
                    <div class="text-green-600 text-xs"><b>Alt:</b> ${a.alt}</div>
                    <div class="text-slate-500 text-xs">${a.duration || a.note || ''}</div>
                  </div>
                `).join('')}
              </div>
            </div>
            
            <!-- Beers Criteria -->
            <div id="drug-beers" class="mb-4">
              <h4 class="font-bold text-orange-600 mb-2 sticky top-0 bg-white py-1">‚ö†Ô∏è Beers Criteria (Avoid in Older Adults)</h4>
              <div class="space-y-2">
                ${KNOWLEDGE.geriatrics.beers.map(d => `
                  <div class="bg-orange-50 rounded-lg p-2 text-sm">
                    <div class="font-medium">${d.drug}</div>
                    <div class="text-orange-600 text-xs">${d.risk}</div>
                    <div class="text-green-600 text-xs">‚Üí ${d.alt}</div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderLabsModal() {
      return `
        <div class="fixed inset-0 bg-black/50 flex items-end z-50 animate-fadeIn" onclick="if(event.target===this)setState({showLabs:false})">
          <div class="bg-white w-full rounded-t-2xl p-4 modal-content max-h-[85vh] overflow-auto">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-bold text-lg text-slate-800">üß™ Lab Reference</h3>
              <button onclick="setState({showLabs:false})" class="text-2xl text-slate-400">√ó</button>
            </div>
            
            <!-- Tabs -->
            <div class="flex gap-1 mb-4 overflow-x-auto pb-2">
              <button onclick="document.getElementById('lab-critical').scrollIntoView({behavior:'smooth'})" class="px-3 py-1 bg-red-100 text-red-700 rounded-full text-xs whitespace-nowrap">üö® Critical</button>
              <button onclick="document.getElementById('lab-cbc').scrollIntoView({behavior:'smooth'})" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs whitespace-nowrap">CBC</button>
              <button onclick="document.getElementById('lab-bmp').scrollIntoView({behavior:'smooth'})" class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs whitespace-nowrap">BMP</button>
              <button onclick="document.getElementById('lab-lft').scrollIntoView({behavior:'smooth'})" class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs whitespace-nowrap">LFTs</button>
              <button onclick="document.getElementById('lab-coags').scrollIntoView({behavior:'smooth'})" class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-xs whitespace-nowrap">Coags</button>
              <button onclick="document.getElementById('lab-formulas').scrollIntoView({behavior:'smooth'})" class="px-3 py-1 bg-slate-100 text-slate-700 rounded-full text-xs whitespace-nowrap">üìê Formulas</button>
            </div>
            
            <!-- Critical Values -->
            <div id="lab-critical" class="mb-6">
              <h4 class="font-bold text-red-600 mb-2">üö® Critical Values - Act Immediately</h4>
              <div class="space-y-1">
                ${KNOWLEDGE.criticalLabs.map(l => `
                  <div class="bg-red-50 rounded p-2 text-sm flex justify-between items-start">
                    <div>
                      <span class="font-medium">${l.test}</span>
                      <span class="text-red-600 ml-2">${l.critical}</span>
                    </div>
                    <div class="text-xs text-red-700 text-right max-w-[50%]">${l.action}</div>
                  </div>
                `).join('')}
              </div>
            </div>
            
            <!-- CBC -->
            <div id="lab-cbc" class="mb-6">
              <h4 class="font-bold text-blue-600 mb-2">CBC</h4>
              <div class="space-y-1">
                ${KNOWLEDGE.labs.cbc.map(l => `
                  <div class="bg-blue-50 rounded p-2 text-xs">
                    <div class="flex justify-between">
                      <span class="font-medium">${l.test}</span>
                      <span>${l.normal} ${l.unit}</span>
                    </div>
                    <div class="text-slate-600 mt-1">‚Üë ${l.high} | ‚Üì ${l.low}</div>
                  </div>
                `).join('')}
              </div>
            </div>
            
            <!-- BMP -->
            <div id="lab-bmp" class="mb-6">
              <h4 class="font-bold text-green-600 mb-2">BMP</h4>
              <div class="space-y-1">
                ${KNOWLEDGE.labs.bmp.map(l => `
                  <div class="bg-green-50 rounded p-2 text-xs">
                    <div class="flex justify-between">
                      <span class="font-medium">${l.test}</span>
                      <span>${l.normal} ${l.unit}</span>
                    </div>
                    <div class="text-slate-600 mt-1">‚Üë ${l.high} | ‚Üì ${l.low}</div>
                  </div>
                `).join('')}
              </div>
            </div>
            
            <!-- LFTs -->
            <div id="lab-lft" class="mb-6">
              <h4 class="font-bold text-yellow-600 mb-2">LFTs / Hepatic</h4>
              <div class="space-y-1">
                ${KNOWLEDGE.labs.lft.map(l => `
                  <div class="bg-yellow-50 rounded p-2 text-xs">
                    <div class="flex justify-between">
                      <span class="font-medium">${l.test}</span>
                      <span>${l.normal} ${l.unit}</span>
                    </div>
                    <div class="text-slate-600 mt-1">${l.pattern || l.high}</div>
                  </div>
                `).join('')}
              </div>
            </div>
            
            <!-- Coags -->
            <div id="lab-coags" class="mb-6">
              <h4 class="font-bold text-purple-600 mb-2">Coagulation</h4>
              <div class="space-y-1">
                ${KNOWLEDGE.labs.coags.map(l => `
                  <div class="bg-purple-50 rounded p-2 text-xs">
                    <div class="flex justify-between">
                      <span class="font-medium">${l.test}</span>
                      <span>${l.normal}</span>
                    </div>
                    <div class="text-slate-600 mt-1">${l.use || l.high}</div>
                  </div>
                `).join('')}
              </div>
            </div>
            
            <!-- Cardiac -->
            <div class="mb-6">
              <h4 class="font-bold text-red-500 mb-2">Cardiac Markers</h4>
              <div class="space-y-1">
                ${KNOWLEDGE.labs.cardiac.map(l => `
                  <div class="bg-red-50 rounded p-2 text-xs">
                    <div class="flex justify-between">
                      <span class="font-medium">${l.test}</span>
                      <span>${l.normal} ${l.unit}</span>
                    </div>
                    <div class="text-slate-600 mt-1">${l.high} ${l.timing || l.note || ''}</div>
                  </div>
                `).join('')}
              </div>
            </div>
            
            <!-- Formulas -->
            <div id="lab-formulas" class="mb-4">
              <h4 class="font-bold text-slate-600 mb-2">üìê Clinical Formulas</h4>
              <div class="space-y-2">
                ${Object.entries(KNOWLEDGE.formulas).slice(0, 8).map(([key, f]) => `
                  <div class="bg-slate-50 rounded p-2 text-xs">
                    <div class="font-medium capitalize">${key.replace(/([A-Z])/g, ' $1')}</div>
                    <div class="font-mono text-slate-700">${f.formula}</div>
                    <div class="text-slate-500">${f.normal || ''} ${f.note || ''}</div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderEmergencyModal() {
      return `
        <div class="fixed inset-0 bg-black/50 flex items-end z-50 animate-fadeIn" onclick="if(event.target===this)setState({showEmergency:false})">
          <div class="bg-white w-full rounded-t-2xl p-4 modal-content max-h-[90vh] overflow-auto">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-bold text-lg text-red-600">üö® Emergency Protocols</h3>
              <button onclick="setState({showEmergency:false})" class="text-2xl text-slate-400">√ó</button>
            </div>
            
            <div class="space-y-4">
              ${KNOWLEDGE.emergencies.map(em => `
                <div class="bg-red-50 border-l-4 border-red-500 rounded-r-lg p-3">
                  <div class="font-bold text-red-700 text-lg mb-2">${em.condition}</div>
                  ${em.ecg ? `<div class="text-xs text-red-600 mb-1"><b>ECG:</b> ${em.ecg}</div>` : ''}
                  ${em.criteria ? `<div class="text-xs text-red-600 mb-1"><b>Criteria:</b> ${em.criteria}</div>` : ''}
                  ${em.symptoms ? `<div class="text-xs text-red-600 mb-1"><b>Symptoms:</b> ${em.symptoms}</div>` : ''}
                  ${em.signs ? `<div class="text-xs text-red-600 mb-1"><b>Signs:</b> ${em.signs}</div>` : ''}
                  <div class="bg-white rounded p-2 mt-2">
                    <div class="text-xs font-bold text-green-700 mb-1">IMMEDIATE ACTIONS:</div>
                    <pre class="text-xs text-slate-700 whitespace-pre-wrap font-sans">${em.immediate || em.hour1}</pre>
                  </div>
                  ${em.contraindications ? `<div class="text-xs text-orange-600 mt-2"><b>‚ö†Ô∏è Contraindications:</b> ${em.contraindications}</div>` : ''}
                  ${em.avoid ? `<div class="text-xs text-orange-600 mt-2"><b>‚ö†Ô∏è Avoid:</b> ${em.avoid}</div>` : ''}
                  ${em.note ? `<div class="text-xs text-slate-500 mt-1 italic">${em.note}</div>` : ''}
                </div>
              `).join('')}
            </div>
            
            <!-- Quick Reference Cards -->
            <div class="mt-6 pt-4 border-t">
              <h4 class="font-bold text-slate-700 mb-3">‚ö° Quick Reference</h4>
              
              <!-- ACLS Drugs -->
              <div class="bg-blue-50 rounded-lg p-3 mb-3">
                <div class="font-bold text-blue-700 mb-2">ACLS Drugs</div>
                <div class="grid grid-cols-2 gap-2 text-xs">
                  <div><b>Epinephrine:</b> 1mg IV q3-5min</div>
                  <div><b>Amiodarone:</b> 300mg, then 150mg</div>
                  <div><b>Lidocaine:</b> 1-1.5mg/kg</div>
                  <div><b>Atropine:</b> 0.5mg q3-5min (max 3mg)</div>
                  <div><b>Adenosine:</b> 6mg, 12mg, 12mg</div>
                  <div><b>Calcium gluconate:</b> 1-2g IV</div>
                  <div><b>Bicarb:</b> 1mEq/kg</div>
                  <div><b>Magnesium:</b> 1-2g IV</div>
                </div>
              </div>
              
              <!-- Vasopressors -->
              <div class="bg-purple-50 rounded-lg p-3 mb-3">
                <div class="font-bold text-purple-700 mb-2">Vasopressors</div>
                <div class="text-xs space-y-1">
                  <div><b>Norepinephrine:</b> 0.1-0.5 mcg/kg/min (1st line sepsis)</div>
                  <div><b>Vasopressin:</b> 0.03-0.04 U/min (adjunct)</div>
                  <div><b>Dopamine:</b> 5-20 mcg/kg/min (2nd line)</div>
                  <div><b>Phenylephrine:</b> 0.5-5 mcg/kg/min (pure Œ±)</div>
                  <div><b>Dobutamine:</b> 2-20 mcg/kg/min (cardiogenic)</div>
                </div>
              </div>
              
              <!-- Reversal Agents -->
              <div class="bg-green-50 rounded-lg p-3 mb-3">
                <div class="font-bold text-green-700 mb-2">Reversal Agents</div>
                <div class="text-xs space-y-1">
                  <div><b>Warfarin:</b> Vit K 10mg IV + 4F-PCC 25-50 U/kg</div>
                  <div><b>Heparin:</b> Protamine 1mg per 100U heparin</div>
                  <div><b>Dabigatran:</b> Idarucizumab 5g IV</div>
                  <div><b>Xa inhibitors:</b> Andexanet or 4F-PCC</div>
                  <div><b>Opioids:</b> Naloxone 0.4-2mg IV/IM/IN</div>
                  <div><b>Benzos:</b> Flumazenil 0.2mg IV (caution!)</div>
                  <div><b>Beta-blockers:</b> Glucagon 3-10mg IV</div>
                  <div><b>CCB:</b> Calcium, glucagon, high-dose insulin</div>
                </div>
              </div>
              
              <!-- RSI Drugs -->
              <div class="bg-orange-50 rounded-lg p-3">
                <div class="font-bold text-orange-700 mb-2">RSI Drugs</div>
                <div class="text-xs space-y-1">
                  <div><b>Etomidate:</b> 0.3mg/kg (hemodynamically stable)</div>
                  <div><b>Ketamine:</b> 1-2mg/kg (bronchospasm, hypotension)</div>
                  <div><b>Propofol:</b> 1-2mg/kg (caution in hypotension)</div>
                  <div><b>Succinylcholine:</b> 1-1.5mg/kg (avoid in hyperK!)</div>
                  <div><b>Rocuronium:</b> 1-1.2mg/kg (can reverse with sugammadex)</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderEditor() {
      if (!state.pres) return renderHome();
      
      const s = state.pres.slides[state.slide];
      
      // Slide thumbnails
      const thumbs = state.pres.slides.map((sl, i) => `
        <button onclick="setState({slide:${i}})" 
          class="flex-shrink-0 px-3 py-2 rounded-lg text-xs whitespace-nowrap transition ${i === state.slide ? 'bg-blue-500 text-white shadow' : 'bg-white shadow-sm'}">
          ${i + 1}. ${e(sl.title.substring(0, 12))}${sl.title.length > 12 ? '...' : ''}
        </button>
      `).join('');

      // Slide content
      let content = '';
      switch(s.type) {
        case 'title':
          content = `
            <div class="text-center py-8">
              <h1 class="text-2xl font-bold mb-2">${e(s.title)}</h1>
              ${s.subtitle ? `<p class="text-slate-600">${e(s.subtitle)}</p>` : ''}
              ${s.presenter ? `<p class="text-sm text-slate-500 mt-4">${e(s.presenter)}</p>` : ''}
              ${s.date ? `<p class="text-sm text-slate-400">${e(s.date)}</p>` : ''}
            </div>`;
          break;
        case 'patient':
          content = `
            <div class="space-y-3">
              ${s.demographics ? `<div><span class="font-medium text-slate-600">Demographics:</span> ${e(s.demographics)}</div>` : ''}
              ${s.cc ? `<div><span class="font-medium text-slate-600">Chief Complaint:</span> ${e(s.cc)}</div>` : ''}
              ${s.codeStatus ? `<div><span class="font-medium text-slate-600">Code Status:</span> ${e(s.codeStatus)}</div>` : ''}
              ${!s.demographics && !s.cc ? '<p class="text-slate-400">No patient info entered</p>' : ''}
            </div>`;
          break;
        case 'content':
          content = `<div class="whitespace-pre-wrap">${e(s.content) || '<span class="text-slate-400">No content</span>'}</div>`;
          break;
        case 'list':
          content = s.items?.length ? `
            <ul class="space-y-2">
              ${s.items.map((item, i) => `<li class="flex items-start gap-2"><span class="text-blue-500 mt-1">‚Ä¢</span><span>${e(item)}</span></li>`).join('')}
            </ul>` : '<p class="text-slate-400">No items</p>';
          break;
        case 'exam':
          const vitals = s.vitals || {};
          content = `
            <div class="space-y-4">
              <div class="grid grid-cols-5 gap-2 text-center">
                ${['BP', 'HR', 'RR', 'Temp', 'SpO2'].map(v => `
                  <div class="bg-slate-50 rounded-lg p-2">
                    <div class="text-xs text-slate-500">${v}</div>
                    <div class="font-medium">${e(vitals[v]) || '‚Äî'}</div>
                  </div>
                `).join('')}
              </div>
              ${s.findings ? `<div class="whitespace-pre-wrap">${e(s.findings)}</div>` : '<p class="text-slate-400">No exam findings</p>'}
            </div>`;
          break;
        case 'scores':
          const scores = s.scores || {};
          const scoreNames = ['MMSE', 'MoCA', 'GDS', 'ADL', 'IADL', 'TUG', 'MNA', 'CFS', 'Morse', 'Braden', 'CAM'];
          content = `
            <div class="grid grid-cols-4 gap-2">
              ${scoreNames.map(sc => `
                <div class="bg-slate-50 rounded-lg p-2 text-center">
                  <div class="text-xs text-slate-500">${sc}</div>
                  <div class="font-medium">${e(scores[sc]) || '‚Äî'}</div>
                </div>
              `).join('')}
            </div>`;
          break;
        case 'treatment':
          content = `
            <div class="space-y-4">
              <div>
                <div class="font-medium text-green-600 mb-1">üíä Pharmacological</div>
                <div class="whitespace-pre-wrap">${e(s.pharm) || '<span class="text-slate-400">None</span>'}</div>
              </div>
              <div>
                <div class="font-medium text-blue-600 mb-1">üè• Non-pharmacological</div>
                <div class="whitespace-pre-wrap">${e(s.nonpharm) || '<span class="text-slate-400">None</span>'}</div>
              </div>
            </div>`;
          break;
        case 'table':
          content = s.rows?.length ? `
            <table class="w-full text-sm">
              ${s.headers ? `<thead><tr>${s.headers.map(h => `<th class="text-left p-2 bg-slate-50">${e(h)}</th>`).join('')}</tr></thead>` : ''}
              <tbody>${s.rows.map(row => `<tr>${row.map(cell => `<td class="p-2 border-b">${e(cell)}</td>`).join('')}</tr>`).join('')}</tbody>
            </table>` : '<p class="text-slate-400">No data</p>';
          break;
        default:
          content = `<div class="whitespace-pre-wrap">${e(s.content) || '<span class="text-slate-400">No content</span>'}</div>`;
      }

      const notesBlock = `
        <div class="mt-4 bg-slate-50 border border-slate-200 rounded-lg p-3">
          <div class="text-xs font-semibold text-slate-600 mb-1">üìù Notes / Plan</div>
          <div class="text-sm text-slate-700 whitespace-pre-wrap">${s.notes ? e(s.notes) : '<span class="text-slate-400">Use evidence drops or AI to populate notes.</span>'}</div>
        </div>`;

      return `
        <div class="min-h-screen bg-slate-100 pb-20">
          <!-- Header -->
          <div class="gradient-szmc text-white p-4 sticky top-0 z-20">
            <div class="flex items-center justify-between">
              <button onclick="setState({view:'home'})" class="text-2xl">‚Üê</button>
              <div class="text-center flex-1 mx-4">
                <div class="font-bold truncate">${e(state.pres.slides[0]?.title)}</div>
                <div class="text-xs text-blue-200">Slide ${state.slide + 1} / ${state.pres.slides.length}</div>
              </div>
              <div class="flex items-center gap-2">
                <button onclick="auditPresentation()" class="text-xl bg-white/10 hover:bg-white/20 px-3 py-1 rounded-lg">‚úÖ</button>
                <button onclick="setState({showAI:true})" class="text-2xl">üß†</button>
              </div>
            </div>
          </div>

          <!-- Slide Navigation -->
          <div class="p-2 flex gap-2 overflow-x-auto bg-slate-100 sticky top-16 z-10">
            ${thumbs}
          </div>

          <!-- Slide Content -->
          <div class="p-4">
            <div class="bg-white rounded-xl shadow-lg p-6 min-h-48">
              <div class="text-xs text-slate-400 mb-1">${s.type.toUpperCase()}</div>
              <h2 class="text-xl font-bold mb-4 text-slate-800">${e(s.title)}</h2>
              ${content}
              ${notesBlock}
            </div>

            <!-- Edit Button -->
            <button onclick="setState({editing:'${s.type}'})" class="w-full mt-4 bg-blue-500 text-white rounded-xl py-3 font-medium shadow">
              ‚úèÔ∏è Edit This Slide
            </button>
            
            <!-- Slide Actions -->
            <div class="flex gap-2 mt-2">
              <button onclick="addSlide('content')" class="flex-1 bg-green-100 text-green-700 rounded-lg py-2 text-sm">+ Add Slide</button>
              <button onclick="deleteSlide()" class="flex-1 bg-red-100 text-red-700 rounded-lg py-2 text-sm">üóëÔ∏è Delete</button>
            </div>
          </div>

          <!-- Bottom Navigation -->
          <div class="fixed bottom-0 left-0 right-0 bg-white border-t p-3 flex gap-2 safe-bottom">
            <button onclick="setState({slide:Math.max(0,state.slide-1)})" ${state.slide === 0 ? 'disabled' : ''} 
              class="flex-1 bg-slate-100 rounded-lg py-3 font-medium disabled:opacity-50">‚Üê Prev</button>
            <button onclick="setState({showCalc:true})" class="px-4 bg-orange-100 rounded-lg text-lg">üßÆ</button>
            <button onclick="setState({showAI:true})" class="px-4 bg-blue-100 rounded-lg text-lg">üß†</button>
            <button onclick="setState({slide:Math.min(state.pres.slides.length-1,state.slide+1)})" ${state.slide >= state.pres.slides.length - 1 ? 'disabled' : ''} 
              class="flex-1 bg-slate-100 rounded-lg py-3 font-medium disabled:opacity-50">Next ‚Üí</button>
          </div>

          ${state.editing ? renderEditModal() : ''}
          ${state.showAI ? renderAIModal() : ''}
          ${state.showCalc ? renderCalcModal() : ''}
          ${state.showDrugs ? renderDrugsModal() : ''}
          ${state.showLabs ? renderLabsModal() : ''}
          ${state.showQA && state.qaResults ? renderQAModal() : ''}
        </div>
        ${state.recentAction ? `<div class="fixed bottom-20 left-4 right-4 bg-green-500 text-white p-3 rounded-xl text-center animate-fadeIn z-50">${e(state.recentAction)}</div>` : ''}
      `;
    }

    function renderEditModal() {
      const s = state.pres.slides[state.slide];
      
      let fields = `
        <div class="mb-3">
          <label class="block text-sm font-medium text-slate-700 mb-1">Title</label>
          <input value="${e(s.title)}" oninput="updateSlide('title',this.value)" class="w-full border rounded-lg p-3">
        </div>`;

      switch(s.type) {
        case 'title':
          fields += `
            <div class="mb-3">
              <label class="block text-sm font-medium text-slate-700 mb-1">Subtitle</label>
              <input value="${e(s.subtitle || '')}" oninput="updateSlide('subtitle',this.value)" class="w-full border rounded-lg p-3">
            </div>
            <div class="mb-3">
              <label class="block text-sm font-medium text-slate-700 mb-1">Presenter</label>
              <input value="${e(s.presenter || '')}" oninput="updateSlide('presenter',this.value)" class="w-full border rounded-lg p-3">
            </div>
            <div class="mb-3">
              <label class="block text-sm font-medium text-slate-700 mb-1">Date</label>
              <input value="${e(s.date || '')}" oninput="updateSlide('date',this.value)" class="w-full border rounded-lg p-3">
            </div>`;
          break;
        case 'patient':
          fields += `
            <div class="mb-3">
              <label class="block text-sm font-medium text-slate-700 mb-1">Demographics (age, sex, etc.)</label>
              <input value="${e(s.demographics || '')}" oninput="updateSlide('demographics',this.value)" class="w-full border rounded-lg p-3" placeholder="85yo female...">
            </div>
            <div class="mb-3">
              <label class="block text-sm font-medium text-slate-700 mb-1">Chief Complaint</label>
              <input value="${e(s.cc || '')}" oninput="updateSlide('cc',this.value)" class="w-full border rounded-lg p-3" placeholder="Falls, confusion...">
            </div>
            <div class="mb-3">
              <label class="block text-sm font-medium text-slate-700 mb-1">Code Status</label>
              <input value="${e(s.codeStatus || '')}" oninput="updateSlide('codeStatus',this.value)" class="w-full border rounded-lg p-3" placeholder="Full code, DNR...">
            </div>`;
          break;
        case 'content':
          fields += `
            <div class="mb-3">
              <label class="block text-sm font-medium text-slate-700 mb-1">Content</label>
              <textarea oninput="updateSlide('content',this.value)" class="w-full border rounded-lg p-3 min-h-32">${e(s.content || '')}</textarea>
            </div>`;
          break;
        case 'list':
          fields += `
            <div class="mb-3">
              <label class="block text-sm font-medium text-slate-700 mb-1">Items (one per line)</label>
              <textarea oninput="updateSlide('items',this.value.split('\\n').filter(x=>x.trim()))" class="w-full border rounded-lg p-3 min-h-32">${(s.items || []).join('\n')}</textarea>
            </div>`;
          break;
        case 'exam':
          const v = s.vitals || {};
          fields += `
            <div class="mb-3">
              <label class="block text-sm font-medium text-slate-700 mb-1">Vitals</label>
              <div class="grid grid-cols-5 gap-2">
                <input placeholder="BP" value="${e(v.BP || '')}" oninput="updateSlide('vitals',{...state.pres.slides[state.slide].vitals,BP:this.value})" class="border rounded p-2 text-center">
                <input placeholder="HR" value="${e(v.HR || '')}" oninput="updateSlide('vitals',{...state.pres.slides[state.slide].vitals,HR:this.value})" class="border rounded p-2 text-center">
                <input placeholder="RR" value="${e(v.RR || '')}" oninput="updateSlide('vitals',{...state.pres.slides[state.slide].vitals,RR:this.value})" class="border rounded p-2 text-center">
                <input placeholder="Temp" value="${e(v.Temp || '')}" oninput="updateSlide('vitals',{...state.pres.slides[state.slide].vitals,Temp:this.value})" class="border rounded p-2 text-center">
                <input placeholder="SpO2" value="${e(v.SpO2 || '')}" oninput="updateSlide('vitals',{...state.pres.slides[state.slide].vitals,SpO2:this.value})" class="border rounded p-2 text-center">
              </div>
            </div>
            <div class="mb-3">
              <label class="block text-sm font-medium text-slate-700 mb-1">Exam Findings</label>
              <textarea oninput="updateSlide('findings',this.value)" class="w-full border rounded-lg p-3 min-h-24">${e(s.findings || '')}</textarea>
            </div>`;
          break;
        case 'scores':
          const sc = s.scores || {};
          const scoreFields = ['MMSE', 'MoCA', 'GDS', 'ADL', 'IADL', 'TUG', 'MNA', 'CFS', 'Morse', 'Braden', 'CAM'];
          fields += `
            <div class="mb-3">
              <label class="block text-sm font-medium text-slate-700 mb-1">Geriatric Assessments</label>
              <div class="grid grid-cols-3 gap-2">
                ${scoreFields.map(name => `
                  <div>
                    <label class="text-xs text-slate-500">${name}</label>
                    <input placeholder="${name}" value="${e(sc[name] || '')}" 
                      oninput="updateSlide('scores',{...state.pres.slides[state.slide].scores,'${name}':this.value})" 
                      class="w-full border rounded p-2 text-center">
                  </div>
                `).join('')}
              </div>
            </div>`;
          break;
        case 'treatment':
          fields += `
            <div class="mb-3">
              <label class="block text-sm font-medium text-slate-700 mb-1">üíä Pharmacological</label>
              <textarea oninput="updateSlide('pharm',this.value)" class="w-full border rounded-lg p-3 min-h-24" placeholder="Medications...">${e(s.pharm || '')}</textarea>
            </div>
            <div class="mb-3">
              <label class="block text-sm font-medium text-slate-700 mb-1">üè• Non-pharmacological</label>
              <textarea oninput="updateSlide('nonpharm',this.value)" class="w-full border rounded-lg p-3 min-h-24" placeholder="PT, OT, diet...">${e(s.nonpharm || '')}</textarea>
            </div>`;
          break;
      }

      fields += `
        <div class="mb-3">
          <label class="block text-sm font-medium text-slate-700 mb-1">Notes / Plan</label>
          <textarea oninput="updateSlide('notes',this.value)" class="w-full border rounded-lg p-3 min-h-20" placeholder="Add speaker notes, plan details, or evidence summaries">${e(s.notes || '')}</textarea>
        </div>`;

      return `
        <div class="fixed inset-0 bg-black/50 flex items-end z-50 animate-fadeIn" onclick="if(event.target===this)setState({editing:null})">
          <div class="bg-white w-full rounded-t-2xl p-4 modal-content max-h-[85vh] overflow-auto">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-bold text-lg text-slate-800">Edit: ${e(s.title)}</h3>
              <button onclick="setState({editing:null})" class="text-2xl text-slate-400">√ó</button>
            </div>
            ${fields}
            <button onclick="setState({editing:null})" class="w-full bg-blue-500 text-white rounded-lg py-3 font-medium">Done</button>
          </div>
        </div>
      `;
    }

    // ============ AI ASSISTANT PAGE ============
    const AI_QUICK_ACTIONS = {
      clinical: [
        { id: 'ddx', icon: 'üîç', label: 'Differential Dx', prompt: 'Generate a comprehensive differential diagnosis considering geriatric-specific etiologies, atypical presentations in elderly, and reversible causes.' },
        { id: 'meds', icon: 'üíä', label: 'Med Review', prompt: 'Review medications for Beers criteria violations, drug-drug interactions, renal/hepatic dosing needs, anticholinergic burden, and deprescribing opportunities.' },
        { id: 'plan', icon: 'üìã', label: 'Mgmt Plan', prompt: 'Generate a comprehensive management plan with pharmacological interventions (geriatric-appropriate dosing), non-pharmacological strategies, and disposition considerations.' },
        { id: 'workup', icon: 'üî¨', label: 'Workup', prompt: 'What additional workup should be ordered? Consider age-appropriate labs, imaging with contrast considerations, and specialist consultations.' },
        { id: 'delirium', icon: 'üß†', label: 'Delirium W/U', prompt: 'This patient may have delirium. Generate a systematic delirium workup including CAM assessment, common precipitants to evaluate (DIMS-VOID), and reversible causes.' },
        { id: 'falls', icon: 'üö∂', label: 'Falls Risk', prompt: 'Assess fall risk factors and generate a comprehensive falls prevention plan including medication review, PT/OT recommendations, and environmental modifications.' },
      ],
      assessment: [
        { id: 'frailty', icon: 'üë¥', label: 'Frailty', prompt: 'Assess frailty status using Clinical Frailty Scale criteria. Identify frailty markers present and implications for treatment goals and prognosis.' },
        { id: 'function', icon: 'üè†', label: 'Functional Status', prompt: 'Assess functional status including ADLs, IADLs, mobility, and recommend appropriate geriatric assessments and rehabilitation needs.' },
        { id: 'cognition', icon: 'üß©', label: 'Cognition', prompt: 'Evaluate cognitive status. Recommend appropriate screening tools (MMSE, MoCA, Mini-Cog) and next steps for cognitive impairment workup.' },
        { id: 'nutrition', icon: 'üçΩÔ∏è', label: 'Nutrition', prompt: 'Assess nutritional status using MNA criteria. Identify risk factors for malnutrition and recommend interventions.' },
        { id: 'goals', icon: 'üéØ', label: 'Goals of Care', prompt: 'Help frame a goals of care discussion considering prognosis, functional trajectory, and patient values. Suggest discussion points.' },
        { id: 'discharge', icon: 'üè•', label: 'Discharge Plan', prompt: 'Create a comprehensive discharge plan including medication reconciliation, follow-up needs, home services, and transition of care considerations.' },
      ],
      teaching: [
        { id: 'teaching', icon: 'üìö', label: 'Teaching Points', prompt: 'Identify 4-5 key teaching points from this case focusing on geriatric principles, evidence-based guidelines, and clinical pearls.' },
        { id: 'evidence', icon: 'üìñ', label: 'Evidence', prompt: 'What is the current evidence and guidelines relevant to this case? Cite specific recommendations and their quality of evidence.' },
        { id: 'pearls', icon: 'üíé', label: 'Clinical Pearls', prompt: 'What are the clinical pearls and pitfalls for this presentation? Focus on geriatric-specific considerations.' },
        { id: 'questions', icon: '‚ùì', label: 'Pimping Q\'s', prompt: 'Generate 5 teaching questions (with answers) that an attending might ask about this case, ranging from basic to advanced.' },
        { id: 'summary', icon: 'üìù', label: 'Case Summary', prompt: 'Generate a concise case summary suitable for sign-out or presentation, including one-liner, key findings, and active issues.' },
        { id: 'improve', icon: '‚ú®', label: 'Improve', prompt: 'Review the entire presentation and suggest improvements. What information is missing? What could be presented better?' },
      ],
      coaching: [
        { id: 'story', icon: 'üé§', label: 'Narrative Hook', prompt: 'Craft a 20-second narrative opening for this case, with a compelling clinical question, one-liner, and why the audience should care.' },
        { id: 'timeline', icon: '‚è±Ô∏è', label: 'Timeline', prompt: 'Build a chronological timeline of this case (presentation, workup, interventions, turning points) as 5-7 crisp bullets.' },
        { id: 'rehearse', icon: 'üó£Ô∏è', label: 'Rehearsal Notes', prompt: 'Write a 90-second rehearsal script with cues for emphasis, audience questions, and transition lines between slides.' },
        { id: 'qna', icon: 'üõ°Ô∏è', label: 'Tough Q&A', prompt: 'Anticipate 6 challenging audience questions and concise answers, including safety, ethics, and evidence defenses.' },
      ],
      slides: [
        { id: 'rewrite', icon: 'üìù', label: 'Rewrite slide', prompt: 'Rewrite the current slide into 5 crisp bullets with citations from the 2024-2025 evidence library. Preserve clinical accuracy and geriatric dosing cautions.' },
        { id: 'notes', icon: 'üé§', label: 'Speaker notes', prompt: 'Draft 60-second speaker notes for this slide with key transitions, risk/safety reminders, and monitoring steps.' },
        { id: 'qa', icon: '‚úÖ', label: 'Fix QA issues', prompt: 'Use the QA report to generate exact edits for missing fields (titles, items, findings, plans). Provide bullet replacements only.' },
        { id: 'onepager', icon: 'üìë', label: '1-slide recap', prompt: 'Condense the entire case into a single slide with problem list, top 3 interventions, follow-up timeline, and citations.' },
        { id: 'monitoring', icon: 'ü©∏', label: 'Monitoring grid', prompt: 'Create a monitoring grid for this case with vitals/labs frequency, hold parameters, and escalation triggers; keep it slide-ready.' },
        { id: 'handoff', icon: 'üì®', label: 'Handoff card', prompt: 'Generate a SBAR-style handoff with situation, background, active issues, anticipatory guidance, and contingency plans.' },
      ],
      safety: [
        { id: 'beers', icon: '‚ö†Ô∏è', label: 'Beers Check', prompt: 'Check all medications against Beers Criteria. List any potentially inappropriate medications with specific concerns and safer alternatives.' },
        { id: 'stopp', icon: 'üõë', label: 'STOPP/START', prompt: 'Apply STOPP/START criteria. Identify medications to potentially stop and medications that may be indicated but missing.' },
        { id: 'renal', icon: 'üíß', label: 'Renal Dosing', prompt: 'Review all medications for renal dosing appropriateness. Provide specific dose adjustments needed based on kidney function.' },
        { id: 'interactions', icon: '‚ö°', label: 'Interactions', prompt: 'Check for significant drug-drug interactions, QT prolongation risks, and additive effects (sedation, anticholinergic, bleeding).' },
        { id: 'acb', icon: 'üß™', label: 'ACB Score', prompt: 'Calculate Anticholinergic Cognitive Burden (ACB) score for current medications. Identify high-ACB medications and alternatives.' },
        { id: 'cascade', icon: 'üåä', label: 'Rx Cascade', prompt: 'Identify potential prescribing cascades where one medication may be treating side effects of another.' },
      ],
      evidence: [
        { id: 'guideline', icon: 'üìë', label: 'Guideline Recap', prompt: 'Summarize guideline-grade recommendations (2023-2025) relevant to this case, with strength of evidence and key citations.' },
        { id: 'dosing', icon: 'üíâ', label: 'Dosing Guardrails', prompt: 'Create a dosing and monitoring table for proposed meds including renal/hepatic adjustments and geriatrics cautions.' },
        { id: 'followup', icon: '‚è≥', label: 'Follow-up', prompt: 'Outline follow-up intervals, monitoring labs, and when to escalate care based on the most recent society guidelines.' },
        { id: 'quality', icon: 'üè•', label: 'Quality Metrics', prompt: 'List quality/safety metrics (antibiotic timeout, fall bundle, delirium prevention) to track for this patient using up-to-date standards.' },
        { id: 'equity', icon: 'ü§ù', label: 'Communication', prompt: 'Draft shared-decision talking points incorporating literacy, cultural considerations, and goals-of-care for older adults.' },
        { id: 'slide', icon: 'üßæ', label: 'Slide Ready', prompt: 'Convert the current slide into concise bullet points with citations and monitoring parameters that fit on a single teaching slide.' },
      ]
    };

    function renderAIAssistant() {
      const categories = [
        { id: 'clinical', icon: 'ü©∫', label: 'Clinical' },
        { id: 'assessment', icon: 'üìä', label: 'Assessment' },
        { id: 'teaching', icon: 'üìö', label: 'Teaching' },
        { id: 'coaching', icon: 'üé§', label: 'Coaching' },
        { id: 'slides', icon: 'üñºÔ∏è', label: 'Slides' },
        { id: 'safety', icon: '‚ö†Ô∏è', label: 'Safety' },
        { id: 'evidence', icon: 'üìñ', label: 'Evidence' }
      ];

      const currentActions = AI_QUICK_ACTIONS[state.aiCategory] || AI_QUICK_ACTIONS.clinical;
      const evidenceButtons = EVIDENCE_LIBRARY.map(ev => `
        <button onclick="injectEvidence('${ev.id}')" class="px-3 py-2 bg-white border border-slate-200 rounded-lg text-left shadow-sm hover:shadow-md text-xs">
          <div class="font-semibold text-slate-800">${e(ev.title)}</div>
          <div class="text-[11px] text-slate-500">${ev.year} ‚Ä¢ ${e(ev.summary.substring(0, 70))}...</div>
        </button>
      `).join('');

      const lastEvidence = (state.aiTemplates || []).find(t => t.type === 'evidence')
        || (state.lastEvidenceId ? EVIDENCE_LIBRARY.find(ev => ev.id === state.lastEvidenceId) : null);
      const evidenceSelect = `
        <div class="px-3 pb-3">
          <div class="flex items-center justify-between mb-2">
            <div class="text-xs text-slate-600 flex items-center gap-2"><span class="text-blue-600">üìù</span>Drop evidence into current slide notes/plan</div>
            ${lastEvidence ? `<button onclick="reuseCachedEvidence()" class="text-[11px] text-blue-700 border border-blue-200 px-2 py-1 rounded-lg bg-blue-50 hover:bg-blue-100">Reuse ${e(lastEvidence.title)} (${e(lastEvidence.year)})</button>` : ''}
          </div>
          <div class="flex gap-2">
            <select onchange="applyEvidenceToNotes(this.value);this.value=''" class="flex-1 border border-slate-200 rounded-lg px-3 py-2 text-sm bg-white">
              <option value="">Select evidence topic...</option>
              ${EVIDENCE_LIBRARY.map(ev => `<option value="${ev.id}">${e(ev.title)} (${e(ev.year)})</option>`).join('')}
            </select>
          </div>
        </div>`;

      // Format messages with basic markdown
      const formatAIMessage = (text) => {
        return text
          .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
          .replace(/\*(.+?)\*/g, '<em>$1</em>')
          .replace(/^‚Ä¢ /gm, '<span class="text-blue-500">‚Ä¢</span> ')
          .replace(/^- /gm, '<span class="text-blue-500">‚Ä¢</span> ')
          .replace(/^(\d+)\. /gm, '<span class="text-blue-500 font-medium">$1.</span> ')
          .replace(/`(.+?)`/g, '<code class="bg-slate-200 px-1 rounded text-sm">$1</code>')
          .replace(/\n/g, '<br>');
      };

      const msgs = state.aiChat.map(m => `
        <div class="${m.role === 'user' ? 'text-right' : ''} animate-fadeIn">
          <div class="inline-block rounded-2xl p-4 text-sm max-w-[90%] ${m.role === 'user' ? 'bg-gradient-to-r from-blue-500 to-blue-600 text-white' : 'bg-white shadow-md text-slate-800 border'}">
            ${m.role === 'user' ? e(m.content) : formatAIMessage(m.content)}
          </div>
          <div class="text-xs text-slate-400 mt-1 ${m.role === 'user' ? 'text-right' : ''}">${m.time || ''}</div>
        </div>
      `).join('');

      const historyItems = state.aiHistory.slice(-10).reverse().map((h, i) => `
        <button onclick="loadAIHistory(${state.aiHistory.length - 1 - i})" class="w-full text-left p-3 hover:bg-slate-50 rounded-lg transition border-b last:border-0">
          <div class="font-medium text-slate-800 text-sm truncate">${e(h.title || h.messages[0]?.content?.substring(0, 40) || 'Conversation')}</div>
          <div class="text-xs text-slate-400">${new Date(h.date).toLocaleDateString()} ‚Ä¢ ${h.messages?.length || 0} messages</div>
        </button>
      `).join('') || '<p class="text-center text-slate-400 py-4">No saved conversations</p>';

      return `
        <div class="min-h-screen bg-gradient-to-b from-slate-100 to-slate-200 flex flex-col">
          <!-- Header -->
          <div class="bg-gradient-to-r from-purple-600 via-blue-600 to-indigo-600 text-white p-4 shadow-lg">
            <div class="flex items-center justify-between">
              <button onclick="setState({view:'home'})" class="text-2xl p-2 hover:bg-white/20 rounded-lg transition">‚Üê</button>
              <div class="text-center flex-1">
                <div class="font-bold text-lg flex items-center justify-center gap-2">
                  <span class="text-2xl">üß†</span> Geriatrics AI Assistant
                </div>
                <div class="text-xs text-blue-200">${state.apiKey ? 'Connected to Claude' : 'API key required'}</div>
              </div>
              <div class="flex gap-1">
                <button onclick="setState({showAIHistory:true})" class="p-2 hover:bg-white/20 rounded-lg transition" title="History">üìú</button>
                <button onclick="exportAIConversation()" class="p-2 hover:bg-white/20 rounded-lg transition" title="Export">üì§</button>
              </div>
            </div>
          </div>

          <!-- Category Tabs -->
          <div class="bg-white shadow-sm sticky top-0 z-10">
            <div class="flex justify-around p-2">
              ${categories.map(c => `
                <button onclick="setState({aiCategory:'${c.id}'})"
                  class="flex-1 py-2 px-3 rounded-lg text-sm font-medium transition ${state.aiCategory === c.id ? 'bg-blue-100 text-blue-700' : 'text-slate-600 hover:bg-slate-100'}">
                  <span class="block text-lg">${c.icon}</span>
                  <span class="text-xs">${c.label}</span>
                </button>
              `).join('')}
            </div>
          </div>

          <!-- Quick Actions Grid -->
          <div class="p-3 bg-white/50">
            <div class="grid grid-cols-3 gap-2">
              ${currentActions.map(a => `
                <button onclick="aiQuickAction('${a.id}')"
                  class="bg-white rounded-xl p-3 shadow-sm hover:shadow-md transition text-center border border-slate-200 hover:border-blue-300">
                  <div class="text-xl mb-1">${a.icon}</div>
                  <div class="text-xs font-medium text-slate-700">${a.label}</div>
                </button>
              `).join('')}
            </div>
          </div>

          ${evidenceSelect}

          <!-- Evidence injectors -->
          <div class="px-3 pb-3">
            <div class="text-xs text-slate-500 mb-2 flex items-center gap-2">
              <span class="text-blue-600">üìñ</span> 2024-2025 evidence quick inserts
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
              ${evidenceButtons}
            </div>
          </div>

          <!-- Evidence Library -->
          <div class="px-3 pb-3">
            <div class="flex items-center justify-between mb-2">
              <div class="text-sm font-semibold text-slate-700 flex items-center gap-2">
                <span>üìñ</span> Evidence Packs (2024-2025)
              </div>
              <div class="text-xs text-slate-500">Tap to auto-fill AI or drop on slides</div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
              ${EVIDENCE_LIBRARY.map(ev => `
                <div class="bg-white border border-slate-200 rounded-xl p-3 shadow-sm hover:border-blue-300 transition">
                  <div class="flex items-start justify-between gap-2">
                    <div>
                      <div class="text-sm font-bold text-slate-800">${e(ev.title)}</div>
                      <div class="text-xs text-blue-600">${e(ev.year)}</div>
                    </div>
                    <div class="flex items-center gap-1">
                      <span class="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded-full">Guideline</span>
                      <button onclick="copyEvidenceBlock('${ev.id}')" class="text-[11px] border border-slate-200 text-slate-600 rounded-md px-2 py-1 hover:border-blue-300 hover:text-blue-700 bg-white" title="Copy to clipboard">üìã</button>
                    </div>
                  </div>
                  <p class="text-xs text-slate-600 mt-2">${e(ev.summary)}</p>
                  <ul class="text-xs text-slate-700 mt-2 list-disc list-inside space-y-1">
                    ${ev.keyPoints.slice(0,3).map(p => `<li>${e(p)}</li>`).join('')}
                  </ul>
                  <div class="flex gap-2 mt-3">
                    <button onclick="seedEvidencePrompt('${ev.id}')" class="flex-1 bg-blue-600 text-white text-xs py-2 rounded-lg hover:bg-blue-700">Ask with evidence</button>
                    <button onclick="pushEvidenceToChat('${ev.id}')" class="flex-1 border border-blue-200 text-blue-700 text-xs py-2 rounded-lg hover:bg-blue-50">Add summary</button>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>

          <!-- Safety rails & auto-briefs -->
          <div class="px-3 pb-3">
            <div class="flex items-center justify-between mb-2">
              <div class="text-sm font-semibold text-slate-700 flex items-center gap-2">
                <span>üõ°Ô∏è</span> Safety rails & auto-briefs
              </div>
              <div class="text-xs text-slate-500">No PHI; cite guidelines</div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
              <button onclick="runSafetyPrompt('Run a patient safety sign-off: list high-risk meds, hold parameters, fall/delirium precautions, and escalation triggers. Keep it concise for slide or handoff.')" class="bg-white border border-amber-200 text-amber-800 rounded-xl p-3 text-left shadow-sm hover:border-amber-300">
                <div class="font-semibold text-sm mb-1">Safety sign-off</div>
                <div class="text-xs">High-risk meds, hold rules, fall/delirium bundle</div>
              </button>
              <button onclick="runSafetyPrompt('Build a 24-hour checklist with monitoring (vitals/labs), mobility goals, nutrition/hydration targets, and discharge blockers. Format as bullets.')" class="bg-white border border-blue-200 text-blue-800 rounded-xl p-3 text-left shadow-sm hover:border-blue-300">
                <div class="font-semibold text-sm mb-1">24h checklist</div>
                <div class="text-xs">Monitoring + mobility + discharge blockers</div>
              </button>
              <button onclick="runSafetyPrompt('Generate an evidence-cited mini brief for leadership: one-liner, top 3 risks, mitigation steps with guideline references, and today\'s ask.')" class="bg-white border border-purple-200 text-purple-800 rounded-xl p-3 text-left shadow-sm hover:border-purple-300">
                <div class="font-semibold text-sm mb-1">Leadership brief</div>
                <div class="text-xs">Risks, mitigations, cites, clear ask</div>
              </button>
            </div>
          </div>

          <!-- Patient Context Banner -->
          ${state.pres ? `
            <div class="mx-3 mt-2 bg-blue-50 border border-blue-200 rounded-lg p-3 flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="text-blue-500">üìã</span>
                <div>
                  <div class="text-sm font-medium text-blue-800">${e(state.pres.slides[0]?.title || 'Current Case')}</div>
                  <div class="text-xs text-blue-600">${state.pres.slides.length} slides loaded</div>
                </div>
              </div>
              <button onclick="setState({pres:null, patientContext:null})" class="text-xs text-blue-600 hover:text-blue-800">Clear</button>
            </div>
          ` : `
            <div class="mx-3 mt-2 bg-amber-50 border border-amber-200 rounded-lg p-3">
              <div class="flex items-center gap-2 text-amber-700">
                <span>üí°</span>
                <span class="text-sm">Open a case presentation for context-aware AI responses</span>
              </div>
            </div>
          `}

          <!-- Chat Area -->
          <div id="aiChatBox" class="flex-1 overflow-auto p-4 space-y-4 min-h-64">
            ${state.aiChat.length === 0 ? `
              <div class="bg-white rounded-2xl p-6 shadow-md border">
                <div class="text-center mb-4">
                  <div class="text-4xl mb-2">ü©∫</div>
                  <h3 class="font-bold text-lg text-slate-800">Geriatrics AI Assistant</h3>
                  <p class="text-sm text-slate-500">Your clinical decision support companion</p>
                </div>
                <div class="grid grid-cols-2 gap-3 text-sm">
                  <div class="bg-blue-50 rounded-lg p-3">
                    <div class="font-medium text-blue-800 mb-1">üîç Clinical Support</div>
                    <div class="text-xs text-blue-600">DDx, workups, management plans</div>
                  </div>
                  <div class="bg-green-50 rounded-lg p-3">
                    <div class="font-medium text-green-800 mb-1">üíä Medication Safety</div>
                    <div class="text-xs text-green-600">Beers, STOPP/START, interactions</div>
                  </div>
                  <div class="bg-purple-50 rounded-lg p-3">
                    <div class="font-medium text-purple-800 mb-1">üìä Assessments</div>
                    <div class="text-xs text-purple-600">Frailty, cognition, function</div>
                  </div>
                  <div class="bg-orange-50 rounded-lg p-3">
                    <div class="font-medium text-orange-800 mb-1">üìö Teaching</div>
                    <div class="text-xs text-orange-600">Cases, pearls, evidence</div>
                  </div>
                </div>
                ${!state.apiKey ? `
                  <div class="mt-4 bg-red-50 border border-red-200 rounded-lg p-3 text-center">
                    <div class="text-red-600 font-medium">‚ö†Ô∏è API Key Required</div>
                    <button onclick="setState({view:'home', showSettings:true})" class="mt-2 px-4 py-1 bg-red-100 text-red-700 rounded-full text-sm hover:bg-red-200 transition">
                      Add API Key in Settings
                    </button>
                  </div>
                ` : ''}
              </div>
            ` : msgs}
            ${state.aiLoading ? `
              <div class="flex items-center gap-3 text-slate-500">
                <div class="typing bg-white rounded-full p-3 shadow-sm">
                  <span></span><span></span><span></span>
                </div>
                <span class="text-sm">AI is thinking...</span>
              </div>
            ` : ''}
          </div>

          <!-- Input Area -->
          <div class="bg-white border-t p-4 safe-bottom shadow-lg">
            <div class="flex gap-2 items-end">
              <button onclick="toggleVoiceInput()"
                class="p-3 rounded-xl transition ${state.isListening ? 'bg-red-500 text-white animate-pulse' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}"
                title="Voice input">
                üé§
              </button>
              <div class="flex-1 relative">
                <textarea id="aiInput"
                  value="${e(state.aiInput)}"
                  oninput="state.aiInput=this.value;autoResizeTextarea(this)"
                  onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();sendAI()}"
                  placeholder="Ask about your patient, medications, differential, or any clinical question..."
                  rows="1"
                  class="w-full border-2 border-slate-200 rounded-xl px-4 py-3 pr-12 resize-none focus:border-blue-400 focus:ring-2 focus:ring-blue-100 transition"
                  style="max-height: 120px; overflow-y: auto;"
                >${e(state.aiInput)}</textarea>
              </div>
              <button onclick="sendAI()" ${state.aiLoading || !state.aiInput.trim() ? 'disabled' : ''}
                class="p-3 bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-xl font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:from-blue-600 hover:to-purple-600 transition shadow-md">
                ${state.aiLoading ? '...' : '‚û§'}
              </button>
            </div>
            <div class="flex justify-between mt-2 text-xs text-slate-400">
              <span>Press Enter to send, Shift+Enter for new line</span>
              <button onclick="state.aiChat=[];render()" class="text-red-400 hover:text-red-600">Clear chat</button>
            </div>
          </div>

          <!-- History Modal -->
          ${state.showAIHistory ? `
            <div class="fixed inset-0 bg-black/50 flex items-end z-50 animate-fadeIn" onclick="if(event.target===this)setState({showAIHistory:false})">
              <div class="bg-white w-full rounded-t-2xl max-h-[70vh] flex flex-col modal-content">
                <div class="p-4 border-b flex justify-between items-center">
                  <h3 class="font-bold text-lg">üìú Conversation History</h3>
                  <button onclick="setState({showAIHistory:false})" class="text-2xl text-slate-400">√ó</button>
                </div>
                <div class="flex-1 overflow-auto p-2">
                  ${historyItems}
                </div>
                <div class="p-3 border-t">
                  <button onclick="clearAIHistory()" class="w-full py-2 text-red-500 hover:bg-red-50 rounded-lg transition text-sm">
                    üóëÔ∏è Clear All History
                  </button>
                </div>
              </div>
            </div>
          ` : ''}

          ${state.showCalc ? renderCalcModal() : ''}
          ${state.showDrugs ? renderDrugsModal() : ''}
          ${state.showLabs ? renderLabsModal() : ''}
        </div>
        ${state.recentAction ? `<div class="fixed bottom-24 left-4 right-4 bg-green-500 text-white p-3 rounded-xl text-center animate-fadeIn z-50">${e(state.recentAction)}</div>` : ''}
      `;
    }

    function aiQuickAction(actionId) {
      const allActions = [
        ...AI_QUICK_ACTIONS.clinical,
        ...AI_QUICK_ACTIONS.assessment,
        ...AI_QUICK_ACTIONS.teaching,
        ...(AI_QUICK_ACTIONS.coaching || []),
        ...(AI_QUICK_ACTIONS.slides || []),
        ...AI_QUICK_ACTIONS.safety,
        ...(AI_QUICK_ACTIONS.evidence || [])
      ];
      const action = allActions.find(a => a.id === actionId);
      if (action) {
        state.aiInput = action.prompt;
        render();
        setTimeout(() => sendAI(), 50);
      }
    }

    function runSafetyPrompt(prompt) {
      state.aiInput = prompt;
      render();
      setTimeout(() => sendAI(), 50);
    }

    function buildEvidenceText(ev) {
      const bulletPoints = ev.keyPoints.map(p => `- ${p}`).join('\n');
      return `${ev.title} (${ev.year})\n${ev.summary}\nKey recommendations:\n${bulletPoints}\nSources: ${ev.sources}`;
    }

    function cacheEvidenceTemplate(ev, content) {
      const evidenceTemplate = {
        type: 'evidence',
        id: ev.id,
        title: ev.title,
        year: ev.year,
        content,
        sources: ev.sources,
        updated: new Date().toISOString()
      };

      state.lastEvidenceId = ev.id;
      const filtered = (state.aiTemplates || []).filter(t => !(t.type === 'evidence' && t.id === ev.id));
      state.aiTemplates = [evidenceTemplate, ...filtered].slice(0, 10);
      save();
    }

    function applyEvidenceToNotes(id) {
      const ev = EVIDENCE_LIBRARY.find(e => e.id === id);
      if (!ev) return;
      if (!state.pres) {
        showToast('Open a presentation to drop evidence into notes');
        return;
      }

      const slide = state.pres.slides[state.slide];
      const text = buildEvidenceText(ev);
      slide.notes = (slide.notes ? slide.notes + '\n\n' : '') + text;
      savePres();
      cacheEvidenceTemplate(ev, text);
      showToast('Evidence injected into slide notes/plan');
      render();
    }

    function reuseCachedEvidence() {
      let cached = (state.aiTemplates || []).find(t => t.type === 'evidence');
      if (!cached && state.lastEvidenceId) {
        const ev = EVIDENCE_LIBRARY.find(e => e.id === state.lastEvidenceId);
        if (ev) {
          cached = { ...ev, content: buildEvidenceText(ev) };
        }
      }

      if (!cached) {
        showToast('No cached evidence yet');
        return;
      }
      if (!state.pres) {
        showToast('Open a presentation to reapply evidence');
        return;
      }

      const slide = state.pres.slides[state.slide];
      slide.notes = (slide.notes ? slide.notes + '\n\n' : '') + cached.content;
      state.lastEvidenceId = cached.id || state.lastEvidenceId;
      savePres();
      save();
      showToast(`Reused evidence: ${cached.title}`);
      render();
    }

    function copyEvidenceBlock(id) {
      const ev = EVIDENCE_LIBRARY.find(e => e.id === id);
      if (!ev) return;
      const text = buildEvidenceText(ev);

      const handleSuccess = () => showToast('Evidence copied');
      const handleFallback = () => {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        handleSuccess();
      };

      if (navigator.clipboard?.writeText) {
        navigator.clipboard.writeText(text).then(handleSuccess).catch(handleFallback);
      } else {
        handleFallback();
      }
    }

    function pushEvidenceToChat(id) {
      const ev = EVIDENCE_LIBRARY.find(e => e.id === id);
      if (!ev) return;
      const text = buildEvidenceText(ev);
      cacheEvidenceTemplate(ev, text);
      state.lastAIContent = text;
      state.editableAIContent = text;
      state.aiChat.push({ role: 'assistant', content: text, time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) });
      render();
      setTimeout(() => {
        const box = document.getElementById('aiChatBox');
        if (box) box.scrollTop = box.scrollHeight;
      }, 50);
      showToast('Evidence summary ready to apply');
    }

    function seedEvidencePrompt(id) {
      const ev = EVIDENCE_LIBRARY.find(e => e.id === id);
      if (!ev) return;
      const slide = state.pres?.slides?.[state.slide];
      const contextLine = slide ? `Current slide: ${slide.title || 'Untitled'}; focus on ${slide.type || 'content'}.` : 'No active slide loaded.';
      state.aiInput = `Using ${ev.title} (${ev.year}) evidence: ${ev.summary}. Key points: ${ev.keyPoints.join('; ')}. ${contextLine} Create slide-ready bullets with monitoring parameters and geriatric cautions.`;
      cacheEvidenceTemplate(ev, buildEvidenceText(ev));
      render();
      setTimeout(() => sendAI(), 50);
    }

    function autoResizeTextarea(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    }

    function toggleVoiceInput() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        showToast('Voice input not supported in this browser');
        return;
      }

      if (state.isListening) {
        if (window.recognition) {
          window.recognition.stop();
        }
        setState({ isListening: false });
        return;
      }

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      window.recognition = new SpeechRecognition();
      window.recognition.continuous = false;
      window.recognition.interimResults = true;
      window.recognition.lang = 'en-US';

      window.recognition.onstart = () => setState({ isListening: true });
      window.recognition.onend = () => setState({ isListening: false });
      window.recognition.onerror = (e) => {
        console.error('Speech recognition error:', e);
        setState({ isListening: false });
        showToast('Voice input error: ' + e.error);
      };
      window.recognition.onresult = (event) => {
        const transcript = Array.from(event.results)
          .map(result => result[0].transcript)
          .join('');
        state.aiInput = transcript;
        render();
      };

      window.recognition.start();
    }

    function exportAIConversation() {
      if (state.aiChat.length === 0) {
        showToast('No conversation to export');
        return;
      }

      const content = state.aiChat.map(m => `${m.role.toUpperCase()}: ${m.content}`).join('\n\n---\n\n');
      const title = state.pres?.slides[0]?.title || 'AI Conversation';
      const blob = new Blob([`# ${title}\n\nDate: ${new Date().toLocaleString()}\n\n---\n\n${content}`], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ai-conversation-${Date.now()}.md`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('Conversation exported!');
    }

    function saveCurrentAIConversation() {
      if (state.aiChat.length < 2) return;

      const conversation = {
        date: Date.now(),
        title: state.pres?.slides[0]?.title || state.aiChat[0]?.content?.substring(0, 40) || 'Conversation',
        messages: [...state.aiChat],
        context: state.pres ? { title: state.pres.slides[0]?.title } : null
      };

      state.aiHistory.push(conversation);
      save();
    }

    function loadAIHistory(index) {
      const conversation = state.aiHistory[index];
      if (conversation) {
        state.aiChat = [...conversation.messages];
        state.showAIHistory = false;
        render();
        showToast('Conversation loaded');
      }
    }

    function clearAIHistory() {
      if (confirm('Clear all conversation history?')) {
        state.aiHistory = [];
        save();
        setState({ showAIHistory: false });
        showToast('History cleared');
      }
    }

    function renderAIModal() {
      // Build slide options for dropdown
      const slideOptions = state.pres ? state.pres.slides.map((s, i) =>
        `<option value="${i}" ${i === state.aiTargetSlide ? 'selected' : ''}>Slide ${i + 1}: ${e(s.title || 'Untitled')}</option>`
      ).join('') : '<option>No presentation</option>';

      // Get field options based on selected slide
      const getFieldOptions = () => {
        if (!state.pres) return '';
        const slide = state.pres.slides[state.aiTargetSlide || 0];
        const fields = [];
        if (slide.items !== undefined) fields.push(['items', 'List Items']);
        if (slide.content !== undefined) fields.push(['content', 'Content']);
        if (slide.findings !== undefined) fields.push(['findings', 'Findings']);
        if (slide.pharm !== undefined) fields.push(['pharm', 'Pharmacological']);
        if (slide.nonpharm !== undefined) fields.push(['nonpharm', 'Non-Pharmacological']);
        if (slide.cc !== undefined) fields.push(['cc', 'Chief Complaint']);
        if (slide.demographics !== undefined) fields.push(['demographics', 'Demographics']);
        fields.push(['title', 'Title']);
        return fields.map(([val, label]) =>
          `<option value="${val}" ${val === state.aiTargetField ? 'selected' : ''}>${label}</option>`
        ).join('');
      };

      const msgs = state.aiChat.map((m, idx) => `
        <div class="${m.role === 'user' ? 'text-right' : ''} group">
          <div class="inline-block rounded-xl p-3 text-sm max-w-[85%] whitespace-pre-wrap ${m.role === 'user' ? 'bg-blue-500 text-white' : 'bg-slate-100 text-slate-800'}">
            ${e(m.content)}
          </div>
          ${m.role === 'assistant' && idx === state.aiChat.length - 1 && state.lastAIContent ? `
            <div class="mt-2 opacity-0 group-hover:opacity-100 transition-opacity">
              <button onclick="showApplyPanel()" class="text-xs bg-green-500 text-white px-3 py-1 rounded-full hover:bg-green-600">
                Apply to Slide
              </button>
              <button onclick="regenerateResponse()" class="text-xs bg-purple-500 text-white px-3 py-1 rounded-full hover:bg-purple-600 ml-1">
                Regenerate
              </button>
            </div>
          ` : ''}
        </div>
      `).join('');

      // Apply panel UI
      const applyPanel = state.showApplyPanel ? `
        <div class="p-4 bg-gradient-to-r from-green-50 to-emerald-50 border-b border-green-200">
          <div class="font-bold text-green-800 mb-3">Apply AI Content to Slide</div>

          <div class="grid grid-cols-2 gap-3 mb-3">
            <div>
              <label class="text-xs font-medium text-slate-600 block mb-1">Target Slide</label>
              <select onchange="state.aiTargetSlide=+this.value;state.aiTargetField='items';render()"
                class="w-full border rounded-lg px-3 py-2 text-sm bg-white">
                ${slideOptions}
              </select>
            </div>
            <div>
              <label class="text-xs font-medium text-slate-600 block mb-1">Field to Update</label>
              <select onchange="state.aiTargetField=this.value;render()"
                class="w-full border rounded-lg px-3 py-2 text-sm bg-white">
                ${getFieldOptions()}
              </select>
            </div>
          </div>

          <div class="mb-3">
            <label class="text-xs font-medium text-slate-600 block mb-1">Content Preview (editable)</label>
            <textarea id="aiEditableContent" class="w-full border rounded-lg px-3 py-2 text-sm h-24 resize-none"
              oninput="state.editableAIContent=this.value">${e(state.editableAIContent || state.lastAIContent || '')}</textarea>
          </div>

          <div class="flex gap-2">
            <button onclick="applyEditedContent()" class="flex-1 bg-green-600 hover:bg-green-700 text-white rounded-lg py-2.5 font-medium text-sm">
              ‚úì Apply Changes
            </button>
            <button onclick="setState({showApplyPanel:false})" class="px-4 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-lg py-2.5 font-medium text-sm">
              Cancel
            </button>
          </div>
        </div>
      ` : '';

      return `
        <div class="fixed inset-0 bg-black/50 flex items-end z-50 animate-fadeIn" onclick="if(event.target===this)setState({showAI:false})">
          <div class="bg-white w-full rounded-t-2xl max-h-[90vh] flex flex-col modal-content">
            <!-- Header -->
            <div class="p-4 border-b flex justify-between items-center bg-gradient-to-r from-blue-600 to-purple-600 rounded-t-2xl">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center text-xl">ü§ñ</div>
                <div>
                  <div class="font-bold text-white">AI Assistant</div>
                  <div class="text-xs text-white/70">Generate & apply content</div>
                </div>
              </div>
              <div class="flex gap-2">
                <button onclick="state.aiChat=[];state.lastAIContent=null;state.showApplyPanel=false;render()" class="text-sm text-white/80 hover:text-white">Clear</button>
                <button onclick="setState({showAI:false})" class="text-2xl text-white/80 hover:text-white">√ó</button>
              </div>
            </div>

            <!-- Quick Actions -->
            <div class="p-3 border-b bg-slate-50">
              <div class="flex gap-2 overflow-x-auto">
                <button onclick="quickGenerate('ddx')" class="flex-shrink-0 px-3 py-1.5 bg-blue-500 text-white rounded-full text-xs font-medium hover:bg-blue-600">üîç Diagnosis</button>
                <button onclick="quickGenerate('teaching')" class="flex-shrink-0 px-3 py-1.5 bg-green-500 text-white rounded-full text-xs font-medium hover:bg-green-600">üìö Teaching</button>
                <button onclick="quickGenerate('plan')" class="flex-shrink-0 px-3 py-1.5 bg-orange-500 text-white rounded-full text-xs font-medium hover:bg-orange-600">üìã Plan</button>
                <button onclick="quickGenerate('summary')" class="flex-shrink-0 px-3 py-1.5 bg-purple-500 text-white rounded-full text-xs font-medium hover:bg-purple-600">üìù Summary</button>
                <button onclick="quickGenerate('improve')" class="flex-shrink-0 px-3 py-1.5 bg-indigo-500 text-white rounded-full text-xs font-medium hover:bg-indigo-600">‚ú® Improve</button>
              </div>
            </div>

            <!-- Apply Panel -->
            ${applyPanel}

            <!-- Chat -->
            <div id="aiChatBox" class="flex-1 overflow-auto p-4 space-y-3 min-h-48 max-h-64">
              ${state.aiChat.length === 0 ? `
                <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-4 text-sm text-slate-600">
                  <div class="font-bold text-slate-800 mb-3">How to use AI Assistant:</div>
                  <ol class="space-y-2 text-xs">
                    <li class="flex gap-2"><span class="bg-blue-500 text-white w-5 h-5 rounded-full flex items-center justify-center flex-shrink-0">1</span> <span>Ask AI to generate content (diagnosis, plan, teaching points, etc.)</span></li>
                    <li class="flex gap-2"><span class="bg-blue-500 text-white w-5 h-5 rounded-full flex items-center justify-center flex-shrink-0">2</span> <span>Click <strong>"Apply to Slide"</strong> on the response</span></li>
                    <li class="flex gap-2"><span class="bg-blue-500 text-white w-5 h-5 rounded-full flex items-center justify-center flex-shrink-0">3</span> <span>Select which slide and field to update</span></li>
                    <li class="flex gap-2"><span class="bg-blue-500 text-white w-5 h-5 rounded-full flex items-center justify-center flex-shrink-0">4</span> <span>Edit the content if needed, then click <strong>"Apply Changes"</strong></span></li>
                  </ol>
                  ${!state.apiKey ? '<p class="mt-3 text-orange-600 font-medium">‚ö†Ô∏è Add API key in Settings to enable AI</p>' : ''}
                </div>
              ` : msgs}
              ${state.aiLoading ? '<div class="typing"><span></span><span></span><span></span></div>' : ''}
            </div>

            <!-- Input -->
            <div class="p-4 border-t bg-white">
              <div class="flex gap-2">
                <input id="aiInput" value="${e(state.aiInput)}" oninput="state.aiInput=this.value"
                  onkeypress="if(event.key==='Enter'&&!event.shiftKey)sendAI()"
                  placeholder="Ask AI to generate content..." class="flex-1 border-2 border-slate-200 focus:border-blue-400 rounded-xl px-4 py-3 outline-none transition-colors">
                <button onclick="sendAI()" ${state.aiLoading ? 'disabled' : ''}
                  class="bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white rounded-xl px-6 font-medium disabled:opacity-50 transition-all">
                  ${state.aiLoading ? '...' : 'Send'}
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Show the apply panel
    function showApplyPanel() {
      state.showApplyPanel = true;
      state.aiTargetSlide = state.slide || 0;
      state.aiTargetField = 'items';
      state.editableAIContent = state.lastAIContent || '';
      render();
    }

    // Apply edited content to slide
    function applyEditedContent() {
      if (!state.pres) {
        showToast('No presentation loaded');
        return;
      }

      const content = state.editableAIContent || state.lastAIContent;
      if (!content) {
        showToast('No content to apply');
        return;
      }

      const slide = state.pres.slides[state.aiTargetSlide];
      const field = state.aiTargetField;

      if (field === 'items') {
        const lines = content.split('\n')
          .map(line => line.replace(/^[\s‚Ä¢\-\*\d\.]+/, '').trim())
          .filter(line => line.length > 0);
        slide.items = lines;
      } else if (field === 'title') {
        slide.title = content.split('\n')[0].substring(0, 100);
      } else {
        slide[field] = content;
      }

      savePres();
      showToast(`Applied to: ${slide.title}`);
      setState({ showAI: false, showApplyPanel: false, slide: state.aiTargetSlide });
    }

    // Regenerate the last response
    function regenerateResponse() {
      if (state.aiChat.length >= 2) {
        const lastUserMsg = [...state.aiChat].reverse().find(m => m.role === 'user');
        if (lastUserMsg) {
          state.aiChat = state.aiChat.slice(0, -1);
          state.aiInput = lastUserMsg.content;
          render();
          setTimeout(() => sendAI(), 50);
        }
      }
    }

    // Initialize
    render();

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (state.editing || state.showAI) return;
      if (state.view === 'editor') {
        if (e.key === 'ArrowRight') setState({ slide: Math.min(state.pres.slides.length - 1, state.slide + 1) });
        if (e.key === 'ArrowLeft') setState({ slide: Math.max(0, state.slide - 1) });
      }
    });

    // Touch swipe navigation
    let touchStartX = 0;
    document.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
    document.addEventListener('touchend', e => {
      if (state.editing || state.showAI || state.view !== 'editor') return;
      const deltaX = e.changedTouches[0].screenX - touchStartX;
      if (Math.abs(deltaX) > 50) {
        if (deltaX < 0) setState({ slide: Math.min(state.pres.slides.length - 1, state.slide + 1) });
        else setState({ slide: Math.max(0, state.slide - 1) });
      }
    }, { passive: true });
  </script>
</body>
</html>
