<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SZMC Pro: Universal Medical Hub</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        :root {
            --primary: #005eb8; 
            --secondary: #003087;
            --accent: #ffb700;
            --success: #2e7d32;
            --bg: #f4f7f6;
            --card-bg: #ffffff;
            --text: #333333;
            --border: #e0e0e0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            background: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 15px;
            margin-bottom: 25px;
        }

        h1 { margin: 0; font-size: 1.8rem; color: var(--secondary); }
        .badge { background: var(--accent); color: #000; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight:bold; vertical-align: middle; }
        
        /* Universal Upload Zone */
        .upload-zone {
            border: 2px dashed var(--primary);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            background: #eef4fc;
            margin-bottom: 25px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .upload-zone:hover { background: #dfe9f5; border-color: var(--secondary); transform: translateY(-2px); }
        .upload-icon { font-size: 2rem; display: block; margin-bottom: 10px; }
        .file-status { font-size: 0.95rem; margin-top: 15px; color: var(--success); font-weight: bold; white-space: pre-wrap; }
        
        /* Controls Grid */
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 0.9rem; }
        
        select, input, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        /* Sections */
        .section-title {
            font-size: 1.1rem;
            color: var(--primary);
            margin-top: 25px;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            font-weight: bold;
        }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }

        textarea { resize: vertical; min-height: 80px; font-family: inherit; }

        /* Buttons */
        .actions {
            margin-top: 30px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary { background-color: var(--primary); color: white; flex: 2; }
        .btn-primary:hover { background-color: var(--secondary); }
        .btn-secondary { background-color: white; border: 2px solid var(--border); color: var(--text); }
        .btn-secondary:hover { border-color: var(--primary); color: var(--primary); }
        .btn-save { background-color: var(--success); color: white; }

        /* Output Area */
        #output-area {
            margin-top: 30px;
            background: #2d2d2d;
            color: #f8f8f2;
            border-radius: 8px;
            padding: 20px;
            display: none;
        }

        .output-header { display: flex; justify-content: space-between; margin-bottom: 15px; color: #fff; }
        pre { white-space: pre-wrap; font-family: 'Courier New', Courier, monospace; font-size: 0.95rem; }

        .hidden { display: none; }
        
        /* Toggle Switch */
        .toggle-container { display: flex; align-items: center; gap: 10px; margin-top: 5px; }
        .toggle-switch { position: relative; display: inline-block; width: 40px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(16px); }

    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <h1>SZMC Pro <span class="badge">v4.0</span></h1>
            <small style="color: #666;">Universal Medical Data Parser</small>
        </div>
        <div>
            <button class="btn-save" onclick="saveCaseJSON()">üíæ Save JSON</button>
        </div>
    </header>

    <div class="upload-zone" id="drop-zone">
        <span class="upload-icon">üìÇ</span>
        <h3>Drag & Drop Files Here</h3>
        <p style="margin:0; color:#666;">Supported: <strong>PDF, PowerPoint (.pptx), HTML, JSON</strong></p>
        <input type="file" id="file-input" accept=".pdf, .json, .html, .htm, .pptx" style="display:none" onchange="handleFileSelect(this)">
        <div id="file-status" class="file-status"></div>
        <textarea id="extracted-content" class="hidden"></textarea>
    </div>

    <div class="controls">
        <div>
            <label>Specialty</label>
            <select id="specialty" onchange="updateForm()">
                <option value="internal">Internal Medicine</option>
                <option value="geriatrics" selected>Geriatrics</option>
                <option value="surgery">Surgery</option>
                <option value="pediatrics">Pediatrics</option>
                <option value="psychiatry">Psychiatry</option>
                <option value="obgyn">OB/GYN</option>
            </select>
        </div>
        <div>
            <label>Output Format</label>
            <select id="format">
                <option value="case">Formal Presentation</option>
                <option value="admission">Admission Note</option>
                <option value="discharge">Discharge Summary</option>
            </select>
        </div>
        <div>
            <label>Language</label>
            <select id="language">
                <option value="english">English</option>
                <option value="hebrew">Hebrew</option>
            </select>
        </div>
        <div>
            <label>AI Supervisor Mode</label>
            <div class="toggle-container">
                <label class="toggle-switch">
                    <input type="checkbox" id="ai-fix-mode" checked>
                    <span class="slider"></span>
                </label>
                <span style="font-size: 0.85rem;">Review & Cite Sources</span>
            </div>
        </div>
    </div>

    <div class="section-title">Patient Profile</div>
    <div class="grid-3">
        <div><label>Age</label><input type="number" id="age" placeholder="85"></div>
        <div><label>Gender</label><select id="sex"><option>Male</option><option>Female</option></select></div>
        <div><label>Chief Complaint</label><input type="text" id="cc"></div>
    </div>

    <div class="section-title">Clinical History</div>
    <textarea id="hpi" placeholder="History of Present Illness..."></textarea>
    <div class="grid-2" style="margin-top:15px;">
        <div><label>Past Medical History</label><textarea id="pmh" rows="3"></textarea></div>
        <div><label>Medications</label><textarea id="meds" rows="3"></textarea></div>
    </div>

    <div id="spec-geriatrics" class="specialty-section">
        <div class="section-title">Geriatric Assessment</div>
        <div class="grid-2">
            <div><label>Function (ADL/IADL)</label><textarea id="ger-func"></textarea></div>
            <div><label>Geriatric Syndromes</label><textarea id="ger-syn" placeholder="Falls, Delirium, Frailty"></textarea></div>
        </div>
    </div>

    <div id="spec-pediatrics" class="specialty-section hidden">
        <div class="section-title">Pediatric History</div>
        <textarea id="ped-birth" placeholder="Birth, development, immunizations"></textarea>
    </div>
    
    <div id="spec-surgery" class="specialty-section hidden">
        <div class="section-title">Surgical Profile</div>
        <textarea id="surg-risk" placeholder="Pre-op risks, past surgeries"></textarea>
    </div>

    <div id="spec-obgyn" class="specialty-section hidden">
        <div class="section-title">OB/GYN History</div>
        <textarea id="ob-hist" placeholder="Gravida/Para, LMP, complications"></textarea>
    </div>
    
    <div id="spec-psychiatry" class="specialty-section hidden">
        <div class="section-title">Psychiatric History</div>
        <textarea id="psych-hist" placeholder="Substance use, family history"></textarea>
    </div>

    <div class="section-title">Assessment</div>
    <div class="grid-2">
        <div><label>Physical Exam</label><textarea id="pe"></textarea></div>
        <div><label>Labs & Imaging</label><textarea id="labs"></textarea></div>
    </div>
    <div style="margin-top:15px;">
        <label>Assessment & Plan</label>
        <textarea id="plan" style="height: 120px;" placeholder="Problem list and plan..."></textarea>
    </div>

    <div class="actions">
        <button class="btn-primary" onclick="generatePrompt()">
            <span>‚ú® Generate AI Architect Prompt</span>
        </button>
        <button class="btn-secondary" onclick="resetForm()">
            <span>üóëÔ∏è Reset</span>
        </button>
    </div>

    <div id="output-area">
        <div class="output-header">
            <strong>Ready for AI (ChatGPT/Claude)</strong>
            <button class="btn-secondary" style="background:transparent; color:white; border:1px solid #666; padding:2px 10px;" onclick="copyToClipboard()">Copy</button>
        </div>
        <pre id="prompt-output"></pre>
    </div>
</div>

<script>
    // --- FILE HANDLING LOGIC ---
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');

    dropZone.onclick = () => fileInput.click();
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.background = '#e1eefd'; });
    dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.style.background = '#eef4fc'; });
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.background = '#eef4fc';
        if(e.dataTransfer.files.length) handleFileSelect({files: e.dataTransfer.files});
    });

    async function handleFileSelect(input) {
        const file = input.files[0];
        const statusEl = document.getElementById('file-status');
        const contentEl = document.getElementById('extracted-content');
        
        statusEl.innerText = `‚è≥ Processing ${file.name}...`;

        try {
            // 1. JSON (Direct Form Import)
            if (file.type === "application/json" || file.name.endsWith(".json")) {
                const text = await file.text();
                const data = JSON.parse(text);
                for (const key in data) {
                    const el = document.getElementById(key);
                    if (el) el.value = data[key]; // Fill form
                }
                statusEl.innerText = "‚úÖ JSON Data Loaded into Form";
                updateForm();
                return;
            }

            // 2. PDF Parsing
            if (file.type === "application/pdf") {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                let fullText = "";
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    fullText += textContent.items.map(item => item.str).join(' ') + "\n";
                }
                contentEl.value = `[SOURCE: PDF - ${file.name}]\n` + fullText;
                statusEl.innerText = `‚úÖ PDF Attached (${pdf.numPages} pages)`;
                return;
            }

            // 3. HTML Parsing
            if (file.type === "text/html" || file.name.endsWith(".html")) {
                const text = await file.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                const cleanText = doc.body.innerText.replace(/\s+/g, ' ').trim();
                contentEl.value = `[SOURCE: HTML - ${file.name}]\n` + cleanText;
                statusEl.innerText = "‚úÖ HTML Content Attached";
                return;
            }

            // 4. PowerPoint (.pptx) Parsing
            if (file.name.endsWith(".pptx")) {
                const zip = await JSZip.loadAsync(file);
                let slideText = "";
                let slideCount = 0;
                
                // Regex to find slide XML files
                const slideFiles = Object.keys(zip.files).filter(name => name.match(/ppt\/slides\/slide\d+\.xml/));
                
                for (const filename of slideFiles) {
                    slideCount++;
                    const xmlStr = await zip.file(filename).async("string");
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlStr, "text/xml");
                    // Extract text from <a:t> tags
                    const textNodes = xmlDoc.getElementsByTagName("a:t");
                    let thisSlide = `--- SLIDE ${slideCount} ---\n`;
                    for (let i = 0; i < textNodes.length; i++) {
                        thisSlide += textNodes[i].textContent + " ";
                    }
                    slideText += thisSlide + "\n";
                }
                
                contentEl.value = `[SOURCE: PPTX - ${file.name}]\n` + slideText;
                statusEl.innerText = `‚úÖ PowerPoint Attached (${slideCount} slides)`;
                return;
            }

            statusEl.innerText = "‚ùå Unsupported file format";

        } catch (err) {
            console.error(err);
            statusEl.innerText = "‚ùå Error reading file.";
        }
    }

    // --- FORM & AI LOGIC ---
    function updateForm() {
        document.querySelectorAll('.specialty-section').forEach(el => el.classList.add('hidden'));
        const spec = document.getElementById('specialty').value;
        const target = document.getElementById('spec-' + spec);
        if (target) target.classList.remove('hidden');
    }

    function generatePrompt() {
        const spec = document.getElementById('specialty').value;
        const format = document.getElementById('format').value;
        const lang = document.getElementById('language').value;
        const fixMode = document.getElementById('ai-fix-mode').checked;
        const sourceMaterial = document.getElementById('extracted-content').value;

        let prompt = `Role: You are an expert Consultant in ${spec}.\n`;
        prompt += `Task: Create a professional ${format.toUpperCase()}.\n`;
        prompt += `Language: ${lang === 'hebrew' ? 'HEBREW (Official Medical Terminology)' : 'ENGLISH'}.\n\n`;

        if (fixMode) {
            prompt += `üî¥ SUPERVISOR MODE ACTIVE:\n`;
            prompt += `1. CRITIQUE the data first. Are labs missing? Is the dose appropriate?\n`;
            prompt += `2. CITE SOURCES for your recommendations (e.g., IMA, ESC, AHA guidelines).\n`;
            prompt += `3. SUGGEST specific investigations that should be added to the plan.\n`;
            prompt += `4. Then, generate the final polished document.\n\n`;
        }

        prompt += `--- MANUAL PATIENT DATA ---\n`;
        prompt += `Age/Sex: ${document.getElementById('age').value} ${document.getElementById('sex').value}\n`;
        prompt += `CC: ${document.getElementById('cc').value}\n`;
        prompt += `HPI: ${document.getElementById('hpi').value}\n`;
        prompt += `PMH: ${document.getElementById('pmh').value}\n`;
        prompt += `Meds: ${document.getElementById('meds').value}\n`;
        
        if (spec === 'geriatrics') {
            prompt += `Func Status: ${document.getElementById('ger-func').value}\n`;
            prompt += `Syndromes: ${document.getElementById('ger-syn').value}\n`;
        }
        
        prompt += `PE: ${document.getElementById('pe').value}\n`;
        prompt += `Labs: ${document.getElementById('labs').value}\n`;
        prompt += `Plan: ${document.getElementById('plan').value}\n`;

        if (sourceMaterial) {
            prompt += `\n--- ATTACHED SOURCE MATERIAL (RAW EXTRACT) ---\n`;
            prompt += `(Note: This text may be messy as it was extracted from a file. Synthesize relevant clinical data from it.)\n`;
            prompt += sourceMaterial.substring(0, 15000); 
        }

        document.getElementById('prompt-output').innerText = prompt;
        document.getElementById('output-area').style.display = 'block';
        document.getElementById('output-area').scrollIntoView({behavior: "smooth"});
    }

    function saveCaseJSON() {
        const data = {};
        document.querySelectorAll('input:not([type=file]), select, textarea').forEach(el => {
            if(el.id) data[el.id] = el.type === 'checkbox' ? el.checked : el.value;
        });
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `case_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    }

    function resetForm() {
        if(confirm("Clear all?")) {
            document.querySelectorAll("input:not([type=file]), textarea").forEach(e => e.value = "");
            document.getElementById('file-status').innerText = "";
            document.getElementById('output-area').style.display = 'none';
        }
    }

    function copyToClipboard() {
        navigator.clipboard.writeText(document.getElementById('prompt-output').innerText)
            .then(() => alert("Copied! Paste to AI."));
    }
</script>

</body>
</html>