<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SZMC Pro: Evidence Edition v8</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        :root {
            --primary: #005eb8; --secondary: #003087; --accent: #00bfa5;
            --crit: #d32f2f; --warn: #f57c00; --bg: #f4f7f6;
            --card: #ffffff; --border: #e0e0e0;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); margin: 0; padding: 0; 
            height: 100vh; display: flex; flex-direction: column;
            overflow: hidden; /* Prevent body scroll, use panels */
        }

        /* RTL SUPPORT CLASS */
        body.rtl { direction: rtl; text-align: right; }
        body.rtl .panel-source { border-right: none; border-left: 1px solid var(--border); }
        
        /* LAYOUT */
        .header-bar {
            background: white; padding: 10px 20px; border-bottom: 2px solid var(--primary);
            display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;
            z-index: 10;
        }
        .app-title { font-size: 1.2rem; font-weight: 800; color: var(--secondary); margin: 0; }
        .badge { background: var(--accent); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; }

        .main-container {
            display: flex; flex: 1; overflow: hidden;
        }

        /* LEFT PANEL (Source) */
        .panel-source {
            width: 30%; background: #eef2f6; border-right: 1px solid var(--border);
            padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px;
        }

        /* RIGHT PANEL (Work) */
        .panel-work {
            width: 70%; background: white; padding: 20px; overflow-y: auto;
        }

        /* MOBILE RESPONSIVE DESIGN */
        @media (max-width: 768px) {
            body { overflow: auto; height: auto; } /* Allow scroll on mobile */
            .main-container { flex-direction: column; height: auto; }
            .panel-source { width: 100%; border-right: none; border-bottom: 1px solid var(--border); height: auto; max-height: 300px; }
            .panel-work { width: 100%; padding: 15px; height: auto; }
            .grid-2, .grid-3 { grid-template-columns: 1fr !important; }
            button { width: 100%; margin-bottom: 5px; }
            .hide-on-mobile { display: none; }
        }

        /* COMPONENTS */
        .card { background: white; border: 1px solid var(--border); border-radius: 8px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .upload-zone { 
            border: 2px dashed var(--primary); border-radius: 8px; padding: 20px; 
            text-align: center; background: #f0f7ff; cursor: pointer; transition: 0.2s;
        }
        .upload-zone:active { background: #dcebff; }

        label { display: block; font-weight: 600; font-size: 0.85rem; margin-bottom: 5px; color: #444; }
        input, select, textarea {
            width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px;
            font-size: 1rem; box-sizing: border-box; font-family: inherit;
        }
        textarea { resize: vertical; min-height: 80px; }

        .section-title {
            color: var(--primary); font-weight: 700; margin: 25px 0 10px 0; 
            border-bottom: 1px solid #eee; padding-bottom: 5px; display: flex; justify-content: space-between;
        }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }

        /* BUTTONS */
        .btn-group { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        button {
            padding: 12px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;
            font-size: 0.95rem; transition: transform 0.1s;
        }
        button:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; flex: 2; }
        .btn-insight { background: var(--secondary); color: white; flex: 2; border: 1px solid var(--primary); }
        .btn-ghost { background: transparent; border: 1px solid var(--border); color: #555; }
        .btn-lang { background: #333; color: white; padding: 5px 10px; font-size: 0.8rem; border-radius: 4px; }

        /* OUTPUT OVERLAY */
        #output-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 1000; display: none;
            align-items: center; justify-content: center;
        }
        .output-box {
            background: white; width: 90%; max-width: 600px; max-height: 80vh;
            border-radius: 10px; display: flex; flex-direction: column; padding: 20px;
        }
        #prompt-output {
            flex: 1; background: #f4f4f4; padding: 10px; border-radius: 6px;
            font-family: monospace; font-size: 0.85rem; overflow-y: auto; margin: 10px 0;
            white-space: pre-wrap; border: 1px solid #ccc;
        }

        /* UTILS */
        .hidden { display: none !important; }
        .lab-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-right: 5px; font-weight: bold; }
        .bg-red { background: #ffebee; color: var(--crit); border: 1px solid var(--crit); }
    </style>
</head>
<body>

<div class="header-bar">
    <div>
        <span class="app-title">SZMC Pro</span>
        <span class="badge">v8.0</span>
    </div>
    <div style="display:flex; gap:10px;">
        <button class="btn-lang" onclick="toggleLang()">üáÆüá± / üá∫üá∏</button>
        <button class="btn-ghost hide-on-mobile" onclick="resetForm()">Reset</button>
    </div>
</div>

<div class="main-container">
    
    <div class="panel-source">
        <div class="card upload-zone" onclick="document.getElementById('file-input').click()">
            <div style="font-size:1.5rem">üìÇ</div>
            <strong>Tap to Import</strong>
            <div style="font-size:0.8rem; color:#666">PDF, PPTX, JSON</div>
            <input type="file" id="file-input" accept=".pdf,.pptx,.json" style="display:none" onchange="handleFile(this)">
        </div>
        
        <div id="status-msg" style="font-size:0.8rem; font-weight:bold; color:var(--primary);"></div>

        <div class="card">
            <label>Raw Context (Editable)</label>
            <textarea id="raw-text" style="height:150px; font-size:0.8rem;" placeholder="Extracted text will appear here..."></textarea>
        </div>
        
        <div id="quick-stats" style="font-size:0.85rem;"></div>
    </div>

    <div class="panel-work">
        
        <div class="grid-2">
            <div>
                <label data-en="Specialty" data-he="◊î◊™◊û◊ó◊ï◊™">Specialty</label>
                <select id="specialty" onchange="updateUI()">
                    <option value="internal">Internal Medicine</option>
                    <option value="geriatrics" selected>Geriatrics</option>
                    <option value="pediatrics">Pediatrics</option>
                    <option value="surgery">Surgery</option>
                </select>
            </div>
            <div>
                <label data-en="Output Goal" data-he="◊°◊ï◊í ◊§◊ú◊ò">Output Goal</label>
                <select id="goal">
                    <option value="case">Presentation</option>
                    <option value="discharge">Discharge Letter</option>
                    <option value="admission">Admission Note</option>
                </select>
            </div>
        </div>

        <div class="section-title">
            <span data-en="Patient Profile" data-he="◊§◊®◊ï◊§◊ô◊ú ◊û◊ò◊ï◊§◊ú">Patient Profile</span>
        </div>
        <div class="grid-3">
            <div><label>Age</label><input type="number" id="age" placeholder="85"></div>
            <div><label>Sex</label><select id="sex"><option>Male</option><option>Female</option></select></div>
            <div><label>CC</label><input type="text" id="cc" placeholder="Complaint"></div>
        </div>

        <div class="section-title">
            <span data-en="Clinical History" data-he="◊î◊ô◊°◊ò◊ï◊®◊ô◊î ◊®◊§◊ï◊ê◊ô◊™">Clinical History</span>
        </div>
        <textarea id="hpi" rows="4" placeholder="HPI: Story of present illness..."></textarea>
        
        <div class="grid-2" style="margin-top:10px;">
            <div><label>Background</label><textarea id="pmh" rows="4"></textarea></div>
            <div><label>Meds</label><textarea id="meds" rows="4"></textarea></div>
        </div>

        <div class="section-title">
            <span data-en="Labs & Imaging" data-he="◊û◊¢◊ë◊ì◊î ◊ï◊î◊ì◊û◊ô◊î">Labs & Imaging</span>
        </div>
        <textarea id="labs" rows="4" placeholder="Paste labs here..." oninput="checkLabs()"></textarea>
        <div id="lab-alerts" style="margin-top:5px;"></div>

        <div id="spec-geriatrics" class="specialty-section">
            <div class="section-title">Geriatrics</div>
            <div class="grid-2">
                <div><label>Function (ADL)</label><textarea id="ger-func"></textarea></div>
                <div><label>Syndromes</label><textarea id="ger-syn" placeholder="Falls, Delirium"></textarea></div>
            </div>
        </div>
        
        <div class="section-title">
            <span data-en="Assessment & Plan" data-he="◊ê◊ë◊ó◊†◊î ◊ï◊™◊ï◊õ◊†◊ô◊™">Assessment & Plan</span>
        </div>
        <textarea id="plan" rows="5"></textarea>

        <div class="btn-group">
            <button class="btn-primary" onclick="generatePrompt('standard')">
                üìù <span data-en="Write Medical Note" data-he="◊õ◊™◊ï◊ë ◊û◊°◊û◊ö ◊®◊§◊ï◊ê◊ô">Write Medical Note</span>
            </button>
            <button class="btn-insight" onclick="generatePrompt('insight')">
                üß† <span data-en="Open Evidence Insights" data-he="◊™◊ï◊ë◊†◊ï◊™ ◊ß◊ú◊ô◊†◊ô◊ï◊™ ◊ï◊°◊§◊®◊ï◊™">Open Evidence Insights</span>
            </button>
        </div>
    </div>
</div>

<div id="output-overlay">
    <div class="output-box">
        <h3 style="margin-top:0; color:var(--primary);">Ready for AI</h3>
        <p style="font-size:0.85rem; color:#666;">Copy this prompt and paste it into ChatGPT / Claude.</p>
        <pre id="prompt-output"></pre>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn-primary" onclick="copyToClip()">Copy Prompt</button>
            <button class="btn-ghost" onclick="document.getElementById('output-overlay').style.display='none'">Close</button>
        </div>
    </div>
</div>

<script>
    // --- STATE & CONFIG ---
    let isHebrew = false;

    // --- FILE PARSING ---
    async function handleFile(input) {
        const file = input.files[0];
        if(!file) return;
        document.getElementById('status-msg').innerText = "‚è≥ Processing...";
        
        try {
            let text = "";
            if(file.name.endsWith('.pdf')) {
                const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
                for(let i=1; i<=pdf.numPages; i++) text += (await (await pdf.getPage(i)).getTextContent()).items.map(s=>s.str).join(' ') + "\n";
            } else if(file.name.endsWith('.pptx')) {
                const zip = await JSZip.loadAsync(file);
                for(let k of Object.keys(zip.files).filter(n=>n.match(/ppt\/slides\/slide\d+\.xml/))) {
                    text += (new DOMParser().parseFromString(await zip.file(k).async("string"),"text/xml")).body.textContent + " ";
                }
            } else if(file.name.endsWith('.json')) {
                const d = JSON.parse(await file.text());
                for(let k in d) if(document.getElementById(k)) document.getElementById(k).value = d[k];
                text = "JSON Loaded";
            }
            
            document.getElementById('raw-text').value = text;
            document.getElementById('status-msg').innerText = "‚úÖ Loaded: " + file.name;
            autoFill(text);
        } catch(e) { console.error(e); document.getElementById('status-msg').innerText = "‚ùå Error"; }
    }

    function autoFill(text) {
        const get = (r) => (text.match(r) || [])[1] || "";
        const set = (id, v) => { if(v && v.length > 2) document.getElementById(id).value = v.trim(); }
        
        set('age', /(\d{2,3})\s?(y|yo|◊©◊†◊ô◊ù)/i);
        set('cc', /(?:CC|Complaint|◊™◊ú◊ï◊†◊î)[:\s]+(.*?)(?=\n|$)/i);
        set('hpi', /(?:HPI|History|◊û◊ó◊ú◊î ◊†◊ï◊õ◊ó◊ô◊™)[:\s]+([\s\S]*?)(?=\n\s*(?:PMH|Med|Lab)|$)/i);
        set('meds', /(?:Meds|Rx|◊™◊®◊ï◊§◊ï◊™)[:\s]+([\s\S]*?)(?=\n\s*(?:Lab|Plan)|$)/i);
        checkLabs();
    }

    // --- LOGIC ---
    function checkLabs() {
        const txt = document.getElementById('labs').value + document.getElementById('raw-text').value;
        const alerts = document.getElementById('lab-alerts');
        let html = "";
        
        // Simple logic for demo
        if(txt.match(/K\s*[>:]\s*5\.[5-9]/)) html += "<span class='lab-badge bg-red'>Hyperkalemia</span>";
        if(txt.match(/Na\s*[<:]\s*130/)) html += "<span class='lab-badge bg-red'>Hyponatremia</span>";
        if(txt.match(/Hgb\s*[<:]\s*8/)) html += "<span class='lab-badge bg-red'>Severe Anemia</span>";
        
        alerts.innerHTML = html;
    }

    function toggleLang() {
        isHebrew = !isHebrew;
        document.body.classList.toggle('rtl', isHebrew);
        
        // Translate labels
        document.querySelectorAll('[data-en]').forEach(el => {
            el.innerText = isHebrew ? el.getAttribute('data-he') : el.getAttribute('data-en');
        });
    }

    function generatePrompt(mode) {
        const spec = document.getElementById('specialty').value;
        const raw = document.getElementById('raw-text').value;
        
        let p = `Role: Expert ${spec} Consultant.\n`;
        p += `Language: ${isHebrew ? 'Hebrew (Professional Medical)' : 'English'}.\n`;
        
        if (mode === 'insight') {
            // OPEN EVIDENCE MODE
            p += `TASK: ACT AS "OPEN EVIDENCE AI" / CLINICAL DECISION SUPPORT.\n`;
            p += `1. GENERATE DIFFERENTIAL DIAGNOSIS: List top 5 with probability %.\n`;
            p += `2. CITE GUIDELINES: You must cite guidelines (ESC, AHA, ADA, GOLD) relevant to this case.\n`;
            p += `3. RED FLAGS: Identify any missed dangerous conditions based on the labs provided.\n`;
            p += `4. SUGGESTED WORKUP: What test is missing?\n`;
            p += `5. PROVIDE LINKS/CITATIONS: Format as [Author, Journal, Year].\n\n`;
        } else {
            // STANDARD NOTE MODE
            p += `TASK: Write a professional ${document.getElementById('goal').value}.\n`;
            p += `STYLE: Concise, Bullet points, Medical terminology.\n\n`;
        }

        p += `--- PATIENT DATA ---\n`;
        p += `ID: ${document.getElementById('age').value} ${document.getElementById('sex').value}\n`;
        p += `CC: ${document.getElementById('cc').value}\n`;
        p += `HPI: ${document.getElementById('hpi').value}\n`;
        p += `Background: ${document.getElementById('pmh').value}\n`;
        p += `Meds: ${document.getElementById('meds').value}\n`;
        if(spec === 'geriatrics') p += `Geriatrics: ${document.getElementById('ger-func').value}\n`;
        p += `Labs/Imaging: ${document.getElementById('labs').value}\n`;
        p += `Current Plan: ${document.getElementById('plan').value}\n`;

        if(raw) p += `\n--- RAW SOURCE CONTEXT ---\n${raw.substring(0, 3000)}...`;

        document.getElementById('prompt-output').innerText = p;
        document.getElementById('output-overlay').style.display = 'flex';
    }

    function updateUI() {
        document.querySelectorAll('.specialty-section').forEach(e => e.classList.add('hidden'));
        const s = document.getElementById('specialty').value;
        if(document.getElementById('spec-'+s)) document.getElementById('spec-'+s).classList.remove('hidden');
    }

    function copyToClip() {
        navigator.clipboard.writeText(document.getElementById('prompt-output').innerText);
        alert("Copied!");
    }
    
    function resetForm() {
        if(confirm("Reset?")) location.reload();
    }
</script>
</body>
</html>
