<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SZMC Pro: Universal v12</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --primary: #2c3e50; /* Slate */
            --accent: #3498db; /* Blue */
            --success: #27ae60;
            --warning: #f39c12;
            --bg: #ecf0f1;
            --sidebar: #ffffff;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* SIDEBAR */
        .sidebar { width: 280px; background: var(--sidebar); border-right: 1px solid #bdc3c7; display: flex; flex-direction: column; padding: 20px; z-index: 2; }
        .logo { font-size: 1.4rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
        .badge { background: var(--accent); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; }

        /* UNIVERSAL DROPZONE */
        .drop-zone {
            border: 2px dashed #95a5a6; border-radius: 8px; padding: 25px; text-align: center;
            background: #f7f9f9; cursor: pointer; transition: 0.3s; position: relative; overflow: hidden;
        }
        .drop-zone:hover { border-color: var(--accent); background: #ebf5fb; }
        .drop-icon { font-size: 2rem; margin-bottom: 10px; display: block; }
        .drop-text { font-size: 0.85rem; font-weight: 600; color: #7f8c8d; }
        .drop-sub { font-size: 0.7rem; color: #95a5a6; margin-top: 5px; }
        
        /* PROGRESS BAR (OCR) */
        #progress-container { margin-top: 15px; display: none; }
        .progress-bar { height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.2s; }
        .progress-text { font-size: 0.75rem; color: #7f8c8d; margin-top: 5px; text-align: right; }

        /* MAIN EDITOR */
        .main { flex: 1; padding: 30px; overflow-y: auto; display: flex; gap: 30px; }
        
        .editor-col { flex: 2; background: white; border-radius: 8px; padding: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .preview-col { flex: 1; display: flex; flex-direction: column; gap: 20px; }

        /* FORM ELEMENTS */
        .sec-header { font-size: 1.1rem; font-weight: 700; color: var(--primary); border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; margin-bottom: 20px; margin-top: 30px; }
        .sec-header:first-child { margin-top: 0; }
        
        label { display: block; font-size: 0.8rem; font-weight: 700; color: #7f8c8d; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #bdc3c7; border-radius: 6px; font-size: 0.95rem; font-family: inherit; box-sizing: border-box; background: #fdfdfd; transition: 0.2s; }
        input:focus, textarea:focus { border-color: var(--accent); outline: none; background: white; }
        textarea { resize: vertical; min-height: 100px; line-height: 1.6; }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }

        /* EXPORT CARDS */
        .export-card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .export-title { font-weight: 800; color: var(--primary); margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { padding: 12px; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem; }
        .btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
        
        .btn-ppt { background: #d35400; color: white; }
        .btn-doc { background: #2980b9; color: white; }
        .btn-pdf { background: #c0392b; color: white; }
        .btn-json { background: #27ae60; color: white; }
        .btn-txt { background: #7f8c8d; color: white; }
        
        .btn-ai { background: linear-gradient(135deg, #8e44ad, #9b59b6); color: white; width: 100%; margin-top: 10px; }

    </style>
</head>
<body>

<div class="sidebar">
    <div class="logo">
        <span>SZMC Pro</span>
        <span class="badge">Universal v12</span>
    </div>

    <div class="drop-zone" onclick="document.getElementById('file-in').click()" id="drop-area">
        <span class="drop-icon">üìÇ</span>
        <div class="drop-text">Import Any File</div>
        <div class="drop-sub">PDF ‚Ä¢ DOCX ‚Ä¢ PPTX ‚Ä¢ JSON<br>JPG ‚Ä¢ PNG ‚Ä¢ TXT</div>
        <input type="file" id="file-in" style="display:none" onchange="handleFile(this)">
    </div>

    <div id="progress-container">
        <div class="progress-bar"><div class="progress-fill" id="ocr-bar"></div></div>
        <div class="progress-text" id="ocr-status">Processing...</div>
    </div>

    <div style="flex:1; display:flex; flex-direction:column; margin-top:20px;">
        <label>Raw Extracted Text</label>
        <textarea id="raw-text" style="flex:1; font-family:monospace; font-size:0.75rem; border:1px solid #bdc3c7;" placeholder="Text from documents or images will appear here..."></textarea>
    </div>
</div>

<div class="main">
    
    <div class="editor-col">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0; color:var(--primary);">Clinical Workspace</h2>
            <button onclick="clearAll()" style="background:transparent; border:1px solid #ccc; padding:5px 10px; border-radius:4px; cursor:pointer;">Clear</button>
        </div>

        <div class="sec-header">1. Demographics & Chief Complaint</div>
        <div class="grid-3">
            <div><label>Age</label><input type="text" id="age"></div>
            <div><label>Sex</label><select id="sex"><option>Male</option><option>Female</option></select></div>
            <div><label>Initials</label><input type="text" id="initials" placeholder="Pt. Name"></div>
        </div>
        <div style="margin-top:15px;">
            <label>Chief Complaint</label>
            <input type="text" id="cc" placeholder="e.g. 3 days of dyspnea">
        </div>

        <div class="sec-header">2. History</div>
        <label>History of Present Illness (HPI)</label>
        <textarea id="hpi" rows="5"></textarea>
        
        <div class="grid-2" style="margin-top:20px;">
            <div><label>Background (PMH)</label><textarea id="pmh" rows="4"></textarea></div>
            <div><label>Medications</label><textarea id="meds" rows="4"></textarea></div>
        </div>

        <div class="sec-header">3. Objective Data</div>
        <div class="grid-2">
            <div>
                <label>Labs (Auto-Table)</label>
                <textarea id="labs" rows="5" placeholder="Paste messy labs here (Na 135, K 4.0)..."></textarea>
            </div>
            <div>
                <label>Imaging / Diagnostics</label>
                <textarea id="imaging" rows="5"></textarea>
            </div>
        </div>

        <div class="sec-header">4. Assessment & Plan</div>
        <label>Discussion & Management</label>
        <textarea id="plan" rows="8"></textarea>
    </div>

    <div class="preview-col">
        
        <div class="export-card">
            <div class="export-title">ü§ñ AI Assistant</div>
            <p style="font-size:0.8rem; color:#666; margin:0 0 10px 0;">Generate a structured discussion based on your data.</p>
            <button class="btn btn-ai" onclick="generatePrompt()">‚ú® Copy Prompt</button>
            <textarea id="prompt-out" style="height:0; opacity:0; padding:0; min-height:0;"></textarea>
        </div>

        <div class="export-card">
            <div class="export-title">üíæ Export Center</div>
            <div class="btn-grid">
                <button class="btn btn-ppt" onclick="exportPPT()">üìä PPTX</button>
                <button class="btn btn-doc" onclick="exportDOC()">üìù DOC</button>
                <button class="btn btn-pdf" onclick="exportPDF()">üì∞ PDF</button>
                <button class="btn btn-json" onclick="exportJSON()">üíæ JSON</button>
            </div>
            <button class="btn btn-txt" onclick="exportTXT()" style="width:100%; margin-top:10px;">üìÑ Text File</button>
        </div>

    </div>
</div>

<div id="pdf-container" style="display:none; padding:40px; font-family:Times New Roman;">
    <h1 style="text-align:center; border-bottom:1px solid #000;">Medical Case Report</h1>
    <p><strong>Patient:</strong> <span id="p-age"></span> <span id="p-sex"></span> | <strong>CC:</strong> <span id="p-cc"></span></p>
    <h3>HPI</h3><p id="p-hpi"></p>
    <h3>Background</h3><p id="p-pmh"></p>
    <h3>Objective</h3><p><strong>Meds:</strong> <span id="p-meds"></span></p><p><strong>Labs:</strong> <span id="p-labs"></span></p>
    <h3>Discussion</h3><p id="p-plan"></p>
</div>

<script>
    // --- 1. UNIVERSAL IMPORT ENGINE ---
    
    // Drag & Drop Handling
    const dropArea = document.getElementById('drop-area');
    dropArea.addEventListener('dragover', (e) => { e.preventDefault(); dropArea.style.background = '#d6eaf8'; });
    dropArea.addEventListener('dragleave', (e) => { e.preventDefault(); dropArea.style.background = '#f7f9f9'; });
    dropArea.addEventListener('drop', (e) => { 
        e.preventDefault(); 
        dropArea.style.background = '#f7f9f9';
        if(e.dataTransfer.files.length) handleFile({files: e.dataTransfer.files});
    });

    async function handleFile(input) {
        const file = input.files[0];
        if(!file) return;
        
        const ext = file.name.split('.').pop().toLowerCase();
        let text = "";
        setStatus("Processing " + ext.toUpperCase() + "...", 10);

        try {
            // A. PDF
            if (ext === 'pdf') {
                const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
                for(let i=1; i<=pdf.numPages; i++) text += (await (await pdf.getPage(i)).getTextContent()).items.map(s=>s.str).join(' ') + " ";
            }
            // B. DOCX (Mammoth)
            else if (ext === 'docx') {
                const result = await mammoth.extractRawText({arrayBuffer: await file.arrayBuffer()});
                text = result.value;
            }
            // C. PPTX (JSZip)
            else if (ext === 'pptx') {
                const zip = await JSZip.loadAsync(file);
                for(let k of Object.keys(zip.files).filter(n=>n.match(/ppt\/slides\/slide\d+\.xml/))) {
                    text += (new DOMParser().parseFromString(await zip.file(k).async("string"),"text/xml")).body.textContent + " ";
                }
            }
            // D. IMAGES (OCR)
            else if (['jpg','jpeg','png','bmp'].includes(ext)) {
                setStatus("Running OCR (Reading Image)...", 50);
                const worker = await Tesseract.createWorker('eng');
                const ret = await worker.recognize(file);
                text = ret.data.text;
                await worker.terminate();
            }
            // E. TEXT / JSON
            else if (ext === 'json') {
                const d = JSON.parse(await file.text());
                for(let k in d) if(document.getElementById(k)) document.getElementById(k).value = d[k];
                text = "JSON Loaded.";
            }
            else { // txt
                text = await file.text();
            }

            document.getElementById('raw-text').value = text;
            smartPopulate(text);
            setStatus("Import Complete", 100);
            setTimeout(() => { document.getElementById('progress-container').style.display='none'; }, 2000);

        } catch (err) {
            console.error(err);
            setStatus("Error: " + err.message, 0);
        }
    }

    function setStatus(msg, pct) {
        document.getElementById('progress-container').style.display = 'block';
        document.getElementById('ocr-status').innerText = msg;
        document.getElementById('ocr-bar').style.width = pct + '%';
    }

    // --- 2. SMART PARSER ---
    function smartPopulate(text) {
        const set = (id, r) => { let m = text.match(r); if(m) document.getElementById(id).value = m[1].trim(); }
        set('age', /(\d{2,3})\s?(y|yo|Year)/i);
        set('hpi', /(?:HPI|History|Present Illness)[:\s]+([\s\S]*?)(?=\n\s*(?:PMH|Past|Med)|$)/i);
        set('pmh', /(?:PMH|Background|Past Medical)[:\s]+([\s\S]*?)(?=\n\s*(?:Med|Lab)|$)/i);
        set('meds', /(?:Meds|Medications)[:\s]+([\s\S]*?)(?=\n\s*(?:Lab|Plan)|$)/i);
        set('labs', /(?:Labs|Laboratory)[:\s]+([\s\S]*?)(?=\n\s*(?:Plan|Imag)|$)/i);
    }

    // --- 3. EXPORT ENGINES ---
    
    // Helper to get values
    const v = (id) => document.getElementById(id).value || "";

    // A. PPTX
    function exportPPT() {
        let pres = new PptxGenJS();
        pres.layout = 'LAYOUT_16x9';
        
        // Master
        pres.defineSlideMaster({
            title: 'MASTER', bkgd: 'F0F0F0',
            objects: [
                { rect: { x:0, y:0, w:'100%', h:0.8, fill:'2c3e50' } },
                { text: { text:'Clinical Case Report', options:{x:0.5, y:0.1, color:'FFFFFF', fontSize:14} } }
            ]
        });

        // 1. Title
        let s1 = pres.addSlide();
        s1.addText("Case Presentation", {x:1, y:2.5, fontSize:36, color:'2c3e50', bold:true});
        s1.addText(v('cc'), {x:1, y:3.5, fontSize:24, color:'7f8c8d'});

        // 2. HPI
        let s2 = pres.addSlide({masterName:'MASTER'});
        s2.addText("History of Present Illness", {x:0.5, y:1.2, fontSize:24, color:'3498db', bold:true});
        s2.addText(v('hpi'), {x:0.5, y:2, w:'90%', fontSize:16});

        // 3. Labs (Table)
        let s3 = pres.addSlide({masterName:'MASTER'});
        s3.addText("Labs", {x:0.5, y:1.2, fontSize:24, color:'3498db', bold:true});
        // Simple regex table parser
        const rows = [[{text:'Test', options:{bold:true}}, {text:'Value', options:{bold:true}}]];
        const regex = /([A-Za-z]+)\s*[:=]?\s*(\d+\.?\d*)/g;
        let m;
        while((m = regex.exec(v('labs'))) !== null) rows.push([m[1], m[2]]);
        if(rows.length>1) s3.addTable(rows, {x:1, y:2, w:5, border:{pt:1, color:'aaaaaa'}});
        else s3.addText(v('labs'), {x:1, y:2, w:'90%', fontSize:16});

        // 4. Plan
        let s4 = pres.addSlide({masterName:'MASTER'});
        s4.addText("Assessment & Plan", {x:0.5, y:1.2, fontSize:24, color:'3498db', bold:true});
        s4.addText(v('plan'), {x:0.5, y:2, w:'90%', fontSize:16});

        pres.writeFile({ fileName: `Case_${v('initials')}.pptx` });
    }

    // B. DOCX (Word)
    function exportDOC() {
        const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Export HTML to Word Document with JavaScript</title></head><body>";
        const footer = "</body></html>";
        const content = `
            <h1>Medical Case Report</h1>
            <p><strong>Patient:</strong> ${v('age')} ${v('sex')} (${v('initials')})</p>
            <h3>HPI</h3><p>${v('hpi')}</p>
            <h3>Background</h3><p>${v('pmh')}</p>
            <h3>Objective</h3><p>Meds: ${v('meds')}</p><p>Labs: ${v('labs')}</p>
            <h3>Plan</h3><p>${v('plan')}</p>
        `;
        const sourceHTML = header + content + footer;
        const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
        const a = document.createElement("a");
        a.href = source;
        a.download = `Case_${v('initials')}.doc`;
        a.click();
    }

    // C. PDF
    function exportPDF() {
        // Fill hidden template
        document.getElementById('p-age').innerText = v('age');
        document.getElementById('p-sex').innerText = v('sex');
        document.getElementById('p-cc').innerText = v('cc');
        document.getElementById('p-hpi').innerText = v('hpi');
        document.getElementById('p-pmh').innerText = v('pmh');
        document.getElementById('p-meds').innerText = v('meds');
        document.getElementById('p-labs').innerText = v('labs');
        document.getElementById('p-plan').innerText = v('plan');
        
        const el = document.getElementById('pdf-container');
        el.style.display = 'block';
        html2pdf().set({margin:1, filename:`Case_${v('initials')}.pdf`}).from(el).save().then(()=>el.style.display='none');
    }

    // D. JSON & TXT
    function exportJSON() {
        const d = {};
        document.querySelectorAll('input, textarea, select').forEach(e => d[e.id] = e.value);
        saveFile(JSON.stringify(d, null, 2), 'case.json', 'application/json');
    }
    function exportTXT() {
        const t = `CASE REPORT\n\nID: ${v('age')} ${v('sex')}\nCC: ${v('cc')}\n\nHPI:\n${v('hpi')}\n\nPMH:\n${v('pmh')}\n\nPLAN:\n${v('plan')}`;
        saveFile(t, 'case.txt', 'text/plain');
    }
    function saveFile(content, name, type) {
        const a = document.createElement("a");
        a.href = URL.createObjectURL(new Blob([content], {type: type}));
        a.download = name;
        a.click();
    }

    // --- 4. AI PROMPT ---
    function generatePrompt() {
        const p = `Role: Medical Consultant.\nTask: Rewrite into professional medical case report.\n\nData:\nAge: ${v('age')} ${v('sex')}\nCC: ${v('cc')}\nHPI: ${v('hpi')}\nPMH: ${v('pmh')}\nLabs: ${v('labs')}\nPlan: ${v('plan')}`;
        document.getElementById('prompt-out').value = p;
        navigator.clipboard.writeText(p);
        alert("Prompt copied to clipboard!");
    }
    
    function clearAll() { if(confirm("Clear workspace?")) location.reload(); }

</script>
</body>
</html>