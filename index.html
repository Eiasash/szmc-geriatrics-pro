<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SZMC Geriatrics Pro</title>
  <meta name="description" content="Geriatric Case Presentation Tool for Shaare Zedek Medical Center">
  <meta name="theme-color" content="#2563eb">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ©º</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, sans-serif; overscroll-behavior: none; }
    .rtl { direction: rtl; text-align: right; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .animate-pulse { animation: pulse 2s infinite; }
    .animate-slideUp { animation: slideUp 0.3s ease-out; }
    .animate-fadeIn { animation: fadeIn 0.2s ease-out; }
    .modal-content { animation: slideUp 0.3s ease-out; }
    input, textarea, select { font-size: 16px !important; }
    .typing span { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #94a3b8; margin: 0 2px; animation: pulse 1s infinite; }
    .typing span:nth-child(2) { animation-delay: 0.2s; }
    .typing span:nth-child(3) { animation-delay: 0.4s; }
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom, 20px); }
    .gradient-szmc { background: linear-gradient(135deg, #1e40af 0%, #7c3aed 100%); }
    .glass { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); }
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
  </style>
</head>
<body class="bg-slate-100 min-h-screen">
  <div id="app"></div>

  <script>
    // ============ SZMC GERIATRICS PRO v4.0 ============
    const VERSION = '4.1';
    
    // State
    let state = {
      view: 'home', // home, editor, present, calc, ref
      pres: null,
      slide: 0,
      saved: [],
      editing: null,
      showAI: false,
      aiChat: [],
      aiInput: '',
      aiLoading: false,
      apiKey: '',
      showSettings: false,
      showImport: false,
      importText: '',
      showExport: false,
      showCalc: false,
      calcType: 'crcl',
      calcIn: {},
      calcRes: null,
      showDrugs: false,
      showLabs: false,
      showTemplates: false,
      presentMode: false,
      timer: 0,
      timerOn: false,
      darkMode: false,
      recentAction: null
    };

    // Load saved data
    try {
      const saved = localStorage.getItem('szmc-pro-v4');
      if (saved) {
        const data = JSON.parse(saved);
        state.saved = data.presentations || [];
        state.apiKey = data.apiKey || '';
        state.darkMode = data.darkMode || false;
      }
    } catch(e) { console.error('Load error:', e); }

    // Save to storage
    function save() {
      try {
        localStorage.setItem('szmc-pro-v4', JSON.stringify({
          presentations: state.saved,
          apiKey: state.apiKey,
          darkMode: state.darkMode
        }));
      } catch(e) { console.error('Save error:', e); }
    }

    // ============ TEMPLATES ============
    const templates = {
      case: {
        name: 'ğŸ©º Case Presentation',
        desc: '13 slides for clinical cases',
        slides: [
          { type: 'title', title: 'Case Presentation', subtitle: '', presenter: '', date: new Date().toLocaleDateString('en-IL') },
          { type: 'patient', title: 'Patient', demographics: '', cc: '', codeStatus: '' },
          { type: 'content', title: 'HPI', content: '' },
          { type: 'list', title: 'PMH / PSH', items: [] },
          { type: 'list', title: 'Medications', items: [] },
          { type: 'exam', title: 'Physical Exam', vitals: {}, findings: '' },
          { type: 'list', title: 'Labs', items: [] },
          { type: 'content', title: 'Imaging', content: '' },
          { type: 'scores', title: 'Geriatric Assessment', scores: {} },
          { type: 'list', title: 'Differential Diagnosis', items: [] },
          { type: 'content', title: 'Final Diagnosis', content: '' },
          { type: 'treatment', title: 'Management', pharm: '', nonpharm: '' },
          { type: 'list', title: 'Teaching Points', items: [] }
        ]
      },
      consult: {
        name: 'ğŸ“‹ Consult Note',
        desc: '8 slides for consultations',
        slides: [
          { type: 'title', title: 'Geriatrics Consultation', subtitle: '', presenter: '', date: new Date().toLocaleDateString('en-IL') },
          { type: 'patient', title: 'Patient', demographics: '', cc: '' },
          { type: 'content', title: 'Reason for Consult', content: '' },
          { type: 'content', title: 'Brief History', content: '' },
          { type: 'scores', title: 'Geriatric Assessment', scores: {} },
          { type: 'list', title: 'Problems Identified', items: [] },
          { type: 'list', title: 'Recommendations', items: [] },
          { type: 'content', title: 'Follow-up Plan', content: '' }
        ]
      },
      morning: {
        name: 'â˜€ï¸ Morning Report',
        desc: '6 slides for teaching',
        slides: [
          { type: 'title', title: 'Morning Report', subtitle: '', presenter: '', date: new Date().toLocaleDateString('en-IL') },
          { type: 'patient', title: 'Case Summary', demographics: '', cc: '' },
          { type: 'content', title: 'Clinical Question', content: '' },
          { type: 'list', title: 'Key Points', items: [] },
          { type: 'content', title: 'Evidence', content: '' },
          { type: 'list', title: 'Take-home Messages', items: [] }
        ]
      }
    };

    // ============ GERIATRICS KNOWLEDGE ============
    const KNOWLEDGE = {
      beers: [
        { drug: 'Diphenhydramine', risk: 'Anticholinergic â†’ confusion, falls', alt: 'Melatonin 0.5-1mg' },
        { drug: 'Benzodiazepines', risk: 'Falls, cognitive impairment, dependence', alt: 'Trazodone 25mg, Mirtazapine 7.5mg' },
        { drug: 'Zolpidem', risk: 'Falls, confusion, complex behaviors', alt: 'Sleep hygiene, Melatonin' },
        { drug: 'TCAs (Amitriptyline)', risk: 'Anticholinergic, orthostasis, cardiac', alt: 'SSRI, SNRI' },
        { drug: 'Muscle relaxants', risk: 'Anticholinergic, sedation', alt: 'Physical therapy, topical' },
        { drug: 'PPIs >8 weeks', risk: 'C. diff, fractures, B12, hypoMg', alt: 'H2 blocker PRN, step down' },
        { drug: 'NSAIDs', risk: 'GI bleed, AKI, CV events', alt: 'Acetaminophen, topical NSAIDs' },
        { drug: 'Metoclopramide', risk: 'EPS, tardive dyskinesia', alt: 'Ondansetron' },
        { drug: 'First-gen antihistamines', risk: 'Anticholinergic', alt: 'Second-gen (loratadine)' },
        { drug: 'Sliding scale insulin alone', risk: 'Hypoglycemia, poor control', alt: 'Basal insulin regimen' }
      ],
      dosing: [
        { drug: 'Gabapentin', start: '100mg qhs', notes: 'CrCl<60: reduce 50%' },
        { drug: 'Pregabalin', start: '25-50mg', notes: 'CrCl<60: reduce dose' },
        { drug: 'Trazodone', start: '25mg qhs', notes: 'Max 100mg for sleep' },
        { drug: 'Mirtazapine', start: '7.5mg qhs', notes: 'Increases appetite' },
        { drug: 'Sertraline', start: '25mg', notes: 'SSRI of choice in elderly' },
        { drug: 'Quetiapine', start: '12.5-25mg', notes: 'Only for delirium/psychosis' },
        { drug: 'Haloperidol', start: '0.5mg', notes: 'Avoid in Parkinson/LBD' },
        { drug: 'Metoprolol', start: '12.5mg', notes: 'Watch HR, orthostasis' },
        { drug: 'Lisinopril', start: '2.5-5mg', notes: 'Monitor K, Cr' },
        { drug: 'Amlodipine', start: '2.5mg', notes: 'Peripheral edema' },
        { drug: 'Furosemide', start: '20mg', notes: 'Monitor electrolytes' },
        { drug: 'Metformin', start: '500mg', notes: 'Hold if CrCl<30, contrast' }
      ],
      assessments: [
        { name: 'MMSE', range: '/30', cutoff: 'â‰¤23 impaired', notes: 'Education affects score' },
        { name: 'MoCA', range: '/30', cutoff: 'â‰¤25 impaired', notes: '+1 if edu <12yr' },
        { name: 'GDS-15', range: '/15', cutoff: 'â‰¥5 depression', notes: 'Yes/No questions' },
        { name: 'PHQ-9', range: '/27', cutoff: 'â‰¥10 moderate', notes: 'Tracks severity' },
        { name: 'CAM', range: '4 criteria', cutoff: '1+2+(3or4)', notes: 'Delirium screen' },
        { name: '4AT', range: '/12', cutoff: 'â‰¥4 delirium', notes: 'Rapid screen' },
        { name: 'MNA-SF', range: '/14', cutoff: '<8 malnourished', notes: '8-11 at risk' },
        { name: 'MUST', range: '0-6+', cutoff: 'â‰¥2 high risk', notes: 'Malnutrition screen' },
        { name: 'TUG', range: 'seconds', cutoff: '>12s fall risk', notes: 'Timed up and go' },
        { name: 'Morse', range: '/125', cutoff: 'â‰¥25 fall risk', notes: 'Inpatient falls' },
        { name: 'Braden', range: '/23', cutoff: 'â‰¤18 pressure risk', notes: 'Lower = higher risk' },
        { name: 'CFS', range: '/9', cutoff: 'â‰¥5 frail', notes: '1-4 fit to vulnerable' },
        { name: 'FRAIL', range: '/5', cutoff: 'â‰¥3 frail', notes: '1-2 pre-frail' },
        { name: 'ADL', range: '/6', cutoff: 'Functional status', notes: 'Basic activities' },
        { name: 'IADL', range: '/8', cutoff: 'Functional status', notes: 'Complex activities' }
      ],
      labs: {
        cbc: [
          { test: 'WBC', normal: '4.5-11.0', unit: 'Ã—10â¹/L', note: 'Blunted in elderly infection' },
          { test: 'Hgb (M)', normal: '13.5-17.5', unit: 'g/dL', note: 'Anemia common, investigate' },
          { test: 'Hgb (F)', normal: '12.0-16.0', unit: 'g/dL', note: '' },
          { test: 'Platelets', normal: '150-400', unit: 'Ã—10â¹/L', note: '' },
          { test: 'MCV', normal: '80-100', unit: 'fL', note: 'High: B12, Low: Fe' }
        ],
        bmp: [
          { test: 'Na', normal: '136-145', unit: 'mEq/L', note: 'Hyponatremia common' },
          { test: 'K', normal: '3.5-5.0', unit: 'mEq/L', note: 'Watch with ACEi, K-sparing' },
          { test: 'Cr', normal: '0.7-1.3', unit: 'mg/dL', note: 'Underestimates CKD' },
          { test: 'BUN', normal: '7-20', unit: 'mg/dL', note: 'Elevated with dehydration' },
          { test: 'Glucose', normal: '70-100', unit: 'mg/dL', note: 'Relax targets if frail' }
        ],
        other: [
          { test: 'TSH', normal: '0.4-4.0', unit: 'mIU/L', note: 'Higher OK in elderly' },
          { test: 'B12', normal: '>200', unit: 'pg/mL', note: 'Deficiency common' },
          { test: 'Vit D', normal: '30-100', unit: 'ng/mL', note: 'Supplement if <30' },
          { test: 'HbA1c', normal: '<5.7%', unit: '', note: 'Target 7-8% if frail' },
          { test: 'Albumin', normal: '3.5-5.0', unit: 'g/dL', note: 'Nutrition, inflammation' }
        ]
      }
    };

    // ============ UTILITY FUNCTIONS ============
    function e(str) {
      if (!str) return '';
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function setState(updates) {
      Object.assign(state, updates);
      render();
    }

    function showToast(msg) {
      state.recentAction = msg;
      render();
      setTimeout(() => { state.recentAction = null; render(); }, 2000);
    }

    // ============ IMPORT FUNCTIONS ============
    function parseJSON(text) {
      try {
        const data = JSON.parse(text);
        // Handle array of presentations
        if (Array.isArray(data)) {
          return data.filter(p => p.slides && Array.isArray(p.slides));
        }
        // Handle single presentation
        if (data.slides && Array.isArray(data.slides)) {
          return [data];
        }
        // Handle just slides array
        if (Array.isArray(data) && data[0]?.type) {
          return [{ id: Date.now(), created: new Date().toISOString(), slides: data }];
        }
        return null;
      } catch(e) { return null; }
    }

    function parseMarkdown(text) {
      const lines = text.split('\n');
      const slides = [];
      let currentSlide = null;
      let contentBuffer = [];

      const flushContent = () => {
        if (currentSlide && contentBuffer.length) {
          const content = contentBuffer.join('\n').trim();
          if (currentSlide.type === 'list') {
            currentSlide.items = content.split('\n').map(l => l.replace(/^[-*â€¢]\s*/, '').trim()).filter(l => l);
          } else {
            currentSlide.content = content;
          }
          contentBuffer = [];
        }
      };

      lines.forEach(line => {
        // H1 = Title slide
        if (line.match(/^#\s+(.+)/)) {
          flushContent();
          if (currentSlide) slides.push(currentSlide);
          currentSlide = { type: 'title', title: line.replace(/^#\s+/, '').trim(), subtitle: '' };
        }
        // H2 = New slide
        else if (line.match(/^##\s+(.+)/)) {
          flushContent();
          if (currentSlide) slides.push(currentSlide);
          const title = line.replace(/^##\s+/, '').trim().toLowerCase();
          let type = 'content';
          if (title.includes('medication') || title.includes('pmh') || title.includes('differential') || title.includes('teaching') || title.includes('lab')) type = 'list';
          else if (title.includes('exam') || title.includes('physical')) type = 'exam';
          else if (title.includes('management') || title.includes('treatment')) type = 'treatment';
          else if (title.includes('assessment') || title.includes('score')) type = 'scores';
          else if (title.includes('patient')) type = 'patient';
          currentSlide = { type, title: line.replace(/^##\s+/, '').trim(), items: [], content: '', vitals: {}, scores: {} };
        }
        // List items
        else if (line.match(/^[-*â€¢]\s+/)) {
          contentBuffer.push(line);
          if (currentSlide && currentSlide.type !== 'list') currentSlide.type = 'list';
        }
        // Regular content
        else if (line.trim()) {
          contentBuffer.push(line);
        }
      });

      flushContent();
      if (currentSlide) slides.push(currentSlide);

      if (slides.length === 0) return null;
      return [{ id: Date.now(), created: new Date().toISOString(), modified: new Date().toISOString(), slides }];
    }

    function parsePlainText(text) {
      // Split by double newlines or common separators
      const sections = text.split(/\n{2,}|={3,}|-{3,}/).filter(s => s.trim());
      if (sections.length === 0) return null;

      const slides = [];
      
      // First section is title
      slides.push({
        type: 'title',
        title: sections[0].split('\n')[0].trim() || 'Imported Case',
        subtitle: sections[0].split('\n').slice(1).join(' ').trim()
      });

      // Process remaining sections
      sections.slice(1).forEach(section => {
        const lines = section.split('\n').filter(l => l.trim());
        if (lines.length === 0) return;

        const firstLine = lines[0].toLowerCase();
        let type = 'content';
        let title = lines[0];

        // Detect slide type from first line
        if (firstLine.includes('hpi') || firstLine.includes('history')) {
          type = 'content'; title = 'HPI';
        } else if (firstLine.includes('medication') || firstLine.includes('med')) {
          type = 'list'; title = 'Medications';
        } else if (firstLine.includes('pmh') || firstLine.includes('past medical')) {
          type = 'list'; title = 'PMH / PSH';
        } else if (firstLine.includes('exam') || firstLine.includes('physical')) {
          type = 'exam'; title = 'Physical Exam';
        } else if (firstLine.includes('lab')) {
          type = 'list'; title = 'Labs';
        } else if (firstLine.includes('differential') || firstLine.includes('ddx')) {
          type = 'list'; title = 'Differential Diagnosis';
        } else if (firstLine.includes('assessment') || firstLine.includes('geriatric')) {
          type = 'scores'; title = 'Geriatric Assessment';
        } else if (firstLine.includes('management') || firstLine.includes('plan') || firstLine.includes('treatment')) {
          type = 'treatment'; title = 'Management';
        } else if (firstLine.includes('teaching') || firstLine.includes('point')) {
          type = 'list'; title = 'Teaching Points';
        } else if (firstLine.includes('patient') || firstLine.match(/^\d+\s*(yo|y\/o|year)/i)) {
          type = 'patient'; title = 'Patient';
        }

        const content = lines.slice(1).join('\n').trim() || lines.join('\n').trim();
        const slide = { type, title };

        if (type === 'list') {
          slide.items = content.split('\n').map(l => l.replace(/^[-*â€¢\d.)\]]\s*/, '').trim()).filter(l => l);
        } else if (type === 'patient') {
          slide.demographics = content.split('\n')[0] || '';
          slide.cc = content.split('\n').slice(1).join(' ').trim() || '';
        } else if (type === 'treatment') {
          const pharm = content.match(/pharm[^:]*:([\s\S]*?)(?=non-?pharm|$)/i);
          const nonpharm = content.match(/non-?pharm[^:]*:([\s\S]*)/i);
          slide.pharm = pharm ? pharm[1].trim() : content;
          slide.nonpharm = nonpharm ? nonpharm[1].trim() : '';
        } else if (type === 'exam') {
          slide.vitals = {};
          slide.findings = content;
          // Try to extract vitals
          const bpMatch = content.match(/BP[:\s]*(\d+\/\d+)/i);
          const hrMatch = content.match(/HR[:\s]*(\d+)/i);
          const rrMatch = content.match(/RR[:\s]*(\d+)/i);
          const tempMatch = content.match(/Temp[:\s]*([\d.]+)/i);
          const spo2Match = content.match(/SpO2[:\s]*(\d+)/i);
          if (bpMatch) slide.vitals.BP = bpMatch[1];
          if (hrMatch) slide.vitals.HR = hrMatch[1];
          if (rrMatch) slide.vitals.RR = rrMatch[1];
          if (tempMatch) slide.vitals.Temp = tempMatch[1];
          if (spo2Match) slide.vitals.SpO2 = spo2Match[1];
        } else if (type === 'scores') {
          slide.scores = {};
          const scorePatterns = ['MMSE', 'MoCA', 'GDS', 'ADL', 'IADL', 'TUG', 'MNA', 'CFS', 'Morse', 'Braden', 'CAM'];
          scorePatterns.forEach(score => {
            const match = content.match(new RegExp(score + '[:\\s]*(\\d+[/\\d]*)', 'i'));
            if (match) slide.scores[score] = match[1];
          });
        } else {
          slide.content = content;
        }

        slides.push(slide);
      });

      return [{ id: Date.now(), created: new Date().toISOString(), modified: new Date().toISOString(), slides }];
    }

    function parseCSV(text) {
      const lines = text.split('\n').filter(l => l.trim());
      if (lines.length < 2) return null;

      const headers = lines[0].split(/[,\t]/).map(h => h.trim().toLowerCase());
      const rows = lines.slice(1).map(line => {
        const values = line.split(/[,\t]/).map(v => v.trim().replace(/^["']|["']$/g, ''));
        const row = {};
        headers.forEach((h, i) => row[h] = values[i] || '');
        return row;
      });

      // Detect CSV type and create appropriate slides
      const slides = [{ type: 'title', title: 'Imported Data', subtitle: `${rows.length} items` }];

      // Medication list
      if (headers.some(h => h.includes('medication') || h.includes('drug') || h.includes('med'))) {
        slides.push({
          type: 'list',
          title: 'Medications',
          items: rows.map(r => Object.values(r).filter(v => v).join(' - '))
        });
      }
      // Lab results
      else if (headers.some(h => h.includes('test') || h.includes('lab') || h.includes('result'))) {
        slides.push({
          type: 'list',
          title: 'Labs',
          items: rows.map(r => Object.values(r).filter(v => v).join(': '))
        });
      }
      // Generic list
      else {
        slides.push({
          type: 'list',
          title: 'Imported Items',
          items: rows.map(r => Object.values(r).filter(v => v).join(' | '))
        });
      }

      return [{ id: Date.now(), created: new Date().toISOString(), modified: new Date().toISOString(), slides }];
    }

    function detectAndParse(text) {
      text = text.trim();
      if (!text) return null;

      // Try JSON first
      if (text.startsWith('{') || text.startsWith('[')) {
        const result = parseJSON(text);
        if (result) return { format: 'JSON', presentations: result };
      }

      // Try Markdown
      if (text.includes('# ') || text.includes('## ')) {
        const result = parseMarkdown(text);
        if (result) return { format: 'Markdown', presentations: result };
      }

      // Try CSV
      if (text.includes(',') && text.split('\n')[0].split(',').length > 2) {
        const result = parseCSV(text);
        if (result) return { format: 'CSV', presentations: result };
      }

      // Fall back to plain text
      const result = parsePlainText(text);
      if (result) return { format: 'Plain Text', presentations: result };

      return null;
    }

    function importPresentation(text) {
      const result = detectAndParse(text);
      if (!result || !result.presentations.length) {
        showToast('âŒ Could not parse import data');
        return;
      }

      result.presentations.forEach(p => {
        p.id = Date.now() + Math.random();
        p.created = p.created || new Date().toISOString();
        p.modified = new Date().toISOString();
        state.saved.push(p);
      });

      save();
      showToast(`âœ… Imported ${result.presentations.length} presentation(s) from ${result.format}`);
      setState({ showImport: false, importText: '' });
    }

    function handleFileImport(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        state.importText = e.target.result;
        render();
      };
      reader.readAsText(file);
    }

    // ============ PRESENTATION FUNCTIONS ============
    function createPresentation(templateKey) {
      const template = templates[templateKey];
      if (!template) return;
      
      const newPres = {
        id: Date.now(),
        created: new Date().toISOString(),
        modified: new Date().toISOString(),
        template: templateKey,
        slides: JSON.parse(JSON.stringify(template.slides))
      };
      
      state.saved.push(newPres);
      state.pres = newPres;
      state.slide = 0;
      state.view = 'editor';
      state.showTemplates = false;
      save();
      render();
    }

    function openPresentation(p) {
      state.pres = p;
      state.slide = 0;
      state.view = 'editor';
      render();
    }

    function deletePresentation(id) {
      if (!confirm('Delete this presentation?')) return;
      state.saved = state.saved.filter(p => p.id !== id);
      if (state.pres?.id === id) {
        state.pres = null;
        state.view = 'home';
      }
      save();
      render();
    }

    function savePres() {
      if (!state.pres) return;
      state.pres.modified = new Date().toISOString();
      state.saved = state.saved.map(p => p.id === state.pres.id ? state.pres : p);
      save();
    }

    function updateSlide(field, value) {
      if (!state.pres) return;
      state.pres.slides[state.slide][field] = value;
      savePres();
      render();
    }

    function addSlide(type) {
      if (!state.pres) return;
      const newSlide = { type, title: 'New Slide', content: '', items: [] };
      state.pres.slides.splice(state.slide + 1, 0, newSlide);
      state.slide++;
      savePres();
      render();
    }

    function deleteSlide() {
      if (!state.pres || state.pres.slides.length <= 1) return;
      if (!confirm('Delete this slide?')) return;
      state.pres.slides.splice(state.slide, 1);
      if (state.slide >= state.pres.slides.length) state.slide = state.pres.slides.length - 1;
      savePres();
      render();
    }

    // ============ AI FUNCTIONS ============
    function buildContext() {
      if (!state.pres) return 'No presentation.';
      let ctx = `PRESENTATION: ${state.pres.slides[0]?.title}\nSlides: ${state.pres.slides.length}\nCurrent slide: ${state.slide + 1}\n\n`;
      
      state.pres.slides.forEach((s, i) => {
        ctx += `[${i + 1}] ${s.type.toUpperCase()}: ${s.title}\n`;
        if (s.demographics) ctx += `  Demographics: ${s.demographics}\n`;
        if (s.cc) ctx += `  CC: ${s.cc}\n`;
        if (s.content) ctx += `  Content: ${s.content.substring(0, 200)}${s.content.length > 200 ? '...' : ''}\n`;
        if (s.items?.length) ctx += `  Items: ${s.items.slice(0, 6).join('; ')}${s.items.length > 6 ? '...' : ''}\n`;
        if (s.vitals && Object.values(s.vitals).some(v => v)) {
          ctx += `  Vitals: ${Object.entries(s.vitals).filter(([k,v]) => v).map(([k,v]) => `${k}:${v}`).join(', ')}\n`;
        }
        if (s.findings) ctx += `  Exam: ${s.findings.substring(0, 150)}...\n`;
        if (s.pharm) ctx += `  Pharm: ${s.pharm.substring(0, 150)}...\n`;
        if (s.scores && Object.keys(s.scores).some(k => s.scores[k])) {
          ctx += `  Scores: ${Object.entries(s.scores).filter(([k,v]) => v).map(([k,v]) => `${k}:${v}`).join(', ')}\n`;
        }
      });
      
      return ctx;
    }

    async function sendAI() {
      if (!state.aiInput.trim() || state.aiLoading) return;
      if (!state.apiKey) {
        state.aiChat.push({ role: 'assistant', content: 'âš ï¸ Please add your Anthropic API key in Settings first.' });
        render();
        return;
      }

      const userMsg = state.aiInput.trim();
      state.aiInput = '';
      state.aiChat.push({ role: 'user', content: userMsg });
      state.aiLoading = true;
      render();

      const systemPrompt = `You are an expert geriatric medicine assistant at Shaare Zedek Medical Center, Jerusalem.

## CAPABILITIES:
1. Clinical decision support - DDx, workup, management
2. Drug information - Beers criteria, renal dosing, interactions
3. Assessment interpretation - MMSE, MoCA, CAM, GDS, MNA, CFS
4. Slide modification - You can update presentation slides

## SLIDE COMMANDS:
To modify slides, include this JSON block:
\`\`\`slidemod
{"action":"update","slide":"ddx","field":"items","value":["Item 1","Item 2"]}
\`\`\`

Slide shortcuts: ddx, meds, teaching, plan, exam, labs, hpi, current, assessment
Actions: update (replace), append (add to)
Fields: title, content, items, vitals, pharm, nonpharm, findings, scores

## BEERS CRITERIA - AVOID:
${KNOWLEDGE.beers.slice(0, 6).map(d => `â€¢ ${d.drug}: ${d.risk}`).join('\n')}

## GERIATRIC DOSING:
${KNOWLEDGE.dosing.slice(0, 8).map(d => `â€¢ ${d.drug}: ${d.start}`).join('\n')}

## ASSESSMENT CUTOFFS:
${KNOWLEDGE.assessments.slice(0, 8).map(a => `â€¢ ${a.name}: ${a.cutoff}`).join('\n')}

## CONTEXT:
${buildContext()}

Be concise and actionable. Include slidemod commands when asked to modify slides.`;

      try {
        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': state.apiKey,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
          },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 2000,
            messages: [{ role: 'user', content: systemPrompt + '\n\nUser: ' + userMsg }]
          })
        });

        if (!response.ok) {
          const err = await response.json().catch(() => ({}));
          throw new Error(err.error?.message || `API error ${response.status}`);
        }

        const data = await response.json();
        let aiResponse = data.content[0]?.text || 'No response';

        // Parse and apply slide commands
        const cmdMatch = aiResponse.match(/```slidemod\s*([\s\S]*?)```/);
        if (cmdMatch && state.pres) {
          try {
            const cmd = JSON.parse(cmdMatch[1].trim());
            let targetSlide = state.slide;
            
            const shortcuts = {
              ddx: 'differential', meds: 'medication', teaching: 'teaching',
              plan: 'management', exam: 'exam', labs: 'lab', hpi: 'hpi',
              assessment: 'assessment', current: null
            };
            
            if (cmd.slide === 'current') {
              targetSlide = state.slide;
            } else if (shortcuts[cmd.slide] !== undefined) {
              if (shortcuts[cmd.slide]) {
                const idx = state.pres.slides.findIndex(s => 
                  s.title?.toLowerCase().includes(shortcuts[cmd.slide])
                );
                if (idx >= 0) targetSlide = idx;
              }
            } else if (typeof cmd.slide === 'number') {
              targetSlide = cmd.slide - 1;
            }

            if (targetSlide >= 0 && targetSlide < state.pres.slides.length) {
              const slide = state.pres.slides[targetSlide];
              
              if (cmd.action === 'update') {
                if (cmd.field === 'items' && Array.isArray(cmd.value)) {
                  slide.items = cmd.value;
                } else if (cmd.field === 'vitals' && typeof cmd.value === 'object') {
                  slide.vitals = { ...slide.vitals, ...cmd.value };
                } else if (cmd.field === 'scores' && typeof cmd.value === 'object') {
                  slide.scores = { ...slide.scores, ...cmd.value };
                } else {
                  slide[cmd.field] = cmd.value;
                }
              } else if (cmd.action === 'append') {
                if (cmd.field === 'items') {
                  slide.items = [...(slide.items || []), ...(Array.isArray(cmd.value) ? cmd.value : [cmd.value])];
                } else if (typeof slide[cmd.field] === 'string') {
                  slide[cmd.field] += '\n' + cmd.value;
                }
              }
              
              savePres();
              aiResponse = aiResponse.replace(/```slidemod[\s\S]*?```/g, '').trim();
              aiResponse += `\n\nâœ… Slide ${targetSlide + 1} (${state.pres.slides[targetSlide].title}) updated!`;
            }
          } catch(e) {
            console.error('Slidemod error:', e);
          }
        }

        state.aiChat.push({ role: 'assistant', content: aiResponse });
      } catch(e) {
        state.aiChat.push({ role: 'assistant', content: `âš ï¸ Error: ${e.message}` });
      }

      state.aiLoading = false;
      render();
      setTimeout(() => {
        const box = document.getElementById('aiChatBox');
        if (box) box.scrollTop = box.scrollHeight;
      }, 100);
    }

    function aiCommand(cmd) {
      const commands = {
        ddx: 'Generate a comprehensive differential diagnosis for this patient considering geriatric-specific etiologies. Update the DDx slide.',
        teaching: 'Identify 4-5 key teaching points from this case focusing on geriatric principles. Update the teaching slide.',
        meds: 'Review all medications for Beers criteria violations, drug interactions, renal dosing needs, and anticholinergic burden.',
        plan: 'Generate a comprehensive management plan with pharmacological and non-pharmacological interventions. Update the management slide.',
        workup: 'What additional workup should be ordered? Consider labs, imaging, and consultations appropriate for this elderly patient.',
        gaps: 'What information is missing from this presentation? Identify gaps that should be filled.',
        assess: 'What geriatric assessments should be performed? Suggest appropriate screening tools.',
        improve: 'Review the entire presentation and suggest improvements. Make any updates you think are needed.'
      };
      
      state.aiInput = commands[cmd] || '';
      render();
      setTimeout(() => sendAI(), 50);
    }

    // ============ CALCULATORS ============
    function calculate() {
      const ci = state.calcIn;
      let r = null;

      switch(state.calcType) {
        case 'crcl':
          if (ci.age && ci.wt && ci.cr) {
            let v = ((140 - +ci.age) * +ci.wt) / (72 * +ci.cr);
            if (ci.female) v *= 0.85;
            const stage = v < 15 ? 'Stage 5 (ESRD)' : v < 30 ? 'Stage 4' : v < 60 ? 'Stage 3' : v < 90 ? 'Stage 2' : 'Normal';
            r = { v: v.toFixed(1), u: 'mL/min', i: stage };
          }
          break;

        case 'ckdepi':
          if (ci.age && ci.cr) {
            const age = +ci.age, cr = +ci.cr;
            let gfr;
            if (ci.female) {
              gfr = 142 * Math.pow(Math.min(cr/0.7, 1), -0.241) * Math.pow(Math.max(cr/0.7, 1), -1.2) * Math.pow(0.9938, age) * 1.012;
            } else {
              gfr = 142 * Math.pow(Math.min(cr/0.9, 1), -0.302) * Math.pow(Math.max(cr/0.9, 1), -1.2) * Math.pow(0.9938, age);
            }
            const stage = gfr < 15 ? 'Stage 5' : gfr < 30 ? 'Stage 4' : gfr < 45 ? 'Stage 3b' : gfr < 60 ? 'Stage 3a' : gfr < 90 ? 'Stage 2' : 'Normal';
            r = { v: gfr.toFixed(1), u: 'mL/min/1.73mÂ²', i: stage };
          }
          break;

        case 'cam':
          const cam = ci.acute && ci.inattention && (ci.disorganized || ci.altered);
          r = { v: cam ? 'POSITIVE' : 'Negative', u: '', i: cam ? 'âš ï¸ Delirium likely' : 'âœ“ Low probability' };
          break;

        case 'morse':
          const morse = (ci.fallHx ? 25 : 0) + (ci.secDx ? 15 : 0) + 
            (ci.ambAid === 'furniture' ? 30 : ci.ambAid === 'device' ? 15 : 0) + 
            (ci.iv ? 20 : 0) + 
            (ci.gait === 'impaired' ? 20 : ci.gait === 'weak' ? 10 : 0) + 
            (ci.mental === 'forgets' ? 15 : 0);
          r = { v: morse, u: 'pts', i: morse < 25 ? 'Low risk' : morse < 45 ? 'Moderate risk' : 'High risk' };
          break;

        case 'mna':
          const mna = (+ci.food || 0) + (+ci.weight || 0) + (+ci.mobility || 0) + (+ci.stress || 0) + (+ci.neuro || 0) + (+ci.bmi || 0);
          r = { v: mna, u: '/14', i: mna >= 12 ? 'Normal' : mna >= 8 ? 'At risk' : 'Malnourished' };
          break;

        case 'gds':
          let gds = 0;
          if (ci.q1 === false) gds++; // satisfied
          if (ci.q2) gds++; // dropped activities
          if (ci.q3) gds++; // empty
          if (ci.q4) gds++; // bored
          if (ci.q5 === false) gds++; // good spirits
          if (ci.q6) gds++; // afraid
          if (ci.q7 === false) gds++; // happy
          if (ci.q8) gds++; // helpless
          if (ci.q9) gds++; // stay home
          if (ci.q10) gds++; // memory
          if (ci.q11 === false) gds++; // wonderful
          if (ci.q12) gds++; // worthless
          if (ci.q13 === false) gds++; // energy
          if (ci.q14) gds++; // hopeless
          if (ci.q15) gds++; // better off
          r = { v: gds, u: '/15', i: gds <= 4 ? 'Normal' : gds <= 9 ? 'Mild depression' : 'Moderate-severe depression' };
          break;

        case 'frail':
          const frail = (ci.fatigue ? 1 : 0) + (ci.resistance ? 1 : 0) + (ci.ambulation ? 1 : 0) + (ci.illness ? 1 : 0) + (ci.weight5 ? 1 : 0);
          r = { v: frail, u: '/5', i: frail === 0 ? 'Robust' : frail <= 2 ? 'Pre-frail' : 'Frail' };
          break;

        case 'chads':
          const chads = (ci.chf ? 1 : 0) + (ci.htn ? 1 : 0) + (ci.age75 ? 2 : ci.age65 ? 1 : 0) + (ci.dm ? 1 : 0) + (ci.stroke ? 2 : 0) + (ci.vasc ? 1 : 0) + (ci.female ? 1 : 0);
          const risk = chads === 0 ? '0%' : chads === 1 ? '1.3%' : chads === 2 ? '2.2%' : chads === 3 ? '3.2%' : chads >= 4 ? '>4%' : '';
          r = { v: chads, u: '/9', i: `Annual stroke risk: ${risk}` };
          break;
      }

      setState({ calcRes: r });
    }

    // ============ RENDER FUNCTIONS ============
    function render() {
      const app = document.getElementById('app');
      
      switch(state.view) {
        case 'home': app.innerHTML = renderHome(); break;
        case 'editor': app.innerHTML = renderEditor(); break;
        default: app.innerHTML = renderHome();
      }
    }

    function renderHome() {
      const savedList = state.saved.length > 0 ? state.saved.map(p => `
        <div class="bg-white rounded-xl p-4 shadow-sm flex justify-between items-center mb-3">
          <div onclick="openPresentation(state.saved.find(x=>x.id===${p.id}))" class="flex-1 cursor-pointer">
            <div class="font-bold">${e(p.slides[0]?.title || 'Untitled')}</div>
            <div class="text-sm text-slate-500">${p.slides.length} slides â€¢ ${new Date(p.modified || p.created).toLocaleDateString()}</div>
          </div>
          <button onclick="deletePresentation(${p.id})" class="text-red-400 p-2">ğŸ—‘ï¸</button>
        </div>
      `).join('') : '<p class="text-center text-blue-200 py-4">No presentations yet</p>';

      return `
        <div class="min-h-screen gradient-szmc text-white">
          <!-- Header -->
          <div class="p-6 text-center">
            <div class="text-5xl mb-2">ğŸ©º</div>
            <h1 class="text-2xl font-bold">SZMC Geriatrics Pro</h1>
            <p class="text-blue-200">v${VERSION} â€¢ Case Presentations</p>
          </div>

          <!-- Quick Tools -->
          <div class="px-4 mb-6">
            <div class="flex gap-2">
              <button onclick="setState({showCalc:true})" class="flex-1 bg-white/20 rounded-xl p-3 text-center hover:bg-white/30 transition">
                <div class="text-2xl">ğŸ§®</div>
                <div class="text-xs mt-1">Calculators</div>
              </button>
              <button onclick="setState({showDrugs:true})" class="flex-1 bg-white/20 rounded-xl p-3 text-center hover:bg-white/30 transition">
                <div class="text-2xl">ğŸ’Š</div>
                <div class="text-xs mt-1">Drugs</div>
              </button>
              <button onclick="setState({showLabs:true})" class="flex-1 bg-white/20 rounded-xl p-3 text-center hover:bg-white/30 transition">
                <div class="text-2xl">ğŸ§ª</div>
                <div class="text-xs mt-1">Labs</div>
              </button>
              <button onclick="setState({showSettings:true})" class="flex-1 bg-white/20 rounded-xl p-3 text-center hover:bg-white/30 transition">
                <div class="text-2xl">âš™ï¸</div>
                <div class="text-xs mt-1">Settings</div>
              </button>
            </div>
          </div>

          <!-- New Presentation -->
          <div class="px-4 mb-4">
            <button onclick="setState({showTemplates:true})" class="w-full bg-white text-blue-600 rounded-xl p-4 font-bold shadow-lg hover:shadow-xl transition">
              + New Presentation
            </button>
          </div>

          <!-- Import Button -->
          <div class="px-4 mb-6">
            <button onclick="setState({showImport:true})" class="w-full bg-white/20 text-white rounded-xl p-3 font-medium hover:bg-white/30 transition flex items-center justify-center gap-2">
              ğŸ“¥ Import Presentation
            </button>
          </div>

          <!-- Saved Presentations -->
          <div class="px-4 pb-8">
            <h2 class="font-bold mb-3 flex items-center gap-2">
              <span>ğŸ“</span> Saved Presentations
              <span class="bg-white/20 px-2 py-0.5 rounded-full text-sm">${state.saved.length}</span>
            </h2>
            ${savedList}
          </div>
          
          <!-- Footer -->
          <div class="text-center text-blue-200 text-xs pb-6">
            Shaare Zedek Medical Center â€¢ Geriatrics Fellowship
          </div>

          ${state.showTemplates ? renderTemplatesModal() : ''}
          ${state.showImport ? renderImportModal() : ''}
          ${state.showCalc ? renderCalcModal() : ''}
          ${state.showDrugs ? renderDrugsModal() : ''}
          ${state.showLabs ? renderLabsModal() : ''}
          ${state.showSettings ? renderSettingsModal() : ''}
        </div>
        ${state.recentAction ? `<div class="fixed bottom-4 left-4 right-4 bg-green-500 text-white p-3 rounded-xl text-center animate-fadeIn">${e(state.recentAction)}</div>` : ''}
      `;
    }

    function renderTemplatesModal() {
      return `
        <div class="fixed inset-0 bg-black/50 flex items-end z-50 animate-fadeIn" onclick="if(event.target===this)setState({showTemplates:false})">
          <div class="bg-white w-full rounded-t-2xl p-4 modal-content">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-bold text-lg text-slate-800">Choose Template</h3>
              <button onclick="setState({showTemplates:false})" class="text-2xl text-slate-400">Ã—</button>
            </div>
            <div class="space-y-3">
              ${Object.entries(templates).map(([key, t]) => `
                <button onclick="createPresentation('${key}')" class="w-full bg-slate-50 hover:bg-slate-100 rounded-xl p-4 text-left transition">
                  <div class="font-bold text-slate-800">${t.name}</div>
                  <div class="text-sm text-slate-500">${t.desc}</div>
                </button>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    }

    function renderImportModal() {
      return `
        <div class="fixed inset-0 bg-black/50 flex items-end z-50 animate-fadeIn" onclick="if(event.target===this)setState({showImport:false,importText:''})">
          <div class="bg-white w-full rounded-t-2xl p-4 modal-content max-h-[85vh] overflow-auto">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-bold text-lg text-slate-800">ğŸ“¥ Import Presentation</h3>
              <button onclick="setState({showImport:false,importText:''})" class="text-2xl text-slate-400">Ã—</button>
            </div>
            
            <!-- Supported Formats -->
            <div class="bg-blue-50 rounded-lg p-3 mb-4 text-sm">
              <div class="font-medium text-blue-800 mb-1">Supported formats:</div>
              <div class="text-blue-600 text-xs space-y-1">
                <div>ğŸ“„ <b>JSON</b> - Export from this app or structured data</div>
                <div>ğŸ“ <b>Markdown</b> - # Title, ## Slide headers</div>
                <div>ğŸ“‹ <b>Plain text</b> - Sections separated by blank lines</div>
                <div>ğŸ“Š <b>CSV</b> - Medication lists, lab values</div>
              </div>
            </div>

            <!-- File Upload -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-slate-700 mb-2">Upload File</label>
              <input type="file" accept=".json,.md,.txt,.csv,.markdown" 
                onchange="if(this.files[0])handleFileImport(this.files[0])"
                class="w-full border rounded-lg p-2 text-sm file:mr-3 file:py-1 file:px-3 file:rounded-full file:border-0 file:text-sm file:bg-blue-100 file:text-blue-700">
            </div>

            <!-- Paste Area -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-slate-700 mb-2">Or paste content</label>
              <textarea 
                placeholder="Paste JSON, Markdown, plain text, or CSV here...

Example Markdown:
# Case: Delirium in Elderly

## Patient
85yo female with confusion

## HPI
Brought by family for 2 days of altered mental status...

## Medications
- Metoprolol 25mg daily
- Lisinopril 10mg daily

## Differential Diagnosis
- Delirium (UTI, medication)
- Dementia exacerbation
- Stroke"
                oninput="state.importText=this.value"
                class="w-full border rounded-lg p-3 min-h-48 text-sm font-mono">${e(state.importText || '')}</textarea>
            </div>

            <!-- Quick Import Examples -->
            <div class="mb-4">
              <div class="text-sm font-medium text-slate-700 mb-2">Quick examples:</div>
              <div class="flex gap-2 flex-wrap">
                <button onclick="state.importText=\`# Delirium Case\\n\\n## Patient\\n78yo male, nursing home resident\\n\\n## Chief Complaint\\nAcute confusion x 2 days\\n\\n## HPI\\nFound by staff to be more confused than baseline. Not eating well. Low-grade fever.\\n\\n## PMH\\n- Dementia (baseline MMSE 18)\\n- HTN\\n- DM2\\n- BPH\\n\\n## Medications\\n- Metformin 500mg BID\\n- Lisinopril 10mg daily\\n- Tamsulosin 0.4mg qhs\\n- Donepezil 10mg qhs\\n\\n## Physical Exam\\nBP 138/78, HR 92, Temp 38.1, RR 18, SpO2 96%\\nConfused, inattentive. Suprapubic tenderness.\\n\\n## Labs\\n- WBC 14.2\\n- UA: positive nitrites, bacteria\\n- Cr 1.4 (baseline 1.0)\\n\\n## Assessment\\nMMSE: 12/30\\nCAM: Positive\\n\\n## Differential\\n- Delirium secondary to UTI\\n- Urosepsis\\n- Medication effect\\n\\n## Management\\nPharmacological:\\n- Ceftriaxone 1g IV daily\\n- Hold tamsulosin\\n- Low-dose haloperidol 0.5mg PRN\\n\\nNon-pharmacological:\\n- Reorientation\\n- Family at bedside\\n- Minimize tethers\\n- Sleep hygiene\`;render()" 
                  class="px-3 py-1 bg-slate-100 rounded-full text-xs hover:bg-slate-200">Delirium case</button>
                <button onclick="state.importText=\`Medication,Dose,Frequency,Notes\\nMetoprolol,25mg,daily,Hold if HR<60\\nLisinopril,10mg,daily,Monitor K\\nMetformin,500mg,BID,Hold if NPO\\nAspirin,81mg,daily,\\nAtorvastatin,40mg,qhs,\`;render()"
                  class="px-3 py-1 bg-slate-100 rounded-full text-xs hover:bg-slate-200">Med list CSV</button>
                <button onclick="state.importText=JSON.stringify({slides:[{type:'title',title:'Quick Case'},{type:'patient',title:'Patient',demographics:'80yo F',cc:'Falls'},{type:'list',title:'PMH',items:['HTN','DM2','Osteoporosis']},{type:'list',title:'Meds',items:['Metoprolol','Lisinopril','Metformin']}]},null,2);render()"
                  class="px-3 py-1 bg-slate-100 rounded-full text-xs hover:bg-slate-200">JSON example</button>
              </div>
            </div>

            <!-- Import Button -->
            <button onclick="importPresentation(state.importText)" 
              ${!state.importText ? 'disabled' : ''}
              class="w-full bg-blue-500 text-white rounded-lg py-3 font-medium disabled:opacity-50 disabled:cursor-not-allowed">
              Import Presentation
            </button>

            <!-- Export Current -->
            ${state.saved.length > 0 ? `
              <div class="mt-4 pt-4 border-t">
                <div class="text-sm font-medium text-slate-700 mb-2">Export existing:</div>
                <div class="flex gap-2 flex-wrap">
                  ${state.saved.slice(0, 3).map(p => `
                    <button onclick="navigator.clipboard.writeText(JSON.stringify(p,null,2));showToast('Copied to clipboard!')" 
                      class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs hover:bg-green-200">
                      ğŸ“¤ ${e((p.slides[0]?.title || 'Untitled').substring(0, 15))}
                    </button>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    function renderSettingsModal() {
      return `
        <div class="fixed inset-0 bg-black/50 flex items-end z-50 animate-fadeIn" onclick="if(event.target===this)setState({showSettings:false})">
          <div class="bg-white w-full rounded-t-2xl p-4 modal-content max-h-[80vh] overflow-auto">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-bold text-lg text-slate-800">âš™ï¸ Settings</h3>
              <button onclick="setState({showSettings:false})" class="text-2xl text-slate-400">Ã—</button>
            </div>
            
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Anthropic API Key (for AI features)</label>
                <input type="password" value="${e(state.apiKey)}" 
                  oninput="state.apiKey=this.value;save()" 
                  placeholder="sk-ant-..." 
                  class="w-full border rounded-lg p-3 text-slate-800">
                <p class="text-xs text-slate-500 mt-1">Get your key from console.anthropic.com</p>
              </div>
              
              <div class="border-t pt-4">
                <h4 class="font-medium text-slate-700 mb-2">Data Management</h4>
                <button onclick="if(confirm('Export all data?')){const d=JSON.stringify(state.saved);navigator.clipboard.writeText(d);showToast('Copied to clipboard!')}" 
                  class="w-full bg-blue-50 text-blue-700 rounded-lg p-3 mb-2">
                  ğŸ“¤ Export All Presentations
                </button>
                <button onclick="if(confirm('This will delete ALL data. Continue?')){state.saved=[];state.pres=null;save();setState({view:'home',showSettings:false})}" 
                  class="w-full bg-red-50 text-red-700 rounded-lg p-3">
                  ğŸ—‘ï¸ Clear All Data
                </button>
              </div>
              
              <div class="border-t pt-4 text-center text-slate-500 text-sm">
                <p>SZMC Geriatrics Pro v${VERSION}</p>
                <p>Built for Shaare Zedek Medical Center</p>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderCalcModal() {
      const calcTypes = [
        ['crcl', 'ğŸ’§ CrCl'],
        ['ckdepi', 'ğŸ§ª eGFR'],
        ['cam', 'ğŸ§  CAM'],
        ['morse', 'ğŸš¶ Morse'],
        ['mna', 'ğŸ½ï¸ MNA'],
        ['gds', 'ğŸ˜” GDS-15'],
        ['frail', 'ğŸ‘´ FRAIL'],
        ['chads', 'â¤ï¸ CHAâ‚‚DSâ‚‚']
      ];

      let fields = '';
      const ci = state.calcIn;

      switch(state.calcType) {
        case 'crcl':
          fields = `
            <h4 class="font-medium mb-2">Creatinine Clearance (Cockcroft-Gault)</h4>
            <input type="number" placeholder="Age" value="${ci.age||''}" oninput="state.calcIn.age=this.value" class="w-full border rounded-lg p-3 mb-2">
            <input type="number" placeholder="Weight (kg)" value="${ci.wt||''}" oninput="state.calcIn.wt=this.value" class="w-full border rounded-lg p-3 mb-2">
            <input type="number" step="0.1" placeholder="Creatinine (mg/dL)" value="${ci.cr||''}" oninput="state.calcIn.cr=this.value" class="w-full border rounded-lg p-3 mb-2">
            <label class="flex items-center gap-2"><input type="checkbox" ${ci.female?'checked':''} onchange="state.calcIn.female=this.checked"> Female</label>`;
          break;
        case 'ckdepi':
          fields = `
            <h4 class="font-medium mb-2">eGFR (CKD-EPI 2021)</h4>
            <input type="number" placeholder="Age" value="${ci.age||''}" oninput="state.calcIn.age=this.value" class="w-full border rounded-lg p-3 mb-2">
            <input type="number" step="0.1" placeholder="Creatinine (mg/dL)" value="${ci.cr||''}" oninput="state.calcIn.cr=this.value" class="w-full border rounded-lg p-3 mb-2">
            <label class="flex items-center gap-2"><input type="checkbox" ${ci.female?'checked':''} onchange="state.calcIn.female=this.checked"> Female</label>`;
          break;
        case 'cam':
          fields = `
            <h4 class="font-medium mb-2">CAM (Confusion Assessment Method)</h4>
            <p class="text-xs text-slate-500 mb-2">Positive = 1 + 2 + (3 or 4)</p>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.acute?'checked':''} onchange="state.calcIn.acute=this.checked"> 1. Acute onset + fluctuating</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.inattention?'checked':''} onchange="state.calcIn.inattention=this.checked"> 2. Inattention</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.disorganized?'checked':''} onchange="state.calcIn.disorganized=this.checked"> 3. Disorganized thinking</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded"><input type="checkbox" ${ci.altered?'checked':''} onchange="state.calcIn.altered=this.checked"> 4. Altered consciousness</label>`;
          break;
        case 'morse':
          fields = `
            <h4 class="font-medium mb-2">Morse Fall Scale</h4>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.fallHx?'checked':''} onchange="state.calcIn.fallHx=this.checked"> Fall history (25pts)</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.secDx?'checked':''} onchange="state.calcIn.secDx=this.checked"> Secondary diagnosis (15pts)</label>
            <select onchange="state.calcIn.ambAid=this.value" class="w-full border rounded-lg p-3 mb-2">
              <option value="">Ambulatory aid (0pts)</option>
              <option value="device" ${ci.ambAid==='device'?'selected':''}>Cane/Walker (15pts)</option>
              <option value="furniture" ${ci.ambAid==='furniture'?'selected':''}>Furniture (30pts)</option>
            </select>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.iv?'checked':''} onchange="state.calcIn.iv=this.checked"> IV/Heparin lock (20pts)</label>
            <select onchange="state.calcIn.gait=this.value" class="w-full border rounded-lg p-3 mb-2">
              <option value="">Normal gait (0pts)</option>
              <option value="weak" ${ci.gait==='weak'?'selected':''}>Weak (10pts)</option>
              <option value="impaired" ${ci.gait==='impaired'?'selected':''}>Impaired (20pts)</option>
            </select>`;
          break;
        case 'frail':
          fields = `
            <h4 class="font-medium mb-2">FRAIL Scale</h4>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.fatigue?'checked':''} onchange="state.calcIn.fatigue=this.checked"> <b>F</b>atigue</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.resistance?'checked':''} onchange="state.calcIn.resistance=this.checked"> <b>R</b>esistance (can't climb stairs)</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.ambulation?'checked':''} onchange="state.calcIn.ambulation=this.checked"> <b>A</b>mbulation (can't walk 1 block)</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.illness?'checked':''} onchange="state.calcIn.illness=this.checked"> <b>I</b>llness (>5 comorbidities)</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded"><input type="checkbox" ${ci.weight5?'checked':''} onchange="state.calcIn.weight5=this.checked"> <b>L</b>oss of weight (>5%)</label>`;
          break;
        case 'chads':
          fields = `
            <h4 class="font-medium mb-2">CHAâ‚‚DSâ‚‚-VASc</h4>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.chf?'checked':''} onchange="state.calcIn.chf=this.checked"> CHF (1pt)</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.htn?'checked':''} onchange="state.calcIn.htn=this.checked"> Hypertension (1pt)</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.age75?'checked':''} onchange="state.calcIn.age75=this.checked;if(this.checked)state.calcIn.age65=false"> Age â‰¥75 (2pts)</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.age65?'checked':''} onchange="state.calcIn.age65=this.checked;if(this.checked)state.calcIn.age75=false"> Age 65-74 (1pt)</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.dm?'checked':''} onchange="state.calcIn.dm=this.checked"> Diabetes (1pt)</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.stroke?'checked':''} onchange="state.calcIn.stroke=this.checked"> Stroke/TIA (2pts)</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded mb-1"><input type="checkbox" ${ci.vasc?'checked':''} onchange="state.calcIn.vasc=this.checked"> Vascular disease (1pt)</label>
            <label class="flex items-center gap-2 p-2 bg-slate-50 rounded"><input type="checkbox" ${ci.female?'checked':''} onchange="state.calcIn.female=this.checked"> Female (1pt)</label>`;
          break;
        case 'mna':
          fields = `
            <h4 class="font-medium mb-2">MNA-SF (Nutrition)</h4>
            <select onchange="state.calcIn.food=this.value" class="w-full border rounded-lg p-3 mb-2">
              <option value="">Food intake...</option>
              <option value="0">Severe decrease (0)</option>
              <option value="1">Moderate decrease (1)</option>
              <option value="2">No decrease (2)</option>
            </select>
            <select onchange="state.calcIn.weight=this.value" class="w-full border rounded-lg p-3 mb-2">
              <option value="">Weight loss...</option>
              <option value="0">>3kg (0)</option>
              <option value="1">Don't know (1)</option>
              <option value="2">1-3kg (2)</option>
              <option value="3">No loss (3)</option>
            </select>
            <select onchange="state.calcIn.mobility=this.value" class="w-full border rounded-lg p-3 mb-2">
              <option value="">Mobility...</option>
              <option value="0">Bed/chair bound (0)</option>
              <option value="1">Gets out but doesn't go out (1)</option>
              <option value="2">Goes out (2)</option>
            </select>
            <select onchange="state.calcIn.stress=this.value" class="w-full border rounded-lg p-3 mb-2">
              <option value="">Stress/illness...</option>
              <option value="0">Yes (0)</option>
              <option value="2">No (2)</option>
            </select>
            <select onchange="state.calcIn.neuro=this.value" class="w-full border rounded-lg p-3 mb-2">
              <option value="">Neuropsych...</option>
              <option value="0">Severe dementia/depression (0)</option>
              <option value="1">Mild (1)</option>
              <option value="2">None (2)</option>
            </select>
            <select onchange="state.calcIn.bmi=this.value" class="w-full border rounded-lg p-3">
              <option value="">BMI...</option>
              <option value="0"><19 (0)</option>
              <option value="1">19-21 (1)</option>
              <option value="2">21-23 (2)</option>
              <option value="3">>23 (3)</option>
            </select>`;
          break;
        case 'gds':
          fields = `
            <h4 class="font-medium mb-2">GDS-15 (Depression)</h4>
            <p class="text-xs text-slate-500 mb-2">Based on past week. Check = depressive answer.</p>
            <div class="space-y-1 text-sm max-h-48 overflow-auto">
              <label class="flex items-center gap-2 p-1"><input type="checkbox" ${ci.q1===false?'checked':''} onchange="state.calcIn.q1=!this.checked"> 1. Satisfied with life? (No=1)</label>
              <label class="flex items-center gap-2 p-1"><input type="checkbox" ${ci.q2?'checked':''} onchange="state.calcIn.q2=this.checked"> 2. Dropped activities? (Yes=1)</label>
              <label class="flex items-center gap-2 p-1"><input type="checkbox" ${ci.q3?'checked':''} onchange="state.calcIn.q3=this.checked"> 3. Feel empty? (Yes=1)</label>
              <label class="flex items-center gap-2 p-1"><input type="checkbox" ${ci.q4?'checked':''} onchange="state.calcIn.q4=this.checked"> 4. Often bored? (Yes=1)</label>
              <label class="flex items-center gap-2 p-1"><input type="checkbox" ${ci.q5===false?'checked':''} onchange="state.calcIn.q5=!this.checked"> 5. Good spirits? (No=1)</label>
              <label class="flex items-center gap-2 p-1"><input type="checkbox" ${ci.q6?'checked':''} onchange="state.calcIn.q6=this.checked"> 6. Afraid something bad? (Yes=1)</label>
              <label class="flex items-center gap-2 p-1"><input type="checkbox" ${ci.q7===false?'checked':''} onchange="state.calcIn.q7=!this.checked"> 7. Happy most of time? (No=1)</label>
              <label class="flex items-center gap-2 p-1"><input type="checkbox" ${ci.q8?'checked':''} onchange="state.calcIn.q8=this.checked"> 8. Feel helpless? (Yes=1)</label>
              <label class="flex items-center gap-2 p-1"><input type="checkbox" ${ci.q9?'checked':''} onchange="state.calcIn.q9=this.checked"> 9. Prefer staying home? (Yes=1)</label>
              <label class="flex items-center gap-2 p-1"><input type="checkbox" ${ci.q10?'checked':''} onchange="state.calcIn.q10=this.checked"> 10. Memory problems? (Yes=1)</label>
              <label class="flex items-center gap-2 p-1"><input type="checkbox" ${ci.q11===false?'checked':''} onchange="state.calcIn.q11=!this.checked"> 11. Wonderful to be alive? (No=1)</label>
              <label class="flex items-center gap-2 p-1"><input type="checkbox" ${ci.q12?'checked':''} onchange="state.calcIn.q12=this.checked"> 12. Feel worthless? (Yes=1)</label>
              <label class="flex items-center gap-2 p-1"><input type="checkbox" ${ci.q13===false?'checked':''} onchange="state.calcIn.q13=!this.checked"> 13. Full of energy? (No=1)</label>
              <label class="flex items-center gap-2 p-1"><input type="checkbox" ${ci.q14?'checked':''} onchange="state.calcIn.q14=this.checked"> 14. Situation hopeless? (Yes=1)</label>
              <label class="flex items-center gap-2 p-1"><input type="checkbox" ${ci.q15?'checked':''} onchange="state.calcIn.q15=this.checked"> 15. Most people better off? (Yes=1)</label>
            </div>`;
          break;
      }

      let resultColor = 'bg-slate-100';
      if (state.calcRes) {
        const i = (state.calcRes.i || '').toLowerCase();
        if (i.includes('normal') || i.includes('robust') || i.includes('low') || state.calcRes.v === 'Negative') {
          resultColor = 'bg-green-100 text-green-800';
        } else if (i.includes('stage 4') || i.includes('stage 5') || i.includes('frail') || i.includes('high') || i.includes('severe') || state.calcRes.v === 'POSITIVE' || i.includes('malnourished')) {
          resultColor = 'bg-red-100 text-red-800';
        } else {
          resultColor = 'bg-yellow-100 text-yellow-800';
        }
      }

      return `
        <div class="fixed inset-0 bg-black/50 flex items-end z-50 animate-fadeIn" onclick="if(event.target===this)setState({showCalc:false})">
          <div class="bg-white w-full rounded-t-2xl p-4 modal-content max-h-[85vh] overflow-auto">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-bold text-lg text-slate-800">ğŸ§® Calculators</h3>
              <button onclick="setState({showCalc:false})" class="text-2xl text-slate-400">Ã—</button>
            </div>
            
            <div class="flex gap-2 overflow-x-auto pb-3 mb-3">
              ${calcTypes.map(([k, n]) => `
                <button onclick="setState({calcType:'${k}',calcIn:{},calcRes:null})" 
                  class="flex-shrink-0 px-3 py-2 rounded-lg text-sm ${state.calcType === k ? 'bg-orange-500 text-white' : 'bg-slate-100'}">
                  ${n}
                </button>
              `).join('')}
            </div>
            
            <div class="space-y-2 text-slate-700">
              ${fields}
            </div>
            
            <button onclick="calculate()" class="w-full bg-orange-500 text-white rounded-lg py-3 font-medium mt-4">Calculate</button>
            
            ${state.calcRes ? `
              <div class="${resultColor} rounded-lg p-4 mt-4 text-center">
                <div class="text-3xl font-bold">${state.calcRes.v} ${state.calcRes.u}</div>
                <div class="mt-1">${state.calcRes.i}</div>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    function renderDrugsModal() {
      return `
        <div class="fixed inset-0 bg-black/50 flex items-end z-50 animate-fadeIn" onclick="if(event.target===this)setState({showDrugs:false})">
          <div class="bg-white w-full rounded-t-2xl p-4 modal-content max-h-[85vh] overflow-auto">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-bold text-lg text-slate-800">ğŸ’Š Drug Reference</h3>
              <button onclick="setState({showDrugs:false})" class="text-2xl text-slate-400">Ã—</button>
            </div>
            
            <h4 class="font-bold text-red-600 mb-2">âš ï¸ Beers Criteria - AVOID in Elderly</h4>
            <div class="space-y-2 mb-4">
              ${KNOWLEDGE.beers.map(d => `
                <div class="bg-red-50 rounded-lg p-2 text-sm">
                  <div class="font-medium">${d.drug}</div>
                  <div class="text-red-600 text-xs">${d.risk}</div>
                  <div class="text-green-600 text-xs">â†’ ${d.alt}</div>
                </div>
              `).join('')}
            </div>
            
            <h4 class="font-bold text-blue-600 mb-2">ğŸ’Š Geriatric Starting Doses</h4>
            <div class="space-y-1">
              ${KNOWLEDGE.dosing.map(d => `
                <div class="flex justify-between bg-blue-50 rounded p-2 text-sm">
                  <span class="font-medium">${d.drug}</span>
                  <span>${d.start}</span>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    }

    function renderLabsModal() {
      return `
        <div class="fixed inset-0 bg-black/50 flex items-end z-50 animate-fadeIn" onclick="if(event.target===this)setState({showLabs:false})">
          <div class="bg-white w-full rounded-t-2xl p-4 modal-content max-h-[85vh] overflow-auto">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-bold text-lg text-slate-800">ğŸ§ª Lab Reference</h3>
              <button onclick="setState({showLabs:false})" class="text-2xl text-slate-400">Ã—</button>
            </div>
            
            <h4 class="font-bold text-slate-700 mb-2">CBC</h4>
            <div class="grid grid-cols-3 gap-1 mb-4 text-xs">
              ${KNOWLEDGE.labs.cbc.map(l => `
                <div class="bg-slate-50 rounded p-2 text-center">
                  <div class="font-medium">${l.test}</div>
                  <div>${l.normal}</div>
                </div>
              `).join('')}
            </div>
            
            <h4 class="font-bold text-slate-700 mb-2">BMP</h4>
            <div class="grid grid-cols-3 gap-1 mb-4 text-xs">
              ${KNOWLEDGE.labs.bmp.map(l => `
                <div class="bg-slate-50 rounded p-2 text-center">
                  <div class="font-medium">${l.test}</div>
                  <div>${l.normal}</div>
                </div>
              `).join('')}
            </div>
            
            <h4 class="font-bold text-slate-700 mb-2">Other</h4>
            <div class="grid grid-cols-3 gap-1 mb-4 text-xs">
              ${KNOWLEDGE.labs.other.map(l => `
                <div class="bg-slate-50 rounded p-2 text-center">
                  <div class="font-medium">${l.test}</div>
                  <div>${l.normal}</div>
                </div>
              `).join('')}
            </div>
            
            <div class="bg-orange-50 rounded-lg p-3">
              <h4 class="font-bold text-orange-700 mb-1">ğŸ§“ Geriatric Notes</h4>
              <ul class="text-xs text-orange-600 space-y-1">
                <li>â€¢ WBC may be blunted in infection</li>
                <li>â€¢ Cr underestimates CKD - use eGFR</li>
                <li>â€¢ D-dimer: age-adjusted = age Ã— 10 if >50</li>
                <li>â€¢ Relax HbA1c targets (7-8%) in frail</li>
                <li>â€¢ Low albumin: malnutrition or inflammation</li>
              </ul>
            </div>
            
            <h4 class="font-bold text-slate-700 mt-4 mb-2">ğŸ“Š Assessment Cutoffs</h4>
            <div class="grid grid-cols-2 gap-1 text-xs">
              ${KNOWLEDGE.assessments.slice(0, 10).map(a => `
                <div class="bg-purple-50 rounded p-2">
                  <div class="font-medium">${a.name}</div>
                  <div class="text-purple-600">${a.cutoff}</div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    }

    function renderEditor() {
      if (!state.pres) return renderHome();
      
      const s = state.pres.slides[state.slide];
      
      // Slide thumbnails
      const thumbs = state.pres.slides.map((sl, i) => `
        <button onclick="setState({slide:${i}})" 
          class="flex-shrink-0 px-3 py-2 rounded-lg text-xs whitespace-nowrap transition ${i === state.slide ? 'bg-blue-500 text-white shadow' : 'bg-white shadow-sm'}">
          ${i + 1}. ${e(sl.title.substring(0, 12))}${sl.title.length > 12 ? '...' : ''}
        </button>
      `).join('');

      // Slide content
      let content = '';
      switch(s.type) {
        case 'title':
          content = `
            <div class="text-center py-8">
              <h1 class="text-2xl font-bold mb-2">${e(s.title)}</h1>
              ${s.subtitle ? `<p class="text-slate-600">${e(s.subtitle)}</p>` : ''}
              ${s.presenter ? `<p class="text-sm text-slate-500 mt-4">${e(s.presenter)}</p>` : ''}
              ${s.date ? `<p class="text-sm text-slate-400">${e(s.date)}</p>` : ''}
            </div>`;
          break;
        case 'patient':
          content = `
            <div class="space-y-3">
              ${s.demographics ? `<div><span class="font-medium text-slate-600">Demographics:</span> ${e(s.demographics)}</div>` : ''}
              ${s.cc ? `<div><span class="font-medium text-slate-600">Chief Complaint:</span> ${e(s.cc)}</div>` : ''}
              ${s.codeStatus ? `<div><span class="font-medium text-slate-600">Code Status:</span> ${e(s.codeStatus)}</div>` : ''}
              ${!s.demographics && !s.cc ? '<p class="text-slate-400">No patient info entered</p>' : ''}
            </div>`;
          break;
        case 'content':
          content = `<div class="whitespace-pre-wrap">${e(s.content) || '<span class="text-slate-400">No content</span>'}</div>`;
          break;
        case 'list':
          content = s.items?.length ? `
            <ul class="space-y-2">
              ${s.items.map((item, i) => `<li class="flex items-start gap-2"><span class="text-blue-500 mt-1">â€¢</span><span>${e(item)}</span></li>`).join('')}
            </ul>` : '<p class="text-slate-400">No items</p>';
          break;
        case 'exam':
          const vitals = s.vitals || {};
          content = `
            <div class="space-y-4">
              <div class="grid grid-cols-5 gap-2 text-center">
                ${['BP', 'HR', 'RR', 'Temp', 'SpO2'].map(v => `
                  <div class="bg-slate-50 rounded-lg p-2">
                    <div class="text-xs text-slate-500">${v}</div>
                    <div class="font-medium">${e(vitals[v]) || 'â€”'}</div>
                  </div>
                `).join('')}
              </div>
              ${s.findings ? `<div class="whitespace-pre-wrap">${e(s.findings)}</div>` : '<p class="text-slate-400">No exam findings</p>'}
            </div>`;
          break;
        case 'scores':
          const scores = s.scores || {};
          const scoreNames = ['MMSE', 'MoCA', 'GDS', 'ADL', 'IADL', 'TUG', 'MNA', 'CFS', 'Morse', 'Braden', 'CAM'];
          content = `
            <div class="grid grid-cols-4 gap-2">
              ${scoreNames.map(sc => `
                <div class="bg-slate-50 rounded-lg p-2 text-center">
                  <div class="text-xs text-slate-500">${sc}</div>
                  <div class="font-medium">${e(scores[sc]) || 'â€”'}</div>
                </div>
              `).join('')}
            </div>`;
          break;
        case 'treatment':
          content = `
            <div class="space-y-4">
              <div>
                <div class="font-medium text-green-600 mb-1">ğŸ’Š Pharmacological</div>
                <div class="whitespace-pre-wrap">${e(s.pharm) || '<span class="text-slate-400">None</span>'}</div>
              </div>
              <div>
                <div class="font-medium text-blue-600 mb-1">ğŸ¥ Non-pharmacological</div>
                <div class="whitespace-pre-wrap">${e(s.nonpharm) || '<span class="text-slate-400">None</span>'}</div>
              </div>
            </div>`;
          break;
        case 'table':
          content = s.rows?.length ? `
            <table class="w-full text-sm">
              ${s.headers ? `<thead><tr>${s.headers.map(h => `<th class="text-left p-2 bg-slate-50">${e(h)}</th>`).join('')}</tr></thead>` : ''}
              <tbody>${s.rows.map(row => `<tr>${row.map(cell => `<td class="p-2 border-b">${e(cell)}</td>`).join('')}</tr>`).join('')}</tbody>
            </table>` : '<p class="text-slate-400">No data</p>';
          break;
        default:
          content = `<div class="whitespace-pre-wrap">${e(s.content) || '<span class="text-slate-400">No content</span>'}</div>`;
      }

      return `
        <div class="min-h-screen bg-slate-100 pb-20">
          <!-- Header -->
          <div class="gradient-szmc text-white p-4 sticky top-0 z-20">
            <div class="flex items-center justify-between">
              <button onclick="setState({view:'home'})" class="text-2xl">â†</button>
              <div class="text-center flex-1 mx-4">
                <div class="font-bold truncate">${e(state.pres.slides[0]?.title)}</div>
                <div class="text-xs text-blue-200">Slide ${state.slide + 1} / ${state.pres.slides.length}</div>
              </div>
              <button onclick="setState({showAI:true})" class="text-2xl">ğŸ§ </button>
            </div>
          </div>

          <!-- Slide Navigation -->
          <div class="p-2 flex gap-2 overflow-x-auto bg-slate-100 sticky top-16 z-10">
            ${thumbs}
          </div>

          <!-- Slide Content -->
          <div class="p-4">
            <div class="bg-white rounded-xl shadow-lg p-6 min-h-48">
              <div class="text-xs text-slate-400 mb-1">${s.type.toUpperCase()}</div>
              <h2 class="text-xl font-bold mb-4 text-slate-800">${e(s.title)}</h2>
              ${content}
            </div>

            <!-- Edit Button -->
            <button onclick="setState({editing:'${s.type}'})" class="w-full mt-4 bg-blue-500 text-white rounded-xl py-3 font-medium shadow">
              âœï¸ Edit This Slide
            </button>
            
            <!-- Slide Actions -->
            <div class="flex gap-2 mt-2">
              <button onclick="addSlide('content')" class="flex-1 bg-green-100 text-green-700 rounded-lg py-2 text-sm">+ Add Slide</button>
              <button onclick="deleteSlide()" class="flex-1 bg-red-100 text-red-700 rounded-lg py-2 text-sm">ğŸ—‘ï¸ Delete</button>
            </div>
          </div>

          <!-- Bottom Navigation -->
          <div class="fixed bottom-0 left-0 right-0 bg-white border-t p-3 flex gap-2 safe-bottom">
            <button onclick="setState({slide:Math.max(0,state.slide-1)})" ${state.slide === 0 ? 'disabled' : ''} 
              class="flex-1 bg-slate-100 rounded-lg py-3 font-medium disabled:opacity-50">â† Prev</button>
            <button onclick="setState({showCalc:true})" class="px-4 bg-orange-100 rounded-lg text-lg">ğŸ§®</button>
            <button onclick="setState({showAI:true})" class="px-4 bg-blue-100 rounded-lg text-lg">ğŸ§ </button>
            <button onclick="setState({slide:Math.min(state.pres.slides.length-1,state.slide+1)})" ${state.slide >= state.pres.slides.length - 1 ? 'disabled' : ''} 
              class="flex-1 bg-slate-100 rounded-lg py-3 font-medium disabled:opacity-50">Next â†’</button>
          </div>

          ${state.editing ? renderEditModal() : ''}
          ${state.showAI ? renderAIModal() : ''}
          ${state.showCalc ? renderCalcModal() : ''}
          ${state.showDrugs ? renderDrugsModal() : ''}
          ${state.showLabs ? renderLabsModal() : ''}
        </div>
        ${state.recentAction ? `<div class="fixed bottom-20 left-4 right-4 bg-green-500 text-white p-3 rounded-xl text-center animate-fadeIn z-50">${e(state.recentAction)}</div>` : ''}
      `;
    }

    function renderEditModal() {
      const s = state.pres.slides[state.slide];
      
      let fields = `
        <div class="mb-3">
          <label class="block text-sm font-medium text-slate-700 mb-1">Title</label>
          <input value="${e(s.title)}" oninput="updateSlide('title',this.value)" class="w-full border rounded-lg p-3">
        </div>`;

      switch(s.type) {
        case 'title':
          fields += `
            <div class="mb-3">
              <label class="block text-sm font-medium text-slate-700 mb-1">Subtitle</label>
              <input value="${e(s.subtitle || '')}" oninput="updateSlide('subtitle',this.value)" class="w-full border rounded-lg p-3">
            </div>
            <div class="mb-3">
              <label class="block text-sm font-medium text-slate-700 mb-1">Presenter</label>
              <input value="${e(s.presenter || '')}" oninput="updateSlide('presenter',this.value)" class="w-full border rounded-lg p-3">
            </div>
            <div class="mb-3">
              <label class="block text-sm font-medium text-slate-700 mb-1">Date</label>
              <input value="${e(s.date || '')}" oninput="updateSlide('date',this.value)" class="w-full border rounded-lg p-3">
            </div>`;
          break;
        case 'patient':
          fields += `
            <div class="mb-3">
              <label class="block text-sm font-medium text-slate-700 mb-1">Demographics (age, sex, etc.)</label>
              <input value="${e(s.demographics || '')}" oninput="updateSlide('demographics',this.value)" class="w-full border rounded-lg p-3" placeholder="85yo female...">
            </div>
            <div class="mb-3">
              <label class="block text-sm font-medium text-slate-700 mb-1">Chief Complaint</label>
              <input value="${e(s.cc || '')}" oninput="updateSlide('cc',this.value)" class="w-full border rounded-lg p-3" placeholder="Falls, confusion...">
            </div>
            <div class="mb-3">
              <label class="block text-sm font-medium text-slate-700 mb-1">Code Status</label>
              <input value="${e(s.codeStatus || '')}" oninput="updateSlide('codeStatus',this.value)" class="w-full border rounded-lg p-3" placeholder="Full code, DNR...">
            </div>`;
          break;
        case 'content':
          fields += `
            <div class="mb-3">
              <label class="block text-sm font-medium text-slate-700 mb-1">Content</label>
              <textarea oninput="updateSlide('content',this.value)" class="w-full border rounded-lg p-3 min-h-32">${e(s.content || '')}</textarea>
            </div>`;
          break;
        case 'list':
          fields += `
            <div class="mb-3">
              <label class="block text-sm font-medium text-slate-700 mb-1">Items (one per line)</label>
              <textarea oninput="updateSlide('items',this.value.split('\\n').filter(x=>x.trim()))" class="w-full border rounded-lg p-3 min-h-32">${(s.items || []).join('\n')}</textarea>
            </div>`;
          break;
        case 'exam':
          const v = s.vitals || {};
          fields += `
            <div class="mb-3">
              <label class="block text-sm font-medium text-slate-700 mb-1">Vitals</label>
              <div class="grid grid-cols-5 gap-2">
                <input placeholder="BP" value="${e(v.BP || '')}" oninput="updateSlide('vitals',{...state.pres.slides[state.slide].vitals,BP:this.value})" class="border rounded p-2 text-center">
                <input placeholder="HR" value="${e(v.HR || '')}" oninput="updateSlide('vitals',{...state.pres.slides[state.slide].vitals,HR:this.value})" class="border rounded p-2 text-center">
                <input placeholder="RR" value="${e(v.RR || '')}" oninput="updateSlide('vitals',{...state.pres.slides[state.slide].vitals,RR:this.value})" class="border rounded p-2 text-center">
                <input placeholder="Temp" value="${e(v.Temp || '')}" oninput="updateSlide('vitals',{...state.pres.slides[state.slide].vitals,Temp:this.value})" class="border rounded p-2 text-center">
                <input placeholder="SpO2" value="${e(v.SpO2 || '')}" oninput="updateSlide('vitals',{...state.pres.slides[state.slide].vitals,SpO2:this.value})" class="border rounded p-2 text-center">
              </div>
            </div>
            <div class="mb-3">
              <label class="block text-sm font-medium text-slate-700 mb-1">Exam Findings</label>
              <textarea oninput="updateSlide('findings',this.value)" class="w-full border rounded-lg p-3 min-h-24">${e(s.findings || '')}</textarea>
            </div>`;
          break;
        case 'scores':
          const sc = s.scores || {};
          const scoreFields = ['MMSE', 'MoCA', 'GDS', 'ADL', 'IADL', 'TUG', 'MNA', 'CFS', 'Morse', 'Braden', 'CAM'];
          fields += `
            <div class="mb-3">
              <label class="block text-sm font-medium text-slate-700 mb-1">Geriatric Assessments</label>
              <div class="grid grid-cols-3 gap-2">
                ${scoreFields.map(name => `
                  <div>
                    <label class="text-xs text-slate-500">${name}</label>
                    <input placeholder="${name}" value="${e(sc[name] || '')}" 
                      oninput="updateSlide('scores',{...state.pres.slides[state.slide].scores,'${name}':this.value})" 
                      class="w-full border rounded p-2 text-center">
                  </div>
                `).join('')}
              </div>
            </div>`;
          break;
        case 'treatment':
          fields += `
            <div class="mb-3">
              <label class="block text-sm font-medium text-slate-700 mb-1">ğŸ’Š Pharmacological</label>
              <textarea oninput="updateSlide('pharm',this.value)" class="w-full border rounded-lg p-3 min-h-24" placeholder="Medications...">${e(s.pharm || '')}</textarea>
            </div>
            <div class="mb-3">
              <label class="block text-sm font-medium text-slate-700 mb-1">ğŸ¥ Non-pharmacological</label>
              <textarea oninput="updateSlide('nonpharm',this.value)" class="w-full border rounded-lg p-3 min-h-24" placeholder="PT, OT, diet...">${e(s.nonpharm || '')}</textarea>
            </div>`;
          break;
      }

      return `
        <div class="fixed inset-0 bg-black/50 flex items-end z-50 animate-fadeIn" onclick="if(event.target===this)setState({editing:null})">
          <div class="bg-white w-full rounded-t-2xl p-4 modal-content max-h-[85vh] overflow-auto">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-bold text-lg text-slate-800">Edit: ${e(s.title)}</h3>
              <button onclick="setState({editing:null})" class="text-2xl text-slate-400">Ã—</button>
            </div>
            ${fields}
            <button onclick="setState({editing:null})" class="w-full bg-blue-500 text-white rounded-lg py-3 font-medium">Done</button>
          </div>
        </div>
      `;
    }

    function renderAIModal() {
      const msgs = state.aiChat.map(m => `
        <div class="${m.role === 'user' ? 'text-right' : ''}">
          <div class="inline-block rounded-xl p-3 text-sm max-w-[85%] whitespace-pre-wrap ${m.role === 'user' ? 'bg-blue-500 text-white' : 'bg-slate-100 text-slate-800'}">${e(m.content)}</div>
        </div>
      `).join('');

      return `
        <div class="fixed inset-0 bg-black/50 flex items-end z-50 animate-fadeIn" onclick="if(event.target===this)setState({showAI:false})">
          <div class="bg-white w-full rounded-t-2xl max-h-[85vh] flex flex-col modal-content">
            <div class="p-4 border-b flex justify-between items-center">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-400 to-purple-500 rounded-full flex items-center justify-center text-xl">ğŸ§ </div>
                <div>
                  <div class="font-bold text-slate-800">Geriatrics AI</div>
                  <div class="text-xs text-slate-500">Auto-modifies slides</div>
                </div>
              </div>
              <div class="flex gap-2">
                <button onclick="state.aiChat=[];render()" class="text-sm text-slate-500">Clear</button>
                <button onclick="setState({showAI:false})" class="text-2xl text-slate-400">Ã—</button>
              </div>
            </div>

            <!-- Quick Actions -->
            <div class="p-3 border-b space-y-2">
              <div class="flex gap-2 overflow-x-auto pb-1">
                <button onclick="aiCommand('ddx')" class="flex-shrink-0 px-3 py-1.5 bg-blue-100 text-blue-700 rounded-full text-xs">ğŸ” Gen DDx</button>
                <button onclick="aiCommand('teaching')" class="flex-shrink-0 px-3 py-1.5 bg-green-100 text-green-700 rounded-full text-xs">ğŸ“š Teaching</button>
                <button onclick="aiCommand('meds')" class="flex-shrink-0 px-3 py-1.5 bg-orange-100 text-orange-700 rounded-full text-xs">ğŸ’Š Med Review</button>
                <button onclick="aiCommand('plan')" class="flex-shrink-0 px-3 py-1.5 bg-teal-100 text-teal-700 rounded-full text-xs">ğŸ“‹ Plan</button>
              </div>
              <div class="flex gap-2 overflow-x-auto">
                <button onclick="aiCommand('workup')" class="flex-shrink-0 px-3 py-1.5 bg-purple-100 text-purple-700 rounded-full text-xs">ğŸ”¬ Workup</button>
                <button onclick="aiCommand('gaps')" class="flex-shrink-0 px-3 py-1.5 bg-yellow-100 text-yellow-700 rounded-full text-xs">âš ï¸ Gaps</button>
                <button onclick="aiCommand('improve')" class="flex-shrink-0 px-3 py-1.5 bg-indigo-100 text-indigo-700 rounded-full text-xs">âœ¨ Improve</button>
                <button onclick="setState({showAI:false,showDrugs:true})" class="flex-shrink-0 px-3 py-1.5 bg-red-50 text-red-700 rounded-full text-xs border border-red-200">ğŸ“– Drugs</button>
              </div>
            </div>

            <!-- Chat -->
            <div id="aiChatBox" class="flex-1 overflow-auto p-4 space-y-3 min-h-48 max-h-72">
              ${state.aiChat.length === 0 ? `
                <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-4 text-sm text-slate-600">
                  <div class="font-medium text-slate-800 mb-2">ğŸ©º I can modify your slides automatically:</div>
                  <ul class="space-y-1 text-xs">
                    <li>â€¢ "Generate DDx" â†’ Updates differential slide</li>
                    <li>â€¢ "Add teaching points" â†’ Updates teaching slide</li>
                    <li>â€¢ "Review meds" â†’ Checks Beers, interactions</li>
                    <li>â€¢ "Create plan" â†’ Updates management slide</li>
                  </ul>
                  ${!state.apiKey ? '<p class="mt-2 text-orange-600">âš ï¸ Add API key in Settings to enable AI</p>' : ''}
                </div>
              ` : msgs}
              ${state.aiLoading ? '<div class="typing"><span></span><span></span><span></span></div>' : ''}
            </div>

            <!-- Input -->
            <div class="p-4 border-t">
              <div class="flex gap-2">
                <input id="aiInput" value="${e(state.aiInput)}" oninput="state.aiInput=this.value" 
                  onkeypress="if(event.key==='Enter')sendAI()" 
                  placeholder="Ask anything..." class="flex-1 border rounded-xl px-4 py-3">
                <button onclick="sendAI()" ${state.aiLoading ? 'disabled' : ''} 
                  class="bg-blue-500 text-white rounded-xl px-5 font-medium disabled:opacity-50">
                  ${state.aiLoading ? '...' : 'Send'}
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Initialize
    render();

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (state.editing || state.showAI) return;
      if (state.view === 'editor') {
        if (e.key === 'ArrowRight') setState({ slide: Math.min(state.pres.slides.length - 1, state.slide + 1) });
        if (e.key === 'ArrowLeft') setState({ slide: Math.max(0, state.slide - 1) });
      }
    });

    // Touch swipe navigation
    let touchStartX = 0;
    document.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
    document.addEventListener('touchend', e => {
      if (state.editing || state.showAI || state.view !== 'editor') return;
      const deltaX = e.changedTouches[0].screenX - touchStartX;
      if (Math.abs(deltaX) > 50) {
        if (deltaX < 0) setState({ slide: Math.min(state.pres.slides.length - 1, state.slide + 1) });
        else setState({ slide: Math.max(0, state.slide - 1) });
      }
    }, { passive: true });
  </script>
</body>
</html>
