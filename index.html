<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SZMC Pro: Auditor v14.1</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2c3e50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- CDN Scripts with Subresource Integrity (SRI) -->
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"
        integrity="sha512-q+4liFwdPC/bNdhUpUx4hF/sLJFLsKxfAQqmUwZ9yraPMKGMq4MJyzON7k3EIoUPzGKxBfTFULw3dew8OL8HjA=="
        crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"
        integrity="sha512-XMVd28F1oH/O71fzwBnV7HucLxVwtxf26XV8P4wPk26EDxuGZ91N8bsOttmnomcCD3CS5ZMRL50H0GgOHvegtg=="
        crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"
        integrity="sha512-3z/3UtcwME2cYyFAzlKwigXjd+synkmTvDJgq/bXjRn76kHOL4TqsjWHHPIJfQl2pZqBvnSQBA3F1xA0CnG0ZQ=="
        crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"
        integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg=="
        crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>

    <style>
        /* ========== CSS VARIABLES ========== */
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --audit: #e74c3c;
            --bg: #f0f2f5;
            --sidebar: #ffffff;
            --sidebar-width: 340px;
        }

        /* ========== BASE STYLES ========== */
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg);
            margin: 0;
            display: flex;
            height: 100vh;
            height: 100dvh; /* Dynamic viewport height for mobile */
            overflow: hidden;
        }

        /* ========== SIDEBAR ========== */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--sidebar);
            border-right: 1px solid #dce1e6;
            display: flex;
            flex-direction: column;
            padding: 25px;
            z-index: 2;
            box-shadow: 4px 0 15px rgba(0,0,0,0.03);
            overflow-y: auto;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 25px;
            flex-shrink: 0;
        }

        .badge {
            background: var(--audit);
            color: white;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
        }

        /* ========== DROPZONE ========== */
        .drop-zone {
            border: 2px dashed #cbd5e0;
            border-radius: 12px;
            padding: 30px 20px;
            text-align: center;
            background: #f8fafc;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .drop-zone:hover {
            border-color: var(--accent);
            background: #ebf5fb;
            transform: translateY(-2px);
        }

        .drop-icon {
            font-size: 2rem;
            display: block;
            margin-bottom: 8px;
        }

        /* ========== MAIN AREA ========== */
        .main {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            display: flex;
            gap: 40px;
        }

        .editor-col {
            flex: 2;
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.04);
            min-width: 0; /* Prevent flex overflow */
        }

        .preview-col {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-width: 300px;
            position: sticky;
            top: 40px;
            height: fit-content;
        }

        /* ========== SECTION HEADERS & MACROS ========== */
        .sec-header {
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--primary);
            border-bottom: 2px solid #f1f3f5;
            padding-bottom: 12px;
            margin-bottom: 15px;
            margin-top: 35px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .sec-header:first-child {
            margin-top: 0;
        }

        .macro-row {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 10px;
            margin-bottom: 5px;
            -webkit-overflow-scrolling: touch;
        }

        .macro-tag {
            background: #edf2f7;
            color: #4a5568;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            border: 1px solid transparent;
            transition: 0.2s;
        }

        .macro-tag:hover,
        .macro-tag:active {
            background: #cbd5e0;
            border-color: #a0aec0;
        }

        /* ========== FORM ELEMENTS ========== */
        label {
            display: block;
            font-size: 0.7rem;
            font-weight: 700;
            color: #95a5a6;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input, select, textarea {
            width: 100%;
            padding: 14px;
            border: 1px solid #dfe6e9;
            border-radius: 8px;
            font-family: inherit;
            font-size: 16px; /* Prevents zoom on iOS */
            box-sizing: border-box;
            background: #fdfdfd;
            transition: border 0.2s;
        }

        input:focus, textarea:focus, select:focus {
            border-color: var(--accent);
            outline: none;
            background: white;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        /* ========== BUTTONS ========== */
        .btn {
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            color: white;
            width: 100%;
            margin-bottom: 12px;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: transform 0.1s;
            -webkit-tap-highlight-color: transparent;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-ai {
            background: linear-gradient(135deg, #2c3e50, #34495e);
        }

        .btn-audit {
            background: linear-gradient(135deg, #c0392b, #e74c3c);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .btn-ppt {
            background: #e67e22;
        }

        .btn-doc {
            background: #2980b9;
        }

        .btn-reset {
            background: transparent;
            color: #95a5a6;
            border: 1px solid #ccc;
        }

        /* ========== AUDIT PANEL ========== */
        .audit-panel {
            background: #fff5f5;
            border: 2px solid #fab1a0;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .audit-title {
            color: #c0392b;
            font-weight: 800;
            font-size: 1rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .audit-panel p {
            font-size: 0.8rem;
            color: #c0392b;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        /* ========== GRID LAYOUTS ========== */
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        /* ========== STATUS MESSAGES ========== */
        #ocr-status {
            font-size: 0.8rem;
            color: #e67e22;
            margin-top: 15px;
            font-weight: bold;
            text-align: center;
            min-height: 1.2em;
        }

        .autosave-msg {
            font-size: 0.7rem;
            color: #27ae60;
            text-align: center;
            opacity: 0;
            transition: opacity 0.5s;
            margin-top: 10px;
        }

        .raw-text-area {
            height: 200px;
            font-family: monospace;
            font-size: 0.75rem;
            color: #333;
            line-height: 1.4;
        }

        .output-panel {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .output-title {
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .divider {
            height: 1px;
            background: #eee;
            margin: 15px 0;
        }

        /* ========== MOBILE NAV (Hidden by default) ========== */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #dce1e6;
            padding: 10px 20px;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
            z-index: 100;
            gap: 10px;
        }

        .mobile-nav .btn {
            margin: 0;
            flex: 1;
            padding: 12px 8px;
            font-size: 0.8rem;
        }

        /* ========== MOBILE RESPONSIVE (S23 Ultra: 412px logical width) ========== */
        @media screen and (max-width: 1024px) {
            .main {
                flex-direction: column;
                padding: 20px;
                gap: 20px;
            }

            .preview-col {
                position: static;
                min-width: auto;
            }
        }

        @media screen and (max-width: 768px) {
            body {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                max-height: 35vh;
                border-right: none;
                border-bottom: 1px solid #dce1e6;
                padding: 15px;
            }

            .logo {
                font-size: 1.2rem;
                margin-bottom: 15px;
            }

            .drop-zone {
                padding: 20px 15px;
            }

            .drop-icon {
                font-size: 1.5rem;
            }

            .raw-text-area {
                height: 100px;
            }

            .main {
                flex: 1;
                padding: 15px;
                padding-bottom: 80px; /* Space for mobile nav */
                gap: 15px;
            }

            .editor-col {
                padding: 20px;
            }

            .grid-3 {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }

            .grid-2 {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .sec-header {
                flex-direction: column;
                align-items: flex-start;
                margin-top: 25px;
            }

            .macro-row {
                width: 100%;
            }

            .preview-col {
                display: none; /* Hide on mobile, use mobile nav instead */
            }

            .mobile-nav {
                display: flex;
            }

            input, select, textarea {
                padding: 12px;
            }

            textarea[rows="6"] {
                min-height: 120px;
            }

            textarea[rows="10"] {
                min-height: 150px;
            }
        }

        @media screen and (max-width: 420px) {
            /* S23 Ultra specific optimizations */
            .grid-3 {
                grid-template-columns: 1fr 1fr 1fr;
                gap: 8px;
            }

            .grid-3 input,
            .grid-3 select {
                padding: 10px 8px;
                font-size: 14px;
            }

            .macro-tag {
                padding: 8px 12px;
                font-size: 0.7rem;
            }

            .btn {
                padding: 12px;
                font-size: 0.85rem;
            }

            .audit-panel {
                padding: 15px;
            }
        }

        /* ========== LANDSCAPE MOBILE ========== */
        @media screen and (max-width: 920px) and (orientation: landscape) {
            .sidebar {
                max-height: 100vh;
                width: 280px;
            }

            body {
                flex-direction: row;
            }

            .mobile-nav {
                display: none;
            }

            .preview-col {
                display: flex;
            }
        }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="logo">
        <span>SZMC Pro</span>
        <span class="badge">v14.1</span>
    </div>

    <div class="drop-zone" onclick="document.getElementById('file-in').click()" id="drop-area">
        <span class="drop-icon">üîç</span>
        <div style="font-weight:700; color:#34495e;">Import Case Data</div>
        <div style="font-size:0.8rem; color:#7f8c8d; margin-top:8px;">
            Drag PDF, PPTX, or Image
        </div>
        <input type="file" id="file-in" style="display:none" onchange="handleFile(this)" accept=".pdf,.pptx,.docx,.jpg,.jpeg,.png,.txt">
    </div>
    <div id="ocr-status"></div>
    <div class="autosave-msg" id="save-msg">‚úÖ Auto-saved</div>

    <div style="margin-top:auto; flex-shrink: 0;">
        <label>Raw Extracted Text</label>
        <textarea id="raw-text" class="raw-text-area" placeholder="Extracted text dump..."></textarea>
    </div>
</div>

<div class="main">
    <div class="editor-col">
        <div class="sec-header">1. Context</div>
        <div class="grid-3">
            <div>
                <label>Age</label>
                <input type="text" id="age" oninput="autoSave()" inputmode="numeric">
            </div>
            <div>
                <label>Sex</label>
                <select id="sex" oninput="autoSave()">
                    <option>Male</option>
                    <option>Female</option>
                </select>
            </div>
            <div>
                <label>Initials</label>
                <input type="text" id="initials" oninput="autoSave()" autocapitalize="characters">
            </div>
        </div>
        <div style="margin-top:20px;">
            <label>Chief Complaint</label>
            <input type="text" id="cc" oninput="autoSave()">
        </div>

        <div class="sec-header">
            <span>2. Narrative</span>
            <div class="macro-row">
                <span class="macro-tag" onclick="insert('hpi', 'Baseline: Independent.')">üö∂ Independent</span>
                <span class="macro-tag" onclick="insert('hpi', 'Baseline: Nursing Home resident.')">üè† Nursing Home</span>
                <span class="macro-tag" onclick="insert('hpi', 'Cognitively intact.')">üß† Intact</span>
            </div>
        </div>
        <textarea id="hpi" rows="5" oninput="autoSave()" placeholder="HPI..."></textarea>

        <div class="grid-2" style="margin-top:25px;">
            <div>
                <label>PMH</label>
                <div class="macro-row">
                    <span class="macro-tag" onclick="insert('pmh', 'HTN, T2DM, HLP')">üíä Met Syn</span>
                    <span class="macro-tag" onclick="insert('pmh', 'IHD (s/p CABG)')">‚ù§Ô∏è Cardiac</span>
                </div>
                <textarea id="pmh" rows="6" oninput="autoSave()"></textarea>
            </div>
            <div>
                <label>Medications</label>
                <textarea id="meds" rows="6" oninput="autoSave()"></textarea>
            </div>
        </div>

        <div class="sec-header">3. Objective</div>
        <div class="grid-2">
            <div>
                <label>Labs</label>
                <textarea id="labs" rows="6" oninput="autoSave()"></textarea>
            </div>
            <div>
                <label>Imaging / Diagnostics</label>
                <textarea id="imaging" rows="6" oninput="autoSave()"></textarea>
            </div>
        </div>

        <div class="sec-header">
            <span>4. Assessment & Plan</span>
            <div class="macro-row">
                <span class="macro-tag" onclick="insert('plan', 'DNR / DNI.')">üõë DNR/DNI</span>
                <span class="macro-tag" onclick="insert('plan', 'Rec: Geriatric Rehab.')">üè• Rehab</span>
            </div>
        </div>
        <textarea id="plan" rows="10" oninput="autoSave()"></textarea>
    </div>

    <div class="preview-col">
        <div class="audit-panel">
            <div class="audit-title">üõ°Ô∏è Inner AI Auditor</div>
            <p>
                Force the AI to critique your plan for safety, errors, and missing items before you discharge.
            </p>
            <label>Audit Focus</label>
            <select id="audit-mode" style="margin-bottom:10px; border-color:#fab1a0;">
                <option value="safety">üíä Med Safety & Beers Criteria</option>
                <option value="diagnostic">üîç Diagnostic Blindspots</option>
                <option value="discharge">üö™ Discharge Safety Check</option>
            </select>
            <button class="btn btn-audit" onclick="generateAudit()">
                <span>üö®</span> Run Clinical Audit
            </button>
        </div>

        <div class="output-panel">
            <div class="output-title">Standard Output</div>

            <button class="btn btn-ai" onclick="generateStandard()">
                <span>‚ú®</span> Generate Summary
            </button>

            <div class="divider"></div>

            <button class="btn btn-ppt" onclick="exportPPT()">üìä PPTX</button>
            <button class="btn btn-doc" onclick="exportDOC()">üìù Word</button>
            <button class="btn btn-reset" onclick="clearData()">Reset</button>
        </div>
    </div>
</div>

<!-- Mobile Bottom Navigation -->
<div class="mobile-nav">
    <button class="btn btn-audit" onclick="generateAudit()" style="font-size:0.75rem;">üö® Audit</button>
    <button class="btn btn-ai" onclick="generateStandard()" style="font-size:0.75rem;">‚ú® Summary</button>
    <button class="btn btn-ppt" onclick="exportPPT()" style="font-size:0.75rem;">üìä PPTX</button>
</div>

<script>
    // ============================================================
    // 1. CORE ELEMENTS & EVENT LISTENERS
    // ============================================================

    const dropArea = document.getElementById('drop-area');
    const statusDiv = document.getElementById('ocr-status');
    const saveMsg = document.getElementById('save-msg');

    // Drag and drop handlers
    dropArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        dropArea.style.background = '#e8f6f3';
    });

    dropArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        dropArea.style.background = '#f8fafc';
    });

    dropArea.addEventListener('drop', function(e) {
        e.preventDefault();
        dropArea.style.background = '#f8fafc';
        if (e.dataTransfer.files.length) {
            handleFile({ files: e.dataTransfer.files });
        }
    });

    // ============================================================
    // 2. FILE IMPORT HANDLER
    // ============================================================

    async function handleFile(input) {
        const file = input.files[0];
        if (!file) return;

        const fileName = file.name;
        const ext = fileName.split('.').pop().toLowerCase();
        let extractedText = "";

        statusDiv.innerText = "Reading " + ext.toUpperCase() + "...";

        try {
            // Handle PPTX files
            if (ext === 'pptx') {
                extractedText = await extractPptxText(file);
            }
            // Handle PDF files
            else if (ext === 'pdf') {
                extractedText = await extractPdfText(file);
            }
            // Handle DOCX files
            else if (ext === 'docx') {
                extractedText = await extractDocxText(file);
            }
            // Handle image files (OCR)
            else if (['jpg', 'png', 'jpeg'].includes(ext)) {
                statusDiv.innerText = "OCR Processing...";
                extractedText = await extractImageText(file);
            }
            // Handle plain text files
            else {
                extractedText = await file.text();
            }

            // Update UI with extracted text
            document.getElementById('raw-text').value = extractedText;
            smartPopulate(extractedText);
            statusDiv.innerText = "Success!";
            autoSave();

            // Clear status after delay
            setTimeout(function() {
                statusDiv.innerText = "";
            }, 2000);

        } catch (err) {
            console.error('File import error:', err);
            statusDiv.innerText = "Error!";
            alert("Import failed. Please try again.");
        }
    }

    // Extract text from PPTX using JSZip
    async function extractPptxText(file) {
        const zip = await JSZip.loadAsync(file);
        const slideFiles = Object.keys(zip.files)
            .filter(function(name) {
                return name.match(/ppt\/slides\/slide\d+\.xml/);
            })
            .sort(function(a, b) {
                const numA = parseInt(a.match(/slide(\d+)\.xml/)[1]);
                const numB = parseInt(b.match(/slide(\d+)\.xml/)[1]);
                return numA - numB;
            });

        let text = "";
        for (const slideFile of slideFiles) {
            const xmlText = await zip.file(slideFile).async("string");
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, "text/xml");
            if (xmlDoc.documentElement) {
                text += xmlDoc.documentElement.textContent + "\n\n";
            }
        }
        return text;
    }

    // Extract text from PDF using PDF.js
    async function extractPdfText(file) {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
        let text = "";

        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            const pageText = content.items.map(function(item) {
                return item.str;
            }).join(' ');
            text += pageText + " ";
        }
        return text;
    }

    // Extract text from DOCX using Mammoth
    async function extractDocxText(file) {
        const arrayBuffer = await file.arrayBuffer();
        const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
        return result.value;
    }

    // Extract text from images using Tesseract OCR
    async function extractImageText(file) {
        const worker = await Tesseract.createWorker('eng');
        const result = await worker.recognize(file);
        await worker.terminate();
        return result.data.text;
    }

    // ============================================================
    // 3. SMART POPULATE - Auto-fill fields from extracted text
    // ============================================================

    function smartPopulate(text) {
        setFieldFromRegex('age', text, /(\d{2,3})\s?(y|yo|Year)/i);
        setFieldFromRegex('hpi', text, /(?:HPI|History|Anamnesis)[:\s]+([\s\S]*?)(?=\n\s*(?:PMH|Back|Meds)|$)/i);
        setFieldFromRegex('pmh', text, /(?:PMH|Background)[:\s]+([\s\S]*?)(?=\n\s*(?:Med|Lab)|$)/i);
        setFieldFromRegex('meds', text, /(?:Meds|Medications)[:\s]+([\s\S]*?)(?=\n\s*(?:Lab|Plan)|$)/i);
        setFieldFromRegex('labs', text, /(?:Labs|Chemistry)[:\s]+([\s\S]*?)(?=\n\s*(?:Plan|Imag)|$)/i);
    }

    function setFieldFromRegex(fieldId, text, regex) {
        const match = text.match(regex);
        if (match && match[1]) {
            document.getElementById(fieldId).value = match[1].trim();
        }
    }

    // Insert macro text into a field
    function insert(fieldId, text) {
        const element = document.getElementById(fieldId);
        if (element.value) {
            element.value = element.value + " " + text;
        } else {
            element.value = text;
        }
        autoSave();
    }

    // ============================================================
    // 4. STATE MANAGEMENT - Auto-save & Load
    // ============================================================

    const FIELD_IDS = [
        'age', 'sex', 'initials', 'cc', 'hpi',
        'pmh', 'meds', 'labs', 'imaging', 'plan', 'raw-text'
    ];

    function autoSave() {
        const data = {};
        FIELD_IDS.forEach(function(id) {
            data[id] = document.getElementById(id).value;
        });
        localStorage.setItem('szmc_v14_data', JSON.stringify(data));

        // Show save indicator
        saveMsg.style.opacity = 1;
        setTimeout(function() {
            saveMsg.style.opacity = 0;
        }, 1000);
    }

    function loadSavedData() {
        const saved = localStorage.getItem('szmc_v14_data');
        if (saved) {
            const data = JSON.parse(saved);
            FIELD_IDS.forEach(function(id) {
                if (data[id]) {
                    document.getElementById(id).value = data[id];
                }
            });
        }
    }

    function clearData() {
        if (confirm("Reset all fields?")) {
            FIELD_IDS.forEach(function(id) {
                document.getElementById(id).value = "";
            });
            localStorage.removeItem('szmc_v14_data');
        }
    }

    // Load saved data on page load
    window.onload = loadSavedData;

    // ============================================================
    // 5. HELPER FUNCTIONS
    // ============================================================

    function getFieldValue(id) {
        return document.getElementById(id).value || "";
    }

    function getRawText() {
        return document.getElementById('raw-text').value || "";
    }

    function getPatientData() {
        const hpi = getFieldValue('hpi');
        if (hpi.length > 5) {
            return "PT: " + getFieldValue('age') + " " + getFieldValue('sex') + "\n" +
                   "HPI: " + hpi + "\n" +
                   "PMH: " + getFieldValue('pmh') + "\n" +
                   "MEDS: " + getFieldValue('meds') + "\n" +
                   "LABS: " + getFieldValue('labs') + "\n" +
                   "PLAN: " + getFieldValue('plan');
        } else {
            return "RAW:\n" + getRawText();
        }
    }

    // ============================================================
    // 6. AI PROMPT GENERATORS
    // ============================================================

    function generateStandard() {
        const prompt = "Act as a Senior Geriatrician. Summarize this case for Morning Report.\n\n" +
                       getPatientData() + "\n\n" +
                       "OUTPUT: 1-Liner ID, HPI Summary, Geriatric Syndromes, Plan.";

        copyToClipboard(prompt);
        alert("‚ú® Summary Prompt Copied!");
    }

    function generateAudit() {
        const mode = document.getElementById('audit-mode').value;
        let prompt = "Act as a STRICT Clinical Safety Officer and Geriatric Pharmacologist. " +
                     "Review this case CRITICALLY. Do NOT summarize. Only find ERRORS and RISKS.\n\n" +
                     getPatientData() + "\n\n";

        if (mode === 'safety') {
            prompt += "TASK: 1. Identify ANY potential Drug-Drug Interactions. " +
                      "2. Flag meds inappropriate for elderly (Beers Criteria / STOPP). " +
                      "3. Check for Renally cleared drugs if Creatinine is high.";
        } else if (mode === 'diagnostic') {
            prompt += "TASK: 1. What diagnoses are we missing? " +
                      "2. Is the Delirium workup complete? " +
                      "3. Are we anchoring on a diagnosis? Suggest 3 differential diagnoses we might have ignored.";
        } else if (mode === 'discharge') {
            prompt += "TASK: 1. Is this patient safe to go home? " +
                      "2. Identify fall risks at home based on this data. " +
                      "3. What social support is missing?";
        }

        copyToClipboard(prompt);
        alert("üö® AUDIT PROMPT COPIED! Paste into AI to start safety check.");
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text);
    }

    // ============================================================
    // 7. EXPORT FUNCTIONS
    // ============================================================

    function exportPPT() {
        const pres = new PptxGenJS();
        const age = getFieldValue('age');
        const sex = getFieldValue('sex');
        const cc = getFieldValue('cc');
        const hpi = getFieldValue('hpi') || getRawText().substring(0, 500);
        const meds = getFieldValue('meds');
        const labs = getFieldValue('labs');
        const plan = getFieldValue('plan');
        const initials = getFieldValue('initials');

        // Slide 1: Title
        const slide1 = pres.addSlide();
        slide1.addText("Geriatric Case", { x: 1, y: 2, fontSize: 32, color: '2c3e50', bold: true });
        slide1.addText(age + "yo " + sex + " - " + cc, { x: 1, y: 3, fontSize: 24, color: '7f8c8d' });

        // Slide 2: HPI
        const slide2 = pres.addSlide();
        slide2.addText("HPI", { x: 0.5, y: 0.5, fontSize: 18, color: '3498db', bold: true });
        slide2.addText(hpi, { x: 0.5, y: 1.0, w: '90%', fontSize: 14 });

        // Slide 3: Objective
        const slide3 = pres.addSlide();
        slide3.addText("Objective", { x: 0.5, y: 0.5, fontSize: 18, color: '3498db', bold: true });
        slide3.addText("Meds: " + meds, { x: 0.5, y: 1.0, w: '45%', fontSize: 12 });
        slide3.addText("Labs: " + labs, { x: 5.0, y: 1.0, w: '45%', fontSize: 12 });

        // Slide 4: Plan
        const slide4 = pres.addSlide();
        slide4.addText("Plan", { x: 0.5, y: 0.5, fontSize: 18, color: '3498db', bold: true });
        slide4.addText(plan, { x: 0.5, y: 1.0, w: '90%', fontSize: 14 });

        // Save file
        pres.writeFile({ fileName: "Case_" + initials + ".pptx" });
    }

    function exportDOC() {
        const age = getFieldValue('age');
        const sex = getFieldValue('sex');
        const hpi = getFieldValue('hpi') || getRawText();
        const plan = getFieldValue('plan');
        const initials = getFieldValue('initials');

        const content = "<h1>Case Report</h1>" +
                        "<p><strong>Pt:</strong> " + age + " " + sex + "</p>" +
                        "<h3>HPI</h3><p>" + hpi + "</p>" +
                        "<h3>Plan</h3><p>" + plan + "</p>";

        const blob = new Blob(
            ['<!DOCTYPE html><html><body>' + content + '</body></html>'],
            { type: 'application/msword' }
        );

        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = "Case_" + initials + ".doc";
        link.click();
    }
</script>
</body>
</html>
