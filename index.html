<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SZMC Pro: Auditor v14.0</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2c3e50">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --audit: #e74c3c; --bg: #f0f2f5; --sidebar: #ffffff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* SIDEBAR */
        .sidebar { width: 340px; background: var(--sidebar); border-right: 1px solid #dce1e6; display: flex; flex-direction: column; padding: 25px; z-index: 2; box-shadow: 4px 0 15px rgba(0,0,0,0.03); }
        .logo { font-size: 1.5rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 10px; margin-bottom: 25px; }
        .badge { background: var(--audit); color: white; padding: 3px 8px; border-radius: 6px; font-size: 0.75rem; letter-spacing: 0.5px; }

        /* DROPZONE */
        .drop-zone {
            border: 2px dashed #cbd5e0; border-radius: 12px; padding: 30px 20px; text-align: center;
            background: #f8fafc; cursor: pointer; transition: all 0.2s ease;
        }
        .drop-zone:hover { border-color: var(--accent); background: #ebf5fb; transform: translateY(-2px); }

        /* MAIN AREA */
        .main { flex: 1; padding: 40px; overflow-y: auto; display: flex; gap: 40px; }
        .editor-col { flex: 2; background: white; border-radius: 12px; padding: 40px; box-shadow: 0 4px 20px rgba(0,0,0,0.04); }
        .preview-col { flex: 1; display: flex; flex-direction: column; gap: 20px; min-width: 300px; position: sticky; top: 40px; height: fit-content; }

        /* INPUTS & MACROS */
        .sec-header { font-size: 1.1rem; font-weight: 800; color: var(--primary); border-bottom: 2px solid #f1f3f5; padding-bottom: 12px; margin-bottom: 15px; margin-top: 35px; display:flex; justify-content:space-between; align-items:center; }
        .sec-header:first-child { margin-top: 0; }

        .macro-row { display:flex; gap:8px; overflow-x:auto; padding-bottom:10px; margin-bottom:5px; }
        .macro-tag {
            background: #edf2f7; color: #4a5568; padding: 4px 10px; border-radius: 20px;
            font-size: 0.75rem; font-weight: 600; cursor: pointer; white-space: nowrap; border: 1px solid transparent; transition:0.2s;
        }
        .macro-tag:hover { background: #cbd5e0; border-color: #a0aec0; }

        label { display: block; font-size: 0.7rem; font-weight: 700; color: #95a5a6; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        input, select, textarea { width: 100%; padding: 14px; border: 1px solid #dfe6e9; border-radius: 8px; font-family: inherit; font-size: 0.95rem; box-sizing: border-box; background: #fdfdfd; transition: border 0.2s; }
        input:focus, textarea:focus { border-color: var(--accent); outline: none; background: white; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); }

        /* BUTTONS */
        .btn { padding: 14px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; color: white; width: 100%; margin-bottom: 12px; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; gap: 8px; transition: transform 0.1s; }
        .btn:active { transform: scale(0.98); }

        .btn-ai { background: linear-gradient(135deg, #2c3e50, #34495e); }
        .btn-audit { background: linear-gradient(135deg, #c0392b, #e74c3c); box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3); }
        .btn-ppt { background: #e67e22; }
        .btn-doc { background: #2980b9; }

        /* AUDIT PANEL */
        .audit-panel { background: #fff5f5; border: 2px solid #fab1a0; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .audit-title { color: #c0392b; font-weight: 800; font-size: 1rem; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }

        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        #ocr-status { font-size: 0.8rem; color: #e67e22; margin-top: 15px; font-weight: bold; text-align: center; }
        .autosave-msg { font-size:0.7rem; color:#27ae60; text-align:center; opacity:0; transition:opacity 0.5s; margin-top:10px; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="logo">
        <span>SZMC Pro</span>
        <span class="badge">v14.0 Auditor</span>
    </div>

    <div class="drop-zone" onclick="document.getElementById('file-in').click()" id="drop-area">
        <span class="drop-icon">üîç</span>
        <div style="font-weight:700; color:#34495e;">Import Case Data</div>
        <div style="font-size:0.8rem; color:#7f8c8d; margin-top:8px;">
            Drag PDF, PPTX, or Image<br>
        </div>
        <input type="file" id="file-in" style="display:none" onchange="handleFile(this)">
    </div>
    <div id="ocr-status"></div>
    <div class="autosave-msg" id="save-msg">‚úÖ Auto-saved</div>

    <div style="margin-top:auto;">
        <label>Raw Extracted Text</label>
        <textarea id="raw-text" style="height:250px; font-family:monospace; font-size:0.75rem; color:#333; line-height:1.4;" placeholder="Extracted text dump..."></textarea>
    </div>
</div>

<div class="main">
    <div class="editor-col">
        <div class="sec-header">1. Context</div>
        <div class="grid-3">
            <div><label>Age</label><input type="text" id="age" oninput="autoSave()"></div>
            <div><label>Sex</label><select id="sex" oninput="autoSave()"><option>Male</option><option>Female</option></select></div>
            <div><label>Initials</label><input type="text" id="initials" oninput="autoSave()"></div>
        </div>
        <div style="margin-top:20px;">
            <label>Chief Complaint</label>
            <input type="text" id="cc" oninput="autoSave()">
        </div>

        <div class="sec-header">
            2. Narrative
            <div class="macro-row">
                <span class="macro-tag" onclick="insert('hpi', 'Baseline: Independent.')">üö∂ Independent</span>
                <span class="macro-tag" onclick="insert('hpi', 'Baseline: Nursing Home resident.')">üè† Nursing Home</span>
                <span class="macro-tag" onclick="insert('hpi', 'Cognitively intact.')">üß† Intact</span>
            </div>
        </div>
        <textarea id="hpi" rows="5" oninput="autoSave()" placeholder="HPI..."></textarea>

        <div class="grid-2" style="margin-top:25px;">
            <div>
                <label>PMH</label>
                <div class="macro-row">
                    <span class="macro-tag" onclick="insert('pmh', 'HTN, T2DM, HLP')">üíä Met Syn</span>
                    <span class="macro-tag" onclick="insert('pmh', 'IHD (s/p CABG)')">‚ù§Ô∏è Cardiac</span>
                </div>
                <textarea id="pmh" rows="6" oninput="autoSave()"></textarea>
            </div>
            <div>
                <label>Medications</label>
                <textarea id="meds" rows="6" oninput="autoSave()"></textarea>
            </div>
        </div>

        <div class="sec-header">3. Objective</div>
        <div class="grid-2">
            <div><label>Labs</label><textarea id="labs" rows="6" oninput="autoSave()"></textarea></div>
            <div><label>Imaging / Diagnostics</label><textarea id="imaging" rows="6" oninput="autoSave()"></textarea></div>
        </div>

        <div class="sec-header">
            4. Assessment & Plan
            <div class="macro-row">
                <span class="macro-tag" onclick="insert('plan', 'DNR / DNI.')">üõë DNR/DNI</span>
                <span class="macro-tag" onclick="insert('plan', 'Rec: Geriatric Rehab.')">üè• Rehab</span>
            </div>
        </div>
        <textarea id="plan" rows="10" oninput="autoSave()"></textarea>
    </div>

    <div class="preview-col">

        <div class="audit-panel">
            <div class="audit-title">üõ°Ô∏è Inner AI Auditor</div>
            <p style="font-size:0.8rem; color:#c0392b; margin-bottom:15px; line-height:1.4;">
                Force the AI to critique your plan for safety, errors, and missing items before you discharge.
            </p>
            <label>Audit Focus</label>
            <select id="audit-mode" style="margin-bottom:10px; border-color:#fab1a0;">
                <option value="safety">üíä Med Safety & Beers Criteria</option>
                <option value="diagnostic">üîç Diagnostic Blindspots</option>
                <option value="discharge">üö™ Discharge Safety Check</option>
            </select>
            <button class="btn btn-audit" onclick="generateAudit()">
                <span>üö®</span> Run Clinical Audit
            </button>
        </div>

        <div style="background:white; padding:25px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.05);">
            <div style="font-weight:800; color:var(--primary); margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">Standard Output</div>

            <button class="btn btn-ai" onclick="generateStandard()">
                <span>‚ú®</span> Generate Summary
            </button>

            <div style="height:1px; background:#eee; margin:15px 0;"></div>

            <button class="btn btn-ppt" onclick="exportPPT()">üìä PPTX</button>
            <button class="btn btn-doc" onclick="exportDOC()">üìù Word</button>
            <button class="btn" onclick="clearData()" style="background:transparent; color:#95a5a6; border:1px solid #ccc; margin-top:10px;">Reset</button>
        </div>
    </div>
</div>

<script>
    // --- 1. CORE & IMPORT ---
    const dropArea = document.getElementById('drop-area');
    const statusDiv = document.getElementById('ocr-status');

    dropArea.addEventListener('dragover', (e) => { e.preventDefault(); dropArea.style.background = '#e8f6f3'; });
    dropArea.addEventListener('dragleave', (e) => { e.preventDefault(); dropArea.style.background = '#f8fafc'; });
    dropArea.addEventListener('drop', (e) => { e.preventDefault(); dropArea.style.background = '#f8fafc'; if(e.dataTransfer.files.length) handleFile({files: e.dataTransfer.files}); });

    async function handleFile(input) {
        const file = input.files[0];
        if(!file) return;
        const ext = file.name.split('.').pop().toLowerCase();
        let text = "";
        statusDiv.innerText = "Reading " + ext.toUpperCase() + "...";

        try {
            if (ext === 'pptx') {
                const zip = await JSZip.loadAsync(file);
                const slideFiles = Object.keys(zip.files).filter(n => n.match(/ppt\/slides\/slide\d+\.xml/)).sort((a,b) => parseInt(a.match(/slide(\d+)\.xml/)[1]) - parseInt(b.match(/slide(\d+)\.xml/)[1]));
                for(let k of slideFiles) { const t = await zip.file(k).async("string"); const d = new DOMParser().parseFromString(t, "text/xml"); if(d.documentElement) text += d.documentElement.textContent + "\n\n"; }
            } else if (ext === 'pdf') {
                const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
                for(let i=1; i<=pdf.numPages; i++) text += (await (await pdf.getPage(i)).getTextContent()).items.map(s=>s.str).join(' ') + " ";
            } else if (ext === 'docx') {
                const result = await mammoth.extractRawText({arrayBuffer: await file.arrayBuffer()});
                text = result.value;
            } else if (['jpg','png','jpeg'].includes(ext)) {
                statusDiv.innerText = "OCR Processing...";
                const w = await Tesseract.createWorker('eng');
                const r = await w.recognize(file); text = r.data.text; await w.terminate();
            } else { text = await file.text(); }
            document.getElementById('raw-text').value = text; smartPopulate(text); statusDiv.innerText = "Success!"; autoSave(); setTimeout(()=>statusDiv.innerText="", 2000);
        } catch (err) { console.error(err); statusDiv.innerText = "Error!"; alert("Import failed."); }
    }

    // --- 2. SMART LOGIC ---
    function smartPopulate(text) {
        const set = (id, r) => { let m = text.match(r); if(m) document.getElementById(id).value = m[1].trim(); }
        set('age', /(\d{2,3})\s?(y|yo|Year)/i);
        set('hpi', /(?:HPI|History|Anamnesis)[:\s]+([\s\S]*?)(?=\n\s*(?:PMH|Back|Meds)|$)/i);
        set('pmh', /(?:PMH|Background)[:\s]+([\s\S]*?)(?=\n\s*(?:Med|Lab)|$)/i);
        set('meds', /(?:Meds|Medications)[:\s]+([\s\S]*?)(?=\n\s*(?:Lab|Plan)|$)/i);
        set('labs', /(?:Labs|Chemistry)[:\s]+([\s\S]*?)(?=\n\s*(?:Plan|Imag)|$)/i);
    }
    function insert(id, txt) { const el = document.getElementById(id); el.value = el.value ? el.value + " " + txt : txt; autoSave(); }

    // --- 3. STATE ---
    const FIELDS = ['age','sex','initials','cc','hpi','pmh','meds','labs','imaging','plan','raw-text'];
    function autoSave() {
        const d = {}; FIELDS.forEach(id => d[id] = document.getElementById(id).value);
        localStorage.setItem('szmc_v14_data', JSON.stringify(d));
        const ind = document.getElementById('save-msg'); ind.style.opacity = 1; setTimeout(() => ind.style.opacity = 0, 1000);
    }
    window.onload = () => { const s = localStorage.getItem('szmc_v14_data'); if(s) { const d = JSON.parse(s); FIELDS.forEach(id => { if(d[id]) document.getElementById(id).value = d[id]; }); } };
    function clearData() { if(confirm("Reset all?")) { FIELDS.forEach(id => document.getElementById(id).value = ""); localStorage.removeItem('szmc_v14_data'); } }

    // --- 4. EXPORT & AI ---
    const v = (id) => document.getElementById(id).value || "";
    const raw = () => document.getElementById('raw-text').value || "";
    const getData = () => v('hpi').length > 5 ? `PT: ${v('age')} ${v('sex')}\nHPI: ${v('hpi')}\nPMH: ${v('pmh')}\nMEDS: ${v('meds')}\nLABS: ${v('labs')}\nPLAN: ${v('plan')}` : `RAW:\n${raw()}`;

    function generateStandard() {
        const p = `Act as a Senior Geriatrician. Summarize this case for Morning Report.\n\n${getData()}\n\nOUTPUT: 1-Liner ID, HPI Summary, Geriatric Syndromes, Plan.`;
        navigator.clipboard.writeText(p); alert("‚ú® Summary Prompt Copied!");
    }

    function generateAudit() {
        const mode = document.getElementById('audit-mode').value;
        let p = `Act as a STRICT Clinical Safety Officer and Geriatric Pharmacologist. Review this case CRITICALLY. Do NOT summarize. Only find ERRORS and RISKS.\n\n${getData()}\n\n`;

        if (mode === 'safety') {
            p += `TASK: 1. Identify ANY potential Drug-Drug Interactions. 2. Flag meds inappropriate for elderly (Beers Criteria / STOPP). 3. Check for Renally cleared drugs if Creatinine is high.`;
        } else if (mode === 'diagnostic') {
            p += `TASK: 1. What diagnoses are we missing? 2. Is the Delirium workup complete? 3. Are we anchoring on a diagnosis? Suggest 3 differential diagnoses we might have ignored.`;
        } else if (mode === 'discharge') {
            p += `TASK: 1. Is this patient safe to go home? 2. Identify fall risks at home based on this data. 3. What social support is missing?`;
        }

        navigator.clipboard.writeText(p); alert("üö® AUDIT PROMPT COPIED! Paste into AI to start safety check.");
    }

    function exportPPT() {
        let pres = new PptxGenJS();
        let s1 = pres.addSlide(); s1.addText("Geriatric Case", {x:1, y:2, fontSize:32, color:'2c3e50', bold:true}); s1.addText(`${v('age')}yo ${v('sex')} - ${v('cc')}`, {x:1, y:3, fontSize:24, color:'7f8c8d'});
        let s2 = pres.addSlide(); s2.addText("HPI", {x:0.5, y:0.5, fontSize:18, color:'3498db', bold:true}); s2.addText(v('hpi') || raw().substring(0,500), {x:0.5, y:1.0, w:'90%', fontSize:14});
        let s3 = pres.addSlide(); s3.addText("Objective", {x:0.5, y:0.5, fontSize:18, color:'3498db', bold:true}); s3.addText("Meds: " + v('meds'), {x:0.5, y:1.0, w:'45%', fontSize:12}); s3.addText("Labs: " + v('labs'), {x:5.0, y:1.0, w:'45%', fontSize:12});
        let s4 = pres.addSlide(); s4.addText("Plan", {x:0.5, y:0.5, fontSize:18, color:'3498db', bold:true}); s4.addText(v('plan'), {x:0.5, y:1.0, w:'90%', fontSize:14});
        pres.writeFile({ fileName: `Case_${v('initials')}.pptx` });
    }

    function exportDOC() {
        const c = `<h1>Case Report</h1><p><strong>Pt:</strong> ${v('age')} ${v('sex')}</p><h3>HPI</h3><p>${v('hpi') || raw()}</p><h3>Plan</h3><p>${v('plan')}</p>`;
        const b = new Blob(['<!DOCTYPE html><html><body>'+c+'</body></html>'], {type: 'application/msword'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `Case_${v('initials')}.doc`; a.click();
    }
</script>
</body>
</html>
