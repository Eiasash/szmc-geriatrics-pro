<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SZMC Pro: Universal v12.2 (AI Fix)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #ecf0f1; --sidebar: #ffffff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* SIDEBAR */
        .sidebar { width: 300px; background: var(--sidebar); border-right: 1px solid #bdc3c7; display: flex; flex-direction: column; padding: 20px; z-index: 2; }
        .logo { font-size: 1.4rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
        .badge { background: #8e44ad; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; }

        /* DROPZONE */
        .drop-zone {
            border: 2px dashed #95a5a6; border-radius: 8px; padding: 30px 20px; text-align: center;
            background: #f7f9f9; cursor: pointer; transition: 0.3s;
        }
        .drop-zone:hover { border-color: var(--accent); background: #ebf5fb; }
        .drop-icon { font-size: 2.5rem; display: block; margin-bottom: 10px; }
        
        /* EDITOR */
        .main { flex: 1; padding: 30px; overflow-y: auto; display: flex; gap: 30px; }
        .editor-col { flex: 2; background: white; border-radius: 8px; padding: 40px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .preview-col { flex: 1; display: flex; flex-direction: column; gap: 20px; min-width: 250px;}

        /* INPUTS */
        .sec-header { font-size: 1.1rem; font-weight: 700; color: var(--primary); border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; margin-bottom: 20px; margin-top: 30px; }
        .sec-header:first-child { margin-top: 0; }
        label { display: block; font-size: 0.75rem; font-weight: 700; color: #7f8c8d; margin-bottom: 6px; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #bdc3c7; border-radius: 6px; font-family: inherit; box-sizing: border-box; background: #fdfdfd; }
        input:focus, textarea:focus { border-color: var(--accent); outline: none; }
        
        /* BUTTONS */
        .btn { padding: 12px; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; color: white; width: 100%; margin-bottom: 10px; }
        .btn-ppt { background: #d35400; }
        .btn-doc { background: #2980b9; }
        .btn-ai { background: linear-gradient(135deg, #8e44ad, #9b59b6); }

        /* STATUS */
        #ocr-status { font-size: 0.8rem; color: #e67e22; margin-top: 10px; font-weight: bold; min-height: 1.2em; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="logo"><span>SZMC Pro</span><span class="badge">v12.2 AI Fix</span></div>
    
    <div class="drop-zone" onclick="document.getElementById('file-in').click()" id="drop-area">
        <span class="drop-icon">üìÇ</span>
        <div style="font-weight:600; color:#7f8c8d;">Drop File Here</div>
        <div style="font-size:0.75rem; color:#95a5a6; margin-top:5px;">PPTX ‚Ä¢ PDF ‚Ä¢ DOCX ‚Ä¢ IMG</div>
        <input type="file" id="file-in" style="display:none" onchange="handleFile(this)">
    </div>
    <div id="ocr-status"></div>
    
    <label style="margin-top:20px;">Raw Extracted Text</label>
    <textarea id="raw-text" style="flex:1; font-family:monospace; font-size:0.75rem; color:#333;"></textarea>
</div>

<div class="main">
    <div class="editor-col">
        <div class="sec-header">1. Demographics</div>
        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:20px;">
            <div><label>Age</label><input type="text" id="age"></div>
            <div><label>Sex</label><select id="sex"><option>Male</option><option>Female</option></select></div>
            <div><label>Initials</label><input type="text" id="initials"></div>
        </div>
        <div style="margin-top:15px;"><label>CC</label><input type="text" id="cc"></div>

        <div class="sec-header">2. History</div>
        <label>HPI</label><textarea id="hpi" rows="5"></textarea>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:20px;">
            <div><label>PMH</label><textarea id="pmh" rows="4"></textarea></div>
            <div><label>Meds</label><textarea id="meds" rows="4"></textarea></div>
        </div>

        <div class="sec-header">3. Objective</div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
            <div><label>Labs</label><textarea id="labs" rows="5"></textarea></div>
            <div><label>Imaging/Scores</label><textarea id="imaging" rows="5"></textarea></div>
        </div>

        <div class="sec-header">4. Plan</div>
        <label>Assessment & Plan</label><textarea id="plan" rows="8"></textarea>
    </div>

    <div class="preview-col">
        <div style="background:white; padding:20px; border-radius:8px; box-shadow:0 4px 6px rgba(0,0,0,0.05);">
            <div style="font-weight:800; color:var(--primary); margin-bottom:15px; border-bottom:1px solid #eee;">Tools</div>
            <button class="btn btn-ai" onclick="generatePrompt()">‚ú® Copy AI Prompt</button>
            <button class="btn btn-ppt" onclick="exportPPT()">üìä Export PPTX</button>
            <button class="btn btn-doc" onclick="exportDOC()">üìù Export Word</button>
        </div>
        <div style="font-size:0.8rem; color:#7f8c8d; background:#eee; padding:10px; border-radius:4px;">
            <strong>Tip:</strong> If the text boxes are empty, the "AI Prompt" button will automatically grab the Raw Text instead.
        </div>
    </div>
</div>

<script>
    // --- 1. ROBUST IMPORT ENGINE ---
    const dropArea = document.getElementById('drop-area');
    const statusDiv = document.getElementById('ocr-status');

    dropArea.addEventListener('dragover', (e) => { e.preventDefault(); dropArea.style.background = '#d6eaf8'; });
    dropArea.addEventListener('dragleave', (e) => { e.preventDefault(); dropArea.style.background = '#f7f9f9'; });
    dropArea.addEventListener('drop', (e) => { 
        e.preventDefault(); dropArea.style.background = '#f7f9f9';
        if(e.dataTransfer.files.length) handleFile({files: e.dataTransfer.files});
    });

    async function handleFile(input) {
        const file = input.files[0];
        if(!file) return;
        
        const ext = file.name.split('.').pop().toLowerCase();
        let text = "";
        statusDiv.innerText = "Reading " + ext.toUpperCase() + "...";

        try {
            // A. PPTX (XML Parsing)
            if (ext === 'pptx') {
                const zip = await JSZip.loadAsync(file);
                const slideFiles = Object.keys(zip.files).filter(n => n.match(/ppt\/slides\/slide\d+\.xml/));
                // Numerical Sort
                slideFiles.sort((a,b) => parseInt(a.match(/slide(\d+)\.xml/)[1]) - parseInt(b.match(/slide(\d+)\.xml/)[1]));

                for(let k of slideFiles) {
                    const xmlText = await zip.file(k).async("string");
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlText, "text/xml");
                    if (xmlDoc.documentElement) text += xmlDoc.documentElement.textContent + "\n\n";
                }
            }
            // B. PDF
            else if (ext === 'pdf') {
                const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
                for(let i=1; i<=pdf.numPages; i++) text += (await (await pdf.getPage(i)).getTextContent()).items.map(s=>s.str).join(' ') + " ";
            }
            // C. DOCX
            else if (ext === 'docx') {
                const result = await mammoth.extractRawText({arrayBuffer: await file.arrayBuffer()});
                text = result.value;
            }
            // D. IMAGES (OCR)
            else if (['jpg','png','jpeg'].includes(ext)) {
                statusDiv.innerText = "OCR Processing...";
                const worker = await Tesseract.createWorker('eng');
                const ret = await worker.recognize(file);
                text = ret.data.text;
                await worker.terminate();
            }
            else { text = await file.text(); } // txt/json

            document.getElementById('raw-text').value = text;
            smartPopulate(text);
            statusDiv.innerText = "Success!";
            setTimeout(()=>statusDiv.innerText="", 3000);

        } catch (err) {
            console.error(err);
            statusDiv.innerText = "Error: " + err.message;
            alert("Error parsing file. See console for details.");
        }
    }

    // --- 2. SMART POPULATE ---
    function smartPopulate(text) {
        const set = (id, r) => { let m = text.match(r); if(m) document.getElementById(id).value = m[1].trim(); }
        // Try to match headers
        set('age', /(\d{2,3})\s?(y|yo|Year)/i);
        set('hpi', /(?:HPI|History|Anamnesis)[:\s]+([\s\S]*?)(?=\n\s*(?:PMH|Back|Meds)|$)/i);
        set('pmh', /(?:PMH|Background)[:\s]+([\s\S]*?)(?=\n\s*(?:Med|Lab)|$)/i);
        set('meds', /(?:Meds|Medications)[:\s]+([\s\S]*?)(?=\n\s*(?:Lab|Plan)|$)/i);
        set('labs', /(?:Labs|Chemistry)[:\s]+([\s\S]*?)(?=\n\s*(?:Plan|Imag)|$)/i);
    }

    // --- 3. EXPORTS ---
    const v = (id) => document.getElementById(id).value || "";
    const raw = () => document.getElementById('raw-text').value || "";

    function exportPPT() {
        let pres = new PptxGenJS();
        
        let s1 = pres.addSlide();
        s1.addText("Geriatric Case", {x:1, y:2, fontSize:32, color:'2c3e50', bold:true});
        s1.addText(`${v('age')}yo ${v('sex')} - ${v('cc')}`, {x:1, y:3, fontSize:24, color:'7f8c8d'});

        let s2 = pres.addSlide();
        s2.addText("HPI", {x:0.5, y:0.5, fontSize:18, color:'3498db', bold:true});
        s2.addText(v('hpi') || raw().substring(0,500) + "...", {x:0.5, y:1.0, w:'90%', fontSize:14});

        let s3 = pres.addSlide();
        s3.addText("Objective", {x:0.5, y:0.5, fontSize:18, color:'3498db', bold:true});
        s3.addText("Meds: " + v('meds'), {x:0.5, y:1.0, w:'45%', fontSize:12});
        s3.addText("Labs: " + v('labs'), {x:5.0, y:1.0, w:'45%', fontSize:12});

        let s4 = pres.addSlide();
        s4.addText("Plan", {x:0.5, y:0.5, fontSize:18, color:'3498db', bold:true});
        s4.addText(v('plan'), {x:0.5, y:1.0, w:'90%', fontSize:14});

        pres.writeFile({ fileName: `Case_${v('initials')}.pptx` });
    }

    function exportDOC() {
        const content = `<h1>Case Report</h1><p><strong>Pt:</strong> ${v('age')} ${v('sex')}</p><h3>HPI</h3><p>${v('hpi') || raw()}</p><h3>Assessment</h3><p>${v('plan')}</p>`;
        const blob = new Blob(['<!DOCTYPE html><html><body>'+content+'</body></html>'], {type: 'application/msword'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `Case_${v('initials')}.doc`;
        a.click();
    }

    // --- 4. IMPROVED AI PROMPT ---
    function generatePrompt() {
        let p = "";
        
        // Strategy: Use structured data if we have it, otherwise fallback to the Raw Text dump.
        const hasStructured = v('hpi').length > 10 || v('meds').length > 10;
        
        p += "Act as a Senior Geriatrician. I need a comprehensive Case Presentation and Assessment.\n\n";
        
        if (hasStructured) {
             p += `PATIENT: ${v('age')} ${v('sex')}\n`;
             p += `CC: ${v('cc')}\n`;
             p += `HPI: ${v('hpi')}\n`;
             p += `PMH: ${v('pmh')}\n`;
             p += `MEDICATIONS: ${v('meds')}\n`;
             p += `LABS/OBJECTIVE: ${v('labs')}\n`;
             p += `CURRENT PLAN: ${v('plan')}\n\n`;
        } else {
             p += "I have extracted the following text from a medical document/image. It is messy. Please organize it into a clinical summary:\n\n";
             p += `--- START RAW DATA ---\n${raw()}\n--- END RAW DATA ---\n\n`;
        }

        p += "TASKS:\n";
        p += "1. Summarize the HPI and primary medical issues.\n";
        p += "2. Identify potential Geriatric Syndromes (Falls, Delirium, Frailty, Incontinence).\n";
        p += "3. Review the Medication List for Polypharmacy and Beer's Criteria (flag inappropriate meds).\n";
        p += "4. Suggest a prioritized Assessment & Plan.";

        navigator.clipboard.writeText(p);
        alert("Prompt copied to clipboard! (Includes fallback to raw text if fields were empty)");
    }
</script>
</body>
</html>
